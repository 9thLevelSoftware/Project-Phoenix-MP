---
phase: 10-monitor-data-processor
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessorTest.kt
autonomous: true
must_haves:
  truths:
    - "MonitorDataProcessor.process(packet) returns validated WorkoutMetric with correct position, load, velocity, and status fields"
    - "Position jump over 20mm threshold rejects sample (returns null) without cascading to next valid sample (Issue #210)"
    - "Velocity EMA seeds with first raw sample (no cold start lag) and converges toward stable velocity"
    - "Deload callback fires at most once per 2-second window (debounce)"
    - "ROM violation callbacks fire for OUTSIDE_HIGH and OUTSIDE_LOW status flags"
    - "resetForNewSession() clears tracking state but preserves lastGoodPosA/B"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt"
      provides: "Synchronous processing pipeline: position clamping, status flags, jump validation, velocity EMA"
      contains: "class MonitorDataProcessor"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessorTest.kt"
      provides: "Comprehensive unit tests for all pipeline stages"
      contains: "class MonitorDataProcessorTest"
  key_links:
    - from: "MonitorDataProcessor.kt"
      to: "ProtocolModels.kt"
      via: "MonitorPacket input parameter"
      pattern: "fun process\\(packet: MonitorPacket\\)"
    - from: "MonitorDataProcessor.kt"
      to: "Models.kt"
      via: "WorkoutMetric return type"
      pattern: "WorkoutMetric\\("
    - from: "MonitorDataProcessor.kt"
      to: "BleConstants.kt"
      via: "Threshold constants for validation"
      pattern: "BleConstants\\.Thresholds"
    - from: "MonitorDataProcessor.kt"
      to: "SampleStatus.kt"
      via: "Status flag parsing"
      pattern: "SampleStatus\\(status\\)"
---

<objective>
Create MonitorDataProcessor with TDD: a synchronous processing pipeline that takes MonitorPacket and returns validated WorkoutMetric?, handling position clamping, status flags (deload/ROM), jump validation (Issue #210 cascade prevention), velocity calculation with EMA smoothing, and poll rate diagnostics.

Purpose: Extract the ~155-line parseMonitorData pipeline plus processStatusFlags and validateSample from KableBleRepository into a standalone, testable class. Every line of logic already exists -- this is a mechanical TDD extraction with callback-based event emission for <5ms latency.

Output: MonitorDataProcessor.kt and MonitorDataProcessorTest.kt with ~30 unit tests covering all pipeline stages, edge cases, and the critical Issue #210 invariant.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-monitor-data-processor/10-RESEARCH.md

# Source code to extract from:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt (lines 173-235 state vars, 1678-1915 processing pipeline)

# Input/output types:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt (WorkoutMetric)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/SampleStatus.kt

# Constants used by processor:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt

# Pattern reference (Phase 9 TDD extraction):
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1 - RED: Write failing tests for MonitorDataProcessor</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessorTest.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt
  </files>
  <action>
Create MonitorDataProcessorTest.kt with a `packet()` helper and fake time/callback tracking, following the HandleStateDetectorTest pattern (fake `fakeTime` variable, callback counters, helper factory).

Write tests for ALL pipeline stages (tests MUST fail initially -- create a minimal stub MonitorDataProcessor that compiles but returns null from process()):

**Position validation (6 tests):**
- Valid position passes through unchanged
- Position A out of range uses last-good fallback (verify returned metric has fallback value)
- Position B out of range uses last-good fallback
- Both positions out of range use last-good fallback
- Position at MIN_POSITION boundary (-1000) is valid
- Position at MAX_POSITION boundary (1000) is valid

**Load validation (3 tests):**
- Valid load passes through
- Negative load rejects sample (returns null)
- Load exceeding MAX_WEIGHT_KG (220) rejects sample

**Jump filter / Issue #210 (6 tests):**
- Position jump over 20mm threshold rejects sample
- Position jump under threshold passes
- Issue #210: spike does not cause infinite cascade (spike at N, filtered at N+1 due to delta from spike, PASSES at N+2 because delta from N+1 is 0)
- Issue #210: tracking updates even when sample filtered (verify next sample's delta is from the spike value, not the pre-spike value)
- Jump filter skips first sample (no previous reference -- lastTimestamp == 0)
- Jump filter respects strictValidationEnabled=false (no filtering)

**Velocity EMA (5 tests):**
- First velocity sample seeds EMA directly (smoothedVelocity equals first raw velocity)
- EMA converges toward stable velocity over multiple samples
- Velocity skipped after filtered sample (lastSampleWasFiltered flag)
- Velocity calculation uses correct time delta
- Zero time delta produces zero velocity

**Status flags (6 tests):**
- Status 0 triggers no callbacks
- DELOAD_OCCURRED triggers onDeloadOccurred callback
- Deload event debounced within 2 seconds (second deload within 2s does NOT fire callback)
- Deload event fires again after 2-second cooldown
- ROM_OUTSIDE_HIGH triggers onRomViolation(OUTSIDE_HIGH)
- ROM_OUTSIDE_LOW triggers onRomViolation(OUTSIDE_LOW)

**Session reset (4 tests):**
- resetForNewSession clears tracking state (next process acts as first sample)
- resetForNewSession resets EMA to initial state (isFirstVelocitySample becomes true)
- resetForNewSession resets poll rate diagnostics
- resetForNewSession does NOT reset lastGoodPosA/B (intentional preservation)

**Stub MonitorDataProcessor.kt** with:
```kotlin
package com.devil.phoenixproject.data.ble

import com.devil.phoenixproject.domain.model.WorkoutMetric
import com.devil.phoenixproject.currentTimeMillis

class MonitorDataProcessor(
    private val onDeloadOccurred: () -> Unit = {},
    private val onRomViolation: (RomViolationType) -> Unit = {},
    private val timeProvider: () -> Long = { currentTimeMillis() }
) {
    enum class RomViolationType { OUTSIDE_HIGH, OUTSIDE_LOW }

    var strictValidationEnabled: Boolean = true
    val notificationCount: Long get() = 0L

    fun process(packet: MonitorPacket): WorkoutMetric? = null
    fun resetForNewSession() {}
    fun getPollRateStats(): String = ""
}
```

Run `./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- tests MUST compile but FAIL.

Commit: `test(10-01): add failing tests for MonitorDataProcessor`
  </action>
  <verify>
`./gradlew :shared:compileTestDebugKotlinAndroid` compiles successfully.
`./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- tests compile and run, majority FAIL (stub returns null).
  </verify>
  <done>MonitorDataProcessorTest.kt exists with ~30 tests covering all pipeline stages. MonitorDataProcessor.kt stub compiles. Tests fail against stub.</done>
</task>

<task type="auto">
  <name>Task 2 - GREEN: Implement MonitorDataProcessor to pass all tests</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt</files>
  <action>
Implement the full MonitorDataProcessor by mechanically extracting the existing logic from KableBleRepository.kt lines 1678-1915. This is NOT new code -- every line exists and works. The implementation must include:

**15 state variables** (moved from KableBleRepository lines 173-235):
- `lastGoodPosA`, `lastGoodPosB` (position clamping)
- `lastPositionA`, `lastPositionB`, `lastTimestamp` (velocity tracking)
- `smoothedVelocityA`, `smoothedVelocityB` (EMA)
- `isFirstVelocitySample` (EMA cold start fix)
- `lastSampleWasFiltered` (velocity edge case)
- `lastDeloadEventTime` (deload debounce)
- `pollIntervalSum`, `pollIntervalCount`, `maxPollInterval`, `minPollInterval` (diagnostics)
- `monitorNotificationCount` (notification counter, exposed as read-only `notificationCount`)

**`process(packet: MonitorPacket): WorkoutMetric?`** pipeline:
1. Increment `monitorNotificationCount`
2. Position clamping: if posA/B out of `MIN_POSITION..MAX_POSITION`, use `lastGoodPosA/B`; else update `lastGoodPosA/B`
3. Status flags: if `packet.status != 0`, call `processStatusFlags(packet.status)`
4. **CRITICAL Issue #210**: Save `previousPosA/B = lastPositionA/B`, then update `lastPositionA/B = posA/B` BEFORE calling `validateSample()`. This prevents cascading filter failures.
5. Validation: `if (!validateSample(posA, loadA, posB, loadB, previousPosA, previousPosB))` -- set `lastSampleWasFiltered = true`, return null
6. Velocity: calculate raw velocity from position delta / time delta. Use `previousPosA/B` for delta (since lastPositionA/B already updated).
7. Poll rate diagnostics: update sum/count/min/max from pollIntervalMs
8. EMA smoothing: if `lastSampleWasFiltered` -- skip update, clear flag. If `isFirstVelocitySample` -- seed EMA. Else -- standard EMA with `VELOCITY_SMOOTHING_ALPHA`.
9. Update `lastTimestamp = currentTime`
10. Return `WorkoutMetric(...)` with smoothed velocities

**`processStatusFlags(status: Int)`** (from lines 1839-1875):
- Use `SampleStatus(status)` for flag checks
- ROM violations -> call `onRomViolation` callback immediately
- Deload -> debounce with `DELOAD_EVENT_DEBOUNCE_MS` (2000ms) using `timeProvider()`
- Deload warn and spotter active -> log only (use Kermit `co.touchlab.kermit.Logger`)

**`validateSample(...): Boolean`** (from lines 1885-1915):
- Range check: posA/B in MIN_POSITION..MAX_POSITION
- Load check: loadA/B in 0..MAX_WEIGHT_KG
- Jump filter: if `strictValidationEnabled && lastTimestamp > 0L`, reject if abs(posA - previousPosA) > POSITION_JUMP_THRESHOLD or same for B

**`resetForNewSession()`** (from lines 1142-1160):
- Reset: lastTimestamp, pollIntervalSum/Count/Min/Max, lastPositionA/B, smoothedVelocityA/B, isFirstVelocitySample, lastSampleWasFiltered, monitorNotificationCount
- Do NOT reset: lastGoodPosA/B, lastDeloadEventTime, strictValidationEnabled

**`getPollRateStats(): String`** -- diagnostic summary string

All constants from `BleConstants.Thresholds`. No suspend functions, no coroutines, no Flow.

Run `./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- ALL tests MUST pass.

Commit: `feat(10-01): implement MonitorDataProcessor processing pipeline`
  </action>
  <verify>
`./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- ALL tests pass.
`./gradlew :shared:compileDebugKotlinAndroid` succeeds.
  </verify>
  <done>MonitorDataProcessor.process() implements the full pipeline. All ~30 tests pass. Issue #210 cascade prevention verified by tests. EMA cold start fix verified. Status flag callbacks verified with debouncing.</done>
</task>

<task type="auto">
  <name>Task 3 - REFACTOR: Clean up MonitorDataProcessor</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt</files>
  <action>
Review MonitorDataProcessor.kt for cleanup opportunities. The implementation was extracted mechanically; now apply refactoring:

1. **Extract velocity calculation helpers** if `calculateRawVelocity()` and `updateSmoothedVelocity()` improve readability
2. **Ensure all logging uses Kermit** (`co.touchlab.kermit.Logger`) with appropriate levels (d for routine, w for warnings, i for diagnostics)
3. **Add KDoc** to the class explaining: synchronous processor for BLE monitor packets, callback-based events, Issue #210 invariant, <5ms latency requirement
4. **Add comments** to the critical Issue #210 section explaining WHY tracking updates before validation
5. **Verify no unnecessary allocations** in the process() hot path (no object creation except the return WorkoutMetric)
6. **Verify constants** reference BleConstants.Thresholds (no magic numbers)

Run ALL tests after refactoring to verify nothing broke:
`./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"`

Commit: `refactor(10-01): clean up MonitorDataProcessor`
  </action>
  <verify>
`./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- ALL tests still pass.
`./gradlew :shared:compileDebugKotlinAndroid` succeeds.
  </verify>
  <done>MonitorDataProcessor.kt is clean: well-documented, no magic numbers, no unnecessary allocations, KDoc on class, Issue #210 comments clear.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileDebugKotlinAndroid` succeeds
2. `./gradlew :shared:testDebugUnitTest --tests "*.MonitorDataProcessorTest"` -- all tests pass
3. `./gradlew :shared:testDebugUnitTest` -- all existing tests still pass (no regressions)
4. MonitorDataProcessor.kt exists in `shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/`
5. MonitorDataProcessorTest.kt exists in `shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/`
6. Grep for `class MonitorDataProcessor` returns exactly 1 result in commonMain
7. No changes to BleRepository.kt interface
8. No changes to KableBleRepository.kt (that's Plan 02)
</verification>

<success_criteria>
- MonitorDataProcessor has process(), resetForNewSession(), getPollRateStats(), and RomViolationType enum
- process() implements full pipeline: position clamping -> status flags -> Issue #210 tracking -> validation -> velocity -> EMA -> WorkoutMetric
- ~30 unit tests pass covering all pipeline stages
- Issue #210 cascade prevention verified by specific test
- Velocity EMA cold start seeding verified by specific test
- Deload debounce timing verified by specific test
- No coroutines or suspend functions in MonitorDataProcessor
</success_criteria>

<output>
After completion, create `.planning/phases/10-monitor-data-processor/10-01-SUMMARY.md`
</output>

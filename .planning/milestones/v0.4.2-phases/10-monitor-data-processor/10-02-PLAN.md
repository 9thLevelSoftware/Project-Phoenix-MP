---
phase: 10-monitor-data-processor
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: true
must_haves:
  truths:
    - "KableBleRepository.parseMonitorData() delegates to monitorProcessor.process() and emits the returned metric"
    - "KableBleRepository no longer contains position clamping, jump validation, velocity EMA, or status flag processing inline"
    - "All 15 monitor processing state variables removed from KableBleRepository"
    - "startMonitorPolling() calls monitorProcessor.resetForNewSession() instead of resetting individual fields"
    - "Deload and ROM violation events wired through monitorProcessor callbacks to existing SharedFlow emissions"
    - "BleRepository interface unchanged"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt"
      provides: "Delegated monitor processing via monitorProcessor property"
      contains: "monitorProcessor"
  key_links:
    - from: "KableBleRepository.kt"
      to: "MonitorDataProcessor.kt"
      via: "private val monitorProcessor = MonitorDataProcessor(...)"
      pattern: "monitorProcessor\\.process\\("
    - from: "KableBleRepository.kt"
      to: "MonitorDataProcessor.kt"
      via: "Callback wiring for deload and ROM events"
      pattern: "onDeloadOccurred|onRomViolation"
---

<objective>
Wire KableBleRepository to delegate all monitor data processing (position validation, velocity EMA, status flags) to MonitorDataProcessor, removing ~200 lines of inline processing logic and 15 state variables.

Purpose: Complete the Phase 10 extraction by connecting the tested MonitorDataProcessor to the repository, following the established delegation pattern from Phases 7-9 (bleQueue, discoMode, handleDetector).

Output: KableBleRepository with monitorProcessor property and delegated parseMonitorData, all inline processing removed.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-monitor-data-processor/10-RESEARCH.md
@.planning/phases/10-monitor-data-processor/10-01-SUMMARY.md

# Source file to modify:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt

# Module being delegated to:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt

# Pattern reference (Phase 9 delegation):
@.planning/phases/09-handle-state-detector/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire KableBleRepository delegation to MonitorDataProcessor</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt</files>
  <action>
Modify KableBleRepository.kt to delegate monitor data processing to MonitorDataProcessor, following the Phase 9 (handleDetector) delegation pattern exactly.

**Step 1: Add monitorProcessor property** (near other extracted module properties -- bleQueue, discoMode, handleDetector):
```kotlin
private val monitorProcessor = MonitorDataProcessor(
    onDeloadOccurred = { scope.launch { _deloadOccurredEvents.emit(Unit) } },
    onRomViolation = { type ->
        scope.launch {
            when (type) {
                MonitorDataProcessor.RomViolationType.OUTSIDE_HIGH ->
                    _romViolationEvents.emit(RomViolationType.OUTSIDE_HIGH)
                MonitorDataProcessor.RomViolationType.OUTSIDE_LOW ->
                    _romViolationEvents.emit(RomViolationType.OUTSIDE_LOW)
            }
        }
    }
)
```

Note: KableBleRepository has its own `RomViolationType` enum at line 126 used by `_romViolationEvents`. The processor has its own enum. Map between them in the callback. If they are identical, consider whether to keep both or use the processor's. The simplest approach: keep both, map in callback (matching research recommendation).

**Step 2: Replace parseMonitorData body** (lines 1678-1833):
Replace the entire function body with delegation:
```kotlin
private fun parseMonitorData(data: ByteArray) {
    val packet = parseMonitorPacket(data)
    if (packet == null) {
        log.w { "Monitor data too short: ${data.size} bytes" }
        return
    }

    try {
        val metric = monitorProcessor.process(packet) ?: return

        // Periodic logging (using processor's notification count)
        if (monitorProcessor.notificationCount % 100 == 0L) {
            log.i { "MONITOR NOTIFICATION #${monitorProcessor.notificationCount}" }
        }

        // Emit metric to flow
        val emitted = _metricsFlow.tryEmit(metric)
        if (!emitted && monitorProcessor.notificationCount % 100 == 0L) {
            log.w { "Failed to emit metric - buffer full? Count: ${monitorProcessor.notificationCount}" }
        }

        // Handle detection delegated to HandleStateDetector
        handleDetector.processMetric(metric)
    } catch (e: Exception) {
        log.e { "Error parsing monitor data: ${e.message}" }
    }
}
```

**Step 3: Remove processStatusFlags()** (lines 1839-1875) -- entirely moved to processor.

**Step 4: Remove validateSample()** (lines 1885-1915) -- entirely moved to processor.

**Step 5: Replace reset logic in startMonitorPolling()** (lines 1142-1160):
Replace the individual field resets with:
```kotlin
monitorProcessor.resetForNewSession()
```
Keep only the log message about previous notification count (read from `monitorProcessor.notificationCount` before reset).

**Step 6: Remove 15 state variables** from class body (lines 173-235):
Remove these fields entirely (they now live in MonitorDataProcessor):
- `lastGoodPosA`, `lastGoodPosB` (lines 174-175)
- `lastPositionA`, `lastPositionB`, `lastTimestamp` (lines 178-180)
- `smoothedVelocityA`, `smoothedVelocityB` (lines 184-185)
- `isFirstVelocitySample` (line 188)
- `lastSampleWasFiltered` (line 193)
- `lastDeloadEventTime` (line 214)
- `pollIntervalSum`, `pollIntervalCount`, `maxPollInterval`, `minPollInterval` (lines 217-220)
- `monitorNotificationCount` (line 223)
- `strictValidationEnabled` (line 235)

Keep the comments for variables that stay (monitorPollingJob, bleQueue, etc.).

**Step 7: Update any remaining references:**
- If `stopPolling()` or other methods reference `monitorNotificationCount` for logging, use `monitorProcessor.notificationCount`
- If any method references `strictValidationEnabled`, use `monitorProcessor.strictValidationEnabled`
- Search for ALL removed variable names to ensure no dangling references

**Step 8: Consider RomViolationType enum:**
The processor defines its own `RomViolationType`. KableBleRepository's `RomViolationType` (line 126) is used by `_romViolationEvents` and may be referenced by the BleRepository interface or other callers. Keep KableBleRepository's enum for API stability and map in the callback. Do NOT change the BleRepository interface.

Run full compilation and ALL tests:
```
./gradlew :shared:compileDebugKotlinAndroid
./gradlew :shared:testDebugUnitTest
./gradlew :androidApp:assembleDebug
```

Commit: `refactor(10-02): delegate monitor data processing from KableBleRepository to MonitorDataProcessor`
  </action>
  <verify>
1. `./gradlew :shared:compileDebugKotlinAndroid` succeeds
2. `./gradlew :shared:testDebugUnitTest` -- ALL tests pass (MonitorDataProcessorTest + HandleStateDetectorTest + any others)
3. `./gradlew :androidApp:assembleDebug` succeeds
4. Grep `monitorProcessor` in KableBleRepository.kt -- found (property + delegation sites)
5. Grep `processStatusFlags` in KableBleRepository.kt -- NOT found (moved to processor)
6. Grep `validateSample` in KableBleRepository.kt -- NOT found (moved to processor)
7. Grep `smoothedVelocityA` in KableBleRepository.kt -- NOT found (moved to processor)
8. Grep `lastGoodPosA` in KableBleRepository.kt -- NOT found (moved to processor)
9. KableBleRepository.kt line count decreased by ~200 lines
  </verify>
  <done>
KableBleRepository delegates all monitor data processing to monitorProcessor. 15 state variables removed. processStatusFlags() and validateSample() removed. startMonitorPolling() uses resetForNewSession(). BleRepository interface unchanged. All tests pass. Net reduction ~200 lines.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileDebugKotlinAndroid` succeeds
2. `./gradlew :shared:testDebugUnitTest` -- ALL tests pass
3. `./gradlew :androidApp:assembleDebug` succeeds
4. BleRepository.kt interface: UNCHANGED
5. SimulatorBleRepository.kt: UNCHANGED
6. KableBleRepository.kt: monitorProcessor property exists, inline processing removed
7. No processStatusFlags, validateSample, smoothedVelocityA/B, lastGoodPosA/B in KableBleRepository.kt
8. KableBleRepository.kt line count reduced by ~200 lines from 2069
</verification>

<success_criteria>
- KableBleRepository.parseMonitorData() is <20 lines (delegation only)
- All 15 monitor state variables removed from KableBleRepository
- processStatusFlags() and validateSample() removed from KableBleRepository
- startMonitorPolling() reset delegates to monitorProcessor.resetForNewSession()
- Deload/ROM events wired through callbacks to existing SharedFlow emissions
- BleRepository interface completely unchanged
- All existing tests pass (no regressions)
- KableBleRepository line count reduced by ~200 lines
</success_criteria>

<output>
After completion, create `.planning/phases/10-monitor-data-processor/10-02-SUMMARY.md`
</output>

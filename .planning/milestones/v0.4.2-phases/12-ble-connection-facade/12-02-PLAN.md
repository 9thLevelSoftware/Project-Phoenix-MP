---
phase: 12-ble-connection-facade
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: false
must_haves:
  truths:
    - "KableBleRepository is a thin facade that delegates ALL methods to extracted modules"
    - "KableBleRepository is under 400 lines"
    - "All existing tests pass without modification"
    - "BleRepository interface is unchanged"
    - "FakeBleRepository and SimulatorBleRepository compile unchanged"
    - "Connection manager is declared LAST among module properties (init-order safety)"
    - "DiscoMode sendCommand callback routes through connectionManager.sendWorkoutCommand"
    - "Peripheral references in facade methods use connectionManager.currentPeripheral"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt"
      provides: "Thin facade delegating to 6 extracted modules"
      contains: "connectionManager = KableBleConnectionManager"
  key_links:
    - from: "KableBleRepository"
      to: "KableBleConnectionManager"
      via: "connectionManager inline property"
      pattern: "connectionManager\\."
    - from: "KableBleRepository.startScanning"
      to: "KableBleConnectionManager.startScanning"
      via: "override delegation"
      pattern: "override suspend fun startScanning.*connectionManager"
    - from: "KableBleRepository.connect"
      to: "KableBleConnectionManager.connect"
      via: "override delegation"
      pattern: "override suspend fun connect.*connectionManager"
    - from: "KableBleRepository.disconnect"
      to: "KableBleConnectionManager.disconnect"
      via: "override delegation"
      pattern: "override suspend fun disconnect.*connectionManager"
    - from: "KableBleRepository.enableHandleDetection"
      to: "connectionManager.currentPeripheral"
      via: "Peripheral access through manager"
      pattern: "connectionManager\\.currentPeripheral"
---

<objective>
Wire KableBleRepository as a thin facade delegating to all 6 extracted modules, completing the v0.4.2 BLE layer decomposition.

Purpose: Remove all connection lifecycle code from KableBleRepository, wire the connectionManager inline property, update all remaining methods to delegate through the appropriate module. Achieve the <400 line target (FACADE-01).

Output: KableBleRepository reduced from 1384 lines to ~310-350 lines of pure delegation.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-ble-connection-facade/12-RESEARCH.md
@.planning/phases/12-ble-connection-facade/12-01-SUMMARY.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/KableBleConnectionManager.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire facade delegation and remove all moved code from KableBleRepository</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt</files>
  <action>
Transform KableBleRepository into a thin facade by removing all code that was extracted to KableBleConnectionManager in Plan 12-01, then wiring the connectionManager inline property with callback-based event routing.

**Step 1: Remove moved state variables** (lines 172-181, 208-221):
- `peripheral`, `discoveredAdvertisements`, `scanJob` (lines 173-175)
- `connectedDeviceName`, `connectedDeviceAddress` (lines 180-181)
- `detectedFirmwareVersion` (line 208)
- `negotiatedMtu` (line 211)
- `isExplicitDisconnect` (line 216)
- `wasEverConnected` (line 221)

**Step 2: Remove moved characteristic references** (lines 70-79):
- `txCharacteristic`, `rxCharacteristic`, `monitorCharacteristic`, `repsCharacteristic`, `diagnosticCharacteristic`, `heuristicCharacteristic`, `versionCharacteristic`, `modeCharacteristic`, `firmwareRevisionCharacteristic`
- These now live in the ConnectionManager.

**Step 3: Remove all moved methods:**
- `startScanning()` (lines 223-373) — replaced by delegation
- `stopScanning()` (lines 375-387) — replaced by delegation
- `scanAndConnect()` (lines 393-440) — replaced by delegation
- `connect()` (lines 442-627) — replaced by delegation
- `onDeviceReady()` (lines 633-749) — internal to ConnectionManager
- `startObservingNotifications()` (lines 751-841) — internal to ConnectionManager
- `tryReadFirmwareVersion()` (lines 847-867) — internal to ConnectionManager
- `tryReadVitruvianVersion()` (lines 873-885) — internal to ConnectionManager
- `parseDiagnosticData()` (lines 891-901) — moved to ConnectionManager per [11-02] decision
- `disconnect()` (lines 903-917) — replaced by delegation
- `cancelConnection()` (lines 919-929) — replaced by delegation
- `sendWorkoutCommand()` (lines 943-1012) — replaced by delegation
- `cleanupExistingConnection()` (lines 1151-1176) — internal to ConnectionManager
- `processIncomingData()` (lines 1178-1192) — internal to ConnectionManager
- `awaitResponse()` (lines 1202-1224) — moved to ConnectionManager
- `commandResponses` flow and `_commandResponses` SharedFlow (lines 164-170) — moved to ConnectionManager

**Step 4: Add connectionManager inline property** (declared LAST per init-order convention):

```kotlin
// ConnectionManager declared LAST (depends on all above modules)
private val connectionManager = KableBleConnectionManager(
    scope = scope,
    logRepo = logRepo,
    bleQueue = bleQueue,
    pollingEngine = pollingEngine,
    discoMode = discoMode,
    handleDetector = handleDetector,
    onConnectionStateChanged = { state -> _connectionState.value = state },
    onScannedDevicesChanged = { devices -> _scannedDevices.value = devices },
    onReconnectionRequested = { request -> _reconnectionRequested.emit(request) },
    onCommandResponse = { opcode -> /* no external consumer currently */ },
    onRepEventFromCharacteristic = { data -> parseRepsCharacteristicData(data) },
    onRepEventFromRx = { data -> parseRepNotification(data) },
    onMetricFromRx = { data -> parseMetricsPacket(data) },
)
```

**Step 5: Update DiscoMode sendCommand callback:**
Change from `sendCommand = { command -> sendWorkoutCommand(command) }` to `sendCommand = { command -> connectionManager.sendWorkoutCommand(command) }`.

IMPORTANT: Kotlin lambdas capture `this`, and the lambda body accesses `this.connectionManager` at INVOCATION time (not capture time). Since DiscoMode only invokes sendCommand after connection (never during init), the manager is guaranteed to be initialized by then. This is safe per Pitfall #5 analysis in the research.

**Step 6: Wire override delegations** — each method becomes a 1-line delegation:

```kotlin
override suspend fun startScanning() = connectionManager.startScanning()
override suspend fun stopScanning() = connectionManager.stopScanning()
override suspend fun scanAndConnect(timeoutMs: Long) = connectionManager.scanAndConnect(timeoutMs)
override suspend fun connect(device: ScannedDevice) = connectionManager.connect(device)
override suspend fun disconnect() = connectionManager.disconnect()
override suspend fun cancelConnection() = connectionManager.cancelConnection()
override suspend fun sendWorkoutCommand(command: ByteArray) = connectionManager.sendWorkoutCommand(command)
override suspend fun setColorScheme(schemeIndex: Int): Result<Unit> {
    val command = BlePacketFactory.createColorSchemeCommand(schemeIndex)
    return connectionManager.sendWorkoutCommand(command)
}
```

**Step 7: Update methods that access `peripheral`** — replace with `connectionManager.currentPeripheral`:

- `enableHandleDetection(enabled: Boolean)` (line 1095-1106): Change `val p = peripheral` to `val p = connectionManager.currentPeripheral`.
- `restartMonitorPolling()` (lines 1112-1120): Change `val p = peripheral ?: run {` to `val p = connectionManager.currentPeripheral ?: run {`.
- `startActiveWorkoutPolling()` (lines 1122-1130): Same pattern.
- `restartDiagnosticPolling()` (lines 1136-1142): Same pattern.
- `startDiscoMode()` (lines 1373-1379): Change `if (peripheral == null)` to `if (connectionManager.currentPeripheral == null)`.

**Step 8: Update onConnectionLost callback in pollingEngine:**
Change `onConnectionLost = { disconnect() }` to `onConnectionLost = { connectionManager.disconnect() }`.

**Step 9: Clean up imports:**
Remove unused imports that were only needed by moved code (Kable Scanner, Advertisement, Peripheral, State, WriteType, etc. — unless still needed by remaining code). Add import for KableBleConnectionManager.

**Step 10: Remove stale comments** about moved code:
- "// Kable objects" comment block
- "// Connected device info (for logging)" comment
- "// Monitor data processing state" comment
- "// Polling state moved to MetricPollingEngine" already exists, keep it
- "// Handle detection delegated to HandleStateDetector (all 15 state variables removed)"
- Any `// parseMonitorData() moved to...` type comments

**Final facade structure** (target ~310-350 lines):
```
Package + imports                          ~30 lines
Class declaration + log/logRepo/scope      ~5 lines
State flow declarations (10 flows)         ~60 lines
Module properties (6 modules)              ~50 lines
Override delegations (scan/connect/etc.)    ~30 lines
Override delegations (workout commands)     ~40 lines
Override delegations (polling/handle)       ~30 lines
Parsing methods (stay in facade)           ~110 lines
Disco mode delegation                      ~10 lines
                                    Total: ~365 lines
```

**CRITICAL: Do not modify BleRepository.kt, FakeBleRepository.kt, or SimulatorBleRepository.kt.** These must remain unchanged for FACADE-02 compliance.
  </action>
  <verify>
1. Line count: `wc -l shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` — must be < 400.
2. Compilation: `./gradlew :shared:compileKotlinMetadata 2>&1 | tail -30` — no errors.
3. All tests: `./gradlew :androidApp:testDebugUnitTest 2>&1 | tail -20` — all pass.
4. Interface unchanged: `git diff shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt` — no changes.
5. Grep for stale peripheral references: `grep -n "private var peripheral" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` — should return nothing.
6. Grep for complete 6-module delegation: `grep -c "connectionManager\.\|pollingEngine\.\|discoMode\.\|handleDetector\.\|monitorProcessor\.\|bleQueue\." shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` — should show delegation references.
  </verify>
  <done>
KableBleRepository is a thin facade under 400 lines. All connection lifecycle code delegates to connectionManager. All 6 extracted modules (bleQueue, discoMode, handleDetector, monitorProcessor, pollingEngine, connectionManager) are wired as inline properties. All existing tests pass without modification. BleRepository interface is unchanged.
  </done>
</task>

<task type="checkpoint:manual-verify">
  <name>Task 2: Manual BLE testing on physical Vitruvian device</name>
  <what-built>
Complete v0.4.2 BLE layer decomposition. KableBleRepository has been transformed from a 2,886-line monolith into a ~350-line facade delegating to 6 focused modules:
1. BleConstants (Phase 5) — protocol constants
2. ProtocolParser (Phase 6) — byte parsing
3. BleOperationQueue (Phase 7) — BLE serialization
4. DiscoMode (Phase 8) — LED easter egg
5. HandleStateDetector (Phase 9) — handle state machine
6. MonitorDataProcessor (Phase 10) — position/velocity processing
7. MetricPollingEngine (Phase 11) — polling loops
8. KableBleConnectionManager (Phase 12) — connection lifecycle
  </what-built>
  <how-to-verify>
Install on Android device: `./gradlew :androidApp:installDebug`

Test the following scenarios with a physical Vitruvian trainer:

1. **Scan + Connect:** Open app, tap scan. Verify device appears. Tap to connect. Verify connection succeeds (green status indicator).

2. **Workout start:** Start a simple workout (e.g., Infinite mode at 20kg). Verify:
   - Weight is set correctly on machine
   - Position metrics update in real-time
   - Rep counter increments on each rep

3. **Workout stop:** Stop the workout. Verify machine releases tension.

4. **Auto-reconnect:** While connected (not in workout), power-cycle the Vitruvian or move out of BLE range briefly. Verify:
   - App detects disconnection
   - Auto-reconnect is attempted
   - Connection re-establishes

5. **Explicit disconnect:** Tap disconnect button. Verify:
   - Connection drops cleanly
   - NO auto-reconnect attempt

6. **Disco mode (Easter egg):** While connected (not in workout), trigger disco mode. Verify LEDs cycle.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found during testing</resume-signal>
</task>

</tasks>

<verification>
1. KableBleRepository.kt is < 400 lines
2. KableBleRepository delegates ALL BleRepository methods to extracted modules
3. connectionManager is declared LAST among module properties
4. No `private var peripheral` in KableBleRepository (exclusive to ConnectionManager)
5. DiscoMode sendCommand routes through connectionManager.sendWorkoutCommand
6. BleRepository.kt has zero git diff
7. FakeBleRepository.kt and SimulatorBleRepository.kt have zero git diff
8. All existing tests pass (`./gradlew :androidApp:testDebugUnitTest`)
9. `wc -l KableBleRepository.kt` < 400
10. Manual BLE test passes all 6 scenarios
</verification>

<success_criteria>
- KableBleRepository < 400 lines (FACADE-01)
- All existing tests pass without modification (FACADE-02)
- Manual BLE testing passes all connection scenarios (FACADE-03)
- Complete 6-module delegation: bleQueue, discoMode, handleDetector, monitorProcessor, pollingEngine, connectionManager
- v0.4.2 BLE Layer Decomposition milestone is COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/12-ble-connection-facade/12-02-SUMMARY.md`
</output>

---
phase: 09-handle-state-detector
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: true

must_haves:
  truths:
    - "KableBleRepository delegates all handle state logic to HandleStateDetector"
    - "All 15 handle-related state variables removed from KableBleRepository"
    - "analyzeHandleState() function removed from KableBleRepository"
    - "BleRepository interface unchanged (HandleState enum stays in BleRepository.kt)"
    - "SimulatorBleRepository unchanged (has its own simplified logic)"
    - "All existing tests still pass"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt"
      provides: "Delegation to HandleStateDetector for all handle operations"
      contains: "handleDetector"
  key_links:
    - from: "KableBleRepository.kt"
      to: "HandleStateDetector.kt"
      via: "private val handleDetector = HandleStateDetector()"
      pattern: "HandleStateDetector\\("
    - from: "KableBleRepository.handleDetection"
      to: "HandleStateDetector.handleDetection"
      via: "override val handleDetection = handleDetector.handleDetection"
      pattern: "handleDetector\\.handleDetection"
    - from: "KableBleRepository.handleState"
      to: "HandleStateDetector.handleState"
      via: "override val handleState = handleDetector.handleState"
      pattern: "handleDetector\\.handleState"
---

<objective>
Wire KableBleRepository to delegate all handle detection to HandleStateDetector, removing ~200 lines of inline handle state logic from the monolith.

Purpose: Complete the extraction by replacing KableBleRepository's inline state machine, state variables, and control methods with delegation calls to the tested HandleStateDetector module from Plan 01.

Output: KableBleRepository reduced by ~200 lines with handle detection fully delegated.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-handle-state-detector/09-RESEARCH.md
@.planning/phases/09-handle-state-detector/09-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire KableBleRepository delegation to HandleStateDetector</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt</files>
  <action>
    Replace all inline handle state logic in KableBleRepository with delegation to HandleStateDetector. Follow the research extraction checklist precisely.

    **1. Add HandleStateDetector property (near other module properties like bleQueue, discoMode):**
    ```kotlin
    private val handleDetector = HandleStateDetector()
    ```

    **2. Replace StateFlow declarations (lines ~92-93, ~112-114):**
    Remove:
    - `private val _handleDetection = MutableStateFlow(HandleDetection())`
    - `override val handleDetection: StateFlow<HandleDetection> = _handleDetection.asStateFlow()`
    - `private val _handleState = MutableStateFlow(HandleState.WaitingForRest)`
    - `override val handleState: StateFlow<HandleState> = _handleState.asStateFlow()`

    Replace with:
    ```kotlin
    override val handleDetection: StateFlow<HandleDetection> = handleDetector.handleDetection
    override val handleState: StateFlow<HandleState> = handleDetector.handleState
    ```

    **3. Remove all 15 handle state variables (lines ~166-221):**
    Remove: handleDetectionEnabled, isAutoStartMode, minPositionSeen, maxPositionSeen, forceAboveGrabThresholdStart, forceBelowReleaseThresholdStart, pendingGrabbedStartTime, pendingReleasedStartTime, activeHandlesMask, waitingForRestStartTime, restBaselinePosA, restBaselinePosB, handleStateLogCounter.

    **4. Update enableHandleDetection() (lines ~1487-1527):**
    Replace inline state initialization with:
    ```kotlin
    override fun enableHandleDetection(enabled: Boolean) {
        log.i { "Handle detection ${if (enabled) "ENABLED" else "DISABLED"}" }
        if (enabled) {
            handleDetector.enable(autoStart = true)
            val p = peripheral
            if (p != null) {
                startMonitorPolling(p, forAutoStart = true)
            }
        } else {
            handleDetector.disable()
        }
    }
    ```

    **5. Update resetHandleState() (lines ~1528-1553):**
    Replace with: `override fun resetHandleState() = handleDetector.reset()`

    **6. Update enableJustLiftWaitingMode() (lines ~1554-1567):**
    Replace with: `override fun enableJustLiftWaitingMode() = handleDetector.enableJustLiftWaiting()`

    **7. Update startMonitorPolling() handle initialization (lines ~1193-1210):**
    Replace direct state manipulation with delegation to HandleStateDetector. The `forAutoStart` parameter maps to `handleDetector.enable(autoStart = true)`. Position range resets delegate to HandleStateDetector's internal state.

    **8. Replace inline analyzeHandleState calls in parseMonitorData/parseRxMetrics:**
    Where KableBleRepository currently calls `analyzeHandleState(metric)` and updates `_handleState.value`, replace with `handleDetector.processMetric(metric)`. The detector handles both simple HandleDetection updates and 4-state machine internally.

    Similarly, where inline HandleDetection updates happen (checking positionA/B > threshold and updating `_handleDetection.value`), remove those -- they are now handled inside `processMetric()`.

    **9. Remove analyzeHandleState() function (lines ~2044-2233):**
    Delete the entire `analyzeHandleState()` private function.

    **10. Remove Double.format() helper (line ~2235):**
    Delete the `private fun Double.format(decimals: Int)` extension -- it now lives in HandleStateDetector.

    **11. Update minPositionSeen/maxPositionSeen references:**
    Any diagnostic logging that reads these values should now read from `handleDetector.minPositionSeen` / `handleDetector.maxPositionSeen`. Search for all references and update.

    **12. Update handleDetectionEnabled references:**
    Any checks like `if (handleDetectionEnabled)` should become `if (handleDetector.isEnabled)`.

    **13. Do NOT modify:**
    - BleRepository.kt (interface stays the same)
    - SimulatorBleRepository.kt (has its own simplified logic per research)
    - FakeBleRepository.kt (test fake, not affected)
    - Any presentation layer files

    **Import cleanup:** Remove unused MutableStateFlow/asStateFlow imports if no longer needed. Add `import com.devil.phoenixproject.data.ble.HandleStateDetector`.
  </action>
  <verify>
    1. `./gradlew :shared:compileKotlinAndroid` succeeds
    2. `grep -c "analyzeHandleState" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` returns 0
    3. `grep -c "handleDetector" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` returns 5+ (property + delegation sites)
    4. `grep -c "handleDetectionEnabled" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` returns 0
    5. `grep -c "pendingGrabbedStartTime\|pendingReleasedStartTime\|waitingForRestStartTime\|restBaselinePosA\|restBaselinePosB" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt` returns 0
    6. `./gradlew :shared:testDebugUnitTest` passes (all existing tests + HandleStateDetector tests)
    7. `./gradlew :androidApp:assembleDebug` succeeds
  </verify>
  <done>
    KableBleRepository delegates all handle detection to HandleStateDetector. The analyzeHandleState() function, all 15 handle state variables, the Double.format() helper, and inline HandleDetection updates are removed from KableBleRepository. All builds compile and all tests pass. BleRepository interface, SimulatorBleRepository, and FakeBleRepository are unchanged.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinAndroid` succeeds
2. `./gradlew :shared:testDebugUnitTest` passes (all tests including HandleStateDetectorTest)
3. `./gradlew :androidApp:assembleDebug` succeeds
4. No `analyzeHandleState` references remain in KableBleRepository.kt
5. No handle state variables remain in KableBleRepository.kt
6. `handleDetector` is the single delegation point for all handle operations
7. BleRepository.kt has zero changes from this plan
8. SimulatorBleRepository.kt has zero changes from this plan
</verification>

<success_criteria>
- KableBleRepository reduced by ~200 lines (analyzeHandleState + state variables + control method bodies)
- All handle detection delegated through single `handleDetector` property
- Zero handle state variables remain in KableBleRepository
- All existing unit tests pass unchanged
- Android build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-handle-state-detector/09-02-SUMMARY.md`
</output>

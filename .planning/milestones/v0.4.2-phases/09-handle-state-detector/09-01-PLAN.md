---
phase: 09-handle-state-detector
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt
autonomous: true

must_haves:
  truths:
    - "HandleStateDetector processes WorkoutMetric and produces correct HandleState transitions through all 4 states"
    - "Hysteresis dwell timers prevent false grab/release transitions (200ms sustained)"
    - "WaitingForRest timeout arms handles after 3 seconds even when cables never reach rest (overhead pulley)"
    - "Baseline-relative grab/release detection works for overhead pulley setups (Issue #176)"
    - "Auto-start mode uses lower velocity threshold (20 vs 50 mm/s) for grab detection (Issue #96)"
    - "Simple HandleDetection (left/right booleans) updates alongside 4-state machine"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt"
      provides: "4-state handle detection state machine with injectable time"
      contains: "class HandleStateDetector"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt"
      provides: "Comprehensive state transition tests with deterministic time"
      contains: "class HandleStateDetectorTest"
  key_links:
    - from: "HandleStateDetector.kt"
      to: "BleConstants.Thresholds"
      via: "threshold constants for grab/release/rest/velocity"
      pattern: "BleConstants\\.Thresholds\\."
    - from: "HandleStateDetector.kt"
      to: "BleConstants.Timing"
      via: "timing constants for dwell and timeout"
      pattern: "BleConstants\\.Timing\\."
    - from: "HandleStateDetector.kt"
      to: "HandleState enum in BleRepository.kt"
      via: "imports and produces HandleState values"
      pattern: "import.*HandleState"
    - from: "HandleStateDetectorTest.kt"
      to: "HandleStateDetector.kt"
      via: "tests all state transitions with fake time"
      pattern: "HandleStateDetector\\(timeProvider"
---

<objective>
Create HandleStateDetector with TDD: the 4-state handle detection state machine extracted from KableBleRepository as a standalone, testable module.

Purpose: The handle state machine is the brain of "Just Lift" auto-start/auto-stop mode. Extracting it enables comprehensive unit testing of all state transitions, hysteresis timing, and baseline tracking -- logic that is currently untestable inside the 2800+ line monolith.

Output: HandleStateDetector.kt (production) + HandleStateDetectorTest.kt (25+ tests covering all states, hysteresis, baseline tracking, single-handle, auto-start mode)
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-handle-state-detector/09-RESEARCH.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt (lines 92-93, 112-114, 166-221, 1487-1567, 2044-2239)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt (HandleState enum, HandleDetection class)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt (Thresholds, Timing objects)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt (WorkoutMetric class)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/DiscoMode.kt (Phase 8 extraction pattern reference)
</context>

<feature>
  <name>HandleStateDetector: 4-State Handle Detection Machine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt
  </files>
  <behavior>
    HandleStateDetector is a pure state machine that processes WorkoutMetric objects and produces HandleState transitions.

    **Constructor:** `HandleStateDetector(timeProvider: () -> Long)` with default `Clock.System.now().toEpochMilliseconds()`.

    **Core method:** `processMetric(metric: WorkoutMetric)` -- called on every metric callback.
    - If `!isEnabled`, no-op (return immediately).
    - Updates simple HandleDetection (left/right booleans: positionA/B > 50.0f threshold).
    - Runs 4-state machine via internal `analyzeHandleState(metric)`.
    - Emits state changes to `handleState: StateFlow<HandleState>`.

    **State Machine (WaitingForRest -> Released -> Grabbed -> Moving):**

    WaitingForRest:
      - Both handles < HANDLE_REST_THRESHOLD (5mm) -> capture baseline -> Released
      - Timeout > WAITING_FOR_REST_TIMEOUT_MS (3s):
        - If handles above HANDLE_GRABBED_THRESHOLD (8mm) -> virtual baseline (0.0) -> Released
        - Otherwise -> real baseline (current pos) -> Released
      - Otherwise -> stay WaitingForRest

    Released:
      - Handle(s) above HANDLE_GRABBED_THRESHOLD (baseline-relative) AND velocity above threshold AND dwell >= STATE_TRANSITION_DWELL_MS (200ms) -> Grabbed
      - Handle(s) above threshold but no velocity -> Moving (passive displacement)
      - Handles still at rest -> stay Released

    Grabbed:
      - Handle(s) return to rest (baseline-relative) AND dwell >= STATE_TRANSITION_DWELL_MS (200ms) -> Released
      - Still grabbed -> stay Grabbed

    Moving:
      - Velocity threshold met with 200ms dwell -> Grabbed
      - Handles return to rest -> Released
      - Otherwise -> stay Moving

    **Velocity threshold selection:**
    - Auto-start mode (isAutoStartMode=true): AUTO_START_VELOCITY_THRESHOLD (20 mm/s)
    - Normal mode: VELOCITY_THRESHOLD (50 mm/s)

    **Control methods:**
    - `enable(autoStart: Boolean)` -- sets isEnabled=true, isAutoStartMode, resets to WaitingForRest, clears all timers/baselines
    - `disable()` -- sets isEnabled=false, resets everything
    - `reset()` -- returns to WaitingForRest, clears all timers/baselines, preserves enabled state
    - `enableJustLiftWaiting()` -- resets state and sets autoStart=true

    **Exposed state:**
    - `handleState: StateFlow<HandleState>` (4-state)
    - `handleDetection: StateFlow<HandleDetection>` (simple left/right booleans)
    - `isEnabled: Boolean` (read-only)
    - `isAutoStartMode: Boolean` (read-only)
    - `minPositionSeen: Double` / `maxPositionSeen: Double` (diagnostics)

    **Internal state (all 15 variables from research inventory):**
    - pendingGrabbedStartTime, pendingReleasedStartTime (hysteresis)
    - activeHandlesMask (single-cable detection)
    - waitingForRestStartTime (timeout)
    - restBaselinePosA, restBaselinePosB (Issue #176)
    - minPositionSeen, maxPositionSeen (diagnostics)
    - logCounter (periodic logging)
    - forceAboveGrabThresholdStart, forceBelowReleaseThresholdStart (legacy, reset but unused)

    **Test cases (input -> expected output):**
    - processMetric(pos=2,2; vel=0,0) when WaitingForRest -> Released (rest detected)
    - processMetric(pos=20,20; vel=100,100) when Released, after 200ms dwell -> Grabbed
    - processMetric(pos=20,20; vel=100,100) when Released, at 199ms -> still Released (dwell not met)
    - processMetric(pos=2,2; vel=0,0) when Grabbed, after 200ms dwell -> Released
    - processMetric(pos=20,20; vel=0,0) when Released -> Moving (no velocity)
    - processMetric when disabled -> no state change
    - 3s timeout in WaitingForRest with grabbed handles -> virtual baseline (0.0) -> Released
    - 3s timeout in WaitingForRest with elevated rest -> real baseline -> Released
    - Auto-start mode: vel=25 triggers grab (above 20 threshold), not in normal mode (below 50 threshold)
  </behavior>
</feature>

<tasks>

<task type="tdd">
  <name>Task 1 - RED: Write failing tests for HandleStateDetector</name>
  <files>shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt</files>
  <behavior>
    HandleStateDetector processes WorkoutMetric objects and produces HandleState transitions through 4 states (WaitingForRest -> Released -> Grabbed -> Moving). Tests must cover:
    - All state transitions (rest detection, grab with dwell, release with dwell, passive displacement)
    - Hysteresis: 200ms dwell required for grab/release; transitions at 199ms must NOT fire
    - WaitingForRest timeout: 3s with grabbed handles -> virtual baseline (0.0); elevated rest -> real baseline
    - Baseline-relative grab/release detection (Issue #176)
    - Auto-start mode: 20 mm/s velocity threshold vs normal 50 mm/s (Issue #96)
    - Single-handle detection (only one cable pulled)
    - Control methods: enable/disable/reset/enableJustLiftWaiting
    - Disabled state: processMetric produces no state changes
    - Edge cases per research Test Strategy section
  </behavior>
  <action>
    Create HandleStateDetectorTest.kt at `shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt`.

    Use injectable `fakeTime` variable (var fakeTime = 0L) passed as `timeProvider = { fakeTime }`.

    Create a `metric()` helper function that builds WorkoutMetric with sensible defaults (all zeros except specified params). Note: WorkoutMetric requires `loadA: Float, loadB: Float, positionA: Float, positionB: Float` at minimum; other fields have defaults.

    Write ALL tests listed in the research Test Strategy section (25+ tests covering state transitions, hysteresis, single-handle, baseline tracking, auto-start mode, control methods, edge cases). Each test should call `detector.enable(autoStart = true)` to arm the detector, then feed metrics and assert state.

    Tests MUST fail at this point (HandleStateDetector class does not exist yet).

    Commit: `test(09-01): add failing tests for HandleStateDetector state machine`
  </action>
  <verify>
    1. HandleStateDetectorTest.kt exists at shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/
    2. Test file contains 25+ test functions covering all behavior cases listed above
    3. `./gradlew :shared:testDebugUnitTest --tests "*.HandleStateDetectorTest"` FAILS (HandleStateDetector class does not exist yet)
  </verify>
  <done>HandleStateDetectorTest.kt contains 25+ failing tests covering all 4 state transitions, hysteresis dwell timing, WaitingForRest timeout, baseline-relative detection, auto-start velocity threshold, single-handle detection, control methods, and disabled-state edge cases. All tests fail because HandleStateDetector.kt does not exist.</done>
</task>

<task type="tdd">
  <name>Task 2 - GREEN: Implement HandleStateDetector to pass all tests</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt</files>
  <behavior>
    HandleStateDetector is a standalone class with:
    - Constructor: `HandleStateDetector(timeProvider: () -> Long)` defaulting to `Clock.System.now().toEpochMilliseconds()`
    - Core method: `processMetric(metric: WorkoutMetric)` runs 4-state machine and updates simple HandleDetection
    - 4-state machine: WaitingForRest -> Released -> Grabbed -> Moving with threshold/velocity/dwell logic
    - Control methods: enable(autoStart), disable(), reset(), enableJustLiftWaiting()
    - Exposed state: handleState (StateFlow), handleDetection (StateFlow), isEnabled, isAutoStartMode, minPositionSeen, maxPositionSeen
    - All 15 internal state variables from research inventory
    - Velocity threshold: 20 mm/s (auto-start) vs 50 mm/s (normal)
    - Hysteresis: 200ms sustained dwell for grab/release transitions
  </behavior>
  <action>
    Create HandleStateDetector.kt at `shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt`.

    Copy the `analyzeHandleState()` function VERBATIM from KableBleRepository.kt (lines 2065-2233). Adapt it:
    - Change `private fun analyzeHandleState(metric: WorkoutMetric): HandleState` to be a private method of HandleStateDetector
    - Replace `currentTimeMillis()` calls with `timeProvider()` calls
    - Replace `_handleState.value` reads with internal state tracking
    - All threshold references should use `BleConstants.Thresholds.*` and `BleConstants.Timing.*` (already done in current code)

    Move the `Double.format(decimals: Int)` extension from KableBleRepository (line 2235) as a private extension inside HandleStateDetector.

    Implement `processMetric()`, `enable()`, `disable()`, `reset()`, `enableJustLiftWaiting()` methods.

    Include ALL 15 state variables from the research inventory.

    Use `Logger.withTag("HandleStateDetector")` for Kermit logging (same pattern as DiscoMode).

    Run all tests -- they MUST pass.

    Commit: `feat(09-01): implement HandleStateDetector 4-state machine`
  </action>
  <verify>
    1. HandleStateDetector.kt exists at shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/
    2. `./gradlew :shared:compileKotlinAndroid` succeeds
    3. `./gradlew :shared:testDebugUnitTest --tests "*.HandleStateDetectorTest"` passes (all 25+ tests green)
    4. `grep -r "class HandleStateDetector" shared/src/commonMain/` returns exactly 1 match
  </verify>
  <done>HandleStateDetector.kt implements the complete 4-state machine with injectable timeProvider, all 15 state variables, processMetric/enable/disable/reset/enableJustLiftWaiting methods, and all 25+ tests from Task 1 pass.</done>
</task>

<task type="tdd">
  <name>Task 3 - REFACTOR: Clean up HandleStateDetector without breaking tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt
  </files>
  <behavior>
    After GREEN, review HandleStateDetector for cleanup opportunities. Code copied verbatim from the monolith may have naming inconsistencies, redundant comments, or extractable helper methods now that it lives in its own class. Tests must remain green after any changes.
  </behavior>
  <action>
    Review HandleStateDetector.kt for:
    - Extract constants if any magic numbers remain (should already use BleConstants)
    - Improve naming for clarity in standalone context (no longer buried in 2800-line file)
    - Reduce duplication in state transition logic if safe to do so
    - Clean up any dead code carried over from the monolith (e.g., forceAboveGrabThresholdStart/forceBelowReleaseThresholdStart noted as "legacy, reset but unused")

    Run tests after every change -- MUST still pass.

    If changes made, commit: `refactor(09-01): clean up HandleStateDetector`
    If no meaningful cleanup found, skip commit (this task is conditional).
  </action>
  <verify>
    1. `./gradlew :shared:testDebugUnitTest --tests "*.HandleStateDetectorTest"` passes (all tests still green)
    2. `./gradlew :shared:compileKotlinAndroid` succeeds
    3. No imports of HandleState, HandleDetection, or WorkoutMetric are broken
  </verify>
  <done>HandleStateDetector code reviewed and cleaned up (or confirmed clean). All 25+ tests still pass. No regressions introduced.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinAndroid` succeeds (HandleStateDetector compiles)
2. `./gradlew :shared:testDebugUnitTest --tests "*.HandleStateDetectorTest"` passes (all 25+ tests green)
3. HandleStateDetector.kt exists in data/ble/ package
4. HandleStateDetectorTest.kt exists in data/ble/ test package
5. No imports of HandleState, HandleDetection, or WorkoutMetric are broken
6. `grep -r "class HandleStateDetector" shared/src/commonMain/` returns exactly 1 match
</verification>

<success_criteria>
- HandleStateDetector is a standalone class in data/ble/ with injectable timeProvider
- All 4 states (WaitingForRest, Released, Grabbed, Moving) have tested transitions
- Hysteresis (200ms dwell) tested for both grab and release
- WaitingForRest timeout (3s) tested with virtual and real baseline cases
- Issue #176 baseline-relative detection tested
- Issue #96 auto-start velocity threshold tested
- Single-handle detection tested
- 25+ unit tests all passing
</success_criteria>

<output>
After completion, create `.planning/phases/09-handle-state-detector/09-01-SUMMARY.md`
</output>

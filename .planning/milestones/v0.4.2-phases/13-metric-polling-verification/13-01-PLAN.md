---
phase: 13-metric-polling-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/13-metric-polling-verification/13-VERIFICATION.md
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "POLL-01 verified: MetricPollingEngine manages all 4 polling loops (monitor, diagnostic, heuristic, heartbeat)"
    - "POLL-02 verified: stopMonitorOnly preserves diagnostic and heartbeat polling (Issue #222)"
    - "POLL-03 verified: Timeout disconnect after MAX_CONSECUTIVE_TIMEOUTS works correctly"
    - "All 18 MetricPollingEngineTest tests pass on current codebase"
  artifacts:
    - path: ".planning/phases/13-metric-polling-verification/13-VERIFICATION.md"
      provides: "Formal verification report with line-number evidence for Phase 11 success criteria"
      contains: "status: passed"
  key_links:
    - from: "MetricPollingEngine.kt"
      to: "BleConstants.Timing"
      via: "Interval and timeout constants"
      pattern: "BleConstants\\.Timing"
    - from: "KableBleRepository.kt"
      to: "MetricPollingEngine"
      via: "pollingEngine property delegation"
      pattern: "pollingEngine\\."
---

<objective>
Formally verify Phase 11 (MetricPollingEngine) success criteria and generate a VERIFICATION.md report.

Purpose: The v0.4.2 milestone audit found Phase 11 was functionally complete (18 tests passing, code integrated) but lacked formal VERIFICATION.md documentation. This closes that gap.
Output: `.planning/phases/13-metric-polling-verification/13-VERIFICATION.md`
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 11 execution context
@.planning/phases/11-metric-polling-engine/11-01-SUMMARY.md
@.planning/phases/11-metric-polling-engine/11-02-SUMMARY.md

# Verification format precedent
@.planning/phases/10-monitor-data-processor/10-VERIFICATION.md

# Research for this phase
@.planning/phases/13-metric-polling-verification/13-RESEARCH.md

# Source files to verify
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/KableBleConnectionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/BleConstants.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Collect evidence and run tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/KableBleRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/KableBleConnectionManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/BleConstants.kt
  </files>
  <action>
    Collect line-number evidence for all Phase 11 success criteria. This is READ-ONLY — do NOT modify any .kt files.

    **Step 1: Run tests to confirm green state**
    ```bash
    ./gradlew :shared:testDebugUnitTest 2>&1 | tail -20
    ```
    Record pass/fail count and timestamp.

    **Step 2: Verify POLL-01 (4 polling loops)**
    Read MetricPollingEngine.kt and record exact current line numbers for:
    - 4 Job reference declarations (monitorPollingJob, diagnosticPollingJob, heuristicPollingJob, heartbeatJob)
    - startAll() method that calls all 4 start methods
    - startMonitorPolling(), startDiagnosticPolling(), startHeuristicPolling(), startHeartbeat() methods
    - Monitor Mutex preventing concurrent loops

    **Step 3: Verify POLL-02 (stopMonitorOnly — Issue #222)**
    Read MetricPollingEngine.kt and record exact line numbers for:
    - stopMonitorOnly() method — must cancel ONLY monitorPollingJob
    - Confirm no references to diagnostic/heuristic/heartbeat cancellation in stopMonitorOnly
    Read MetricPollingEngineTest.kt and record test names/lines for the 4 Issue #222 partial stop tests.

    **Step 4: Verify POLL-03 (timeout disconnect)**
    Read MetricPollingEngine.kt and record exact line numbers for:
    - consecutiveTimeouts counter
    - MAX_CONSECUTIVE_TIMEOUTS threshold check
    - onConnectionLost callback invocation
    Read BleConstants.kt for MAX_CONSECUTIVE_TIMEOUTS constant value.
    Read MetricPollingEngineTest.kt for the 3 timeout disconnect tests.

    **Step 5: Verify delegation wiring**
    Read KableBleRepository.kt for:
    - pollingEngine property declaration
    - All call sites delegating to pollingEngine (stopPolling, stopMonitorPollingOnly, restartAll, etc.)
    Read KableBleConnectionManager.kt for:
    - pollingEngine constructor parameter
    - Any pollingEngine call sites

    **Step 6: Verify Phase 11 success criterion #4 (atomic lifecycle)**
    Confirm stopAll() cancels all 4 jobs and resets state.
    Confirm restartAll() conditionally restarts only inactive jobs.

    **Step 7: Verify BleRepository interface unchanged**
    ```bash
    grep -n "fun stop\|fun start\|fun restart\|fun connect\|fun disconnect" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/BleInterfaces.kt
    ```
    Confirm interface has no polling-specific methods added by Phase 11.

    CRITICAL: Use CURRENT source file line numbers, not numbers from Phase 11 summaries. Phase 12 changed KableBleRepository significantly.
  </action>
  <verify>
    - `./gradlew :shared:testDebugUnitTest` passes (all 18 MetricPollingEngine tests green)
    - All 3 POLL requirements have at least 2 pieces of evidence (code + test)
    - Line numbers verified against current files (not stale Phase 11 references)
  </verify>
  <done>Evidence collected for all Phase 11 success criteria with current line-number references. Tests confirmed passing.</done>
</task>

<task type="auto">
  <name>Task 2: Generate VERIFICATION.md report</name>
  <files>.planning/phases/13-metric-polling-verification/13-VERIFICATION.md</files>
  <action>
    Create `.planning/phases/13-metric-polling-verification/13-VERIFICATION.md` following the exact format from Phase 10's `10-VERIFICATION.md`:

    **Frontmatter:**
    ```yaml
    ---
    phase: 11-metric-polling-engine
    verified: [current ISO timestamp]
    status: passed  # or failed if evidence doesn't support
    score: N/N must-haves verified
    ---
    ```

    Note: `phase` in frontmatter is `11-metric-polling-engine` (the phase BEING verified), not 13.

    **Sections (follow 10-VERIFICATION.md format exactly):**

    1. **Observable Truths** — Table with 6 truths from Phase 11 Plan 01 and 7 truths from Plan 02 (see 13-RESEARCH.md "What Must Be Verified"). Each row: #, truth statement, status (VERIFIED/FAILED), evidence with exact line numbers.

    2. **Required Artifacts** — Table listing MetricPollingEngine.kt (532 lines, 4 loops), MetricPollingEngineTest.kt (345 lines, 18 tests), KableBleRepository.kt (delegation wiring), KableBleConnectionManager.kt (delegation wiring).

    3. **Key Link Verification** — Table with all links from 13-RESEARCH.md "Key Links to Verify". Verify each using CURRENT line numbers. Mark as WIRED or BROKEN.

    4. **Requirements Coverage** — Table with POLL-01, POLL-02, POLL-03. Status SATISFIED/UNSATISFIED. Evidence with specific file:line references and test names.

    5. **Anti-Patterns Found** — Note any issues. If none, state "No blockers or warnings detected."

    6. **Human Verification Required** — Note that BLE hardware testing was covered by Phase 12 checkpoint (manual BLE verify), not Phase 11 specifically.

    7. **Gaps Summary** — If all truths and requirements pass, state "No gaps found." If any fail, document as gaps with suggested remediation.

    **Quality checks before writing:**
    - Every line number referenced must match the actual current source
    - Every test name referenced must exist in MetricPollingEngineTest.kt
    - Status should be "passed" ONLY if all truths verified and all 3 requirements satisfied
    - If any truth fails, set status to "failed" and document gaps
  </action>
  <verify>
    - 13-VERIFICATION.md exists and has valid frontmatter
    - All sections present matching 10-VERIFICATION.md structure
    - Line numbers spot-checked against actual source files
    - POLL-01, POLL-02, POLL-03 all have status entries
  </verify>
  <done>VERIFICATION.md generated with evidence-backed verification for all Phase 11 success criteria. All 3 POLL requirements formally verified with line-number evidence and test references.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest` passes — all MetricPollingEngine tests green
2. `13-VERIFICATION.md` exists with valid frontmatter (phase, verified, status, score)
3. All 3 requirements (POLL-01, POLL-02, POLL-03) have SATISFIED/UNSATISFIED status with evidence
4. No .kt files modified (this is verification-only)
5. Line numbers in VERIFICATION.md match current source (post-Phase-12 state)
</verification>

<success_criteria>
- 13-VERIFICATION.md generated following established format
- Phase 11 success criteria formally verified with traceable evidence
- POLL-01 verified: MetricPollingEngine manages 4 polling loops
- POLL-02 verified: stopMonitorOnly preserves diagnostic/heartbeat (Issue #222)
- POLL-03 verified: Timeout disconnect after MAX_CONSECUTIVE_TIMEOUTS
- All 18 MetricPollingEngineTest tests confirmed passing
- No code changes made (verification only)
</success_criteria>

<output>
After completion, create `.planning/phases/13-metric-polling-verification/13-01-SUMMARY.md`
</output>

---
milestone: v0.4.2
audited: 2026-02-16T10:30:00Z
status: tech_debt
scores:
  requirements: 23/23
  phases: 9/9
  integration: 8/8
  flows: 4/4
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 07-ble-operation-queue
    items:
      - "QUEUE-02: Hardware integration test for fault 16384 under concurrent access (Issue #222) — unit tests verify Mutex serialization, physical device stress test deferred to QA cycle"
  - phase: 10-monitor-data-processor
    items:
      - "Live BLE deload event detection requires triggering specific machine condition on hardware"
      - "Live BLE ROM violation detection requires configured range + out-of-bounds movement on hardware"
  - phase: 12-ble-connection-facade
    items:
      - "Auto-reconnect timing behavior only partially verifiable via unit tests — full BLE range/power-cycle test recommended during QA"
---

# v0.4.2 BLE Layer Decomposition — Milestone Audit

**Audited:** 2026-02-16
**Previous Audit:** 2026-02-16 (gaps_found — Phase 11 missing VERIFICATION.md)
**Status:** tech_debt
**Milestone Goal:** Decompose KableBleRepository (2,886 lines) into 8 focused, testable modules while preserving BleRepository interface contract.

## Executive Summary

All 9 phases formally verified and passed. All 23 requirements satisfied. The previous audit gap (Phase 11 MetricPollingEngine missing VERIFICATION.md) was closed by Phase 13, which produced a comprehensive verification report with line-number evidence and spot-checked source code. Cross-phase integration is 100% connected with zero broken flows. Remaining tech debt is limited to hardware-specific edge cases that require physical Vitruvian devices.

## Phase Verification Status

| Phase | Name | Verification | Score | Status |
|-------|------|-------------|-------|--------|
| 5 | BleProtocolConstants | 05-01-VERIFICATION.md | 5/5 | PASSED |
| 6 | ProtocolParser | 06-VERIFICATION.md | 4/4 + 5/5 truths | PASSED |
| 7 | BleOperationQueue | 07-01-VERIFICATION.md | 4/4 | PASSED (hardware deferred) |
| 8 | DiscoMode + Interface | 08-01-VERIFICATION.md | 4/4 | PASSED |
| 9 | HandleStateDetector | 09-01-VERIFICATION.md | 6/6 | PASSED |
| 10 | MonitorDataProcessor | 10-VERIFICATION.md | 6/6 | PASSED (hardware deferred) |
| 11 | MetricPollingEngine | 13-VERIFICATION.md | 13/13 | PASSED (verified by Phase 13) |
| 12 | KableBleConnectionManager + Facade | 12-VERIFICATION.md | 8/8 | PASSED (hardware approved at 12-02 checkpoint) |
| 13 | MetricPollingEngine Verification | 13-PHASE-VERIFICATION.md | 4/4 | PASSED |

**Score: 9/9 phases verified and passed**

## Requirements Coverage

| Requirement | Phase | Verification | Satisfied |
|-------------|-------|-------------|-----------|
| CONST-01 | 5 | 05-01-VERIFICATION.md | YES |
| PARSE-01 | 6 | 06-VERIFICATION.md | YES |
| PARSE-02 | 6 | 06-VERIFICATION.md (42 tests) | YES |
| QUEUE-01 | 7 | 07-01-VERIFICATION.md (Mutex + 10 sites) | YES |
| QUEUE-02 | 7 | 07-01-VERIFICATION.md (unit tests) | YES (hardware deferred) |
| DISCO-01 | 8 | 08-01-VERIFICATION.md | YES |
| IFACE-01 | 8 | 08-01-VERIFICATION.md (interface line 268) | YES |
| IFACE-02 | 8 | 08-01-VERIFICATION.md (Issue #144 fixed) | YES |
| HAND-01 | 9 | 09-01-VERIFICATION.md (4-state machine) | YES |
| HAND-02 | 9 | 09-01-VERIFICATION.md (Issue #176 baseline) | YES |
| HAND-03 | 9 | 09-01-VERIFICATION.md (auto-start detection) | YES |
| PROC-01 | 10 | 10-VERIFICATION.md (6-stage pipeline) | YES |
| PROC-02 | 10 | 10-VERIFICATION.md (Issue #210 preserved) | YES |
| PROC-03 | 10 | 10-VERIFICATION.md (synchronous, <5ms) | YES |
| POLL-01 | 11 | 13-VERIFICATION.md (4 Job refs, 18 tests) | YES |
| POLL-02 | 11 | 13-VERIFICATION.md (stopMonitorOnly, 4 tests) | YES |
| POLL-03 | 11 | 13-VERIFICATION.md (timeout disconnect, 3 tests) | YES |
| CONN-01 | 12 | 12-VERIFICATION.md (7 lifecycle methods) | YES |
| CONN-02 | 12 | 12-VERIFICATION.md (auto-reconnect logic) | YES |
| CONN-03 | 12 | 12-VERIFICATION.md (3-attempt retry) | YES |
| FACADE-01 | 12 | 12-VERIFICATION.md (394 lines < 400) | YES |
| FACADE-02 | 12 | 12-VERIFICATION.md (all tests pass) | YES |
| FACADE-03 | 12 | 12-VERIFICATION.md (hardware approved at checkpoint) | YES |

**Score: 23/23 requirements satisfied**

## Cross-Phase Integration

**Status: COMPLETE (8/8 modules connected, 0 orphaned, 0 circular dependencies)**

### Module Dependency Graph

```
Level 1 (Foundation):
  BleConstants (Phase 5) ← imported by all modules

Level 2 (Utilities):
  ProtocolParser (Phase 6) ← MetricPollingEngine, KableBleRepository
  BleOperationQueue (Phase 7) ← MetricPollingEngine, KableBleConnectionManager

Level 3 (Processors):
  DiscoMode (Phase 8) ← KableBleRepository (callback to ConnectionManager)
  HandleStateDetector (Phase 9) ← MetricPollingEngine, KableBleRepository (flows)
  MonitorDataProcessor (Phase 10) ← MetricPollingEngine

Level 4 (Engine):
  MetricPollingEngine (Phase 11) ← KableBleConnectionManager, KableBleRepository

Level 5 (Connection):
  KableBleConnectionManager (Phase 12) ← KableBleRepository (facade)

Facade:
  KableBleRepository (394 lines, 86% reduction)
```

### Init Order Safety

KableBleRepository initializes modules in dependency order:
1. BleOperationQueue, ProtocolParser (no deps)
2. DiscoMode, HandleStateDetector, MonitorDataProcessor (use constants only)
3. MetricPollingEngine (uses queue, parser, processors)
4. KableBleConnectionManager (uses queue, engine — `lateinit var` + `init` block)

### API Coverage

All public APIs consumed — zero orphaned methods across all 8 modules.

| Module | Methods/Properties | Used | Coverage |
|--------|-------------------|------|----------|
| BleConstants | UUIDs, Timing, Thresholds | All | 100% |
| ProtocolParser | 4 parse functions, 6 utilities | All | 100% |
| BleOperationQueue | read, write, writeSimple, withLock | All | 100% |
| DiscoMode | start, stop, setLastColorSchemeIndex, isActive | All | 100% |
| HandleStateDetector | 7 methods/properties | All | 100% |
| MonitorDataProcessor | process, resetForNewSession, callbacks | All | 100% |
| MetricPollingEngine | 6 lifecycle methods | All | 100% |
| KableBleConnectionManager | 6 connection methods | All | 100% |

## E2E Flows

**Status: 4/4 COMPLETE**

| Flow | Steps | Status |
|------|-------|--------|
| Full Workout: Scan → Connect → Start → Monitor → Stop → Disconnect | UI → ConnectionManager.startScanning → connect → pollingEngine.startAll → MetricPollingEngine loops → MonitorDataProcessor.process → Facade SharedFlows → UI | COMPLETE |
| Auto-Start: Enable Handle Detection → Poll → Detect Grab → Start | enableHandleDetection → pollingEngine.startMonitorPolling(forAutoStart=true) → HandleStateDetector.processMetric → state transition → UI | COMPLETE |
| Disco Mode: Start → Cycle Colors → Stop → Restore | DiscoMode.start → sendCommand callback → ConnectionManager.sendWorkoutCommand → BLE → DiscoMode.stop → restore lastColorSchemeIndex | COMPLETE |
| Auto-Reconnect: Unexpected Disconnect → Reconnect → Resume | State observer → pollingEngine.stopAll → onReconnectionRequested callback → UI dialog → ConnectionManager.connect → pollingEngine.startAll | COMPLETE |

## Critical Invariants Preserved

| Issue | Invariant | Module | Verified |
|-------|-----------|--------|----------|
| #222 | BLE operation serialization (no fault 16384) | BleOperationQueue | YES (Mutex + 10 sites + 6 tests) |
| #222 | stopMonitorOnly preserves diagnostic/heartbeat | MetricPollingEngine | YES (4 dedicated tests) |
| #210 | Position tracking before validation (no cascade) | MonitorDataProcessor | YES (6 tests) |
| #204/#214 | Velocity EMA with cold-start seeding | MonitorDataProcessor | YES |
| #176 | Overhead pulley baseline-relative detection | HandleStateDetector | YES (37 tests) |
| #96 | Auto-start lower velocity threshold (20mm/s) | HandleStateDetector | YES |
| #144 | No concrete cast in SettingsManager | DiscoMode + Interface | YES (zero casts found) |
| POLL-03 | Timeout disconnect after 5 consecutive failures | MetricPollingEngine | YES (3 tests) |

## Gaps (Blockers)

**None.** All previous gaps have been closed:
- Phase 11 VERIFICATION.md gap → Closed by Phase 13 (13-VERIFICATION.md with 13/13 truths verified)

## Tech Debt (Non-Blocking)

### Phase 7: Hardware Integration Test
- QUEUE-02 hardware stress test under concurrent BLE access deferred
- Unit tests verify Mutex serialization logic; fault 16384 confirmation needs physical device
- **Recommended:** Include in v0.4.2 QA cycle

### Phase 10: Live BLE Edge Cases
- Deload event detection requires triggering specific machine condition (sudden load drop during eccentric)
- ROM violation detection requires configured range + out-of-bounds handle movement
- Basic metric flow was implicitly tested during Phase 12 hardware approval

### Phase 12: Auto-Reconnect Edge Cases
- Auto-reconnect timing under real BLE range loss / device power cycle
- Unit tests cover logic flow; physical environment testing recommended
- Phase 12 hardware checkpoint approved core scenarios (scan, connect, workout, disconnect, disco)

**Total: 4 items across 3 phases — all hardware-specific, no code changes needed**

## Code Metrics

| Metric | Before (v0.4.1) | After (v0.4.2) | Change |
|--------|-----------------|----------------|--------|
| KableBleRepository.kt | 2,886 lines | 394 lines | -86% |
| BLE module files | 1 monolith | 8 focused modules + facade | +8 |
| BLE unit test files | 0 | 6 test files, 146 tests | +146 |
| Total BLE code | 2,886 lines | ~3,500 lines (across 10 files) | +21% (testability investment) |
| Longest file | 2,886 lines | 1,105 lines (ConnectionManager) | -62% |

## Callback Wiring Summary

15 callbacks verified across all modules:
- MonitorDataProcessor → Facade: 2 (deload, ROM violation)
- MetricPollingEngine → Facade: 3 (metric emit, heuristic, connection lost)
- KableBleConnectionManager → Facade: 9 (state, devices, reconnect, commands, events)
- DiscoMode → ConnectionManager: 1 (sendCommand)

---
*Audited: 2026-02-16*
*Previous audit: 2026-02-16 (gaps_found → resolved by Phase 13)*
*Auditor: Claude Opus 4.6 (audit-milestone workflow)*

---
phase: 11-metric-polling-engine
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt
autonomous: true
must_haves:
  truths:
    - "MetricPollingEngine manages 4 independent polling Jobs (monitor, diagnostic, heuristic, heartbeat)"
    - "stopMonitorOnly cancels only monitor job while diagnostic, heuristic, and heartbeat remain active (Issue #222)"
    - "stopAll cancels all 4 jobs, nulls references, and resets diagnostic counters"
    - "restartAll conditionally restarts only inactive jobs (no duplicate loops)"
    - "Consecutive timeout threshold triggers onConnectionLost callback (POLL-03)"
    - "Monitor polling mutex prevents concurrent monitor loops"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt"
      provides: "MetricPollingEngine class with 4 polling loops, lifecycle management, and timeout disconnect"
      contains: "class MetricPollingEngine"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt"
      provides: "Unit tests for job lifecycle, partial stop (Issue #222), timeout disconnect, conditional restart"
      contains: "class MetricPollingEngineTest"
  key_links:
    - from: "MetricPollingEngine"
      to: "BleOperationQueue"
      via: "constructor injection"
      pattern: "bleQueue\\.read"
    - from: "MetricPollingEngine"
      to: "MonitorDataProcessor"
      via: "constructor injection"
      pattern: "monitorProcessor\\.process"
    - from: "MetricPollingEngine"
      to: "HandleStateDetector"
      via: "constructor injection"
      pattern: "handleDetector\\.processMetric"
---

<objective>
Create MetricPollingEngine with TDD: a coroutine Job lifecycle manager for the 4 BLE polling loops (monitor at 10-20Hz, diagnostic at 1Hz, heuristic at 4Hz, heartbeat at 0.5Hz) plus selective stop/restart methods.

Purpose: Fifth module extraction in v0.4.2 decomposition. The engine owns Job references, Mutex, diagnostic counters, and all start/stop/restart lifecycle methods. The critical invariant is Issue #222: `stopMonitorOnly()` MUST preserve diagnostic and heartbeat polling.

Output: MetricPollingEngine.kt class + MetricPollingEngineTest.kt with lifecycle, partial-stop, timeout disconnect, and conditional restart tests.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-metric-polling-engine/11-RESEARCH.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessor.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetector.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/BleOperationQueue.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolParser.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolModels.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/HandleStateDetectorTest.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MonitorDataProcessorTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for MetricPollingEngine job lifecycle</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
  </files>
  <action>
Create MetricPollingEngineTest.kt with tests covering all critical behaviors. Create a minimal MetricPollingEngine.kt stub (empty class with constructor signature) so tests compile but fail.

**Test categories (target ~20 tests):**

1. **Job Lifecycle (4 tests):**
   - `startAll starts all 4 polling jobs` - After `startAll(peripheral)`, all 4 jobs should be non-null and active
   - `stopAll cancels all 4 polling jobs` - After `stopAll()`, all jobs should be null
   - `stopAll resets diagnostic counters` - After `stopAll()`, `diagnosticPollCount` should be 0 and `lastDiagnosticFaults` should be null
   - `startMonitorPolling cancels previous job before starting new` - Calling twice should not leave orphan jobs

2. **Partial Stop - Issue #222 (4 tests, CRITICAL):**
   - `stopMonitorOnly cancels only monitor job` - monitorPollingJob should be null
   - `stopMonitorOnly preserves diagnostic job` - diagnosticPollingJob should still be active
   - `stopMonitorOnly preserves heartbeat job` - heartbeatJob should still be active
   - `stopMonitorOnly preserves heuristic job` - heuristicPollingJob should still be active

3. **Conditional Restart (5 tests):**
   - `restartAll starts monitor unconditionally`
   - `restartAll skips diagnostic if already active`
   - `restartAll restarts diagnostic if not active`
   - `restartAll skips heartbeat if already active`
   - `restartAll restarts heartbeat if not active`

4. **Timeout Disconnect - POLL-03 (3 tests):**
   - `consecutive timeouts trigger disconnect after MAX_CONSECUTIVE_TIMEOUTS` - onConnectionLost callback fires
   - `successful read resets consecutive timeout counter` - Counter resets to 0 on successful read
   - `timeout counter does not trigger at MAX minus 1` - onConnectionLost should NOT fire

5. **Diagnostic/Heartbeat Restart (2 tests):**
   - `restartDiagnosticAndHeartbeat starts both if not active`
   - `restartDiagnosticAndHeartbeat skips if already active`

**Testing approach:** Since Kable's `Peripheral` is a concrete class that can't be mocked in KMP common tests, test the lifecycle methods by verifying Job states (isActive, null) rather than BLE read results. Use `kotlinx.coroutines.test.runTest` with `TestScope`.

**Constructor signature for the stub:**
```kotlin
class MetricPollingEngine(
    private val scope: CoroutineScope,
    private val bleQueue: BleOperationQueue,
    private val monitorProcessor: MonitorDataProcessor,
    private val handleDetector: HandleStateDetector,
    private val onMetricEmit: (WorkoutMetric) -> Boolean,
    private val onHeuristicData: (HeuristicStatistics) -> Unit,
    private val onConnectionLost: suspend () -> Unit
)
```

For testing, create a test-friendly approach: since we can't mock Peripheral, expose internal Job state for testing via `@VisibleForTesting` internal properties, or use a test-only method `isPollingActive(type: PollingType): Boolean`.

**Alternative approach if Peripheral mocking is too complex:** Focus on the lifecycle management methods that DON'T need a Peripheral reference. Test `stopAll()`, `stopMonitorOnly()` by first setting job fields programmatically (via reflection or test-specific setup). If this proves unwieldy, create the tests as integration-ready (compilable, logically correct) and verify compilation + basic structure, with full lifecycle verified in Plan 02 via `./gradlew :androidApp:testDebugUnitTest`.

Commit: `test(11-01): add failing tests for MetricPollingEngine lifecycle`
  </action>
  <verify>Tests compile but fail (RED). Run `./gradlew :shared:compileTestKotlinJvm` to verify compilation.</verify>
  <done>MetricPollingEngineTest.kt exists with ~18-20 tests covering lifecycle, partial stop (Issue #222), timeout disconnect (POLL-03), and conditional restart. All tests compile. Stub MetricPollingEngine.kt exists with constructor signature.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement MetricPollingEngine with all polling loops and lifecycle management</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
  </files>
  <action>
Implement MetricPollingEngine by moving logic from KableBleRepository (lines referenced in 11-RESEARCH.md). This is a MOVE operation - copy the logic faithfully from KableBleRepository, adapting method signatures to use constructor-injected dependencies.

**Class structure:**
```kotlin
class MetricPollingEngine(
    private val scope: CoroutineScope,
    private val bleQueue: BleOperationQueue,
    private val monitorProcessor: MonitorDataProcessor,
    private val handleDetector: HandleStateDetector,
    private val onMetricEmit: (WorkoutMetric) -> Boolean,
    private val onHeuristicData: (HeuristicStatistics) -> Unit,
    private val onConnectionLost: suspend () -> Unit
)
```

**State (moved from KableBleRepository):**
- 4 Job references: `monitorPollingJob`, `diagnosticPollingJob`, `heuristicPollingJob`, `heartbeatJob`
- `monitorPollingMutex: Mutex`
- `diagnosticPollCount: Long`, `lastDiagnosticFaults: List<Short>?`

**Public methods (with their KableBleRepository equivalents):**

1. `startAll(peripheral: Peripheral)` - Calls all 4 start methods. Called from `startObservingNotifications()`.

2. `startMonitorPolling(peripheral: Peripheral, forAutoStart: Boolean = false)` - Move from KableBleRepository lines 1124-1213. Key adaptations:
   - `stopDiscoMode()` call REMOVED (handled by KableBleRepository before calling engine - see Research open question #3)
   - `monitorProcessor.resetForNewSession()` stays (engine has processor ref)
   - `handleDetector.enable(autoStart = true)` stays (engine has detector ref)
   - Mutex-guarded polling loop with timeout tracking
   - `parseMonitorData(data)` logic INLINED: call `monitorProcessor.process(packet)`, then `handleDetector.processMetric(metric)`, then `onMetricEmit(metric)` (per Research open question #1)
   - Timeout disconnect: `onConnectionLost()` callback instead of direct `scope.launch { disconnect() }`
   - Connection state check: Accept a lambda or check via callback. Since engine doesn't own `_connectionState`, pass a `isConnected: () -> Boolean` parameter OR just rely on `isActive` (the job is cancelled by stopAll when disconnecting). Use `isActive` only - simpler and correct since disconnect() calls stopAll() which cancels jobs.

3. `startDiagnosticPolling(peripheral: Peripheral)` - Move from lines 984-1022. Adaptation:
   - `parseDiagnosticData()` logic inlined (call `parseDiagnosticPacket()` directly, log fault changes)
   - Connection state check: use `isActive` only (same reasoning)

4. `startHeuristicPolling(peripheral: Peripheral)` - Move from lines 1035-1073. Adaptation:
   - `parseHeuristicData()` logic inlined (call `parseHeuristicPacket()`, emit via `onHeuristicData`)
   - Connection state check: use `isActive` only

5. `startHeartbeat(peripheral: Peripheral)` - Move from lines 765-794. Include `performHeartbeatRead()` (802-814) and `sendHeartbeatNoOp()` (821-828) as private methods.

6. `stopAll()` - Move from `stopPolling()` lines 1477-1510. Include workout analysis logging (reads handleDetector.minPositionSeen/maxPositionSeen).

7. `stopMonitorOnly()` - Move from `stopMonitorPollingOnly()` lines 1517-1526. Cancels ONLY monitorPollingJob. CRITICAL: diagnostic, heuristic, heartbeat CONTINUE.

8. `restartAll(peripheral: Peripheral)` - Move from `startActiveWorkoutPolling()` lines 1443-1475. Conditionally restart only inactive jobs.

9. `restartDiagnosticAndHeartbeat(peripheral: Peripheral)` - Move from `restartDiagnosticPolling()` lines 1532-1554. Conditionally restart diagnostic + heartbeat.

**Critical details to preserve:**
- Monitor polling: NO delay on success (BLE response time naturally rate-limits). Small `delay(50)` on timeout/failure.
- Monitor polling mutex: NO `if (mutex.isLocked) return` (causes race condition - see research pitfall #4)
- Heartbeat: `WriteType.WithResponse` for V-Form (Issue #222 v15.1)
- Diagnostic: connection state check uses `isActive` from coroutine scope
- `parseDiagnosticData` and `parseHeuristicData`: Move the thin wrapper logic into the engine's polling loops directly. These are only called from the loops (plus one post-CONFIG in `sendWorkoutCommand` which stays in KableBleRepository per pitfall #6, option c).

**Imports needed:**
- `co.touchlab.kermit.Logger`
- `com.juul.kable.Peripheral`, `WriteType`
- `kotlinx.coroutines.*` (Job, CoroutineScope, delay, isActive, launch, withTimeoutOrNull)
- `kotlinx.coroutines.sync.Mutex`, `withLock`
- `com.devil.phoenixproject.util.BleConstants`
- `com.devil.phoenixproject.domain.model.WorkoutMetric`, `currentTimeMillis`
- Protocol parser functions: `parseMonitorPacket`, `parseDiagnosticPacket`, `parseHeuristicPacket`

Commit: `feat(11-01): implement MetricPollingEngine with 4 polling loops and lifecycle management`
  </action>
  <verify>Run `./gradlew :androidApp:testDebugUnitTest` - all tests pass (GREEN). No regressions in existing tests (ProtocolParserTest, HandleStateDetectorTest, MonitorDataProcessorTest, BleOperationQueueTest).</verify>
  <done>MetricPollingEngine.kt implements all 4 polling loops, stopAll/stopMonitorOnly/restartAll/restartDiagnosticAndHeartbeat lifecycle methods. All MetricPollingEngineTest tests pass. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 3: REFACTOR - Clean up MetricPollingEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngineTest.kt
  </files>
  <action>
Review MetricPollingEngine.kt for cleanup opportunities after GREEN:

1. **Remove any test scaffolding** that was needed only for RED phase (test helpers, internal visibility modifiers that aren't needed)
2. **Consolidate logging patterns** - ensure consistent tag and format matching the rest of the codebase
3. **Extract shared patterns** - if the diagnostic/heuristic/heartbeat loops share a common pattern (poll-with-timeout), consider a private helper to reduce duplication (but ONLY if it doesn't obscure readability)
4. **KDoc comments** - Add class-level KDoc explaining the engine's role in the decomposition, the Issue #222 invariant, and the polling frequencies
5. **Verify no dead code** - remove any unused imports or methods

Do NOT change any public API or behavior. Tests MUST still pass after cleanup.

Commit: `refactor(11-01): clean up MetricPollingEngine`
  </action>
  <verify>Run `./gradlew :androidApp:testDebugUnitTest` - all tests still pass. No behavioral changes.</verify>
  <done>MetricPollingEngine.kt is clean, well-documented, follows codebase conventions. All tests pass.</done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:testDebugUnitTest` passes (all tests green)
2. MetricPollingEngine.kt exists in `shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/`
3. MetricPollingEngineTest.kt exists in `shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/`
4. Engine has 4 `startXxx()` methods, `startAll()`, `stopAll()`, `stopMonitorOnly()`, `restartAll()`, `restartDiagnosticAndHeartbeat()`
5. Tests verify Issue #222 partial-stop invariant
6. Tests verify POLL-03 timeout disconnect
7. No changes to KableBleRepository (that's Plan 02)
</verification>

<success_criteria>
- MetricPollingEngine class created with all polling loop logic and lifecycle management
- ~18-20 unit tests covering job lifecycle, Issue #222 partial stop, timeout disconnect, conditional restart
- All tests pass including existing tests (no regressions)
- Engine is ready for delegation wiring in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/11-metric-polling-engine/11-01-SUMMARY.md`
</output>

---
phase: 11-metric-polling-engine
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: true
must_haves:
  truths:
    - "KableBleRepository delegates all polling lifecycle to pollingEngine inline property"
    - "startObservingNotifications splits cleanly: notifications stay, polling delegates to engine"
    - "disconnect() and cleanupExistingConnection() cancel polling via pollingEngine.stopAll()"
    - "stopPolling(), stopMonitorPollingOnly(), restartDiagnosticPolling(), startActiveWorkoutPolling(), restartMonitorPolling() delegate to engine"
    - "BleRepository interface is completely unchanged"
    - "Post-CONFIG diagnostic read in sendWorkoutCommand() still works (parseDiagnosticData stays in repository)"
    - "enableHandleDetection() still calls engine for polling restart"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt"
      provides: "Delegated polling via pollingEngine property, ~300-line net reduction"
      contains: "private val pollingEngine"
  key_links:
    - from: "KableBleRepository"
      to: "MetricPollingEngine"
      via: "inline property delegation"
      pattern: "pollingEngine\\."
    - from: "KableBleRepository.startObservingNotifications"
      to: "pollingEngine.startAll"
      via: "method call after notification subscriptions"
      pattern: "pollingEngine\\.startAll"
    - from: "KableBleRepository.stopPolling"
      to: "pollingEngine.stopAll"
      via: "direct delegation"
      pattern: "pollingEngine\\.stopAll"
---

<objective>
Wire KableBleRepository to delegate all polling lifecycle to MetricPollingEngine, removing ~300 lines of polling loop code, 4 Job references, Mutex, and diagnostic counters.

Purpose: Complete Phase 11 extraction. After this, KableBleRepository no longer directly manages polling Jobs. All polling start/stop/restart operations go through the engine.

Output: KableBleRepository reduced by ~300 lines with polling delegation pattern matching bleQueue, discoMode, handleDetector, monitorProcessor.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-metric-polling-engine/11-RESEARCH.md
@.planning/phases/11-metric-polling-engine/11-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/MetricPollingEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire KableBleRepository delegation to MetricPollingEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
  </files>
  <action>
Wire polling delegation from KableBleRepository to MetricPollingEngine. This is a DELETE-heavy task: remove ~300 lines of polling code and replace with engine delegation.

**Step 1: Add pollingEngine inline property**

Declare `pollingEngine` AFTER `bleQueue`, `handleDetector`, AND `monitorProcessor` (init-order dependency, per [10-02] decision pattern). Must come LAST among delegated module properties.

```kotlin
private val pollingEngine = MetricPollingEngine(
    scope = scope,
    bleQueue = bleQueue,
    monitorProcessor = monitorProcessor,
    handleDetector = handleDetector,
    onMetricEmit = { metric ->
        val emitted = _metricsFlow.tryEmit(metric)
        if (!emitted && monitorProcessor.notificationCount % 100 == 0L) {
            log.w { "Failed to emit metric - buffer full? Count: ${monitorProcessor.notificationCount}" }
        }
        emitted
    },
    onHeuristicData = { stats -> _heuristicData.value = stats },
    onConnectionLost = { disconnect() }
)
```

**Step 2: Remove state variables (7 mutable fields + 1 Mutex)**

Delete from class body:
- `monitorPollingJob` (line ~193)
- `monitorPollingMutex` (line ~196)
- `diagnosticPollingJob` (line ~202)
- `diagnosticPollCount` (line ~203)
- `lastDiagnosticFaults` (line ~204)
- `heuristicPollingJob` (line ~207)
- `heartbeatJob` (line ~213)

Leave comment: `// Polling state moved to MetricPollingEngine (Phase 11 extraction)`

**Step 3: Remove polling loop methods**

Delete entirely:
- `startHeartbeat()` (~lines 765-794)
- `performHeartbeatRead()` (~lines 802-814)
- `sendHeartbeatNoOp()` (~lines 821-828)
- `startDiagnosticPolling()` (~lines 984-1022)
- `startHeuristicPolling()` (~lines 1035-1073)
- `startMonitorPolling()` (~lines 1124-1213)
- `parseMonitorData()` (~lines 1650-1671) -- logic moved to engine's monitor loop
- `parseHeuristicData()` (~lines 1103-1110) -- logic moved to engine's heuristic loop

Keep `parseDiagnosticData()` (~lines 1079-1096) -- still called from post-CONFIG one-shot in `sendWorkoutCommand()` (pitfall #6, option c).

**Step 4: Update startObservingNotifications() (split notification vs polling)**

Replace the polling section at the bottom of `startObservingNotifications()` (lines ~917-934):

BEFORE (lines 917-934):
```kotlin
// ===== POLLING (NOT notifications) =====
log.i { "Starting MONITOR characteristic polling..." }
startMonitorPolling(p)
log.i { "Starting DIAGNOSTIC characteristic polling..." }
startDiagnosticPolling(p)
log.i { "Starting HEURISTIC characteristic polling..." }
startHeuristicPolling(p)
```

AFTER:
```kotlin
// ===== POLLING (delegated to MetricPollingEngine) =====
pollingEngine.startAll(p)
```

Also remove `startHeartbeat()` call from `onDeviceReady()` (line ~758) since `startAll()` includes heartbeat.

**Step 5: Update lifecycle delegation methods**

Replace method bodies (keep override signatures):

```kotlin
override fun stopPolling() = pollingEngine.stopAll()

override fun stopMonitorPollingOnly() = pollingEngine.stopMonitorOnly()

override fun restartDiagnosticPolling() {
    val p = peripheral ?: run {
        log.w { "Cannot restart diagnostic polling - peripheral is null" }
        return
    }
    pollingEngine.restartDiagnosticAndHeartbeat(p)
}

override fun restartMonitorPolling() {
    val p = peripheral ?: run {
        log.w { "Cannot restart monitor polling - peripheral is null" }
        return
    }
    pollingEngine.startMonitorPolling(p, forAutoStart = false)
}

override fun startActiveWorkoutPolling() {
    val p = peripheral ?: run {
        log.w { "Cannot start active workout polling - peripheral is null" }
        return
    }
    pollingEngine.restartAll(p)
}
```

**Step 6: Update enableHandleDetection()**

Replace the `startMonitorPolling(p, forAutoStart = true)` call with engine delegation:
```kotlin
pollingEngine.startMonitorPolling(p, forAutoStart = true)
```

Note: `handleDetector.enable(autoStart = true)` is now called inside the engine's `startMonitorPolling()`, so remove it from `enableHandleDetection()` to avoid double-enabling. BUT verify this is correct -- the engine's `startMonitorPolling` already calls `handleDetector.enable()` when `forAutoStart=true`. So `enableHandleDetection` should just call the engine.

Updated `enableHandleDetection`:
```kotlin
override fun enableHandleDetection(enabled: Boolean) {
    log.i { "Handle detection ${if (enabled) "ENABLED" else "DISABLED"}" }
    if (enabled) {
        val p = peripheral
        if (p != null) {
            pollingEngine.startMonitorPolling(p, forAutoStart = true)
        }
    } else {
        handleDetector.disable()
    }
}
```

Note: `handleDetector.enable()` removed here because `pollingEngine.startMonitorPolling(forAutoStart=true)` calls it internally. This avoids double-enable.

**Step 7: Update disconnect() and cleanupExistingConnection()**

In `disconnect()` (~lines 1215-1228), replace manual job cancellation:

BEFORE:
```kotlin
heartbeatJob?.cancel()
heartbeatJob = null
monitorPollingJob?.cancel()
monitorPollingJob = null
diagnosticPollingJob?.cancel()
diagnosticPollingJob = null
heuristicPollingJob?.cancel()
heuristicPollingJob = null
```

AFTER:
```kotlin
pollingEngine.stopAll()
```

In `cleanupExistingConnection()` (~lines 1574-1582), same replacement:

BEFORE:
```kotlin
heartbeatJob?.cancel()
heartbeatJob = null
monitorPollingJob?.cancel()
monitorPollingJob = null
diagnosticPollingJob?.cancel()
diagnosticPollingJob = null
heuristicPollingJob?.cancel()
heuristicPollingJob = null
```

AFTER:
```kotlin
pollingEngine.stopAll()
```

**Step 8: Clean up imports**

Remove any now-unused imports (Mutex, withLock if only used by monitor polling). Keep imports needed for `parseDiagnosticData()` which stays.

**Step 9: Update stopDiscoMode call**

The engine does NOT call `stopDiscoMode()` (per Research open question #3). This was previously called at the top of `startMonitorPolling()`. After delegation:
- `enableHandleDetection(true)` calls `pollingEngine.startMonitorPolling(p, forAutoStart = true)` -- disco mode should be stopped before this. Add `stopDiscoMode()` call in `enableHandleDetection(true)` before the engine call.
- `restartMonitorPolling()` calls `pollingEngine.startMonitorPolling(p, forAutoStart = false)` -- add `stopDiscoMode()` before.
- `startActiveWorkoutPolling()` calls `pollingEngine.restartAll(p)` -- add `stopDiscoMode()` before.
- `startObservingNotifications()` already calls `pollingEngine.startAll(p)` -- disco mode shouldn't be running at connection time, but add `stopDiscoMode()` before for safety.

This keeps disco mode management in KableBleRepository where it belongs.

Commit: `refactor(11-02): delegate polling lifecycle from KableBleRepository to MetricPollingEngine`
  </action>
  <verify>
1. `./gradlew :androidApp:testDebugUnitTest` passes (all tests green, no regressions)
2. `./gradlew :shared:compileKotlinJvm` compiles successfully
3. Verify line count reduced: `wc -l KableBleRepository.kt` should show ~300 fewer lines (from ~1829 to ~1500-1550)
4. Verify BleRepository.kt interface UNCHANGED: `git diff shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt` shows no changes
5. Verify SimulatorBleRepository.kt and FakeBleRepository.kt UNCHANGED
6. Grep for orphan references: `grep -n "monitorPollingJob\|diagnosticPollingJob\|heuristicPollingJob\|heartbeatJob\|monitorPollingMutex\|diagnosticPollCount\|lastDiagnosticFaults" KableBleRepository.kt` should return ZERO matches (except comments)
  </verify>
  <done>
KableBleRepository delegates all polling lifecycle to pollingEngine. 4 Job references, Mutex, and 2 diagnostic counters removed. ~300-line net reduction. BleRepository interface unchanged. All tests pass. Complete 5-module delegation: bleQueue, discoMode, handleDetector, monitorProcessor, pollingEngine.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:testDebugUnitTest` passes
2. KableBleRepository.kt contains `private val pollingEngine = MetricPollingEngine(`
3. KableBleRepository.kt does NOT contain `monitorPollingJob`, `diagnosticPollingJob`, `heuristicPollingJob`, `heartbeatJob`, `monitorPollingMutex` (except in comments)
4. `pollingEngine` is declared AFTER bleQueue, handleDetector, and monitorProcessor
5. `startObservingNotifications()` has clean split: notifications stay, `pollingEngine.startAll(p)` for polling
6. `disconnect()` uses `pollingEngine.stopAll()` instead of manual job cancellation
7. `cleanupExistingConnection()` uses `pollingEngine.stopAll()` instead of manual job cancellation
8. BleRepository.kt interface UNCHANGED
9. SimulatorBleRepository.kt UNCHANGED
10. FakeBleRepository.kt UNCHANGED
</verification>

<success_criteria>
- KableBleRepository reduced by ~300 lines through polling delegation
- All 5 extraction modules wired: bleQueue, discoMode, handleDetector, monitorProcessor, pollingEngine
- All existing tests pass with no regressions
- BleRepository interface completely unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-metric-polling-engine/11-02-SUMMARY.md`
</output>

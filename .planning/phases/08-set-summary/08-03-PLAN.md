---
phase: 08-set-summary
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
autonomous: true

must_haves:
  truths:
    - "After completing a set, user sees asymmetry card showing avg asymmetry %, dominant side, and trend direction"
    - "All biomechanics summary cards are hidden for users below Phoenix subscription tier"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt"
      provides: "AsymmetrySummaryCard composable"
      contains: "AsymmetrySummaryCard"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt"
      provides: "Tier gating for biomechanicsSummary on SetSummary state"
      contains: "biomechanicsSummary"
  key_links:
    - from: "ActiveWorkoutScreen.kt"
      to: "WorkoutState.SetSummary.biomechanicsSummary"
      via: "null-out for free tier before passing to WorkoutTab"
      pattern: "biomechanicsSummary"
    - from: "SetSummaryCard.kt"
      to: "BiomechanicsSetSummary.avgAsymmetryPercent"
      via: "biomechanicsSummary.avgAsymmetryPercent"
      pattern: "avgAsymmetryPercent"
---

<objective>
Add asymmetry summary card to set summary and apply Phoenix tier gating to all biomechanics summary cards.

Purpose: Complete the set summary biomechanics display with balance analysis, and ensure free-tier users don't see premium biomechanics content.
Output: AsymmetrySummaryCard composable, tier gating applied to biomechanicsSummary field.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-set-summary/08-01-SUMMARY.md
@.planning/phases/07-hud-integration/07-03-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AsymmetrySummaryCard to SetSummaryCard</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  </files>
  <action>
    Add an asymmetry/balance summary card to SetSummaryCard.

    1. **Create AsymmetrySummaryCard composable** (private, in SetSummaryCard.kt) taking `biomechanicsSummary: BiomechanicsSetSummary`:

       - Card with `surfaceContainerHigh` background, `RoundedCornerShape(16.dp)`
       - Header row: "Balance Analysis" title in `titleSmall` + Bold + `primary` color, with balance/compare_arrows icon

       - **Main stats row** (3 columns):
         - "Avg Asymmetry": `"${biomechanicsSummary.avgAsymmetryPercent.toInt()}%"` in headlineMedium, color-coded by severity (green < 10%, yellow 10-15%, red > 15% -- same thresholds as HUD balance bar from 07-02)
         - "Dominant Side": `biomechanicsSummary.dominantSide` displayed as "Left (A)" / "Right (B)" / "Balanced". Use bodyLarge.
         - "Trend": Compute trend from per-rep asymmetry data. Compare first-half average vs second-half average of `repResults.map { it.asymmetry.asymmetryPercent }`:
           - If second half > first half + 2%: WORSENING (trending up icon, red)
           - If first half > second half + 2%: IMPROVING (trending down icon, green)
           - Otherwise: STABLE (trending flat icon, gray)

       - **Per-rep asymmetry sparkline** (optional, if >= 3 reps):
         - Canvas height 40.dp, fillMaxWidth
         - Plot `repResults.map { it.asymmetry.asymmetryPercent }` as a line chart
         - Draw a horizontal dashed reference line at 10% (yellow threshold)
         - Color the line segments using severity colors (green/yellow/red based on value)

    2. **Insert AsymmetrySummaryCard** in SetSummaryCard layout -- Add after the ForceCurveSummaryCard (from Plan 02). Since Plan 02 and 03 are parallel (both Wave 2), check if ForceCurveSummaryCard exists and place after it; if not yet added, place after VelocitySummaryCard. The safest approach: add it right before the RPE section, as a separate `summary.biomechanicsSummary?.let { biomechanics -> AsymmetrySummaryCard(biomechanics) }` block.

    3. **Add imports**: `AsymmetryResult`, `Icons.Default.CompareArrows` or `Icons.Default.Balance`.

    Asymmetry severity colors (same as HUD from 07-02):
    - Green (< 10%): Color(0xFF43A047)
    - Yellow (10-15%): Color(0xFFFDD835)
    - Red (> 15%): Color(0xFFE53935)
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` compiles successfully. Grep for `AsymmetrySummaryCard` in SetSummaryCard.kt confirms composable exists. Grep for `avgAsymmetryPercent` confirms data binding.
  </verify>
  <done>
    Asymmetry summary card shows avg asymmetry % (color-coded), dominant side, trend direction, and per-rep sparkline (SUM-03, ASYM-06).
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply Phoenix tier gating to biomechanics summary cards</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  </files>
  <action>
    Gate the biomechanicsSummary field on WorkoutState.SetSummary for free-tier users, using the same upstream gate pattern established in Phase 7 Plan 03.

    In ActiveWorkoutScreen.kt, find where the `WorkoutUiState` is constructed (the `remember`/`derivedStateOf` block around line ~265-297). The `workoutState` value flows through to `WorkoutTab` -> `SetSummaryCard`.

    The approach: When workoutState is `WorkoutState.SetSummary` and user is free tier, null out the `biomechanicsSummary` field. This is the SAME pattern as `gatedBiomechanicsResult` (line ~82) but applied to the SetSummary state.

    Add this transformation inside the `derivedStateOf` block, right before constructing `WorkoutUiState`:
    ```kotlin
    // Gate biomechanics summary cards for free tier (SUM-05)
    val gatedWorkoutState = if (!hasProAccess && workoutState is WorkoutState.SetSummary) {
        workoutState.copy(biomechanicsSummary = null)
    } else {
        workoutState
    }
    ```

    Then use `gatedWorkoutState` instead of `workoutState` in the `WorkoutUiState(workoutState = ...)` constructor.

    This single upstream gate hides all three biomechanics cards (velocity, force curve, asymmetry) because they all check `summary.biomechanicsSummary?.let { ... }`.

    NOTE: The existing `qualitySummary` gating is already handled separately (it was added in v0.4.5 Phase 3). Do NOT change that gating. Only add the biomechanics gating.
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` compiles successfully. Grep for `gatedWorkoutState` in ActiveWorkoutScreen.kt confirms tier gate exists. Verify the gate nulls `biomechanicsSummary` when `!hasProAccess`.
  </verify>
  <done>
    Free-tier users see standard set summary without biomechanics cards. Phoenix-tier users see all three cards (velocity, force curve, asymmetry). Single upstream gate pattern -- consistent with HUD gating from Phase 7 (SUM-05).
  </done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` passes
- Asymmetry card shows avg %, dominant side, trend, sparkline
- Free-tier gate nulls biomechanicsSummary on SetSummary state
- All three biomechanics cards hidden for free tier
</verification>

<success_criteria>
- Asymmetry summary card visible for Phoenix-tier users after set completion
- Trend direction computed from first-half vs second-half rep comparison
- Severity colors match HUD balance bar thresholds
- Free-tier users see no biomechanics cards on set summary
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-set-summary/08-03-SUMMARY.md`
</output>

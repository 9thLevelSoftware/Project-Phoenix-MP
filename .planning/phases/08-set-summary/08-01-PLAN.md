---
phase: 08-set-summary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
autonomous: true

must_haves:
  truths:
    - "After completing a set, BiomechanicsSetSummary is captured and attached to WorkoutState.SetSummary"
    - "Averaged force curve across all reps is computed (not null stub)"
    - "After completing a set, user sees velocity card showing avg MCV, peak velocity, velocity loss %, and zone distribution"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt"
      provides: "biomechanicsSummary field on WorkoutState.SetSummary"
      contains: "biomechanicsSummary"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt"
      provides: "Averaged force curve computation in getSetSummary()"
      contains: "avgForceCurve"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "Biomechanics summary captured before engine reset"
      contains: "biomechanicsEngine.getSetSummary()"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt"
      provides: "VelocitySummaryCard composable"
      contains: "VelocitySummaryCard"
  key_links:
    - from: "ActiveSessionEngine.kt"
      to: "BiomechanicsEngine.getSetSummary()"
      via: "capture before reset at line ~1882"
      pattern: "biomechanicsEngine\\.getSetSummary\\(\\)"
    - from: "WorkoutState.SetSummary"
      to: "SetSummaryCard"
      via: "biomechanicsSummary parameter"
      pattern: "biomechanicsSummary"
---

<objective>
Wire BiomechanicsSetSummary into the set completion flow and add velocity summary card to SetSummaryCard.

Purpose: Establish the data pipeline from BiomechanicsEngine to SetSummaryCard, implement averaged force curve computation, and display the first biomechanics summary card (velocity).
Output: BiomechanicsSetSummary attached to WorkoutState.SetSummary, velocity card visible on set completion screen.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hud-integration/07-01-SUMMARY.md
@.planning/phases/07-hud-integration/07-03-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire BiomechanicsSetSummary into set completion flow</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  </files>
  <action>
    Three changes needed:

    1. **Models.kt** -- Add `biomechanicsSummary: BiomechanicsSetSummary? = null` field to `WorkoutState.SetSummary` data class (after the existing `qualitySummary` field at line ~86). Import `BiomechanicsSetSummary` from `domain.model`.

    2. **BiomechanicsEngine.kt** -- Replace the `avgForceCurve = null // TODO` stub in `getSetSummary()` (line ~130) with actual averaged force curve computation:
       - Collect all `repResults.map { it.forceCurve }` where `normalizedForceN.size == 101`
       - If no valid curves, return null for avgForceCurve
       - Otherwise, compute element-wise average of `normalizedForceN` across all valid curves (all are 101-point arrays)
       - Use the same `normalizedPositionPct` from any curve (they're all 0..100)
       - For sticking point: find the ROM % where the averaged curve has minimum force (excluding first/last 5% per existing convention)
       - For strength profile: call `classifyStrengthProfile()` on the averaged curve
       - Construct `ForceCurveResult(normalizedForceN = avgForce, normalizedPositionPct = positions, stickingPointPct = stickingPt, strengthProfile = profile, repNumber = 0)` where repNumber=0 indicates set-level average

    3. **ActiveSessionEngine.kt** -- In `handleSetCompletion()` around line ~1870-1883, capture biomechanics summary BEFORE the engine reset. Follow the exact same pattern used for `qualitySummary`:
       - BEFORE line 1883 (`coordinator.biomechanicsEngine.reset()`), add:
         ```kotlin
         // Capture biomechanics set summary BEFORE reset
         val biomechanicsSummary = coordinator.biomechanicsEngine.getSetSummary()
         ```
       - Then at line ~1902 where `baseSummary.copy(qualitySummary = qualitySummary)` is called, change to:
         ```kotlin
         val summary = baseSummary.copy(
             qualitySummary = qualitySummary,
             biomechanicsSummary = biomechanicsSummary
         )
         ```

    CRITICAL: The capture MUST happen before `coordinator.biomechanicsEngine.reset()` or getSetSummary() returns null (the repResults list gets cleared by reset).
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` compiles successfully. Grep for `biomechanicsSummary` in Models.kt confirms field exists. Grep for `biomechanicsEngine.getSetSummary()` in ActiveSessionEngine.kt confirms it appears BEFORE `biomechanicsEngine.reset()`.
  </verify>
  <done>
    WorkoutState.SetSummary has biomechanicsSummary field. BiomechanicsEngine.getSetSummary() returns non-null avgForceCurve when valid curves exist. ActiveSessionEngine captures biomechanics data before engine reset.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add VelocitySummaryCard to SetSummaryCard</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  </files>
  <action>
    Add a velocity summary section to SetSummaryCard that displays when `summary.biomechanicsSummary` is non-null.

    1. **Add `biomechanicsSummary` parameter access** -- The `summary` parameter is `WorkoutState.SetSummary` which now has `biomechanicsSummary: BiomechanicsSetSummary?`. No new parameter needed.

    2. **Add VelocitySummaryCard composable** (private, in SetSummaryCard.kt) that takes `biomechanicsSummary: BiomechanicsSetSummary`:
       - Card with `surfaceContainerHigh` background, `RoundedCornerShape(16.dp)` (matches existing stat cards)
       - Header row: "Velocity Analysis" title in `titleSmall` + Bold + `primary` color, with speed icon
       - Stats row with 3 columns:
         - "Avg MCV": `formatMcv(biomechanicsSummary.avgMcvMmS)` formatted as m/s (reuse `formatMcv()` helper from WorkoutHud.kt or duplicate the integer-arithmetic version: `"${(mcv / 1000).toInt()}.${((mcv % 1000) / 10).toInt().toString().padStart(2, '0')}"`)
         - "Peak": same format for `peakVelocityMmS`
         - "Velocity Loss": `"${totalVelocityLossPercent?.toInt() ?: 0}%"` (show "--" if null / < 2 reps)
       - Zone distribution bar: A horizontal stacked bar showing proportion of reps in each zone, using the same zone colors from WorkoutHud.kt (EXPLOSIVE=red, FAST=orange, MODERATE=yellow, SLOW=blue, GRIND=gray). Each segment's width proportional to count. Show zone labels below with counts.
       - Use KMP-safe integer arithmetic for velocity formatting (no String.format). Copy the `formatMcv` approach from WorkoutHud.kt.

    3. **Insert VelocitySummaryCard in SetSummaryCard layout** -- Add it after the existing QualityStatsSection block (around line 236) and before the RPE section. Wrap in `summary.biomechanicsSummary?.let { biomechanics -> VelocitySummaryCard(biomechanics) }`.

    4. **Add necessary imports**: `BiomechanicsSetSummary`, `BiomechanicsVelocityZone`, zone color values.

    Zone colors (from WorkoutHud.kt zoneColor()): EXPLOSIVE = Color(0xFFE53935), FAST = Color(0xFFFF9800), MODERATE = Color(0xFFFDD835), SLOW = Color(0xFF42A5F5), GRIND = Color.Gray
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` compiles successfully. Grep for `VelocitySummaryCard` in SetSummaryCard.kt confirms composable exists. Grep for `biomechanicsSummary?.let` confirms conditional rendering.
  </verify>
  <done>
    Velocity summary card appears on set summary screen when biomechanics data is available (SUM-01). Shows avg MCV, peak velocity, velocity loss %, and zone distribution bar.
  </done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` passes
- BiomechanicsSetSummary flows from engine through SetSummary state to UI
- avgForceCurve is computed (not null) when valid force curves exist
- Velocity card renders with all required metrics
</verification>

<success_criteria>
- WorkoutState.SetSummary.biomechanicsSummary is non-null after set completion (when reps were processed by engine)
- Velocity summary card shows avg MCV in m/s, peak velocity, velocity loss %, zone distribution
- avgForceCurve computed from averaged rep force curves (not the null stub)
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-set-summary/08-01-SUMMARY.md`
</output>

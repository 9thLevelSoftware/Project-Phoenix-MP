---
phase: 17-wcag-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/App.kt
  - androidApp/src/main/kotlin/com/devil/phoenixproject/ui/theme/AndroidTheme.kt
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.ios.kt
autonomous: true
requirements:
  - BOARD-02

must_haves:
  truths:
    - "User can enable a color-blind mode toggle in Settings that switches the app to a deuteranopia-safe palette"
    - "LocalColorBlindMode CompositionLocal is available at the theme root for all composables"
    - "AccessibilityColors (standard and colorblind palettes) are provided through the theme for all composables"
    - "Color-blind mode preference persists across app restarts"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt"
      provides: "@Immutable AccessibilityColors data class, LocalColorBlindMode, LocalAccessibilityColors, StandardPalette, ColorBlindPalette, AccessibilityTheme convenience object"
      min_lines: 80
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt"
      provides: "VitruvianTheme wired with CompositionLocalProvider for colorBlindMode"
      contains: "CompositionLocalProvider"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt"
      provides: "colorBlindModeEnabled boolean field"
      contains: "colorBlindModeEnabled"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt"
      provides: "Color-blind mode toggle switch in Settings UI"
  key_links:
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/App.kt"
      to: "shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt"
      via: "VitruvianTheme(colorBlindMode = colorBlindModeEnabled)"
      pattern: "VitruvianTheme.*colorBlindMode"
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt"
      to: "shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt"
      via: "CompositionLocalProvider provides AccessibilityColors"
      pattern: "LocalAccessibilityColors provides"
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt"
      to: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt"
      via: "setColorBlindModeEnabled() delegation"
      pattern: "setColorBlindModeEnabled"
---

<objective>
Create the WCAG accessibility color infrastructure and settings toggle.

Purpose: Establish the `AccessibilityColors` data class with standard and deuteranopia-safe palettes, wire `LocalColorBlindMode` and `LocalAccessibilityColors` CompositionLocals into the theme root, and add a user-facing toggle in Settings. This creates the foundation that Plan 17-02 uses to retrofit all composables.

Output: AccessibilityColors.kt, updated Theme.kt with CompositionLocalProvider, Settings toggle wired through the full UserPreferences -> PreferencesManager -> SettingsManager -> SettingsTab -> App.kt chain, and platform theme wrappers updated to forward colorBlindMode.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-wcag-accessibility/17-RESEARCH.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Color.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/App.kt
@androidApp/src/main/kotlin/com/devil/phoenixproject/ui/theme/AndroidTheme.kt
@shared/src/iosMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.ios.kt

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From shared/.../ui/theme/Theme.kt:
```kotlin
enum class ThemeMode { SYSTEM, LIGHT, DARK }

@Composable
fun VitruvianTheme(
    themeMode: ThemeMode = ThemeMode.SYSTEM,
    content: @Composable () -> Unit
)
// Currently uses MaterialTheme directly, no CompositionLocalProvider
```

From shared/.../domain/model/UserPreferences.kt:
```kotlin
data class UserPreferences(
    val weightUnit: WeightUnit = WeightUnit.LB,
    val stopAtTop: Boolean = false,
    val enableVideoPlayback: Boolean = true,
    val beepsEnabled: Boolean = true,
    val colorScheme: Int = 0,
    val stallDetectionEnabled: Boolean = true,
    val discoModeUnlocked: Boolean = false,
    val audioRepCountEnabled: Boolean = false,
    val ledFeedbackEnabled: Boolean = false,
    val summaryCountdownSeconds: Int = 10,
    val autoStartCountdownSeconds: Int = 5
)
```

From shared/.../data/preferences/PreferencesManager.kt:
```kotlin
// Interface + DefaultPreferencesManager implementation
// Pattern: KEY constant + suspend setter + loadPreferences() reader + updateAndEmit {}
// Example: KEY_LED_FEEDBACK_ENABLED = "led_feedback_enabled"
//          suspend fun setLedFeedbackEnabled(enabled: Boolean)
```

From shared/.../presentation/manager/SettingsManager.kt:
```kotlin
class SettingsManager(
    private val preferencesManager: PreferencesManager,
    private val bleRepository: BleRepository,
    private val scope: CoroutineScope
)
// Pattern: StateFlow + fun setter that launches coroutine
// Example: val ledFeedbackEnabled: StateFlow<Boolean>
//          fun setLedFeedbackEnabled(enabled: Boolean)
```

From shared/.../App.kt:
```kotlin
// Line 90: VitruvianTheme(themeMode = themeMode) {
// themeMode comes from ThemeViewModel collected as state
```

From androidApp/.../ui/theme/AndroidTheme.kt:
```kotlin
import com.devil.phoenixproject.ui.theme.VitruvianTheme as SharedVitruvianTheme
// Line 26: SharedVitruvianTheme(themeMode = themeMode) { ... }
// Needs to forward colorBlindMode parameter
```

From shared/.../ui/theme/Theme.ios.kt:
```kotlin
import com.devil.phoenixproject.ui.theme.VitruvianTheme as SharedVitruvianTheme
// Line 24: SharedVitruvianTheme(themeMode = themeMode) { ... }
// Needs to forward colorBlindMode parameter
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccessibilityColors data class with standard and deuteranopia palettes</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt</files>
  <action>
Create a new file `AccessibilityColors.kt` in the `ui/theme` package with:

1. **`@Immutable data class AccessibilityColors`** containing semantic color properties:
   - Semantic status: `success`, `error`, `warning`, `neutral`
   - Velocity zones: `zoneExplosive`, `zoneFast`, `zoneModerate`, `zoneSlow`, `zoneGrind`
   - Asymmetry severity: `asymmetryGood`, `asymmetryCaution`, `asymmetryBad`
   - Rep quality: `qualityExcellent`, `qualityGood`, `qualityFair`, `qualityBelowAverage`, `qualityPoor`
   - Reserved for future phases: `statusGreen`, `statusYellow`, `statusRed` (for readiness card, ghost racing)

2. **`StandardPalette`** -- extract EXACT existing hex values from current codebase (preserves current visual appearance):
   - success = `Color(0xFF22C55E)` (from Color.kt SignalSuccess)
   - error = `Color(0xFFEF4444)` (from Color.kt SignalError)
   - warning = `Color(0xFFF59E0B)` (from Color.kt SignalWarning)
   - Velocity zones: Use BiomechanicsHistoryCard mapping as canonical (Cyan/Green/Amber/Orange/Red) since it follows standard VBT convention. This resolves the pre-existing inconsistency where WorkoutHud used a different mapping.
   - zoneExplosive = `Color(0xFF06B6D4)` (Cyan -- fastest), zoneFast = `Color(0xFF22C55E)` (Green), zoneModerate = `Color(0xFFF59E0B)` (Amber), zoneSlow = `Color(0xFFF97316)` (Orange), zoneGrind = `Color(0xFFEF4444)` (Red -- near failure)
   - asymmetryGood = `Color(0xFF4CAF50)`, asymmetryCaution = `Color(0xFFFFC107)`, asymmetryBad = `Color(0xFFF44336)`
   - qualityExcellent = `Color(0xFF00E676)`, qualityGood = `Color(0xFF43A047)`, qualityFair = `Color(0xFFFDD835)`, qualityBelowAverage = `Color(0xFFFF9800)`, qualityPoor = `Color(0xFFE53935)`
   - statusGreen/Yellow/Red: match success/warning/error for now

3. **`ColorBlindPalette`** -- deuteranopia-safe (blue/orange axis):
   - success = `Color(0xFF2196F3)` (blue), error = `Color(0xFFFF9800)` (orange), warning = `Color(0xFFFDD835)` (yellow), neutral = `Color(0xFF9E9E9E)`
   - zoneExplosive = `Color(0xFF1565C0)` (dark blue), zoneFast = `Color(0xFF42A5F5)` (medium blue), zoneModerate = `Color(0xFFFDD835)` (yellow), zoneSlow = `Color(0xFFFF9800)` (orange), zoneGrind = `Color(0xFFE65100)` (deep orange)
   - asymmetryGood = `Color(0xFF2196F3)`, asymmetryCaution = `Color(0xFFFDD835)`, asymmetryBad = `Color(0xFFFF9800)`
   - qualityExcellent = `Color(0xFF1565C0)`, qualityGood = `Color(0xFF42A5F5)`, qualityFair = `Color(0xFFFDD835)`, qualityBelowAverage = `Color(0xFFFF9800)`, qualityPoor = `Color(0xFFE65100)`
   - statusGreen = blue, statusYellow = yellow, statusRed = orange

4. **CompositionLocals:**
   - `val LocalColorBlindMode = compositionLocalOf { false }` (dynamic -- triggers recomposition on toggle)
   - `val LocalAccessibilityColors = staticCompositionLocalOf { StandardPalette }` (static -- entire value swaps)

5. **`AccessibilityTheme` convenience object:**
   ```kotlin
   object AccessibilityTheme {
       val colors: AccessibilityColors
           @Composable @ReadOnlyComposable
           get() = LocalAccessibilityColors.current

       val isColorBlindMode: Boolean
           @Composable @ReadOnlyComposable
           get() = LocalColorBlindMode.current
   }
   ```

6. **Shared utility functions** (consolidating 3 duplicate functions from WorkoutHud, SetSummaryCard, BiomechanicsHistoryCard):
   ```kotlin
   @Composable
   fun velocityZoneColor(zone: BiomechanicsVelocityZone): Color {
       val colors = AccessibilityTheme.colors
       return when (zone) {
           BiomechanicsVelocityZone.EXPLOSIVE -> colors.zoneExplosive
           BiomechanicsVelocityZone.FAST -> colors.zoneFast
           BiomechanicsVelocityZone.MODERATE -> colors.zoneModerate
           BiomechanicsVelocityZone.SLOW -> colors.zoneSlow
           BiomechanicsVelocityZone.GRIND -> colors.zoneGrind
       }
   }

   fun velocityZoneLabel(zone: BiomechanicsVelocityZone): String = when (zone) {
       BiomechanicsVelocityZone.EXPLOSIVE -> "Explosive"
       BiomechanicsVelocityZone.FAST -> "Fast"
       BiomechanicsVelocityZone.MODERATE -> "Moderate"
       BiomechanicsVelocityZone.SLOW -> "Slow"
       BiomechanicsVelocityZone.GRIND -> "Grind"
   }
   ```

Import `BiomechanicsVelocityZone` from `com.devil.phoenixproject.domain.model`.

IMPORTANT: The `StandardPalette` velocity zone colors are intentionally aligned to the BiomechanicsHistoryCard mapping (Cyan=Explosive, Green=Fast, Amber=Moderate, Orange=Slow, Red=Grind). This resolves the pre-existing inconsistency where WorkoutHud/SetSummaryCard used a different (non-VBT-standard) mapping. This is a deliberate improvement, not a regression.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileCommonMainKotlinMetadata 2>&1 | tail -5</automated>
  </verify>
  <done>AccessibilityColors.kt exists with @Immutable data class, StandardPalette, ColorBlindPalette, LocalColorBlindMode, LocalAccessibilityColors, AccessibilityTheme object, shared velocityZoneColor() and velocityZoneLabel() functions. Compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire color-blind mode through Settings and Theme</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/App.kt
    androidApp/src/main/kotlin/com/devil/phoenixproject/ui/theme/AndroidTheme.kt
    shared/src/iosMain/kotlin/com/devil/phoenixproject/ui/theme/Theme.ios.kt
  </files>
  <action>
Follow the exact same pattern as `ledFeedbackEnabled` across all 8 files:

**1. UserPreferences.kt** -- Add field:
```kotlin
val colorBlindModeEnabled: Boolean = false  // Deuteranopia-safe palette (off by default)
```
Add it after `ledFeedbackEnabled` (before the countdown settings comment).

**2. PreferencesManager.kt** -- Add KEY, interface method, and implementation:
- Interface: Add `suspend fun setColorBlindModeEnabled(enabled: Boolean)` next to other setters
- Companion: Add `private const val KEY_COLOR_BLIND_MODE = "color_blind_mode_enabled"` next to other KEYs
- `loadPreferences()`: Add `colorBlindModeEnabled = settings.getBoolean(KEY_COLOR_BLIND_MODE, false)` to the constructor call
- Implementation: Add setter following the `setLedFeedbackEnabled` pattern:
  ```kotlin
  override suspend fun setColorBlindModeEnabled(enabled: Boolean) {
      settings.putBoolean(KEY_COLOR_BLIND_MODE, enabled)
      updateAndEmit { copy(colorBlindModeEnabled = enabled) }
  }
  ```

**3. SettingsManager.kt** -- Add StateFlow and setter:
```kotlin
val colorBlindModeEnabled: StateFlow<Boolean> = userPreferences
    .map { it.colorBlindModeEnabled }
    .stateIn(scope, SharingStarted.Eagerly, false)

fun setColorBlindModeEnabled(enabled: Boolean) {
    scope.launch { preferencesManager.setColorBlindModeEnabled(enabled) }
}
```
Place after `ledFeedbackEnabled` block.

**4. SettingsTab.kt** -- Add toggle switch in the Display/Appearance section:
- Collect `colorBlindModeEnabled` from SettingsManager
- Add a toggle row with:
  - Label: "Color-blind Mode"
  - Subtitle: "Deuteranopia-safe palette (blue/orange)"
  - Switch checked/onCheckedChange wired to SettingsManager
- Place it in the display/appearance preferences group (near the color scheme or LED feedback settings)

**5. Theme.kt** -- Modify `VitruvianTheme` to accept `colorBlindMode` parameter and provide CompositionLocals:
```kotlin
@Composable
fun VitruvianTheme(
    themeMode: ThemeMode = ThemeMode.SYSTEM,
    colorBlindMode: Boolean = false,
    content: @Composable () -> Unit
) {
    val useDarkColors = when (themeMode) { /* existing logic */ }
    val accessibilityColors = if (colorBlindMode) ColorBlindPalette else StandardPalette

    MaterialTheme(
        colorScheme = if (useDarkColors) DarkColorScheme else LightColorScheme,
        typography = Typography,
        shapes = ExpressiveShapes,
    ) {
        CompositionLocalProvider(
            LocalColorBlindMode provides colorBlindMode,
            LocalAccessibilityColors provides accessibilityColors,
            content = content
        )
    }
}
```
Import `CompositionLocalProvider`, `LocalColorBlindMode`, `LocalAccessibilityColors`, `StandardPalette`, `ColorBlindPalette` from the same package.

**6. App.kt** -- Collect `colorBlindModeEnabled` and pass to `VitruvianTheme`:
- Get SettingsManager from Koin (may already be available via `viewModel` or direct `koinInject<SettingsManager>()`)
- Collect as state: `val colorBlindModeEnabled by settingsManager.colorBlindModeEnabled.collectAsState()`
- Pass to theme: `VitruvianTheme(themeMode = themeMode, colorBlindMode = colorBlindModeEnabled)`

**7. AndroidTheme.kt** -- Forward `colorBlindMode` parameter:
```kotlin
@Composable
fun VitruvianTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    dynamicColor: Boolean = false,
    colorBlindMode: Boolean = false,
    content: @Composable () -> Unit
) {
    val themeMode = if (darkTheme) SharedThemeMode.DARK else SharedThemeMode.LIGHT
    SharedVitruvianTheme(themeMode = themeMode, colorBlindMode = colorBlindMode) {
        // ... existing status bar logic ...
        content()
    }
}
```

**8. Theme.ios.kt** -- Forward `colorBlindMode` parameter:
```kotlin
@Composable
fun VitruvianTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    colorBlindMode: Boolean = false,
    content: @Composable () -> Unit
) {
    val themeMode = if (darkTheme) SharedThemeMode.DARK else SharedThemeMode.LIGHT
    SharedVitruvianTheme(themeMode = themeMode, colorBlindMode = colorBlindMode) {
        content()
    }
}
```

NOTE: App.kt calls the shared `VitruvianTheme` directly (not the Android/iOS wrappers), so the critical path is App.kt -> shared Theme.kt. The Android/iOS wrappers are used by platform-specific entry points (MainActivity, iOSApp) which may or may not pass colorBlindMode -- their defaults of `false` are correct since those entry points delegate to App.kt anyway.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug 2>&1 | tail -10</automated>
  </verify>
  <done>Color-blind mode toggle appears in Settings. Toggling it persists across app restarts. VitruvianTheme provides LocalColorBlindMode and LocalAccessibilityColors to all composables. Android and iOS theme wrappers accept the new parameter. Full project compiles without errors.</done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:assembleDebug` compiles successfully
2. `AccessibilityColors.kt` contains `@Immutable data class AccessibilityColors`, `StandardPalette`, `ColorBlindPalette`, `LocalColorBlindMode`, `LocalAccessibilityColors`, `AccessibilityTheme` object, `velocityZoneColor()`, and `velocityZoneLabel()`
3. `Theme.kt` `VitruvianTheme` has `colorBlindMode: Boolean` parameter and `CompositionLocalProvider` wrapping content
4. `UserPreferences.kt` has `colorBlindModeEnabled: Boolean = false`
5. `PreferencesManager.kt` has `KEY_COLOR_BLIND_MODE` and `setColorBlindModeEnabled()`
6. `SettingsManager.kt` has `colorBlindModeEnabled: StateFlow<Boolean>` and `setColorBlindModeEnabled()`
7. `SettingsTab.kt` has a "Color-blind Mode" toggle row
8. `App.kt` passes `colorBlindMode` to `VitruvianTheme`
9. `AndroidTheme.kt` and `Theme.ios.kt` accept and forward `colorBlindMode` parameter
</verification>

<success_criteria>
- AccessibilityColors infrastructure fully wired from settings persistence through theme to CompositionLocal availability
- Settings toggle is functional with "Color-blind Mode" label and "Deuteranopia-safe palette (blue/orange)" subtitle
- Default is OFF (standard palette) -- no visual changes to existing users
- Full project compiles on both Android and iOS build targets
</success_criteria>

<output>
After completion, create `.planning/phases/17-wcag-accessibility/17-01-SUMMARY.md`
</output>

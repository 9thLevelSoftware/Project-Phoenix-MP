---
phase: 16-foundation-board-conditions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt
  - androidApp/build.gradle.kts
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngineTest.kt
autonomous: true
requirements:
  - BOARD-09
  - BOARD-07
  - BOARD-01

must_haves:
  truths:
    - "FeatureGate correctly gates CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING at PHOENIX tier and READINESS_BRIEFING at ELITE tier"
    - "FREE users cannot access any of the four new features"
    - "versionName reads 0.5.1 in build.gradle.kts and appears correctly in Settings screen"
    - "classifyTimeWindow() returns correct window for local time, not UTC"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt"
      provides: "Four new Feature enum entries with correct tier assignments"
      contains: "CV_FORM_CHECK"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt"
      provides: "Tests for new feature tier assignments"
      contains: "CV_FORM_CHECK"
    - path: "androidApp/build.gradle.kts"
      provides: "Updated versionName and versionCode"
      contains: "0.5.1"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt"
      provides: "Updated APP_VERSION constant"
      contains: "0.5.1"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt"
      provides: "Local timezone conversion in classifyTimeWindow"
      contains: "TimeZone"
  key_links:
    - from: "FeatureGate.kt"
      to: "FeatureGateTest.kt"
      via: "Test coverage for new features"
      pattern: "Feature\\.CV_FORM_CHECK|Feature\\.RPG_ATTRIBUTES|Feature\\.GHOST_RACING|Feature\\.READINESS_BRIEFING"
    - from: "SmartSuggestionsEngine.kt"
      to: "SmartSuggestionsEngineTest.kt"
      via: "Test coverage for timezone fix"
      pattern: "classifyTimeWindow.*TimeZone"
    - from: "Constants.kt"
      to: "SettingsTab.kt"
      via: "DeviceInfo.appVersionName replaces hardcoded version"
      pattern: "DeviceInfo\\.appVersionName"
---

<objective>
Add four new FeatureGate entries for v0.5.1 premium features, bump version to 0.5.1, and fix the UTC timezone bug in SmartSuggestions.

Purpose: Downstream phases (19-22) depend on FeatureGate entries existing. The version and UTC bugs are Board of Directors conditions that must be resolved before shipping. These are all shared-module domain/config changes with no Android-specific XML or UI layout work.

Output: Updated FeatureGate with 4 new features, version bumped to 0.5.1 across all 3 locations, classifyTimeWindow using local time with timezone-injectable tests.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-foundation-board-conditions/16-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt:
```kotlin
object FeatureGate {
    enum class Feature {
        FORCE_CURVES, PER_REP_METRICS, VBT_METRICS, PORTAL_SYNC,
        LED_BIOFEEDBACK, REP_QUALITY_SCORE,
        ASYMMETRY_ANALYSIS, AUTO_REGULATION, SMART_SUGGESTIONS,
        WORKOUT_REPLAY, STRENGTH_ASSESSMENT, PORTAL_ADVANCED_ANALYTICS
    }
    private val phoenixFeatures = setOf(
        Feature.FORCE_CURVES, Feature.PER_REP_METRICS, Feature.VBT_METRICS,
        Feature.PORTAL_SYNC, Feature.LED_BIOFEEDBACK, Feature.REP_QUALITY_SCORE
    )
    private val eliteFeatures = phoenixFeatures + setOf(
        Feature.ASYMMETRY_ANALYSIS, Feature.AUTO_REGULATION, Feature.SMART_SUGGESTIONS,
        Feature.WORKOUT_REPLAY, Feature.STRENGTH_ASSESSMENT, Feature.PORTAL_ADVANCED_ANALYTICS
    )
    fun isEnabled(feature: Feature, tier: SubscriptionTier): Boolean
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt (lines 255-263):
```kotlin
// BUG: Uses UTC hour, not local hour
private fun classifyTimeWindow(timestampMs: Long): TimeWindow {
    val hourOfDay = ((timestampMs % ONE_DAY_MS) / ONE_HOUR_MS).toInt()
    return when (hourOfDay) {
        in 5..6 -> TimeWindow.EARLY_MORNING
        in 7..9 -> TimeWindow.MORNING
        in 10..14 -> TimeWindow.AFTERNOON
        in 15..19 -> TimeWindow.EVENING
        else -> TimeWindow.NIGHT
    }
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/util/DeviceInfo.kt:
```kotlin
expect object DeviceInfo {
    val appVersionName: String
    val appVersionCode: Int
    // ...
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt:
```kotlin
object Constants {
    const val APP_VERSION = "0.4.0"  // Must become "0.5.1"
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FeatureGate with v0.5.1 premium features and update tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt
  </files>
  <action>
In FeatureGate.kt:
1. Add four new entries to the `Feature` enum. Place them in logical groups with comments:
   - After existing Phoenix features (REP_QUALITY_SCORE): add `CV_FORM_CHECK`, `RPG_ATTRIBUTES`, `GHOST_RACING` with a comment `// New Phoenix tier features (v0.5.1)`
   - After existing Elite features (PORTAL_ADVANCED_ANALYTICS): add `READINESS_BRIEFING` with a comment `// New Elite tier feature (v0.5.1)`

2. Add CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING to the `phoenixFeatures` set.

3. Add READINESS_BRIEFING to the elite-only set within `eliteFeatures`. Since `eliteFeatures = phoenixFeatures + setOf(...)`, just add `Feature.READINESS_BRIEFING` to the elite-only setOf.

In FeatureGateTest.kt:
4. In the `PHOENIX tier has phoenix features enabled` test: add CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING to the `phoenixFeatures` list.

5. In the `PHOENIX tier does not have elite-only features` test: add READINESS_BRIEFING to the `eliteOnlyFeatures` list.

6. Add a new test `PHOENIX tier has v0.5.1 phoenix features` that explicitly asserts:
   - `FeatureGate.isEnabled(Feature.CV_FORM_CHECK, SubscriptionTier.PHOENIX)` is true
   - `FeatureGate.isEnabled(Feature.RPG_ATTRIBUTES, SubscriptionTier.PHOENIX)` is true
   - `FeatureGate.isEnabled(Feature.GHOST_RACING, SubscriptionTier.PHOENIX)` is true

7. Add a new test `READINESS_BRIEFING is elite-only` that asserts:
   - `FeatureGate.isEnabled(Feature.READINESS_BRIEFING, SubscriptionTier.PHOENIX)` is false
   - `FeatureGate.isEnabled(Feature.READINESS_BRIEFING, SubscriptionTier.ELITE)` is true

The existing `FREE tier has no premium features enabled` and `ELITE tier has all features enabled` tests use `Feature.entries.forEach`, so they auto-cover the new entries without modification.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.FeatureGateTest" --no-daemon -q 2>&1 | tail -20</automated>
  </verify>
  <done>
    - Feature enum has 16 entries (12 existing + 4 new)
    - phoenixFeatures contains CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING
    - eliteFeatures contains READINESS_BRIEFING (plus all phoenix features)
    - All FeatureGateTest tests pass, including two new explicit tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Bump version to 0.5.1 across all locations</name>
  <files>
    androidApp/build.gradle.kts
    shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  </files>
  <action>
1. In `androidApp/build.gradle.kts`:
   - Change `versionName = "0.4.0"` to `versionName = "0.5.1"` (line 17)
   - Change the default versionCode from `3` to `4` in the `?: 3` fallback (line 16): `?: 4`

2. In `shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt`:
   - Change `const val APP_VERSION = "0.4.0"` to `const val APP_VERSION = "0.5.1"` (line 8)

3. In `shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt`:
   - Replace the hardcoded `Text("Version: 0.4.0", ...)` (line 1381) with `Text("Version: ${DeviceInfo.appVersionName}", color = MaterialTheme.colorScheme.onSurface)`
   - Add import at top of file: `import com.devil.phoenixproject.util.DeviceInfo`
   - This ensures Settings always reflects the canonical version from DeviceInfo/Constants

NOTE: The existing `applicationVariants.all` APK renaming block in build.gradle.kts references `variant.versionName` which uses `BaseVariantOutputImpl`. This is a known AGP 9.0 issue per MEMORY.md but is a pre-existing concern, not part of this task. Leave it unchanged.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && grep -n "versionName" androidApp/build.gradle.kts | head -5 && grep -n "APP_VERSION" shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt && grep -n "DeviceInfo" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt | head -5</automated>
  </verify>
  <done>
    - build.gradle.kts shows versionName = "0.5.1" and default versionCode = 4
    - Constants.kt shows APP_VERSION = "0.5.1"
    - SettingsTab.kt uses DeviceInfo.appVersionName instead of hardcoded string
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix UTC timezone bug in SmartSuggestions classifyTimeWindow</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngineTest.kt
  </files>
  <action>
In SmartSuggestionsEngine.kt:
1. Add imports at the top of the file:
   ```kotlin
   import kotlin.time.Instant
   import kotlinx.datetime.TimeZone
   import kotlinx.datetime.toLocalDateTime
   ```
   NOTE: Use `kotlin.time.Instant` (NOT `kotlinx.datetime.Instant`). Per project convention with kotlinx-datetime 0.7.1, `Instant` is promoted to `kotlin.time`. The rest of the kotlinx.datetime imports (TimeZone, toLocalDateTime) remain correct.

2. Change `classifyTimeWindow` from `private` to `internal` and add a `TimeZone` parameter with default:
   ```kotlin
   internal fun classifyTimeWindow(
       timestampMs: Long,
       timeZone: TimeZone = TimeZone.currentSystemDefault()
   ): TimeWindow {
       val instant = Instant.fromEpochMilliseconds(timestampMs)
       val localDateTime = instant.toLocalDateTime(timeZone)
       val hourOfDay = localDateTime.hour
       return when (hourOfDay) {
           in 5..6 -> TimeWindow.EARLY_MORNING
           in 7..9 -> TimeWindow.MORNING
           in 10..14 -> TimeWindow.AFTERNOON
           in 15..19 -> TimeWindow.EVENING
           else -> TimeWindow.NIGHT
       }
   }
   ```

3. Update the KDoc comment above classifyTimeWindow: change "based on hour of day (UTC)" to "based on local hour of day" and note the injectable TimeZone parameter for testing.

4. Remove the now-unused `ONE_DAY_MS` and `ONE_HOUR_MS` constants ONLY if they are not used elsewhere in the file. Check all usages first -- `ONE_DAY_MS` is likely used in `computeWeeklyVolume` and elsewhere, so it should be kept. Only remove constants that have zero remaining usages.

In SmartSuggestionsEngineTest.kt:
5. Add imports:
   ```kotlin
   import kotlinx.datetime.TimeZone
   ```

6. The existing time-of-day tests use `baseTime + N * ONE_HOUR_MS` to construct timestamps, which creates UTC-based times. These tests implicitly test in whatever timezone the CI/dev machine runs. To make them timezone-deterministic, update the SUGG-05 time-of-day tests to call `SmartSuggestionsEngine.classifyTimeWindow()` directly with an explicit timezone.

7. Add a dedicated test section for classifyTimeWindow with explicit timezone injection. All epoch values below have been verified:
   ```kotlin
   // ========== classifyTimeWindow timezone fix (BOARD-01) ==========

   @Test
   fun classifyTimeWindowUsesLocalTime() {
       // 2023-11-15 08:00:00 UTC = 18:00 in UTC+10 (AEDT)
       val utc8am = 1_700_035_200_000L
       val utcPlus10 = TimeZone.of("Australia/Melbourne")
       // In UTC+10, 8am UTC is 6pm local -> EVENING (15..19)
       val result = SmartSuggestionsEngine.classifyTimeWindow(utc8am, utcPlus10)
       assertEquals(TimeWindow.EVENING, result)
   }

   @Test
   fun classifyTimeWindowMorningInUtc() {
       // 2023-11-15 08:00:00 UTC
       val utc8am = 1_700_035_200_000L
       val utc = TimeZone.UTC
       val result = SmartSuggestionsEngine.classifyTimeWindow(utc8am, utc)
       assertEquals(TimeWindow.MORNING, result)
   }

   @Test
   fun classifyTimeWindowNightCrossover() {
       // 2023-11-15 23:00:00 UTC = 10:00 next day in UTC+11
       val utc11pm = 1_700_089_200_000L
       val utcPlus11 = TimeZone.of("Pacific/Noumea")
       // In UTC+11, 11pm UTC is 10am next day -> AFTERNOON (10..14)
       val result = SmartSuggestionsEngine.classifyTimeWindow(utc11pm, utcPlus11)
       assertEquals(TimeWindow.AFTERNOON, result)
   }
   ```

The existing `analyzeTimeOfDay` tests may continue to work as-is since they test the full analysis pipeline (which now uses local time internally). If any existing time-of-day test fails after the change, update it to pass an explicit TimeZone through the pipeline or adjust the expected results.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.SmartSuggestionsEngineTest" --no-daemon -q 2>&1 | tail -20</automated>
  </verify>
  <done>
    - classifyTimeWindow uses kotlin.time.Instant (project convention) with toLocalDateTime and TimeZone parameter
    - classifyTimeWindow is internal (not private) for direct test access
    - Three new timezone-specific tests pass with verified epoch values, proving local time is used
    - All existing SmartSuggestionsEngine tests still pass
    - A user in UTC+10 training at 6pm local no longer gets classified as MORNING
  </done>
</task>

</tasks>

<verification>
1. All FeatureGateTest tests pass: `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.FeatureGateTest"`
2. All SmartSuggestionsEngineTest tests pass: `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.SmartSuggestionsEngineTest"`
3. Version strings consistent: `grep -r "0.5.1" androidApp/build.gradle.kts shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt` returns matches in both files
4. No remaining "0.4.0" in modified files: `grep -r "0.4.0" androidApp/build.gradle.kts shared/src/commonMain/kotlin/com/devil/phoenixproject/util/Constants.kt shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt` returns no matches
5. Build compiles: `./gradlew :shared:compileDebugKotlinAndroid :androidApp:assembleDebug`
</verification>

<success_criteria>
- FeatureGate.Feature enum has CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING, READINESS_BRIEFING
- PHOENIX tier enables CV_FORM_CHECK, RPG_ATTRIBUTES, GHOST_RACING; does NOT enable READINESS_BRIEFING
- ELITE tier enables all 16 features; FREE tier enables none
- versionName is "0.5.1" in build.gradle.kts, Constants.kt uses "0.5.1", SettingsTab reads from DeviceInfo
- classifyTimeWindow converts epoch to local time using kotlin.time.Instant + kotlinx-datetime, not UTC modular arithmetic
- All existing and new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-foundation-board-conditions/16-01-SUMMARY.md`
</output>

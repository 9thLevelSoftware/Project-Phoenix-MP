---
phase: 16-foundation-board-conditions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - androidApp/src/main/res/xml/backup_rules.xml
  - androidApp/src/main/res/xml/data_extraction_rules.xml
  - androidApp/src/main/AndroidManifest.xml
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/Platform.android.kt
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/Platform.ios.kt
autonomous: true
requirements:
  - BOARD-03
  - BOARD-05
  - BOARD-06
  - BOARD-08

must_haves:
  truths:
    - "VitruvianDatabase and sensitive preferences are excluded from Android auto-backup on both API 30 and API 31+ devices"
    - "Camera permission dialog displays custom rationale text explaining on-device-only CV processing"
    - "PoseLandmarkerHelper displays a user-facing error message instead of crashing when asset is missing"
    - "iOS PHOENIX tier upgrade prompts do not mention Form Check as a feature"
  artifacts:
    - path: "androidApp/src/main/res/xml/backup_rules.xml"
      provides: "API 23-30 backup exclusion rules for database and preferences"
      contains: "vitruvian.db"
    - path: "androidApp/src/main/res/xml/data_extraction_rules.xml"
      provides: "API 31+ data extraction rules for database and preferences"
      contains: "vitruvian.db"
    - path: "androidApp/src/main/AndroidManifest.xml"
      provides: "Manifest references to both backup exclusion XML files"
      contains: "fullBackupContent"
    - path: "shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt"
      provides: "Graceful error handling for missing model asset"
      contains: "listener.onError"
    - path: "shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt"
      provides: "Camera permission rationale dialog and error state display"
      contains: "CameraPermissionRationale"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt"
      provides: "Platform detection expect val for iOS suppression"
      contains: "isIosPlatform"
  key_links:
    - from: "AndroidManifest.xml"
      to: "backup_rules.xml"
      via: "android:fullBackupContent attribute reference"
      pattern: "@xml/backup_rules"
    - from: "AndroidManifest.xml"
      to: "data_extraction_rules.xml"
      via: "android:dataExtractionRules attribute reference"
      pattern: "@xml/data_extraction_rules"
    - from: "PoseLandmarkerHelper.kt"
      to: "FormCheckOverlay.android.kt"
      via: "listener.onError propagates to error state display"
      pattern: "listener\\.onError|errorMessage"
    - from: "FormCheckOverlay.android.kt"
      to: "PoseLandmarkerHelper.kt"
      via: "setupPoseLandmarker error handling chain"
      pattern: "setupPoseLandmarker|onError"
---

<objective>
Implement Android backup exclusion, camera permission rationale, PoseLandmarkerHelper error handling, and iOS form check suppression infrastructure.

Purpose: These are Board of Directors security, UX, and platform-correctness conditions. Backup exclusion prevents sensitive data leakage. Camera rationale builds user trust. Error handling prevents crashes. iOS suppression prevents misleading feature claims.

Output: Two backup exclusion XMLs + manifest attributes, camera rationale dialog in FormCheckOverlay, graceful error display in PoseLandmarkerHelper/FormCheckOverlay, and `isIosPlatform` expect/actual for Phase 19 to use.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-foundation-board-conditions/16-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt:
```kotlin
class PoseLandmarkerHelper(
    private val context: Context,
    private val listener: PoseLandmarkerListener,
    // ...
) {
    fun setupPoseLandmarker() {
        // Currently throws RuntimeException if asset missing -- NO try-catch
        poseLandmarker = PoseLandmarker.createFromOptions(context, options)
    }

    interface PoseLandmarkerListener {
        fun onResults(normalizedLandmarks: List<NormalizedLandmark>, worldLandmarks: List<Landmark>?, timestampMs: Long)
        fun onEmpty()
        fun onError(error: String)
    }
}
```

From shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt:
```kotlin
// Current permission handling -- no rationale dialog:
val permissionLauncher = rememberLauncherForActivityResult(
    ActivityResultContracts.RequestPermission()
) { granted -> hasCameraPermission = granted }

LaunchedEffect(Unit) {
    if (!hasCameraPermission) {
        permissionLauncher.launch(Manifest.permission.CAMERA)
    }
}

// Current error handling -- logs only, no user-facing message:
LaunchedEffect(Unit) {
    try {
        poseLandmarkerHelper.setupPoseLandmarker()
    } catch (e: Exception) {
        co.touchlab.kermit.Logger.e("FormCheckOverlay") { "Failed to init PoseLandmarker: ${e.message}" }
    }
}
```

From androidApp/src/main/AndroidManifest.xml:
```xml
<application
    android:name=".VitruvianApp"
    android:allowBackup="true"
    <!-- NO fullBackupContent or dataExtractionRules attributes yet -->
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt:
```kotlin
interface Platform { val name: String }
expect fun getDeviceName(): String
expect fun getPlatform(): Platform
// No isIosPlatform expect val yet
```

From shared/src/androidMain/kotlin/com/devil/phoenixproject/Platform.android.kt:
```kotlin
actual fun getDeviceName(): String = "${Build.MANUFACTURER} ${Build.MODEL}"
class AndroidPlatform : Platform { override val name: String = "Android ${Build.VERSION.SDK_INT}" }
actual fun getPlatform(): Platform = AndroidPlatform()
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Android backup exclusion for database and preferences</name>
  <files>
    androidApp/src/main/res/xml/backup_rules.xml
    androidApp/src/main/res/xml/data_extraction_rules.xml
    androidApp/src/main/AndroidManifest.xml
  </files>
  <action>
1. Create `androidApp/src/main/res/xml/backup_rules.xml` (for API 23-30):
   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <full-backup-content>
       <exclude domain="database" path="vitruvian.db" />
       <exclude domain="database" path="vitruvian.db-journal" />
       <exclude domain="database" path="vitruvian.db-wal" />
       <exclude domain="database" path="vitruvian.db-shm" />
       <exclude domain="sharedpref" path="vitruvian_preferences.xml" />
   </full-backup-content>
   ```
   Include WAL/SHM/journal files because SQLite in WAL mode creates these companion files that also contain user data.

   The database name "vitruvian.db" comes from `DriverFactory.android.kt` line 15. The preferences file "vitruvian_preferences.xml" comes from `PlatformModule.android.kt` line 23.

2. Create `androidApp/src/main/res/xml/data_extraction_rules.xml` (for API 31+):
   ```xml
   <?xml version="1.0" encoding="utf-8"?>
   <data-extraction-rules>
       <cloud-backup>
           <exclude domain="database" path="vitruvian.db" />
           <exclude domain="database" path="vitruvian.db-journal" />
           <exclude domain="database" path="vitruvian.db-wal" />
           <exclude domain="database" path="vitruvian.db-shm" />
           <exclude domain="sharedpref" path="vitruvian_preferences.xml" />
       </cloud-backup>
       <device-transfer>
           <exclude domain="database" path="vitruvian.db" />
           <exclude domain="database" path="vitruvian.db-journal" />
           <exclude domain="database" path="vitruvian.db-wal" />
           <exclude domain="database" path="vitruvian.db-shm" />
           <exclude domain="sharedpref" path="vitruvian_preferences.xml" />
       </device-transfer>
   </data-extraction-rules>
   ```
   Exclude from BOTH cloud-backup AND device-transfer per research (preferences contain portal_auth_token).

3. Update `androidApp/src/main/AndroidManifest.xml` `<application>` tag. Add two attributes AFTER `android:allowBackup="true"`:
   ```xml
   android:fullBackupContent="@xml/backup_rules"
   android:dataExtractionRules="@xml/data_extraction_rules"
   ```
   Keep `android:allowBackup="true"` so non-sensitive data (app settings, themes) can still be backed up. The exclusion rules specifically target the database and sensitive preferences.

CRITICAL: Both XML files MUST be provided. `fullBackupContent` is used on API 23-30, `dataExtractionRules` on API 31+. The app targets compileSdk 36 but minSdk 26, so both are needed.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && test -f androidApp/src/main/res/xml/backup_rules.xml && test -f androidApp/src/main/res/xml/data_extraction_rules.xml && grep -c "fullBackupContent" androidApp/src/main/AndroidManifest.xml && grep -c "dataExtractionRules" androidApp/src/main/AndroidManifest.xml && echo "All backup exclusion files present and manifest updated"</automated>
  </verify>
  <done>
    - backup_rules.xml exists with vitruvian.db and vitruvian_preferences.xml exclusions
    - data_extraction_rules.xml exists with both cloud-backup and device-transfer exclusions
    - AndroidManifest.xml references both XML files via fullBackupContent and dataExtractionRules attributes
    - android:allowBackup remains "true" (targeted exclusion, not blanket disable)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add camera permission rationale and PoseLandmarkerHelper error handling</name>
  <files>
    shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt
    shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt
  </files>
  <action>
**PoseLandmarkerHelper.kt changes:**

1. Wrap the `PoseLandmarker.createFromOptions(context, options)` call in `setupPoseLandmarker()` in a try-catch:
   ```kotlin
   fun setupPoseLandmarker() {
       try {
           val baseOptions = BaseOptions.builder()
               .setModelAssetPath(modelName)
               .setDelegate(Delegate.CPU)
               .build()

           val options = PoseLandmarker.PoseLandmarkerOptions.builder()
               .setBaseOptions(baseOptions)
               .setMinPoseDetectionConfidence(minDetectionConfidence)
               .setMinTrackingConfidence(minTrackingConfidence)
               .setMinPosePresenceConfidence(minPresenceConfidence)
               .setRunningMode(RunningMode.LIVE_STREAM)
               .setResultListener(this::handleResult)
               .setErrorListener(this::handleError)
               .build()

           poseLandmarker = PoseLandmarker.createFromOptions(context, options)
       } catch (e: Exception) {
           co.touchlab.kermit.Logger.e("PoseLandmarkerHelper") {
               "Failed to initialize PoseLandmarker: ${e.message}"
           }
           listener.onError(
               "Form Check model not available. Please reinstall the app to restore this feature."
           )
       }
   }
   ```
   Add Kermit import: `import co.touchlab.kermit.Logger`

**FormCheckOverlay.android.kt changes:**

2. Add an error state variable alongside the existing `currentLandmarks`:
   ```kotlin
   var errorMessage by remember { mutableStateOf<String?>(null) }
   ```

3. Update the PoseLandmarkerListener.onError callback to set errorMessage:
   ```kotlin
   override fun onError(error: String) {
       co.touchlab.kermit.Logger.w("FormCheckOverlay") { "Pose detection error: $error" }
       // Only set error message for initialization failures (user-facing)
       if (error.contains("not available") || error.contains("model")) {
           errorMessage = error
       }
       currentLandmarks = null
   }
   ```

4. Remove the try-catch from the LaunchedEffect that calls `setupPoseLandmarker()` -- the error is now handled internally by PoseLandmarkerHelper and propagated via onError:
   ```kotlin
   LaunchedEffect(Unit) {
       poseLandmarkerHelper.setupPoseLandmarker()
   }
   ```

5. Add error state rendering BEFORE the permission check render block. If errorMessage is set, show it instead of the camera preview:
   ```kotlin
   if (errorMessage != null) {
       Box(
           modifier = modifier
               .size(160.dp, 120.dp)
               .clip(RoundedCornerShape(12.dp))
               .background(MaterialTheme.colorScheme.errorContainer),
           contentAlignment = Alignment.Center
       ) {
           Text(
               text = errorMessage!!,
               style = MaterialTheme.typography.labelSmall,
               color = MaterialTheme.colorScheme.onErrorContainer,
               textAlign = TextAlign.Center,
               modifier = Modifier.padding(8.dp)
           )
       }
       return
   }
   ```
   Add import: `import androidx.compose.ui.text.style.TextAlign`

6. **Camera permission rationale (BOARD-05):** Replace the aggressive "request on first composition" pattern with a rationale-first flow. Get Activity context for `shouldShowRequestPermissionRationale`:

   a. Add a `showRationale` state: `var showRationale by remember { mutableStateOf(false) }`

   b. Replace the LaunchedEffect permission request with a smarter flow:
   ```kotlin
   LaunchedEffect(Unit) {
       if (!hasCameraPermission) {
           val activity = context as? android.app.Activity
           if (activity != null && activity.shouldShowRequestPermissionRationale(Manifest.permission.CAMERA)) {
               showRationale = true
           } else {
               // First time or permanently denied -- show rationale before requesting
               showRationale = true
           }
       }
   }
   ```

   c. When `!hasCameraPermission`, render a rationale box instead of just "Camera access required":
   ```kotlin
   if (!hasCameraPermission) {
       Box(
           modifier = modifier
               .size(160.dp, 120.dp)
               .clip(RoundedCornerShape(12.dp))
               .background(MaterialTheme.colorScheme.surfaceVariant),
           contentAlignment = Alignment.Center
       ) {
           Column(
               horizontalAlignment = Alignment.CenterHorizontally,
               verticalArrangement = Arrangement.Center,
               modifier = Modifier.padding(8.dp)
           ) {
               Icon(
                   imageVector = Icons.Default.CameraAlt,
                   contentDescription = null,
                   modifier = Modifier.size(24.dp),
                   tint = MaterialTheme.colorScheme.onSurfaceVariant
               )
               Spacer(modifier = Modifier.height(4.dp))
               Text(
                   text = "Camera needed for Form Check.\nAll processing stays on your device.",
                   style = MaterialTheme.typography.labelSmall,
                   textAlign = TextAlign.Center,
                   color = MaterialTheme.colorScheme.onSurfaceVariant
               )
               Spacer(modifier = Modifier.height(4.dp))
               TextButton(onClick = { permissionLauncher.launch(Manifest.permission.CAMERA) }) {
                   Text("Allow Camera")
               }
           }
       }
   }
   ```
   Add imports: `import androidx.compose.material.icons.Icons`, `import androidx.compose.material.icons.filled.CameraAlt`, `import androidx.compose.material3.TextButton`, `import androidx.compose.material3.Icon`, `import androidx.compose.foundation.layout.Column`, `import androidx.compose.foundation.layout.Arrangement`, `import androidx.compose.foundation.layout.Spacer`, `import androidx.compose.foundation.layout.height`, `import androidx.compose.foundation.layout.padding`

   Check existing imports first -- several of these (Column, Spacer, etc.) may already be imported. Only add missing ones.

IMPORTANT: The rationale text per BOARD-05 must communicate that "All processing happens entirely on your device" -- this is the on-device guarantee the Board requires.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && grep -c "listener.onError" shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt && grep -c "errorMessage" shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt && grep -c "All processing stays on your device" shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt && echo "Error handling and rationale text present"</automated>
  </verify>
  <done>
    - PoseLandmarkerHelper.setupPoseLandmarker() catches exceptions and calls listener.onError with user-friendly message
    - FormCheckOverlay shows errorMessage in error-styled box when PoseLandmarker initialization fails
    - Camera permission shows rationale with on-device processing guarantee text and "Allow Camera" button
    - No crash when pose_landmarker_lite.task asset is missing
  </done>
</task>

<task type="auto">
  <name>Task 3: Add isIosPlatform expect/actual for iOS form check suppression</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt
    shared/src/androidMain/kotlin/com/devil/phoenixproject/Platform.android.kt
    shared/src/iosMain/kotlin/com/devil/phoenixproject/Platform.ios.kt
  </files>
  <action>
BOARD-06 requires iOS PHOENIX tier upgrade prompts to not mention Form Check. The research found that the current PaywallScreen does NOT list Form Check at all, and PremiumFeatureGate is a generic wrapper that accepts featureName as a parameter. So the primary work for BOARD-06 is establishing the platform detection infrastructure that Phase 19 will use when it adds the Form Check toggle (CV-01/CV-10).

1. In `shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt`, add below the existing `expect fun getPlatform(): Platform`:
   ```kotlin
   /**
    * Whether the current platform is iOS.
    * Used for platform-conditional feature availability (e.g., BOARD-06: iOS Form Check suppression).
    */
   expect val isIosPlatform: Boolean
   ```

2. In `shared/src/androidMain/kotlin/com/devil/phoenixproject/Platform.android.kt`, add:
   ```kotlin
   actual val isIosPlatform: Boolean = false
   ```

3. In `shared/src/iosMain/kotlin/com/devil/phoenixproject/Platform.ios.kt`, add:
   ```kotlin
   actual val isIosPlatform: Boolean = true
   ```

4. Audit for existing Form Check mentions in tier feature lists. Check these files for any "Form Check" text in feature descriptions visible to users:
   - PaywallScreen.kt -- Already confirmed: does NOT mention Form Check
   - PremiumFeatureGate.kt -- Generic wrapper, no feature list
   - GamificationTab / SmartInsightsTab / NavGraph.kt -- Check for feature list strings

   If any file lists "Form Check" as a PHOENIX feature benefit, add a platform guard:
   ```kotlin
   if (!isIosPlatform) {
       // Show Form Check in feature list
   }
   ```

   Based on research, no such list currently exists, so this step is likely a no-op verification. Document the audit results in the SUMMARY.

5. Add a brief KDoc comment to `isIosPlatform` noting it is used by BOARD-06 and will be consumed by Phase 19's Form Check toggle to show "Coming soon" on iOS instead of enabling the camera.

This task establishes the infrastructure. The actual "Coming soon" message will be added in Phase 19 (CV-10) when the Form Check toggle UI is created.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && grep -c "isIosPlatform" shared/src/commonMain/kotlin/com/devil/phoenixproject/Platform.kt && grep -c "isIosPlatform" shared/src/androidMain/kotlin/com/devil/phoenixproject/Platform.android.kt && grep -c "isIosPlatform" shared/src/iosMain/kotlin/com/devil/phoenixproject/Platform.ios.kt && ./gradlew :shared:compileDebugKotlinAndroid --no-daemon -q 2>&1 | tail -10</automated>
  </verify>
  <done>
    - Platform.kt declares `expect val isIosPlatform: Boolean`
    - Platform.android.kt provides `actual val isIosPlatform: Boolean = false`
    - Platform.ios.kt provides `actual val isIosPlatform: Boolean = true`
    - Shared module compiles successfully with new expect/actual
    - Audit confirms no iOS-visible UI lists Form Check as a tier feature, OR any found instances are now guarded with `if (!isIosPlatform)`
    - Infrastructure ready for Phase 19 to use `isIosPlatform` in Form Check toggle
  </done>
</task>

</tasks>

<verification>
1. Backup exclusion files exist and manifest references them: `grep "fullBackupContent\|dataExtractionRules" androidApp/src/main/AndroidManifest.xml`
2. PoseLandmarkerHelper has error handling: `grep "try\|catch\|listener.onError" shared/src/androidMain/kotlin/com/devil/phoenixproject/cv/PoseLandmarkerHelper.kt`
3. FormCheckOverlay has error state and rationale: `grep "errorMessage\|All processing stays" shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.android.kt`
4. Platform detection compiles: `./gradlew :shared:compileDebugKotlinAndroid`
5. Full Android build: `./gradlew :androidApp:assembleDebug`
</verification>

<success_criteria>
- Two backup exclusion XML files exist excluding vitruvian.db and vitruvian_preferences.xml
- AndroidManifest.xml has both fullBackupContent and dataExtractionRules attributes
- PoseLandmarkerHelper catches asset-missing exceptions and calls listener.onError with user-friendly message
- FormCheckOverlay shows error message box when PoseLandmarker init fails (not just a log)
- FormCheckOverlay shows rationale text with on-device processing guarantee before requesting camera permission
- isIosPlatform expect/actual exists for Android (false) and iOS (true)
- No existing UI lists "Form Check" as an iOS-available feature, or any found instances are platform-guarded
- Android debug build compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/16-foundation-board-conditions/16-02-SUMMARY.md`
</output>

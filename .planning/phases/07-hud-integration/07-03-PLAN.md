---
phase: 07-hud-integration
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceCurveMiniGraph.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
autonomous: true

must_haves:
  truths:
    - "User sees mini force curve graph at bottom of StatsPage"
    - "Tapping mini force curve expands to full-size overlay with sticking point annotation and strength profile badge"
    - "All biomechanics HUD elements (velocity card, balance bar, force curve) are hidden for users below Phoenix tier"
    - "Free tier users see no biomechanics data on the HUD"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceCurveMiniGraph.kt"
      provides: "ForceCurveMiniGraph and ExpandedForceCurve composables"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt"
      provides: "Force curve in StatsPage, tier gating wrapper for all biomechanics elements"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt"
      provides: "Tier-gated biomechanics result (null for free tier)"
  key_links:
    - from: "ActiveWorkoutScreen tier check"
      to: "WorkoutUiState.latestBiomechanicsResult"
      via: "hasProAccess gate sets to null for free tier"
      pattern: "if.*hasProAccess.*biomechanics"
    - from: "ForceCurveMiniGraph"
      to: "ForceCurveResult.normalizedForceN"
      via: "Canvas drawing of 101-point force array"
      pattern: "normalizedForceN"
---

<objective>
Add force curve mini-graph to StatsPage and apply Phoenix tier gating to ALL biomechanics HUD elements.

Purpose: The force curve visualization completes the biomechanics HUD. The mini-graph gives immediate visual feedback on force production through ROM. Tap-to-expand provides detailed analysis (sticking point, strength profile). Tier gating ensures these premium features are only visible to Phoenix+ subscribers, completing HUD-05.

Output: ForceCurveMiniGraph.kt composable, expanded view, tier gating applied in ActiveWorkoutScreen.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-hud-integration/07-01-SUMMARY.md
@.planning/phases/07-hud-integration/07-02-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/PremiumFeatureGate.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ForceCurveMiniGraph component with expanded view</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceCurveMiniGraph.kt
  </files>
  <action>
    Create `ForceCurveMiniGraph.kt` with two composables: a compact mini-graph and an expanded overlay.

    **1. ForceCurveMiniGraph (compact):**
    ```kotlin
    @Composable
    fun ForceCurveMiniGraph(
        forceCurveResult: ForceCurveResult,
        onTapToExpand: () -> Unit,
        modifier: Modifier = Modifier
    )
    ```

    - Height: ~80dp, fills available width
    - Draws the 101-point normalized force curve using `Canvas`:
      - X axis: ROM position (0-100%)
      - Y axis: Force (auto-scaled to min/max of the data)
      - Line: primary color, 2dp stroke
      - Background: surfaceContainerHigh, rounded 12dp corners
    - Sticking point: draw a small red dot/circle at the sticking point position on the curve
    - Label overlay: "Force Curve" in top-left corner (labelSmall, dimmed)
    - Tap handler: `Modifier.clickable { onTapToExpand() }`
    - If `normalizedForceN` is empty, show "No data" placeholder text

    **Canvas drawing logic:**
    ```kotlin
    Canvas(modifier = Modifier.fillMaxSize()) {
        if (forceData.isEmpty()) return@Canvas
        val maxForce = forceData.max()
        val minForce = forceData.min()
        val forceRange = (maxForce - minForce).coerceAtLeast(1f)

        val path = Path()
        forceData.forEachIndexed { index, force ->
            val x = (index / 100f) * size.width
            val y = size.height - ((force - minForce) / forceRange) * size.height
            if (index == 0) path.moveTo(x, y) else path.lineTo(x, y)
        }
        drawPath(path, color = primaryColor, style = Stroke(width = 2.dp.toPx()))

        // Sticking point marker
        stickingPointPct?.let { pct ->
            val spX = (pct / 100f) * size.width
            val spIndex = pct.toInt().coerceIn(0, forceData.lastIndex)
            val spY = size.height - ((forceData[spIndex] - minForce) / forceRange) * size.height
            drawCircle(color = Color.Red, radius = 4.dp.toPx(), center = Offset(spX, spY))
        }
    }
    ```

    **2. ExpandedForceCurve (overlay):**
    ```kotlin
    @Composable
    fun ExpandedForceCurve(
        forceCurveResult: ForceCurveResult,
        onDismiss: () -> Unit,
        modifier: Modifier = Modifier
    )
    ```

    - Full-screen overlay using `Dialog` or a `Box` with `fillMaxSize` and semi-transparent scrim
    - Larger Canvas rendering of the same curve (~300dp height)
    - X axis label: "ROM %" with tick marks at 0, 25, 50, 75, 100
    - Y axis label: "Force (N)" with auto-scaled tick marks
    - Sticking point: red dot with annotation text ("Sticking point: XX%")
    - Strength profile badge: Small chip/badge in top-right corner showing profile name (e.g., "ASCENDING", "BELL_SHAPED")
    - Tap to dismiss: scrim click or explicit close button
    - Use `AlertDialog` or similar composable for clean overlay behavior

    Import: `ForceCurveResult`, `StrengthProfile` from domain model, Canvas/Path/Offset from compose graphics.
  </action>
  <verify>
    `./gradlew :shared:compileKotlinMetadata` passes. Grep confirms `fun ForceCurveMiniGraph` and `fun ExpandedForceCurve` exist in ForceCurveMiniGraph.kt. Grep confirms `normalizedForceN` is referenced for Canvas drawing. Grep confirms `stickingPointPct` marker is drawn.
  </verify>
  <done>ForceCurveMiniGraph renders a compact 101-point force curve with sticking point marker and tap-to-expand. ExpandedForceCurve shows full-size curve with axis labels, sticking point annotation, and strength profile badge.</done>
</task>

<task type="auto">
  <name>Task 2: Add force curve to StatsPage and apply Phoenix tier gating to all biomechanics elements</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
  </files>
  <action>
    **Part A: Force curve in StatsPage**

    1. In `StatsPage` in WorkoutHud.kt, add the force curve mini-graph AFTER the existing Position card (at the bottom of the column):

       ```kotlin
       // Force Curve Mini-Graph (tap to expand)
       if (latestBiomechanicsResult != null &&
           latestBiomechanicsResult.forceCurve.normalizedForceN.isNotEmpty()) {

           var showExpandedCurve by remember { mutableStateOf(false) }

           ForceCurveMiniGraph(
               forceCurveResult = latestBiomechanicsResult.forceCurve,
               onTapToExpand = { showExpandedCurve = true },
               modifier = Modifier.fillMaxWidth()
           )

           if (showExpandedCurve) {
               ExpandedForceCurve(
                   forceCurveResult = latestBiomechanicsResult.forceCurve,
                   onDismiss = { showExpandedCurve = false }
               )
           }
       }
       ```

    2. Import `ForceCurveMiniGraph` and `ExpandedForceCurve` from components.

    **Part B: Tier gating (HUD-05)**

    Apply tier gating at the ActiveWorkoutScreen level, following the exact pattern used for `gatedRepQualityScore`:

    3. In `ActiveWorkoutScreen.kt`, the `latestBiomechanicsResult` collected from ViewModel should be gated:
       ```kotlin
       // Biomechanics data - gated to Phoenix+ tier users only (HUD-05)
       val latestBiomechanicsResult by viewModel.latestBiomechanicsResult.collectAsState()
       val gatedBiomechanicsResult = if (hasProAccess) latestBiomechanicsResult else null
       ```
       Update the WorkoutUiState construction to use `gatedBiomechanicsResult` instead of `latestBiomechanicsResult`.
       Update the `remember()` key list to use `gatedBiomechanicsResult`.

    This means:
    - Free tier: `latestBiomechanicsResult` is null in WorkoutUiState -> velocity card hidden, balance bar hidden, force curve hidden
    - Phoenix+ tier: full biomechanics data flows through

    This is cleaner than wrapping each individual UI element in a gate, because:
    - Single gate point (ActiveWorkoutScreen)
    - All downstream UI simply checks `!= null` (already does this)
    - Data capture still happens regardless (GATE-04 from Phase 6)

    **Note**: Plan 07-01 already added `latestBiomechanicsResult` without gating. This task modifies that wiring to add the gate. The `hasProAccess` variable already exists in ActiveWorkoutScreen (used for `gatedRepQualityScore`).

    4. In `WorkoutUiState.kt`, no change needed (field already nullable from Plan 01).
    5. In `WorkoutTab.kt`, no change needed (parameter already nullable from Plan 01).
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` passes. `./gradlew :androidApp:testDebugUnitTest` passes.
    Grep: `ForceCurveMiniGraph(` appears in WorkoutHud.kt StatsPage.
    Grep: `ExpandedForceCurve(` appears in WorkoutHud.kt.
    Grep: `gatedBiomechanicsResult` appears in ActiveWorkoutScreen.kt.
    Grep: `if (hasProAccess) latestBiomechanicsResult else null` pattern in ActiveWorkoutScreen.kt.
  </verify>
  <done>Force curve mini-graph appears at bottom of StatsPage with tap-to-expand showing sticking point and strength profile. All biomechanics HUD elements are hidden for free tier users (single gate in ActiveWorkoutScreen). Phoenix+ users see velocity card, balance bar, and force curve.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinMetadata` passes
2. `./gradlew :androidApp:assembleDebug` passes
3. `./gradlew :androidApp:testDebugUnitTest` passes
4. Grep: `ForceCurveMiniGraph` composable exists in components/ForceCurveMiniGraph.kt
5. Grep: `ExpandedForceCurve` composable exists with sticking point annotation and strength profile badge
6. Grep: `gatedBiomechanicsResult` in ActiveWorkoutScreen.kt gates on `hasProAccess`
7. Grep: No `FeatureGate.isEnabled` calls needed in WorkoutHud (gating happens upstream)
8. Manual verification: Setting `hasProAccess = false` results in null biomechanics throughout HUD
</verification>

<success_criteria>
- Force curve mini-graph renders 101-point force curve with sticking point marker on StatsPage
- Tapping mini-graph opens expanded view with axis labels, sticking point annotation, and strength profile badge
- Tapping scrim or close button dismisses expanded view
- ALL biomechanics elements (velocity card, balance bar, force curve) are null/hidden for free tier
- Phoenix+ tier sees all biomechanics elements
- No regressions in existing HUD functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-hud-integration/07-03-SUMMARY.md`
</output>

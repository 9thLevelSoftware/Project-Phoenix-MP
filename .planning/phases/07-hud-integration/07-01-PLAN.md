---
phase: 07-hud-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
autonomous: true

must_haves:
  truths:
    - "User sees MCV number on StatsPage, color-coded by velocity zone (EXPLOSIVE=red, FAST=orange, MODERATE=yellow, SLOW=blue, GRIND=gray)"
    - "After rep 2, user sees velocity loss percentage on StatsPage"
    - "Biomechanics data flows from BiomechanicsEngine StateFlow through ViewModel to WorkoutHud"
    - "Velocity display updates reactively after each completed rep"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt"
      provides: "latestBiomechanicsResult field in WorkoutUiState"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt"
      provides: "VelocityDisplay composable in StatsPage showing MCV + zone color + velocity loss"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt"
      provides: "BiomechanicsRepResult parameter threaded through to WorkoutHud"
  key_links:
    - from: "MainViewModel.latestBiomechanicsResult"
      to: "ActiveWorkoutScreen collectAsState()"
      via: "StateFlow collection and WorkoutUiState construction"
      pattern: "latestBiomechanicsResult.*collectAsState"
    - from: "WorkoutUiState.latestBiomechanicsResult"
      to: "WorkoutHud StatsPage"
      via: "Parameter threading through WorkoutTab"
      pattern: "biomechanicsResult"
---

<objective>
Wire BiomechanicsEngine output through the ViewModel/UI layer and display velocity metrics on the WorkoutHud StatsPage.

Purpose: This is the plumbing plan. Phase 6 built the engines but no UI consumes the data yet. This plan threads BiomechanicsRepResult from WorkoutCoordinator through MainViewModel -> ActiveWorkoutScreen -> WorkoutUiState -> WorkoutTab -> WorkoutHud, then adds a Velocity card to StatsPage (page 2) showing MCV with zone color-coding and velocity loss percentage.

Output: Complete data pipeline from engine to HUD, plus velocity display composable on StatsPage.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-core-engine/06-01-SUMMARY.md
@.planning/phases/06-core-engine/06-02-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread BiomechanicsRepResult through ViewModel to WorkoutUiState</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  </files>
  <action>
    Follow the exact pattern used for `latestRepQualityScore` data flow:

    1. **MainViewModel.kt**: Add a public getter that delegates to the coordinator's StateFlow:
       ```kotlin
       val latestBiomechanicsResult get() = workoutSessionManager.coordinator.latestBiomechanicsResult
       ```
       Place it near the existing `latestRepQuality` getter.

    2. **WorkoutUiState.kt**: Add a field:
       ```kotlin
       val latestBiomechanicsResult: BiomechanicsRepResult? = null
       ```
       Import `com.devil.phoenixproject.domain.model.BiomechanicsRepResult`. Place it after `latestRepQualityScore`.

    3. **ActiveWorkoutScreen.kt**:
       - Collect the StateFlow: `val latestBiomechanicsResult by viewModel.latestBiomechanicsResult.collectAsState()`
       - Do NOT apply tier gating here yet (Plan 03 handles gating). Just pass the raw result.
       - Add `latestBiomechanicsResult` to the `remember()` key list for WorkoutUiState construction.
       - Pass `latestBiomechanicsResult = latestBiomechanicsResult` to WorkoutUiState constructor.
  </action>
  <verify>
    `./gradlew :shared:compileKotlinMetadata` passes. Grep confirms `latestBiomechanicsResult` appears in all three files.
  </verify>
  <done>BiomechanicsRepResult flows from WorkoutCoordinator through MainViewModel to WorkoutUiState with no tier gating applied yet.</done>
</task>

<task type="auto">
  <name>Task 2: Thread data to WorkoutHud and add velocity display on StatsPage</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  </files>
  <action>
    1. **WorkoutTab.kt**:
       - Add `latestBiomechanicsResult: BiomechanicsRepResult? = null` parameter to both `WorkoutTab` overloads.
       - In the convenience overload, pass `latestBiomechanicsResult = state.latestBiomechanicsResult`.
       - Pass it through to `WorkoutHud(...)` call.

    2. **WorkoutHud.kt**:
       - Add `latestBiomechanicsResult: BiomechanicsRepResult? = null` parameter to `WorkoutHud` composable.
       - Pass it to `StatsPage(...)` call.
       - Add `latestBiomechanicsResult: BiomechanicsRepResult? = null` parameter to `StatsPage`.

    3. **StatsPage velocity card**: Add a new Card in StatsPage ABOVE the existing "LOAD" card (so velocity is the first thing users see). Use the exact same Card styling pattern as LOAD/VELOCITY/POSITION cards already in StatsPage:

       ```kotlin
       // Biomechanics Velocity Card (after rep completion)
       if (latestBiomechanicsResult != null) {
           Card(...same styling as other cards...) {
               Column(modifier = Modifier.padding(16.dp), verticalArrangement = Arrangement.spacedBy(12.dp)) {
                   Text("MEAN CONCENTRIC VELOCITY", style = labelMedium, color = zoneColor, letterSpacing = 1.sp)

                   // MCV display: large number with unit, color-coded by zone
                   val mcv = latestBiomechanicsResult.velocity.meanConcentricVelocityMmS
                   val zone = latestBiomechanicsResult.velocity.zone
                   val zoneColor = zoneToColor(zone)  // helper function

                   Row(fillMaxWidth, SpaceEvenly) {
                       StatColumn(label = "MCV", value = "${(mcv / 1000f).format(2)} m/s", color = zoneColor)
                       StatColumn(label = "Zone", value = zone.name, color = zoneColor)
                       StatColumn(label = "Peak", value = "${(latestBiomechanicsResult.velocity.peakVelocityMmS / 1000f).format(2)} m/s", color = zoneColor)
                   }

                   // Velocity loss (only shown after rep 2)
                   val vloss = latestBiomechanicsResult.velocity.velocityLossPercent
                   if (vloss != null) {
                       Row(fillMaxWidth, SpaceEvenly) {
                           StatColumn(label = "Vel. Loss", value = "${vloss.toInt()}%", color = if (vloss > 20f) errorColor else onSurfaceVariant)
                           val repsRemaining = latestBiomechanicsResult.velocity.estimatedRepsRemaining
                           if (repsRemaining != null) {
                               StatColumn(label = "Est. Reps Left", value = "$repsRemaining", color = onSurfaceVariant)
                           }
                       }
                   }
               }
           }
       }
       ```

    4. **Zone color helper**: Create a private composable helper or `@Composable` function in WorkoutHud.kt:
       ```kotlin
       @Composable
       private fun zoneColor(zone: BiomechanicsVelocityZone): Color = when (zone) {
           BiomechanicsVelocityZone.EXPLOSIVE -> Color(0xFFE53935)   // Red
           BiomechanicsVelocityZone.FAST -> Color(0xFFFF9800)        // Orange
           BiomechanicsVelocityZone.MODERATE -> Color(0xFFFDD835)    // Yellow
           BiomechanicsVelocityZone.SLOW -> Color(0xFF42A5F5)        // Blue
           BiomechanicsVelocityZone.GRIND -> Color(0xFF9E9E9E)       // Gray
       }
       ```

    5. **Float formatting**: Use `"%.2f".format(value)` or create a simple extension. Do NOT add external dependencies. In KMP commonMain, use: `((mcv / 1000f * 100).toInt() / 100f).toString()` as a safe cross-platform approach, or use kotlin.math.round to format to 2 decimal places.

    Import `com.devil.phoenixproject.domain.model.BiomechanicsRepResult` and `com.devil.phoenixproject.domain.model.BiomechanicsVelocityZone` where needed.
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` passes. Grep confirms `zoneColor` function exists in WorkoutHud.kt. Grep confirms `MEAN CONCENTRIC VELOCITY` text in StatsPage. Grep confirms `velocityLossPercent` is referenced in WorkoutHud.kt.
  </verify>
  <done>StatsPage shows MCV with zone color-coding, peak velocity, velocity loss percentage (after rep 2), and estimated reps remaining. Data flows from engine through complete pipeline to UI.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinMetadata` passes (no KMP compilation errors)
2. `./gradlew :androidApp:assembleDebug` passes (full Android build)
3. `./gradlew :androidApp:testDebugUnitTest` passes (no regressions)
4. Grep: `latestBiomechanicsResult` appears in MainViewModel, ActiveWorkoutScreen, WorkoutUiState, WorkoutTab, WorkoutHud
5. Grep: `BiomechanicsVelocityZone` imported in WorkoutHud.kt
6. Grep: `velocityLossPercent` referenced in StatsPage section of WorkoutHud.kt
</verification>

<success_criteria>
- BiomechanicsRepResult data flows from BiomechanicsEngine through MainViewModel to WorkoutHud without breaking existing UI
- StatsPage (page 2) shows velocity card with MCV (m/s), zone name, peak velocity, velocity loss %, and estimated reps remaining
- Velocity values are color-coded by BiomechanicsVelocityZone (EXPLOSIVE=red, FAST=orange, MODERATE=yellow, SLOW=blue, GRIND=gray)
- Velocity loss only appears after rep 2 (null for rep 1)
- No tier gating yet (applied in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/07-hud-integration/07-01-SUMMARY.md`
</output>

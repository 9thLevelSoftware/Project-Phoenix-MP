---
phase: 07-hud-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BalanceBar.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
autonomous: true

must_haves:
  truths:
    - "User sees L/R balance bar below cable position bars during workout"
    - "Balance bar color indicates asymmetry severity: green <10%, yellow 10-15%, red >15%"
    - "Visual alert appears when asymmetry exceeds 15% for 3+ consecutive reps"
    - "Balance bar updates after each completed rep with latest asymmetry data"
    - "Balance bar is hidden for bodyweight exercises"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BalanceBar.kt"
      provides: "BalanceBar composable with severity color-coding and alert animation"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt"
      provides: "BalanceBar placement below cable position bars, consecutive asymmetry tracking"
  key_links:
    - from: "WorkoutHud latestBiomechanicsResult"
      to: "BalanceBar composable"
      via: "AsymmetryResult passed as parameter"
      pattern: "BalanceBar.*asymmetry"
    - from: "BalanceBar"
      to: "Color severity thresholds"
      via: "Green <10%, Yellow 10-15%, Red >15%"
      pattern: "asymmetryPercent.*(10|15)"
---

<objective>
Add real-time L/R balance bar and consecutive asymmetry alerts to the WorkoutHud overlay.

Purpose: Users need immediate visual feedback about bilateral force imbalance during exercise. The balance bar sits below the existing cable position bars (which show physical position) and shows force balance. Color-coding (green/yellow/red) gives at-a-glance severity indication. A visual alert triggers after 3+ consecutive high-asymmetry reps to prompt the user to correct form.

Output: New BalanceBar.kt composable, WorkoutHud integration with consecutive rep tracking.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-hud-integration/07-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/EnhancedCablePositionBar.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BalanceBar composable component</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BalanceBar.kt
  </files>
  <action>
    Create a new `BalanceBar.kt` composable that visualizes L/R force asymmetry as a horizontal bar.

    **Design specification:**
    - Horizontal bar with a center line (50/50 balance point)
    - An indicator that shifts left or right proportional to the asymmetry
    - Width: fills available width (used in a Box overlay context)
    - Height: ~16dp (compact, doesn't crowd the HUD)
    - Background: surfaceContainerHigh with rounded corners (8dp)

    **Parameters:**
    ```kotlin
    @Composable
    fun BalanceBar(
        asymmetryPercent: Float,    // 0-100, how imbalanced
        dominantSide: String,       // "A", "B", or "BALANCED"
        showAlert: Boolean = false, // true when consecutive threshold exceeded
        modifier: Modifier = Modifier
    )
    ```

    **Color logic (ASYM-04):**
    ```kotlin
    val severityColor = when {
        asymmetryPercent < 10f -> Color(0xFF4CAF50)    // Green - acceptable
        asymmetryPercent < 15f -> Color(0xFFFFC107)    // Yellow/Amber - caution
        else -> Color(0xFFF44336)                       // Red - concerning
    }
    ```

    **Visual structure:**
    - Draw a rounded rectangle background
    - Draw a filled indicator from center toward dominant side
    - Indicator width proportional to asymmetry (e.g., asymmetry 20% = indicator extends 20% from center toward dominant side)
    - Side labels "L" and "R" at edges (small, dimmed text)
    - Center tick mark or line at 50% point
    - Asymmetry percentage text centered or near indicator

    **Alert animation (ASYM-05):**
    - When `showAlert = true`, apply a pulsing border animation using `animateColorAsState` or `InfiniteTransition`:
      - Border color pulses between red and transparent over 1 second cycle
      - This draws attention without being distracting
    - When `showAlert = false`, no border animation

    Use `Canvas` for the bar drawing (position indicator, center line) and overlay `Text` composables for labels. Alternatively, use `Box` with background + indicator Box positioned via `offset` -- choose whichever produces cleaner code.

    Import from `androidx.compose.animation.core.*` for alert animation, `androidx.compose.ui.graphics.*` for drawing.
  </action>
  <verify>
    `./gradlew :shared:compileKotlinMetadata` passes. Grep confirms `fun BalanceBar` exists in BalanceBar.kt with `asymmetryPercent`, `dominantSide`, and `showAlert` parameters.
  </verify>
  <done>BalanceBar composable renders a horizontal asymmetry indicator with green/yellow/red color-coding and pulsing border alert.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate BalanceBar into WorkoutHud with consecutive rep tracking</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  </files>
  <action>
    1. **Add BalanceBar to HUD overlay**: In the `WorkoutHud` composable's `Box` (the one containing `HorizontalPager` and cable position bars), add the BalanceBar BELOW the cable position bars section:

       ```kotlin
       // L/R Balance Bar (below cable position bars)
       // Only show when biomechanics data is available and not bodyweight
       if (latestBiomechanicsResult != null && !isCurrentExerciseBodyweight) {
           BalanceBar(
               asymmetryPercent = latestBiomechanicsResult.asymmetry.asymmetryPercent,
               dominantSide = latestBiomechanicsResult.asymmetry.dominantSide,
               showAlert = showAsymmetryAlert,
               modifier = Modifier
                   .align(Alignment.BottomCenter)
                   .fillMaxWidth(0.7f)  // 70% width to avoid overlapping cable bars
                   .padding(bottom = 24.dp)  // Above pager indicator dots
           )
       }
       ```

       Place this AFTER the cable position bars (Right Bar) but BEFORE the pager indicator Row.

    2. **Track consecutive high-asymmetry reps (ASYM-05)**: Add state tracking inside `WorkoutHud`:

       ```kotlin
       // Track consecutive high-asymmetry reps for alert
       var consecutiveHighAsymmetryCount by remember { mutableStateOf(0) }
       var lastProcessedRepNumber by remember { mutableStateOf(0) }

       // Update consecutive count when new rep data arrives
       LaunchedEffect(latestBiomechanicsResult?.repNumber) {
           val result = latestBiomechanicsResult ?: return@LaunchedEffect
           if (result.repNumber > lastProcessedRepNumber) {
               lastProcessedRepNumber = result.repNumber
               if (result.asymmetry.asymmetryPercent > 15f) {
                   consecutiveHighAsymmetryCount++
               } else {
                   consecutiveHighAsymmetryCount = 0
               }
           }
       }

       val showAsymmetryAlert = consecutiveHighAsymmetryCount >= 3
       ```

       Place this state tracking near the top of the `WorkoutHud` composable, after `pagerState` declaration.

    3. **Import BalanceBar**: Add import for the new component:
       ```kotlin
       import com.devil.phoenixproject.presentation.components.BalanceBar
       ```

    Ensure the BalanceBar does NOT overlap with existing UI elements. The bottom alignment with `padding(bottom = 24.dp)` should keep it above the pager indicator dots (which have `padding(bottom = 8.dp)`).
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` passes. Grep confirms `BalanceBar(` call in WorkoutHud.kt. Grep confirms `consecutiveHighAsymmetryCount` tracking state in WorkoutHud.kt. Grep confirms `showAsymmetryAlert` is computed and passed to BalanceBar.
  </verify>
  <done>Balance bar appears below cable position bars during workout, color-coded by asymmetry severity, with pulsing alert after 3+ consecutive high-asymmetry reps. Hidden for bodyweight exercises.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinMetadata` passes
2. `./gradlew :androidApp:assembleDebug` passes
3. `./gradlew :androidApp:testDebugUnitTest` passes (no regressions)
4. Grep: `BalanceBar` composable exists in components/BalanceBar.kt
5. Grep: `BalanceBar(` called from WorkoutHud.kt
6. Grep: Severity thresholds 10f and 15f appear in BalanceBar.kt
7. Grep: `consecutiveHighAsymmetryCount` tracked in WorkoutHud.kt
8. Grep: `showAsymmetryAlert` computed with threshold >= 3
</verification>

<success_criteria>
- BalanceBar component renders horizontal L/R balance indicator with green/yellow/red severity colors
- Balance bar positioned below cable position bars in WorkoutHud overlay
- Alert triggers visual pulsing after 3 consecutive reps with >15% asymmetry
- Alert resets when a rep falls below 15% asymmetry
- Balance bar hidden for bodyweight exercises
- No overlap with existing HUD elements (cable bars, pager dots, bottom bar)
</success_criteria>

<output>
After completion, create `.planning/phases/07-hud-integration/07-02-SUMMARY.md`
</output>

---
phase: 04-koin-di-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/SyncModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/AppModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/KoinInit.kt
  - androidApp/src/androidTest/kotlin/com/devil/phoenixproject/e2e/AppE2ETest.kt
autonomous: true

must_haves:
  truths:
    - "commonModule no longer exists -- replaced by appModule composing feature-scoped modules via includes()"
    - "Each feature module (dataModule, syncModule, domainModule, presentationModule) contains only bindings for its architectural layer"
    - "KoinInit.kt loads appModule + platformModule (not commonModule)"
    - "AppE2ETest compiles and references appModule instead of commonModule"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt"
      provides: "dataModule with 10 database and repository bindings"
      contains: "val dataModule"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/SyncModule.kt"
      provides: "syncModule with 7 portal, sync, and auth bindings"
      contains: "val syncModule"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt"
      provides: "domainModule with 5 preferences, use case, and migration bindings"
      contains: "val domainModule"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt"
      provides: "presentationModule with 7 viewmodel bindings"
      contains: "val presentationModule"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/AppModule.kt"
      provides: "appModule composing all feature modules via includes(), plus platformModule expect declaration"
      contains: "val appModule"
  key_links:
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/AppModule.kt"
      to: "DataModule.kt, SyncModule.kt, DomainModule.kt, PresentationModule.kt"
      via: "includes(dataModule, syncModule, domainModule, presentationModule)"
      pattern: "includes\\(dataModule"
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/KoinInit.kt"
      to: "AppModule.kt"
      via: "modules(appModule, platformModule)"
      pattern: "modules\\(appModule"
---

<objective>
Split the monolithic commonModule (28 bindings) into 4 feature-scoped Koin modules composed via appModule using includes().

Purpose: Satisfies DI-01 (feature-scoped modules) and DI-03 (app starts normally). Moving from a single file with all bindings to organized modules improves navigability and makes dependency relationships explicit.

Output: 4 new feature module files, updated AppModule.kt with includes(), updated KoinInit.kt and AppE2ETest.kt references.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-koin-di-cleanup/04-RESEARCH.md

# Source files
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/AppModule.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/KoinInit.kt
@androidApp/src/androidTest/kotlin/com/devil/phoenixproject/e2e/AppE2ETest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature-scoped Koin modules</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/SyncModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  </files>
  <action>
Create 4 new Kotlin files in the `di/` package. Each file declares a `val xxxModule = module { ... }` with the appropriate bindings moved from the current commonModule.

**DataModule.kt** (10 bindings):
```
package com.devil.phoenixproject.di

val dataModule = module {
    // Database
    single { DatabaseFactory(get()).createDatabase() }
    single { ExerciseImporter(get()) }

    // Repositories
    single<ExerciseRepository> { SqlDelightExerciseRepository(get(), get()) }
    single<WorkoutRepository> { SqlDelightWorkoutRepository(get(), get()) }
    single<PersonalRecordRepository> { SqlDelightPersonalRecordRepository(get()) }
    single<GamificationRepository> { SqlDelightGamificationRepository(get()) }
    single<UserProfileRepository> { SqlDelightUserProfileRepository(get()) }
    single<TrainingCycleRepository> { SqlDelightTrainingCycleRepository(get()) }
    single<CompletedSetRepository> { SqlDelightCompletedSetRepository(get()) }
    single<ProgressionRepository> { SqlDelightProgressionRepository(get()) }
}
```

**SyncModule.kt** (7 bindings):
```
package com.devil.phoenixproject.di

val syncModule = module {
    // Portal
    single { PortalTokenStorage(get()) }
    single { PortalApiClient(tokenProvider = { get<PortalTokenStorage>().getToken() }) }

    // Sync
    single<SyncRepository> { SqlDelightSyncRepository(get()) }
    single { SyncManager(get(), get(), get()) }
    single { SyncTriggerManager(get(), get()) }

    // Auth & Subscription
    single<AuthRepository> { PortalAuthRepository(get(), get()) }
    single { SubscriptionManager(get()) }
}
```

**DomainModule.kt** (5 bindings + 1 migration):
```
package com.devil.phoenixproject.di

val domainModule = module {
    // Preferences
    single<PreferencesManager> { SettingsPreferencesManager(get()) }

    // Use Cases
    single { RepCounterFromMachine() }
    single { ProgressionUseCase(get(), get()) }
    factory { ResolveRoutineWeightsUseCase(get()) }
    single { TemplateConverter(get()) }

    // Migration
    single { MigrationManager() }
}
```

**PresentationModule.kt** (7 bindings):
```
package com.devil.phoenixproject.di

val presentationModule = module {
    // ViewModels
    factory { MainViewModel(get(), get(), get(), get(), get(), get(), get(), get(), get(), get(), get()) }
    factory { ConnectionLogsViewModel() }
    factory { CycleEditorViewModel(get()) }
    factory { GamificationViewModel(get()) }
    single { ThemeViewModel(get()) }
    single { EulaViewModel(get()) }

    // Sync UI
    factory { LinkAccountViewModel(get()) }
}
```

Each file needs the same package declaration (`com.devil.phoenixproject.di`) and only the imports needed for its specific bindings. Copy imports from the current AppModule.kt, splitting them by which module needs them.

IMPORTANT: Preserve exact binding types (single vs factory), exact generic type parameters (e.g., `single<ExerciseRepository>`), and exact constructor arguments (e.g., `get(), get()`). This is a pure move -- zero behavioral changes.
  </action>
  <verify>All 4 new files exist and have correct package declarations. Each file compiles (verify in next task via build).</verify>
  <done>4 feature module files created with the correct bindings distributed per the research plan. Total binding count across all 4 modules equals 28+1 (29 -- the original 28 plus MigrationManager).</done>
</task>

<task type="auto">
  <name>Task 2: Replace commonModule with appModule and update references</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/AppModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/KoinInit.kt
    androidApp/src/androidTest/kotlin/com/devil/phoenixproject/e2e/AppE2ETest.kt
  </files>
  <action>
**AppModule.kt** -- Replace the entire `commonModule` definition with:
```kotlin
package com.devil.phoenixproject.di

import org.koin.core.module.Module
import org.koin.dsl.module

expect val platformModule: Module

val appModule = module {
    includes(dataModule, syncModule, domainModule, presentationModule)
}
```

Remove ALL imports that were only needed for the individual bindings (they've moved to feature module files). Keep only `org.koin.core.module.Module`, `org.koin.dsl.module`, and the `expect val platformModule` declaration.

**KoinInit.kt** -- Change line 11 from:
```kotlin
modules(commonModule, platformModule)
```
to:
```kotlin
modules(appModule, platformModule)
```
No other changes to KoinInit.kt. The `doInitKoin()` and `runMigrations()` functions remain untouched.

**AppE2ETest.kt** -- Two changes:
1. Line 33: Change `import com.devil.phoenixproject.di.commonModule` to `import com.devil.phoenixproject.di.appModule`
2. Line 77: Change `modules(commonModule, platformModule, testModule)` to `modules(appModule, platformModule, testModule)`

After all changes, run `./gradlew :shared:testDebugUnitTest` to confirm compilation and existing tests pass. Then run `./gradlew :androidApp:assembleDebug` to confirm the app builds.
  </action>
  <verify>
Run `./gradlew :shared:testDebugUnitTest` -- all tests pass.
Run `./gradlew :androidApp:assembleDebug` -- builds successfully.
Grep for `commonModule` across all .kt files -- zero results (fully migrated).
  </verify>
  <done>commonModule is fully replaced by appModule with includes(). KoinInit and AppE2ETest reference appModule. Project compiles and all tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -r "commonModule" --include="*.kt" .` returns zero results
2. `./gradlew :shared:testDebugUnitTest` passes (all 38+ characterization tests + repository tests)
3. `./gradlew :androidApp:assembleDebug` succeeds
4. AppModule.kt contains `includes(dataModule, syncModule, domainModule, presentationModule)`
5. KoinInit.kt contains `modules(appModule, platformModule)`
</verification>

<success_criteria>
The monolithic commonModule is replaced by 4 feature-scoped modules composed via appModule. All existing tests pass and the Android app builds successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/04-koin-di-cleanup/04-01-SUMMARY.md`
</output>

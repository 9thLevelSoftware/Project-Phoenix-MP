---
phase: 13-biomechanics-persistence
plan: 02
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BiomechanicsHistoryCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
autonomous: true
requirements:
  - PERSIST-01
  - PERSIST-02
  - PERSIST-03
  - PERSIST-04
must_haves:
  truths:
    - "User can see set-level biomechanics summary (avg MCV, avg asymmetry, velocity loss trend) at a glance in session history"
    - "User can tap to expand and see per-rep biomechanics (MCV, velocity zone, velocity loss %, asymmetry %, dominant side)"
    - "User can see per-rep force curve sparklines with sticking point and strength profile annotations"
    - "FREE tier users see a premium upsell card instead of biomechanics data"
    - "Phoenix+ tier users see VBT metrics and force curves but NOT asymmetry data (Elite-only per FeatureGate)"
    - "Elite tier users see all biomechanics data including asymmetry"
    - "Older sessions without biomechanics data show no biomechanics section (graceful null handling)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BiomechanicsHistoryCard.kt"
      provides: "BiomechanicsHistorySummary and RepBiomechanicsDetail composables"
      min_lines: 80
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt"
      provides: "Biomechanics section integrated into expanded session card"
      contains: "BiomechanicsHistorySummary"
  key_links:
    - from: "HistoryTab.kt expanded section"
      to: "BiomechanicsHistoryCard.kt"
      via: "BiomechanicsHistorySummary composable call with session data"
      pattern: "BiomechanicsHistorySummary"
    - from: "BiomechanicsHistoryCard.kt"
      to: "BiomechanicsRepository"
      via: "Lazy-load RepBiomechanics on per-rep expand"
      pattern: "biomechanicsRepository\\.getRepBiomechanics"
    - from: "HistoryTab.kt"
      to: "FeatureGate"
      via: "VBT_METRICS (Phoenix+) gates VBT/force display; ASYMMETRY_ANALYSIS (Elite) gates asymmetry display"
      pattern: "FeatureGate\\.isEnabled.*VBT_METRICS|FeatureGate\\.isEnabled.*ASYMMETRY_ANALYSIS"
    - from: "BiomechanicsHistoryCard.kt per-rep detail"
      to: "ForceSparkline composable"
      via: "Reuse existing ForceSparkline for force curve visualization"
      pattern: "ForceSparkline"
---

<objective>
Display persisted biomechanics data in session history with set-level summary and per-rep drill-down, gated behind Phoenix+ tier.

Purpose: Users can review their biomechanics analysis after workout completion. Set-level summary (avg MCV, avg asymmetry, velocity loss trend) is visible at a glance. Per-rep detail (VBT, force curve sparkline, asymmetry) is accessible via tap/expand interaction.

Output: BiomechanicsHistoryCard composable integrated into HistoryTab with FeatureGate tier gating.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-biomechanics-persistence/13-RESEARCH.md
@.planning/phases/13-biomechanics-persistence/13-01-SUMMARY.md

Key existing files to reference:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceSparkline.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RepReplayCard.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BiomechanicsRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/FeatureGate.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: BiomechanicsHistoryCard composable with set-level summary and per-rep detail</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BiomechanicsHistoryCard.kt
  </files>
  <action>
    Create a new composable file `BiomechanicsHistoryCard.kt` with two main composables:

    **1. BiomechanicsHistorySummary (set-level "at a glance" view):**
    - Accepts: `avgMcvMmS: Float?`, `avgAsymmetryPercent: Float?`, `totalVelocityLossPercent: Float?`, `dominantSide: String?`, `strengthProfile: String?`, `onExpandReps: () -> Unit`
    - Displays a compact card/section consistent with existing HistoryTab card styling:
      - Row 1: Average MCV (formatted as "X.X mm/s") with velocity zone color indicator, Strength Profile label
      - Row 2: Average Asymmetry % with dominant side label, Velocity Loss % (with trend indicator if applicable)
    - Include a "View Per-Rep" clickable text/button that triggers `onExpandReps`
    - Use `PhoenixColors` and existing theme tokens from the project for consistent styling
    - Handle all nullable values gracefully — if a value is null, show "—" or hide that metric

    **2. RepBiomechanicsDetail (per-rep drill-down, shown on expand):**
    - Accepts: `repResults: List<BiomechanicsRepResult>`, `isLoading: Boolean`, `showAsymmetry: Boolean = true`
    - Shows a loading indicator when `isLoading = true` (while RepBiomechanics data is being lazy-loaded from DB)
    - Displays a Column of per-rep rows. Each row shows:
      - Rep number (1-indexed)
      - MCV (mm/s) with velocity zone color chip
      - Velocity Loss % (if non-null)
      - Asymmetry % with dominant side (only shown when `showAsymmetry = true` — Elite tier)
    - Each rep row is expandable to show the force curve sparkline:
      - Reuse `ForceSparkline` composable from Phase 12 (pass `normalizedForceN` as the data)
      - Show sticking point as a labeled annotation (e.g., "Sticking point: X% ROM")
      - Show strength profile label (e.g., "Ascending", "Bell-shaped")
    - Use `AnimatedVisibility` for expand/collapse consistent with existing HistoryTab patterns

    **3. PremiumBiomechanicsUpsell (tier gating):**
    - A simple card shown to FREE tier users: "Biomechanics Analysis" title + "Upgrade to Phoenix+ to view detailed biomechanics data for every rep" message
    - Consistent with existing PremiumUpsell patterns in the codebase (check FeatureGate usage in other screens)

    **Styling guidelines:**
    - Follow existing card patterns in HistoryTab (RoundedCornerShape, Surface with border, padding)
    - Use `MaterialTheme.colorScheme` for text colors
    - Velocity zone colors: map BiomechanicsVelocityZone enum to color (STRENGTH=Red, POWER=Orange, SPEED_STRENGTH=Yellow, SPEED=Green, etc.) — check BiomechanicsModels.kt for the enum
    - Keep the composable stateless — data loading logic lives in the HistoryTab caller
  </action>
  <verify>
    Run `./gradlew :androidApp:assembleDebug` — build must pass.
    Verify BiomechanicsHistoryCard.kt exists and contains `BiomechanicsHistorySummary`, `RepBiomechanicsDetail`, and the upsell composable.
    Verify `ForceSparkline` is imported and used in RepBiomechanicsDetail.
  </verify>
  <done>
    BiomechanicsHistoryCard.kt created with set-level summary composable, per-rep detail composable with ForceSparkline reuse, and premium upsell card. All composables are stateless and accept data as parameters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate biomechanics display into HistoryTab with lazy-loading and tier gating</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
  </files>
  <action>
    Integrate the BiomechanicsHistoryCard composables into the existing HistoryTab expanded session card view.

    **Add BiomechanicsRepository injection:**
    - Add `biomechanicsRepository: BiomechanicsRepository` parameter to `HistoryTab` composable (or inject via `koinInject()` matching the existing pattern for `RepMetricRepository` in HistoryTab)

    **In the expanded session card section (where RepReplayCard is shown):**

    After the existing rep metrics section, add the biomechanics section.

    **IMPORTANT — Tier gating granularity per FeatureGate.kt:**
    - `VBT_METRICS` (Phoenix+ tier) gates: MCV, velocity zones, velocity loss, strength profile
    - `FORCE_CURVES` (Phoenix+ tier) gates: force curve sparklines, sticking point
    - `ASYMMETRY_ANALYSIS` (Elite tier) gates: asymmetry %, dominant side
    - The BiomechanicsHistorySummary composable should accept a `showAsymmetry: Boolean` parameter to conditionally show/hide asymmetry metrics. Similarly, RepBiomechanicsDetail should accept `showAsymmetry: Boolean` to hide per-rep asymmetry columns.
    - This means Phoenix+ users see VBT + force curves but NOT asymmetry. Elite users see everything.

    ```kotlin
    // Biomechanics section — tiered gating
    if (session.hasBiomechanicsData) {
        val tier = // get current subscription tier (follow existing pattern in HistoryTab or parent)
        val hasVbt = FeatureGate.isEnabled(FeatureGate.Feature.VBT_METRICS, tier)
        val hasAsymmetry = FeatureGate.isEnabled(FeatureGate.Feature.ASYMMETRY_ANALYSIS, tier)

        if (hasVbt) {
            BiomechanicsHistorySummary(
                avgMcvMmS = session.avgMcvMmS,
                avgAsymmetryPercent = if (hasAsymmetry) session.avgAsymmetryPercent else null,
                totalVelocityLossPercent = session.totalVelocityLossPercent,
                dominantSide = if (hasAsymmetry) session.dominantSide else null,
                strengthProfile = session.strengthProfile,
                onExpandReps = { /* toggle per-rep expansion */ }
            )

            // Per-rep detail (lazy-loaded)
            if (isRepBiomechanicsExpanded) {
                var repBiomechanics by remember { mutableStateOf<List<BiomechanicsRepResult>>(emptyList()) }
                var isLoadingBiomechanics by remember { mutableStateOf(true) }

                LaunchedEffect(session.id) {
                    isLoadingBiomechanics = true
                    repBiomechanics = biomechanicsRepository.getRepBiomechanics(session.id)
                    isLoadingBiomechanics = false
                }

                RepBiomechanicsDetail(
                    repResults = repBiomechanics,
                    isLoading = isLoadingBiomechanics,
                    showAsymmetry = hasAsymmetry
                )
            }
        } else {
            PremiumBiomechanicsUpsell()
        }
    }
    ```

    **Key implementation details:**
    - Check `session.hasBiomechanicsData` FIRST — older sessions won't have biomechanics and should show no biomechanics section at all (not even the upsell)
    - Only lazy-load `RepBiomechanics` when user expands the per-rep section (not on card expand). This avoids deserializing 101-point force curves for every session in the list
    - Use `AnimatedVisibility` for the per-rep expand/collapse, consistent with existing expand patterns in the file
    - The FeatureGate check should use the same tier resolution pattern already used elsewhere in HistoryTab or parent screen. If HistoryTab doesn't have tier access, either pass it as a parameter or resolve via Koin (check how existing VBT_METRICS gating works in other screens)
    - The `ForceSparkline` composable is already available in the project (used in RepReplayCard) — the BiomechanicsHistoryCard calls it directly

    **State management for per-rep expansion:**
    - Add a `var isRepBiomechanicsExpanded by remember { mutableStateOf(false) }` state in the card scope
    - Wire `onExpandReps` callback to toggle this state
    - The LaunchedEffect only fires when expanded (conditional composition)
  </action>
  <verify>
    Run `./gradlew :androidApp:assembleDebug` — build must pass.
    Run `./gradlew :androidApp:testDebugUnitTest` — all existing tests must pass.
    Grep for `BiomechanicsHistorySummary` in HistoryTab.kt to confirm integration.
    Grep for `FeatureGate` in HistoryTab.kt to confirm tier gating.
    Grep for `hasBiomechanicsData` in HistoryTab.kt to confirm null-safe handling of older sessions.
  </verify>
  <done>
    Biomechanics section integrated into HistoryTab expanded session view. Set-level summary shown at a glance for Phoenix+ users. Per-rep detail with force curve sparklines lazy-loaded on expand. FREE tier users see upsell card. Older sessions without biomechanics data show nothing. Build passes. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:assembleDebug` passes
2. `./gradlew :androidApp:testDebugUnitTest` passes (no regression)
3. BiomechanicsHistoryCard.kt exists with set-level summary and per-rep detail composables
4. HistoryTab.kt integrates BiomechanicsHistorySummary in expanded card view
5. FeatureGate checks: VBT_METRICS (Phoenix+) gates VBT/force curves, ASYMMETRY_ANALYSIS (Elite) gates asymmetry display
6. session.hasBiomechanicsData guards against null biomechanics on older sessions
7. RepBiomechanics data lazy-loaded only on per-rep expand (not eagerly)
8. ForceSparkline reused for per-rep force curve visualization
</verification>

<success_criteria>
- Set-level biomechanics summary visible in session history for Phoenix+ users
- Per-rep detail accessible via expand with VBT metrics, asymmetry, and force curve sparklines
- FREE tier users see upsell card instead of biomechanics data
- Older sessions without biomechanics data handled gracefully (no crash, no empty section)
- All existing tests pass with no regression
</success_criteria>

<output>
After completion, create `.planning/phases/13-biomechanics-persistence/13-02-SUMMARY.md`
</output>

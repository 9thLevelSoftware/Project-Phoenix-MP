---
phase: 13-biomechanics-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/15.sqm
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BiomechanicsRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
  - shared/build.gradle.kts
autonomous: true
requirements:
  - PERSIST-01
  - PERSIST-02
  - PERSIST-03
  - PERSIST-04
  - PERSIST-05
must_haves:
  truths:
    - "Per-rep biomechanics data (VBT, force curve, asymmetry) is saved to RepBiomechanics table at set completion"
    - "Set-level biomechanics summary (avg MCV, avg asymmetry, velocity loss trend) is saved on WorkoutSession"
    - "Schema migration v16 applied safely on Android via 15.sqm"
    - "Schema migration v16 applied safely on iOS via DriverFactory.ios.kt manual schema"
    - "Data is captured for ALL subscription tiers (GATE-04 compliance)"
  artifacts:
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      provides: "RepBiomechanics CREATE TABLE + queries + WorkoutSession summary columns"
      contains: "CREATE TABLE RepBiomechanics"
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/15.sqm"
      provides: "Schema migration from v15 to v16"
      contains: "CREATE TABLE RepBiomechanics"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt"
      provides: "Updated insertSession/upsertSyncSession calls and WorkoutSession mapper with 5 new biomechanics columns"
      contains: "avgMcvMmS"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BiomechanicsRepository.kt"
      provides: "BiomechanicsRepository interface + SQLDelightBiomechanicsRepository implementation"
      exports: ["BiomechanicsRepository", "SqlDelightBiomechanicsRepository"]
    - path: "shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt"
      provides: "iOS manual schema for RepBiomechanics + WorkoutSession columns + CURRENT_SCHEMA_VERSION = 16L"
      contains: "CURRENT_SCHEMA_VERSION = 16L"
  key_links:
    - from: "ActiveSessionEngine.handleSetCompletion()"
      to: "BiomechanicsRepository.saveRepBiomechanics()"
      via: "biomechanicsRepository call after repMetricRepository save"
      pattern: "biomechanicsRepository\\.saveRepBiomechanics"
    - from: "ActiveSessionEngine.saveWorkoutSession()"
      to: "WorkoutSession domain model"
      via: "biomechanics summary columns mapped to WorkoutSession constructor"
      pattern: "avgMcvMmS|avgAsymmetryPercent|totalVelocityLossPercent"
    - from: "PresentationModule/DataModule"
      to: "BiomechanicsRepository"
      via: "Koin DI registration"
      pattern: "BiomechanicsRepository"
---

<objective>
Add RepBiomechanics table, WorkoutSession summary columns, schema migration v16, BiomechanicsRepository, and persistence wiring so that per-rep biomechanics data is saved to the database at set completion.

Purpose: Bridge the gap between BiomechanicsEngine (in-memory computation) and persistent storage. Currently biomechanics results are discarded after workout completion. This plan makes them survive for session history display (Plan 02).

Output: Working schema v16 on both platforms, BiomechanicsRepository with save/load/delete, biomechanics persisted at set completion in ActiveSessionEngine.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-biomechanics-persistence/13-RESEARCH.md

Key existing files to reference:
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
@shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration v16 — RepBiomechanics table + WorkoutSession summary columns</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/15.sqm
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
    shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
    shared/build.gradle.kts
  </files>
  <action>
    **3-LOCATION MIGRATION (Daem0n warning #155 — all 3 locations MUST be updated together):**

    **Location 1: VitruvianDatabase.sq (canonical schema)**

    Add the RepBiomechanics table AFTER the RepMetric table section:

    ```sql
    -- Per-Rep Biomechanics Analysis (Phase 13 - v16)
    CREATE TABLE RepBiomechanics (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        sessionId TEXT NOT NULL,
        repNumber INTEGER NOT NULL,
        -- VBT metrics (PERSIST-01)
        mcvMmS REAL NOT NULL,
        peakVelocityMmS REAL NOT NULL,
        velocityZone TEXT NOT NULL,
        velocityLossPercent REAL,
        estimatedRepsRemaining INTEGER,
        shouldStopSet INTEGER NOT NULL DEFAULT 0,
        -- Force curve (PERSIST-02)
        normalizedForceN TEXT NOT NULL,
        normalizedPositionPct TEXT NOT NULL,
        stickingPointPct REAL,
        strengthProfile TEXT NOT NULL,
        -- Asymmetry (PERSIST-03)
        asymmetryPercent REAL NOT NULL,
        dominantSide TEXT NOT NULL,
        avgLoadA REAL NOT NULL,
        avgLoadB REAL NOT NULL,
        -- Metadata
        timestamp INTEGER NOT NULL,
        FOREIGN KEY (sessionId) REFERENCES WorkoutSession(id) ON DELETE CASCADE
    );

    CREATE INDEX idx_rep_biomechanics_session ON RepBiomechanics(sessionId);
    CREATE UNIQUE INDEX idx_rep_biomechanics_session_rep ON RepBiomechanics(sessionId, repNumber);
    ```

    Add 5 nullable columns to the existing WorkoutSession CREATE TABLE (PERSIST-04):
    ```sql
    avgMcvMmS REAL,
    avgAsymmetryPercent REAL,
    totalVelocityLossPercent REAL,
    dominantSide TEXT,
    strengthProfile TEXT
    ```

    Add queries for RepBiomechanics (follow RepMetric query patterns):
    ```sql
    -- RepBiomechanics queries
    selectRepBiomechanicsBySession:
    SELECT * FROM RepBiomechanics WHERE sessionId = ? ORDER BY repNumber ASC;

    insertRepBiomechanics:
    INSERT OR REPLACE INTO RepBiomechanics (
        sessionId, repNumber, mcvMmS, peakVelocityMmS, velocityZone,
        velocityLossPercent, estimatedRepsRemaining, shouldStopSet,
        normalizedForceN, normalizedPositionPct, stickingPointPct, strengthProfile,
        asymmetryPercent, dominantSide, avgLoadA, avgLoadB, timestamp
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

    deleteRepBiomechanicsBySession:
    DELETE FROM RepBiomechanics WHERE sessionId = ?;

    -- Backup/sync queries for RepBiomechanics
    selectAllRepBiomechanicsSync:
    SELECT * FROM RepBiomechanics;

    insertRepBiomechanicsIgnore:
    INSERT OR IGNORE INTO RepBiomechanics (
        id, sessionId, repNumber, mcvMmS, peakVelocityMmS, velocityZone,
        velocityLossPercent, estimatedRepsRemaining, shouldStopSet,
        normalizedForceN, normalizedPositionPct, stickingPointPct, strengthProfile,
        asymmetryPercent, dominantSide, avgLoadA, avgLoadB, timestamp
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
    ```

    Update `insertSession` query to include the 5 new WorkoutSession columns (append to the existing column list and VALUES placeholders). Also update `upsertSyncSession` query the same way.

    **Location 2: migrations/15.sqm**

    Create `15.sqm` with the complete migration SQL:
    - CREATE TABLE RepBiomechanics (same as above)
    - CREATE INDEX and UNIQUE INDEX statements
    - 5 ALTER TABLE WorkoutSession ADD COLUMN statements for the summary columns

    **Location 3: DriverFactory.ios.kt**

    - Update `CURRENT_SCHEMA_VERSION` from `15L` to `16L`
    - In `createAllTables()`: Add `CREATE TABLE IF NOT EXISTS RepBiomechanics (...)` statement
    - In `createAllIndexes()`: Add `CREATE INDEX IF NOT EXISTS idx_rep_biomechanics_session` and `CREATE UNIQUE INDEX IF NOT EXISTS idx_rep_biomechanics_session_rep`
    - In `safeAddAllColumns()`: Add `safeAddColumn` calls for all 5 WorkoutSession columns: `avgMcvMmS REAL`, `avgAsymmetryPercent REAL`, `totalVelocityLossPercent REAL`, `dominantSide TEXT`, `strengthProfile TEXT`

    **Also update DriverFactory.android.kt:**
    - Add migration 15 to `getMigrationStatements()` map, returning the same SQL as 15.sqm

    **Update shared/build.gradle.kts:**
    - Change SQLDelight `version` from `15` to `16`

    **Update WorkoutSession domain model (Models.kt):**
    - Add 5 new nullable fields to the `WorkoutSession` data class:
      - `val avgMcvMmS: Float? = null`
      - `val avgAsymmetryPercent: Float? = null`
      - `val totalVelocityLossPercent: Float? = null`
      - `val dominantSide: String? = null`
      - `val strengthProfile: String? = null`
    - Add computed property: `val hasBiomechanicsData: Boolean get() = avgMcvMmS != null`

    **Update SqlDelightWorkoutRepository.kt (CRITICAL — build will fail without this):**
    - Update the `insertSession()` call site to pass the 5 new WorkoutSession fields (`avgMcvMmS`, `avgAsymmetryPercent`, `totalVelocityLossPercent`, `dominantSide`, `strengthProfile`) as parameters to the updated `insertSession` query
    - Update the `upsertSyncSession()` call site similarly
    - Update the WorkoutSession row mapper (the lambda that maps SQLDelight query results to `WorkoutSession` domain objects) to include the 5 new columns. The mapper receives ALL columns as positional parameters — append the new nullable parameters and map them to the corresponding `WorkoutSession` constructor fields
    - Follow the existing pattern for nullable column mapping (e.g., how `exerciseId`, `exerciseName`, etc. are already mapped)
  </action>
  <verify>
    Run `./gradlew :shared:generateCommonMainVitruvianDatabaseInterface` (or the full Android build) to confirm SQLDelight compiles without errors.
    Run `./gradlew :androidApp:assembleDebug` to verify full Android build succeeds.
    Verify that DriverFactory.ios.kt has CURRENT_SCHEMA_VERSION = 16L.
    Verify 15.sqm exists and contains both CREATE TABLE RepBiomechanics and ALTER TABLE WorkoutSession statements.
  </verify>
  <done>
    Schema v16 compiles on Android. RepBiomechanics table defined in all 3 locations. WorkoutSession has 5 new summary columns. Domain model updated. All SQLDelight queries include the new columns. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: BiomechanicsRepository + persistence wiring in ActiveSessionEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BiomechanicsRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  </files>
  <action>
    **Create BiomechanicsRepository.kt** following the exact same pattern as RepMetricRepository:

    ```kotlin
    // Interface
    interface BiomechanicsRepository {
        suspend fun saveRepBiomechanics(sessionId: String, results: List<BiomechanicsRepResult>)
        suspend fun getRepBiomechanics(sessionId: String): List<BiomechanicsRepResult>
        suspend fun deleteRepBiomechanics(sessionId: String)
    }

    // Implementation
    class SqlDelightBiomechanicsRepository(
        private val database: VitruvianDatabase
    ) : BiomechanicsRepository {
        // IMPORTANT: No subscription tier checks here. Data is captured for ALL users (GATE-04).
        // Tier gating happens only at the UI layer.
    }
    ```

    In `saveRepBiomechanics`:
    - Loop through results and call `database.vitruvianDatabaseQueries.insertRepBiomechanics(...)` for each
    - Map BiomechanicsRepResult fields to SQL parameters:
      - VBT: `velocity.meanConcentricVelocityMmS`, `velocity.peakVelocityMmS`, `velocity.zone.name`, `velocity.velocityLossPercent`, `velocity.estimatedRepsRemaining`, `velocity.shouldStopSet`
      - Force curve: `forceCurve.normalizedForceN.toJsonString()`, `forceCurve.normalizedPositionPct.toJsonString()`, `forceCurve.stickingPointPct`, `forceCurve.strengthProfile.name`
      - Asymmetry: `asymmetry.asymmetryPercent`, `asymmetry.dominantSide`, `asymmetry.avgLoadA`, `asymmetry.avgLoadB`
      - Metadata: `timestamp`
    - Reuse existing `toJsonString()` and `toFloatArrayFromJson()` extension functions from RepMetricRepository (import them)

    In `getRepBiomechanics`:
    - Query `selectRepBiomechanicsBySession` and map rows back to `BiomechanicsRepResult` objects
    - Parse JSON TEXT columns back to FloatArray using `toFloatArrayFromJson()`
    - Parse VelocityZone and StrengthProfile enums from TEXT using `valueOf()` or safe lookup

    In `deleteRepBiomechanics`:
    - Call `deleteRepBiomechanicsBySession(sessionId)`

    **Register in DI (DataModule.kt):**
    - Add `single<BiomechanicsRepository> { SqlDelightBiomechanicsRepository(get()) }` in the DataModule

    **Wire into ActiveSessionEngine DI chain (same pattern as RepMetricRepository in Phase 5):**
    1. Add `biomechanicsRepository: BiomechanicsRepository` parameter to `ActiveSessionEngine` constructor
    2. Add `biomechanicsRepository: BiomechanicsRepository` parameter to `DefaultWorkoutSessionManager` and pass through
    3. Add `biomechanicsRepository: BiomechanicsRepository` parameter to `MainViewModel` constructor
    4. Update `PresentationModule.kt` Koin factory to inject `get<BiomechanicsRepository>()`

    **Wire persistence in ActiveSessionEngine.handleSetCompletion():**
    AFTER the existing `repMetricRepository.saveRepMetrics(...)` block (around line 1953), add:

    ```kotlin
    // Persist per-rep biomechanics data (GATE-04: captured for all tiers)
    val biomechanicsSummary = coordinator.biomechanicsEngine.getSetSummary()
    if (sessionId != null && biomechanicsSummary != null) {
        try {
            biomechanicsRepository.saveRepBiomechanics(
                sessionId,
                biomechanicsSummary.repResults
            )
            Logger.d { "Persisted ${biomechanicsSummary.repResults.size} rep biomechanics for session $sessionId" }
        } catch (e: Exception) {
            Logger.e(e) { "Failed to persist rep biomechanics for session $sessionId" }
        }
    }
    ```

    NOTE: The `biomechanicsSummary` variable is already captured at line 1969 in handleSetCompletion. Reuse that existing variable for the persistence call. Do NOT call `getSetSummary()` a second time — it was already called and the engine is reset after. Place the persistence call BEFORE the `coordinator.biomechanicsEngine.reset()` line or use the already-captured variable.

    **Wire biomechanics summary into saveWorkoutSession():**

    **TIMING ISSUE:** In `handleSetCompletion()`, `saveWorkoutSession()` is called at line ~1941, BEFORE `biomechanicsSummary` is captured from the engine at line ~1969. The engine data is still available at `saveWorkoutSession()` time (it hasn't been reset yet).

    **Solution:** In `saveWorkoutSession()`, capture the biomechanics summary directly from the coordinator's engine:
    ```kotlin
    // In saveWorkoutSession(), BEFORE constructing WorkoutSession:
    val bioSummary = coordinator.biomechanicsEngine.getSetSummary()
    ```
    Then map `BiomechanicsSetSummary` fields to the 5 new WorkoutSession fields:
    - `avgMcvMmS = bioSummary?.avgMcvMmS`
    - `avgAsymmetryPercent = bioSummary?.avgAsymmetryPercent`
    - `totalVelocityLossPercent = bioSummary?.totalVelocityLossPercent`
    - `dominantSide = bioSummary?.dominantSide`
    - `strengthProfile = bioSummary?.strengthProfile?.name`

    This works because `saveWorkoutSession()` runs BEFORE `coordinator.biomechanicsEngine.reset()` in handleSetCompletion, so the engine still has the current set's data. The `getSetSummary()` call is idempotent (read-only on the engine state) so calling it here and again later in handleSetCompletion is safe.

    **Reference file:** `WorkoutCoordinator.kt` — field `biomechanicsEngine` at line ~291 is the `BiomechanicsEngine()` instance accessible from the coordinator.
  </action>
  <verify>
    Run `./gradlew :androidApp:assembleDebug` — build must pass.
    Run `./gradlew :androidApp:testDebugUnitTest` — all existing tests must pass.
    Grep for `BiomechanicsRepository` in PresentationModule.kt and DataModule.kt to confirm DI wiring.
    Grep for `biomechanicsRepository.saveRepBiomechanics` in ActiveSessionEngine.kt to confirm persistence call.
  </verify>
  <done>
    BiomechanicsRepository interface and SQLDelight implementation created with save/get/delete. Registered in Koin DI. Injected through MainViewModel -> DWSM -> ActiveSessionEngine chain. Per-rep biomechanics persisted at set completion in handleSetCompletion(). Biomechanics summary fields populated on WorkoutSession at save time. Build passes. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:assembleDebug` passes (schema v16, new repository, DI wiring)
2. `./gradlew :androidApp:testDebugUnitTest` passes (no regression)
3. RepBiomechanics table exists in all 3 locations (VitruvianDatabase.sq, 15.sqm, DriverFactory.ios.kt)
4. DriverFactory.ios.kt CURRENT_SCHEMA_VERSION = 16L
5. shared/build.gradle.kts version = 16
6. BiomechanicsRepository registered in DataModule, injected in PresentationModule
7. handleSetCompletion() calls biomechanicsRepository.saveRepBiomechanics()
8. No FeatureGate checks in BiomechanicsRepository (GATE-04: capture for all tiers)
</verification>

<success_criteria>
- Schema v16 compiles and is consistent across Android and iOS
- BiomechanicsRepository persists per-rep VBT, force curve, and asymmetry data
- WorkoutSession records include biomechanics summary columns
- Data captured for ALL subscription tiers (GATE-04 compliance)
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-biomechanics-persistence/13-01-SUMMARY.md`
</output>

---
phase: 19-cv-form-check-ux-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/16.sqm
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/HapticFeedbackEffect.android.kt
autonomous: true
requirements:
  - CV-05
  - CV-06

must_haves:
  truths:
    - "Form score (0-100) is computed from accumulated FormAssessment objects at set completion using FormRulesEngine.calculateFormScore()"
    - "Form score persists in WorkoutSession.formScore column and survives app restart on both Android and iOS"
    - "Form assessments accumulate during a set and are cleared between sets (no cross-set contamination)"
    - "FORM_WARNING haptic event plays a warning sound with 3-5 second debounce per violation type"
  artifacts:
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/16.sqm"
      provides: "formScore column migration"
      contains: "ALTER TABLE WorkoutSession ADD COLUMN formScore"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt"
      provides: "HapticEvent.FORM_WARNING and WorkoutSession.formScore field"
      contains: "FORM_WARNING"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "Assessment accumulation, form score computation at set end, debounced warning audio"
  key_links:
    - from: "ActiveSessionEngine.handleSetCompletion"
      to: "FormRulesEngine.calculateFormScore"
      via: "formAssessments list accumulated during set"
      pattern: "FormRulesEngine\\.calculateFormScore"
    - from: "ActiveSessionEngine.saveWorkoutSession"
      to: "WorkoutSession.formScore"
      via: "formScore field passed to constructor"
      pattern: "formScore.*="
    - from: "SqlDelightWorkoutRepository.saveSession"
      to: "VitruvianDatabase.sq insertSession"
      via: "formScore parameter"
      pattern: "formScore"
    - from: "DriverFactory.ios.kt"
      to: "migrations/16.sqm"
      via: "CURRENT_SCHEMA_VERSION bump to 17"
      pattern: "CURRENT_SCHEMA_VERSION.*=.*17"
---

<objective>
Wire form check data pipeline: schema migration for formScore persistence, HapticEvent.FORM_WARNING with debounced audio, assessment accumulation during sets with score computation at set end, and WorkoutSession + repository plumbing.

Purpose: Establishes the data foundation (CV-05, CV-06) that the UI layer (Plan 02) will consume. Without this, there is no score to display and no way to persist it.
Output: formScore column in DB, assessment accumulation in ActiveSessionEngine, FORM_WARNING haptic event, WorkoutSession model and repository updates.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-cv-form-check-ux-persistence/19-RESEARCH.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/15.sqm
@shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
@shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/HapticFeedbackEffect.android.kt

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From domain/model/FormCheckModels.kt:
```kotlin
data class FormAssessment(
    val violations: List<FormViolation>,
    val exerciseType: ExerciseFormType,
    val timestamp: Long
)
data class FormViolation(
    val rule: FormRule,
    val actualDegrees: Float,
    val severity: FormViolationSeverity,
    val message: String,
    val correctiveCue: String,
    val timestamp: Long
)
enum class FormViolationSeverity { INFO, WARNING, CRITICAL }
```

From domain/premium/FormRulesEngine.kt:
```kotlin
fun calculateFormScore(assessments: List<FormAssessment>): Int  // Returns 0-100
```

From domain/model/Models.kt (HapticEvent sealed class):
```kotlin
sealed class HapticEvent {
    data object REP_COMPLETED : HapticEvent()
    data class REP_COUNT_ANNOUNCED(val repNumber: Int) : HapticEvent()
    data object WARMUP_COMPLETE : HapticEvent()
    data object WORKOUT_COMPLETE : HapticEvent()
    data object WORKOUT_START : HapticEvent()
    data object WORKOUT_END : HapticEvent()
    data object REST_ENDING : HapticEvent()
    data object ERROR : HapticEvent()
    data object DISCO_MODE_UNLOCKED : HapticEvent()
    data object BADGE_EARNED : HapticEvent()
    data object PERSONAL_RECORD : HapticEvent()
}
```

From domain/model/Models.kt (WorkoutSession data class, last fields):
```kotlin
data class WorkoutSession(
    // ... 40+ existing fields ...
    val avgMcvMmS: Float? = null,
    val avgAsymmetryPercent: Float? = null,
    val totalVelocityLossPercent: Float? = null,
    val dominantSide: String? = null,
    val strengthProfile: String? = null
)
```

From VitruvianDatabase.sq (WorkoutSession table ends with):
```sql
    strengthProfile TEXT,
    -- Sync fields (added in migration 6)
    updatedAt INTEGER,
    serverId TEXT,
    deletedAt INTEGER
);
```

From VitruvianDatabase.sq (insertSession query):
```sql
insertSession:
INSERT INTO WorkoutSession (
    ... 43 columns ending with ...
    avgMcvMmS, avgAsymmetryPercent, totalVelocityLossPercent, dominantSide, strengthProfile
)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
```

From DriverFactory.ios.kt:
```kotlin
private const val CURRENT_SCHEMA_VERSION = 16L
```

From ActiveSessionEngine.handleSetCompletion (reset pattern):
```kotlin
// Reset rep quality scorer for next set
coordinator.repQualityScorer.reset()
coordinator._latestRepQuality.value = null
// Reset biomechanics engine and rep boundary timestamps for next set
coordinator.biomechanicsEngine.reset()
coordinator.repBoundaryTimestamps.clear()
```

From HapticFeedbackEffect.android.kt (sound loading pattern):
```kotlin
loadSoundByName(context, soundPool, "beep")?.let { put(HapticEvent.REP_COMPLETED, it) }
loadSoundByName(context, soundPool, "restover")?.let { put(HapticEvent.REST_ENDING, it) }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, model updates, and HapticEvent.FORM_WARNING</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/16.sqm
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
    shared/src/androidMain/kotlin/com/devil/phoenixproject/presentation/components/HapticFeedbackEffect.android.kt
  </files>
  <action>
    **1. Create SQLDelight migration 16.sqm:**
    Create `shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/16.sqm` with:
    ```sql
    -- Migration 16: Form Check score persistence (Phase 19, CV-06)
    ALTER TABLE WorkoutSession ADD COLUMN formScore INTEGER;
    ```

    **2. Update VitruvianDatabase.sq:**
    - In the `CREATE TABLE WorkoutSession` block, add `formScore INTEGER` BEFORE the sync fields comment (`-- Sync fields`). It should go after `strengthProfile TEXT,` on a new line: `formScore INTEGER,`
    - In the `insertSession:` query, add `formScore` to the column list after `strengthProfile`. Update VALUES to include one more `?` (44 total).
    - In the `upsertSession:` query (the sync query further down), add `formScore` to the column list and VALUES. Adjust the `?` count accordingly.
    - In the `updateSession:` query, add `formScore = ?` to the SET clause.
    - IMPORTANT: Check ALL queries that SELECT from WorkoutSession with column enumeration -- any mapper that receives ALL columns will need updating. The `selectAllSessions`, `selectSessionById`, etc. queries that use `*` are fine. But any query that explicitly lists columns must include `formScore`.

    **3. Bump iOS DriverFactory schema version:**
    In `DriverFactory.ios.kt`, change `CURRENT_SCHEMA_VERSION = 16L` to `CURRENT_SCHEMA_VERSION = 17L`.

    **4. Add formScore to WorkoutSession data class:**
    In `Models.kt`, add `val formScore: Int? = null` to the `WorkoutSession` data class, after `strengthProfile`. Also add computed property: `val hasFormCheckData: Boolean get() = formScore != null`.

    **5. Add HapticEvent.FORM_WARNING:**
    In `Models.kt`, add to the `HapticEvent` sealed class:
    ```kotlin
    /** Warning tone for form violations during CV form check */
    data object FORM_WARNING : HapticEvent()
    ```

    **6. Add form check state fields to WorkoutUiState:**
    In `WorkoutUiState.kt`, add these fields (after `hudPreset`):
    ```kotlin
    val isFormCheckEnabled: Boolean = false,
    val latestFormViolations: List<FormViolation> = emptyList(),
    val latestFormScore: Int? = null
    ```
    Add import for `FormViolation` from `com.devil.phoenixproject.domain.model.FormViolation`.

    **7. Update WorkoutRepository interface:**
    Verify `saveSession` in `WorkoutRepository.kt` accepts `WorkoutSession` -- if it does, no interface change needed (the model change propagates automatically).

    **8. Update SqlDelightWorkoutRepository.saveSession:**
    Add `formScore = session.formScore?.toLong()` parameter to the `queries.insertSession()` call. Add it after `strengthProfile`. Also update `queries.updateSession()` and `queries.upsertSession()` if they exist with explicit parameters.

    **9. Update mapper functions:**
    Any SQLDelight-generated mapper that reads WorkoutSession columns will receive `formScore` as a new parameter. Find the mapper lambdas in `SqlDelightWorkoutRepository.kt` (e.g., in `selectAllSessions`, `selectSessionById`) and add the `formScore` parameter, passing it to the `WorkoutSession` constructor as `formScore = formScore?.toInt()`.

    **10. Add FORM_WARNING sound to HapticFeedbackEffect.android.kt:**
    No `form_warning.ogg` file exists in `res/raw/`. Use `ToneGenerator.TONE_CDMA_ALERT_CALL_GUARD` as a fallback. In the `soundIds` map initialization block in `HapticFeedbackEffect.android.kt`, add:
    ```kotlin
    // Form warning: reuse restover sound as interim warning tone (distinct from rep beep)
    loadSoundByName(context, soundPool, "restover")?.let { put(HapticEvent.FORM_WARNING, it) }
    ```
    This reuses the existing `restover.ogg` sound as a warning tone (it's a short alert that is distinct from the rep beep). This is an interim choice until a dedicated form warning sound asset is created.

    In the `LaunchedEffect` block that handles haptic events, add a case for `HapticEvent.FORM_WARNING`:
    ```kotlin
    is HapticEvent.FORM_WARNING -> {
        // Light vibration + warning sound
        vibrateLightClick(vibrator)
        soundIds[HapticEvent.FORM_WARNING]?.let { soundId ->
            if (loadedSounds.contains(soundId)) {
                soundPool.play(soundId, 0.7f, 0.7f, 1, 0, 1.0f)
            }
        }
    }
    ```
    Follow the exact pattern used by `HapticEvent.REST_ENDING` (light vibrate + SoundPool play).
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileKotlinAndroid :androidApp:compileDebugKotlin 2>&1 | tail -5</automated>
  </verify>
  <done>
    - Migration 16.sqm exists with formScore ALTER TABLE
    - VitruvianDatabase.sq CREATE TABLE, insertSession, upsertSession, and updateSession all include formScore
    - DriverFactory.ios.kt CURRENT_SCHEMA_VERSION = 17L
    - WorkoutSession has formScore: Int? field and hasFormCheckData computed property
    - HapticEvent.FORM_WARNING exists in sealed class
    - WorkoutUiState has isFormCheckEnabled, latestFormViolations, latestFormScore fields
    - SqlDelightWorkoutRepository passes formScore through all session queries
    - HapticFeedbackEffect.android.kt handles FORM_WARNING with sound and vibration
    - Project compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Assessment accumulation and form score computation in ActiveSessionEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  </files>
  <action>
    **1. Add form check fields to WorkoutCoordinator:**
    In `WorkoutCoordinator.kt`, add these fields alongside the existing biomechanics/quality fields:
    ```kotlin
    /** Accumulated form assessments during current set (cleared at set completion) */
    val formAssessments = mutableListOf<FormAssessment>()

    /** Latest form violations for real-time UI display */
    val _latestFormViolations = MutableStateFlow<List<FormViolation>>(emptyList())

    /** Whether form check is currently enabled by user */
    val _isFormCheckEnabled = MutableStateFlow(false)

    /** Latest computed form score for current/last set */
    val _latestFormScore = MutableStateFlow<Int?>(null)

    /** Timestamp of last form warning audio emission per JointAngleType (debounce tracking) */
    val formWarningLastEmitTimestamps = mutableMapOf<JointAngleType, Long>()
    ```
    Add required imports for `FormAssessment`, `FormViolation`, `JointAngleType`, `FormViolationSeverity` from `com.devil.phoenixproject.domain.model`.

    **2. Add onFormAssessment handler in ActiveSessionEngine:**
    Add this function to `ActiveSessionEngine`:
    ```kotlin
    /**
     * Called from FormCheckOverlay when a new form assessment frame is available.
     * Accumulates assessments for set-end scoring and emits real-time violations.
     * Audio cues are debounced per JointAngleType (3-second cooldown).
     */
    fun onFormAssessment(assessment: FormAssessment) {
        coordinator.formAssessments.add(assessment)
        coordinator._latestFormViolations.value = assessment.violations

        // Emit warning audio with per-violation-type debounce (3 seconds)
        val now = currentTimeMillis()
        val hasCriticalOrWarning = assessment.violations.any { violation ->
            val shouldEmit = (violation.severity == FormViolationSeverity.WARNING ||
                violation.severity == FormViolationSeverity.CRITICAL) &&
                (now - (coordinator.formWarningLastEmitTimestamps[violation.rule.jointAngle] ?: 0L)) >= 3000L

            if (shouldEmit) {
                coordinator.formWarningLastEmitTimestamps[violation.rule.jointAngle] = now
            }
            shouldEmit
        }
        if (hasCriticalOrWarning) {
            scope.launch {
                coordinator._hapticEvents.emit(HapticEvent.FORM_WARNING)
            }
        }
    }
    ```
    Add import for `currentTimeMillis` from `com.devil.phoenixproject.util` (or wherever the expect fun is declared -- check existing imports in the file).

    **3. Compute form score at set completion:**
    In `ActiveSessionEngine.handleSetCompletion()`, BEFORE the biomechanics summary capture and BEFORE any resets, add form score computation:
    ```kotlin
    // Capture form score BEFORE clearing assessments
    val formScore = if (coordinator.formAssessments.isNotEmpty()) {
        FormRulesEngine.calculateFormScore(coordinator.formAssessments)
    } else null
    coordinator._latestFormScore.value = formScore
    ```
    Add import for `FormRulesEngine` from `com.devil.phoenixproject.domain.premium`.

    **4. Clear form assessments alongside other resets:**
    In `handleSetCompletion()`, AFTER the existing reset block (where `biomechanicsEngine.reset()` and `repQualityScorer.reset()` are called), add:
    ```kotlin
    // Reset form check state for next set
    coordinator.formAssessments.clear()
    coordinator._latestFormViolations.value = emptyList()
    coordinator.formWarningLastEmitTimestamps.clear()
    ```

    **5. Pass formScore to saveWorkoutSession:**
    In `ActiveSessionEngine.saveWorkoutSession()`, the `WorkoutSession` constructor call must include `formScore = formScore`. The `formScore` variable should be captured from `coordinator._latestFormScore.value` at the top of the function:
    ```kotlin
    val formScoreValue = coordinator._latestFormScore.value
    ```
    Then add to the `WorkoutSession(...)` constructor: `formScore = formScoreValue,`

    **6. Include formScore in SetSummary state:**
    In `handleSetCompletion()`, where `WorkoutState.SetSummary(...)` is constructed, add `formScore` to the SetSummary data class if it has a formScore field. If `WorkoutState.SetSummary` does NOT have a `formScore` field, add one:
    In `Models.kt`, find `data class SetSummary(...)` inside `sealed class WorkoutState` and add:
    ```kotlin
    val formScore: Int? = null
    ```
    Then in `handleSetCompletion`, pass `formScore = formScore` to the SetSummary constructor.

    **7. Also reset form state in resetWorkout / startNewSet:**
    Find the existing reset patterns (where `biomechanicsEngine.reset()` is called in the start-of-workout or reset-workout paths, not just set completion). Add the same form assessment clearing there to ensure no stale data when starting a fresh workout:
    ```kotlin
    coordinator.formAssessments.clear()
    coordinator._latestFormViolations.value = emptyList()
    coordinator.formWarningLastEmitTimestamps.clear()
    coordinator._latestFormScore.value = null
    ```

    **ANTI-PATTERNS TO AVOID:**
    - Do NOT call `FormRulesEngine.evaluate()` anywhere -- that is already called inside `FormCheckOverlay.android.kt`. This layer only receives `FormAssessment` results.
    - Do NOT accumulate assessments when `_isFormCheckEnabled` is false -- but since `FormCheckOverlay` returns early when `!isEnabled`, no assessments will arrive anyway. No guard needed here.
    - Do NOT hold synchronized locks across the `emit()` suspend call -- the debounce logic uses simple timestamp comparison (safe for single-threaded coroutine dispatcher).
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5</automated>
  </verify>
  <done>
    - WorkoutCoordinator has formAssessments list, _latestFormViolations, _isFormCheckEnabled, _latestFormScore flows, and formWarningLastEmitTimestamps map
    - ActiveSessionEngine.onFormAssessment accumulates assessments, emits real-time violations, and triggers debounced FORM_WARNING audio
    - handleSetCompletion computes formScore via FormRulesEngine.calculateFormScore before clearing assessments
    - saveWorkoutSession passes formScore to WorkoutSession constructor
    - Form state is cleared in all reset paths (set completion, workout reset, new set start)
    - WorkoutState.SetSummary includes formScore field
    - Project compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinAndroid :androidApp:compileDebugKotlin` succeeds
2. Migration 16.sqm exists and contains `ALTER TABLE WorkoutSession ADD COLUMN formScore INTEGER`
3. `grep -r "CURRENT_SCHEMA_VERSION" shared/src/iosMain/` shows `17L`
4. `grep -r "FORM_WARNING" shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt` returns a match
5. `grep -r "formAssessments" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/` returns matches in both WorkoutCoordinator and ActiveSessionEngine
6. `grep -r "formScore" shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt` shows field in WorkoutSession and SetSummary
</verification>

<success_criteria>
- Schema migration 16 adds formScore column to WorkoutSession
- iOS DriverFactory bumped to version 17
- HapticEvent.FORM_WARNING exists with sound handling on Android
- FormAssessments accumulate during sets, are scored at completion, and cleared between sets
- Form score flows through saveWorkoutSession to database
- WorkoutUiState has form check state fields ready for UI consumption
- Full project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/19-cv-form-check-ux-persistence/19-01-SUMMARY.md`
</output>

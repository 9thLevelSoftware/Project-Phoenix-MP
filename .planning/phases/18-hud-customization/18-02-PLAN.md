---
phase: 18-hud-customization
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavGraph.kt
autonomous: true
requirements:
  - BOARD-04
must_haves:
  truths:
    - "User can select a HUD preset (Essential, Biomechanics, Full) in Settings"
    - "WorkoutHud pager shows only pages from the selected preset"
    - "Page count changes dynamically when preset changes"
    - "Execution page is always visible regardless of preset"
    - "Dot indicator shows correct number of dots matching visible page count"
    - "HUD preference persists across app restarts"
    - "Preset selector uses Material 3 SegmentedButton row"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt"
      provides: "Dynamic pager filtering based on hudPreset"
      contains: "visiblePages"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt"
      provides: "HUD preset selector UI"
      contains: "SingleChoiceSegmentedButtonRow"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt"
      provides: "hudPreset field in WorkoutUiState"
      contains: "hudPreset"
  key_links:
    - from: "NavGraph.kt"
      to: "SettingsTab.kt"
      via: "hudPreset prop and onHudPresetChange callback"
      pattern: "hudPreset.*viewModel"
    - from: "ActiveWorkoutScreen.kt"
      to: "WorkoutUiState.kt"
      via: "hudPreset collected from viewModel into uiState"
      pattern: "hudPreset"
    - from: "WorkoutTab.kt"
      to: "WorkoutHud.kt"
      via: "hudPreset parameter passed through"
      pattern: "hudPreset"
    - from: "WorkoutHud.kt"
      to: "HudModels.kt"
      via: "HudPreset.fromKey(hudPreset).pages for pager filtering"
      pattern: "HudPreset\\.fromKey"
---

<objective>
Wire the HUD preset into the UI layer: add preset selector in SettingsTab, thread hudPreset through ActiveWorkoutScreen -> WorkoutUiState -> WorkoutTab -> WorkoutHud, and convert WorkoutHud's HorizontalPager from hardcoded 3-page to dynamic filtered page list.

Purpose: Complete the user-facing feature so users can select a HUD preset in Settings and see the pager page count change accordingly during workouts.

Output: SettingsTab with preset selector, WorkoutHud with dynamic pager, full data flow from ViewModel to HUD.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-hud-customization/18-RESEARCH.md
@.planning/phases/18-hud-customization/18-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01. Executor should use these directly. -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/HudModels.kt (created in Plan 01):
```kotlin
enum class HudPage(val key: String) {
    EXECUTION("execution"),
    INSTRUCTION("instruction"),
    STATS("stats");
    companion object {
        fun fromKey(key: String): HudPage? = entries.find { it.key == key }
    }
}

enum class HudPreset(val key: String, val displayName: String, val description: String, val pages: List<HudPage>) {
    ESSENTIAL("essential", "Essential", "Rep counter and force gauge only", listOf(HudPage.EXECUTION)),
    BIOMECHANICS("biomechanics", "Biomechanics", "Execution + live velocity/force stats", listOf(HudPage.EXECUTION, HudPage.STATS)),
    FULL("full", "Full", "All pages including exercise video", listOf(HudPage.EXECUTION, HudPage.INSTRUCTION, HudPage.STATS));
    companion object {
        fun fromKey(key: String): HudPreset = entries.find { it.key == key } ?: FULL
    }
}
```

From MainViewModel.kt (added in Plan 01):
```kotlin
val hudPreset: StateFlow<String> get() = settingsManager.hudPreset
fun setHudPreset(preset: String) = settingsManager.setHudPreset(preset)
```

From WorkoutHud.kt current signature (lines 56-83):
```kotlin
fun WorkoutHud(
    activeState: WorkoutState.Active,
    metric: WorkoutMetric?,
    workoutParameters: WorkoutParameters,
    repCount: RepCount,
    repRanges: RepRanges?,
    weightUnit: WeightUnit,
    connectionState: ConnectionState,
    exerciseRepository: ExerciseRepository,
    loadedRoutine: Routine?,
    currentExerciseIndex: Int,
    currentSetIndex: Int,
    enableVideoPlayback: Boolean,
    onStopWorkout: () -> Unit,
    formatWeight: (Float, WeightUnit) -> String,
    onUpdateParameters: (WorkoutParameters) -> Unit,
    onStartNextExercise: () -> Unit,
    currentHeuristicKgMax: Float = 0f,
    loadBaselineA: Float = 0f,
    loadBaselineB: Float = 0f,
    timedExerciseRemainingSeconds: Int? = null,
    isCurrentExerciseBodyweight: Boolean = false,
    latestBiomechanicsResult: BiomechanicsRepResult? = null,
    detectionState: DetectionState = DetectionState(),
    onDetectionConfirmed: suspend (String, String) -> Unit = { _, _ -> },
    onDetectionDismissed: () -> Unit = {},
    modifier: Modifier = Modifier
)
```

From WorkoutHud.kt current pager (lines 87-183):
```kotlin
val pagerState = rememberPagerState(pageCount = { 3 })
// ...
HorizontalPager(state = pagerState, ...) { page ->
    when (page) {
        0 -> ExecutionPage(...)
        1 -> InstructionPage(...)
        2 -> StatsPage(...)
    }
}
// Dot indicator at line 194:
repeat(pagerState.pageCount) { iteration -> ... }
```

From WorkoutUiState.kt (current fields):
```kotlin
data class WorkoutUiState(
    val connectionState: ConnectionState = ConnectionState.Disconnected,
    // ... many fields ...
    val detectionState: DetectionState = DetectionState()
)
```

From WorkoutTab.kt state holder overload (lines 51-113):
```kotlin
fun WorkoutTab(
    state: WorkoutUiState,
    actions: WorkoutActions,
    exerciseRepository: ExerciseRepository,
    hapticEvents: SharedFlow<HapticEvent>? = null,
    modifier: Modifier = Modifier
)
// Delegates to full WorkoutTab implementation, passing state fields individually
```

From WorkoutTab.kt full implementation (lines 120-175):
```kotlin
fun WorkoutTab(
    // ... many params including enableVideoPlayback: Boolean ...
)
// At line 185: WorkoutHud(...) call
```

From ActiveWorkoutScreen.kt (lines 31-79):
```kotlin
fun ActiveWorkoutScreen(
    navController: NavController,
    viewModel: MainViewModel,
    exerciseRepository: ExerciseRepository
)
// Collects many flows from viewModel, creates WorkoutUiState
```

From SettingsTab.kt signature (lines 41-89):
```kotlin
fun SettingsTab(
    // ... many params including:
    colorBlindModeEnabled: Boolean = false,
    onColorBlindModeChange: (Boolean) -> Unit = {},
    simulatorModeUnlocked: Boolean = false,
    // ...
)
```

From NavGraph.kt SettingsTab call site (lines 298-345):
```kotlin
SettingsTab(
    // ... many props ...
    colorBlindModeEnabled = userPreferences.colorBlindModeEnabled,
    onColorBlindModeChange = { viewModel.setColorBlindModeEnabled(it) },
    simulatorModeUnlocked = viewModel.isSimulatorModeUnlocked(),
    // ...
)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread hudPreset through ActiveWorkoutScreen, WorkoutUiState, and WorkoutTab to WorkoutHud</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  </files>
  <action>
    **1. Add hudPreset to WorkoutUiState.kt:**
    Add `val hudPreset: String = "full"` as a field in the `WorkoutUiState` data class, after `detectionState`. Import `HudPreset` from domain model and use `HudPreset.FULL.key` as default (or just the string "full" for simplicity since it's a data class default).

    **2. Collect hudPreset in ActiveWorkoutScreen.kt:**
    After the `val userPreferences by viewModel.userPreferences.collectAsState()` line (~line 62), the hudPreset is already available via `userPreferences.hudPreset`. Find where the WorkoutUiState is constructed (search for how `WorkoutTab` is called with a `WorkoutUiState` or how the state holder overload is used).

    IMPORTANT: ActiveWorkoutScreen does NOT use WorkoutUiState directly -- it collects individual flows and passes them as individual parameters. Look at how ActiveWorkoutScreen constructs its WorkoutTab call. It likely uses the state holder overload that takes `WorkoutUiState`.

    Search ActiveWorkoutScreen for `WorkoutTab(` to find the call site. If it creates a `WorkoutUiState(...)`, add `hudPreset = userPreferences.hudPreset`. If it passes params individually, add a `hudPreset` parameter.

    Also: add `val hudPreset by viewModel.hudPreset.collectAsState()` as a collected flow in ActiveWorkoutScreen, then pass it wherever WorkoutTab is called.

    **3. Thread hudPreset through WorkoutTab:**

    a) In the **state holder overload** (lines 51-113): Add `hudPreset = state.hudPreset` in the delegation to the full implementation.

    b) In the **full implementation** (lines 120-175): Add `hudPreset: String = HudPreset.FULL.key` as a parameter. Pass it to `WorkoutHud(...)` call at line 185.

    Import `HudPreset` from `com.devil.phoenixproject.domain.model.HudPreset`.

    **4. Add hudPreset parameter to WorkoutHud and convert pager to dynamic filtering:**

    a) Add parameter: `hudPreset: String = HudPreset.FULL.key` after `enableVideoPlayback` in the function signature.

    b) Replace the hardcoded pager setup:
    ```kotlin
    // OLD (line 87):
    val pagerState = rememberPagerState(pageCount = { 3 })

    // NEW:
    val visiblePages = remember(hudPreset) {
        HudPreset.fromKey(hudPreset).pages
    }
    val pagerState = rememberPagerState(pageCount = { visiblePages.size })
    ```

    c) Replace the `when (page)` block inside `HorizontalPager` (lines 145-183):
    ```kotlin
    // OLD:
    when (page) {
        0 -> ExecutionPage(...)
        1 -> InstructionPage(...)
        2 -> StatsPage(...)
    }

    // NEW:
    when (visiblePages[pageIndex]) {
        HudPage.EXECUTION -> ExecutionPage(...)
        HudPage.INSTRUCTION -> InstructionPage(...)
        HudPage.STATS -> StatsPage(...)
    }
    ```
    Note: The lambda parameter name changes from `page` to `pageIndex` for clarity. Keep all the existing arguments to ExecutionPage, InstructionPage, and StatsPage exactly as they are.

    d) The dot indicator at line 194 already uses `pagerState.pageCount` via `repeat(pagerState.pageCount)`, so it will automatically update. No change needed there.

    Import `HudPage` and `HudPreset` from `com.devil.phoenixproject.domain.model`.
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug --no-daemon 2>&1 | tail -5</automated>
  </verify>
  <done>hudPreset flows from MainViewModel through ActiveWorkoutScreen -> WorkoutUiState -> WorkoutTab -> WorkoutHud. WorkoutHud pager dynamically filters pages based on active preset. Dot indicator reflects visible page count. Full Android build compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Add HUD preset selector to SettingsTab and wire through NavGraph</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavGraph.kt
  </files>
  <action>
    **1. Add hudPreset parameters to SettingsTab.kt:**
    After the `onColorBlindModeChange` parameter (line 83), add:
    ```kotlin
    // HUD preset customization
    hudPreset: String = HudPreset.FULL.key,
    onHudPresetChange: (String) -> Unit = {},
    ```
    Import `HudPreset` from `com.devil.phoenixproject.domain.model.HudPreset`.

    **2. Add HUD preset selector UI in SettingsTab body:**
    Add a new "Workout HUD" card section AFTER the Accessibility card (after line ~859, before the LED Biofeedback section at line 861). The placement is: Accessibility -> **Workout HUD** -> LED Biofeedback.

    Create a Card identical in style to the Accessibility card (same shadow, border, shape), with:
    - Header: Icon `Icons.Default.Dashboard` with a gradient background (use `Color(0xFF5C6BC0)` to `Color(0xFF7E57C2)` for a purple-ish display theme), title "Workout HUD"
    - Description text: "Choose which pages to show during workouts"
    - A `SingleChoiceSegmentedButtonRow` with 3 segments for Essential/Biomechanics/Full
    - Below each segment, a description text for the selected preset

    Implementation:
    ```kotlin
    // Workout HUD Section - Preset page visibility
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .shadow(8.dp, RoundedCornerShape(20.dp)),
        colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceContainerHighest),
        shape = RoundedCornerShape(20.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 8.dp),
        border = BorderStroke(2.dp, MaterialTheme.colorScheme.primary.copy(alpha = 0.2f))
    ) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(Spacing.medium)
        ) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Box(
                    modifier = Modifier
                        .size(48.dp)
                        .shadow(8.dp, RoundedCornerShape(20.dp))
                        .background(
                            Brush.linearGradient(
                                listOf(Color(0xFF5C6BC0), Color(0xFF7E57C2))
                            ),
                            RoundedCornerShape(20.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    Icon(
                        Icons.Default.Dashboard,
                        contentDescription = "Workout HUD",
                        tint = MaterialTheme.colorScheme.onPrimary,
                        modifier = Modifier.size(24.dp)
                    )
                }
                Spacer(modifier = Modifier.width(Spacing.medium))
                Text(
                    "Workout HUD",
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = MaterialTheme.colorScheme.onSurface
                )
            }

            Spacer(modifier = Modifier.height(Spacing.medium))

            Text(
                "Choose which pages to show during workouts",
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            Spacer(modifier = Modifier.height(Spacing.small))

            SingleChoiceSegmentedButtonRow(
                modifier = Modifier.fillMaxWidth()
            ) {
                HudPreset.entries.forEachIndexed { index, preset ->
                    SegmentedButton(
                        selected = hudPreset == preset.key,
                        onClick = { onHudPresetChange(preset.key) },
                        shape = SegmentedButtonDefaults.itemShape(index, HudPreset.entries.size)
                    ) {
                        Text(preset.displayName)
                    }
                }
            }

            Spacer(modifier = Modifier.height(Spacing.small))

            // Description of selected preset
            val selectedPreset = HudPreset.fromKey(hudPreset)
            Text(
                selectedPreset.description,
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
    ```

    Add the necessary imports at the top of SettingsTab.kt:
    - `import com.devil.phoenixproject.domain.model.HudPreset`
    - `import androidx.compose.material3.SegmentedButton`
    - `import androidx.compose.material3.SegmentedButtonDefaults`
    - `import androidx.compose.material3.SingleChoiceSegmentedButtonRow`

    Also add `@OptIn(ExperimentalMaterial3Api::class)` to the SettingsTab function if not already present (SegmentedButton is experimental in Material 3).

    **3. Wire hudPreset in NavGraph.kt:**
    In the SettingsTab call site (around lines 298-345), add these two lines alongside the colorBlindModeEnabled wiring:
    ```kotlin
    // HUD preset customization
    hudPreset = userPreferences.hudPreset,
    onHudPresetChange = { viewModel.setHudPreset(it) },
    ```
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug --no-daemon 2>&1 | tail -5</automated>
  </verify>
  <done>SettingsTab shows a "Workout HUD" card with a 3-segment preset selector (Essential/Biomechanics/Full). Selecting a preset persists via the full pipeline and the WorkoutHud pager responds dynamically. Full Android build compiles.</done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:assembleDebug` passes (full Android build)
2. `./gradlew :shared:testAndroidHostTest --tests "*.SettingsManagerTest"` passes (from Plan 01)
3. SettingsTab displays "Workout HUD" card with SegmentedButton row
4. Setting a preset persists and the WorkoutHud pager filters pages accordingly
5. Essential preset shows 1 page (Execution only, 1 dot)
6. Biomechanics preset shows 2 pages (Execution + Stats, 2 dots)
7. Full preset shows 3 pages (all, 3 dots)
8. Execution page is always present in every preset
</verification>

<success_criteria>
- User can select Essential, Biomechanics, or Full preset in Settings
- WorkoutHud pager shows only pages matching the selected preset
- Page count and dot indicator update dynamically
- Execution page is always visible (cannot be hidden)
- Preset persists across app restarts (stored as string key "hud_preset")
- Full Android assembleDebug build passes
</success_criteria>

<output>
After completion, create `.planning/phases/18-hud-customization/18-02-SUMMARY.md`
</output>

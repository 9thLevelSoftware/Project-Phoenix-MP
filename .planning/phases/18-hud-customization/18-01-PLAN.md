---
phase: 18-hud-customization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/HudModels.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakePreferencesManager.kt
  - androidApp/src/androidTest/kotlin/com/devil/phoenixproject/testutil/FakePreferencesManager.kt
  - shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManagerTest.kt
autonomous: true
requirements:
  - BOARD-04
must_haves:
  truths:
    - "HudPage enum defines EXECUTION, INSTRUCTION, and STATS with stable string keys"
    - "HudPreset enum defines ESSENTIAL, BIOMECHANICS, and FULL presets with correct page lists"
    - "EXECUTION page is present in every preset definition"
    - "HUD preset persists as a string key via multiplatform-settings"
    - "HudPreset.FULL is the default (existing users see no behavior change)"
    - "SettingsManager exposes hudPreset as StateFlow and setter"
    - "MainViewModel delegates hudPreset to SettingsManager"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/HudModels.kt"
      provides: "HudPage and HudPreset enum definitions"
      contains: "enum class HudPage"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt"
      provides: "hudPreset field in UserPreferences data class"
      contains: "hudPreset"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt"
      provides: "setHudPreset interface method and implementation"
      contains: "setHudPreset"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt"
      provides: "hudPreset StateFlow and setter"
      contains: "hudPreset"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt"
      provides: "hudPreset delegation to SettingsManager"
      contains: "hudPreset"
  key_links:
    - from: "UserPreferences.kt"
      to: "PreferencesManager.kt"
      via: "hudPreset field loaded/saved"
      pattern: "KEY_HUD_PRESET"
    - from: "PreferencesManager.kt"
      to: "SettingsManager.kt"
      via: "StateFlow map from preferencesFlow"
      pattern: "map.*hudPreset"
    - from: "SettingsManager.kt"
      to: "MainViewModel.kt"
      via: "delegation getter and setter"
      pattern: "settingsManager\\.hudPreset"
---

<objective>
Create the HudPage/HudPreset domain models and wire the HUD preset preference through the entire persistence pipeline (UserPreferences -> PreferencesManager -> SettingsManager -> MainViewModel).

Purpose: Establish the data layer and preference pipeline so Plan 02 can consume the hudPreset value in the UI (WorkoutHud pager filtering and SettingsTab selector).

Output: HudModels.kt with enums, preference pipeline wired end-to-end, FakePreferencesManager fixes, SettingsManager test.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-hud-customization/18-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->
<!-- Executor should use these directly -- no codebase exploration needed. -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt:
```kotlin
data class UserPreferences(
    val weightUnit: WeightUnit = WeightUnit.LB,
    val stopAtTop: Boolean = false,
    val enableVideoPlayback: Boolean = true,
    val beepsEnabled: Boolean = true,
    val colorScheme: Int = 0,
    val stallDetectionEnabled: Boolean = true,
    val discoModeUnlocked: Boolean = false,
    val audioRepCountEnabled: Boolean = false,
    val ledFeedbackEnabled: Boolean = false,
    val colorBlindModeEnabled: Boolean = false,
    val summaryCountdownSeconds: Int = 10,
    val autoStartCountdownSeconds: Int = 5
)
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt (interface):
```kotlin
interface PreferencesManager {
    val preferencesFlow: StateFlow<UserPreferences>
    suspend fun setWeightUnit(unit: WeightUnit)
    suspend fun setStopAtTop(enabled: Boolean)
    suspend fun setEnableVideoPlayback(enabled: Boolean)
    suspend fun setBeepsEnabled(enabled: Boolean)
    suspend fun setColorScheme(scheme: Int)
    suspend fun setStallDetectionEnabled(enabled: Boolean)
    suspend fun setDiscoModeUnlocked(unlocked: Boolean)
    suspend fun setAudioRepCountEnabled(enabled: Boolean)
    suspend fun setLedFeedbackEnabled(enabled: Boolean)
    suspend fun setColorBlindModeEnabled(enabled: Boolean)
    suspend fun setSummaryCountdownSeconds(seconds: Int)
    suspend fun setAutoStartCountdownSeconds(seconds: Int)
    suspend fun setSimulatorModeUnlocked(unlocked: Boolean)
    fun isSimulatorModeUnlocked(): Boolean
    // ... exercise/justlift defaults omitted
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt (pattern):
```kotlin
val colorBlindModeEnabled: StateFlow<Boolean> = userPreferences
    .map { it.colorBlindModeEnabled }
    .stateIn(scope, SharingStarted.Eagerly, false)
fun setColorBlindModeEnabled(enabled: Boolean) {
    scope.launch { preferencesManager.setColorBlindModeEnabled(enabled) }
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt (pattern):
```kotlin
val colorBlindModeEnabled: StateFlow<Boolean> get() = settingsManager.colorBlindModeEnabled
fun setColorBlindModeEnabled(enabled: Boolean) = settingsManager.setColorBlindModeEnabled(enabled)
```

From SettingsPreferencesManager (implementation pattern):
```kotlin
private const val KEY_COLOR_BLIND_MODE = "color_blind_mode_enabled"
// In loadPreferences():
colorBlindModeEnabled = settings.getBoolean(KEY_COLOR_BLIND_MODE, false)
// Setter:
override suspend fun setColorBlindModeEnabled(enabled: Boolean) {
    settings.putBoolean(KEY_COLOR_BLIND_MODE, enabled)
    updateAndEmit { copy(colorBlindModeEnabled = enabled) }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HudPage and HudPreset enums and wire preference pipeline</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/HudModels.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  </files>
  <action>
    **1. Create HudModels.kt** in `domain/model/`:
    ```kotlin
    package com.devil.phoenixproject.domain.model

    enum class HudPage(val key: String) {
        EXECUTION("execution"),
        INSTRUCTION("instruction"),
        STATS("stats");

        companion object {
            fun fromKey(key: String): HudPage? = entries.find { it.key == key }
        }
    }

    enum class HudPreset(val key: String, val displayName: String, val description: String, val pages: List<HudPage>) {
        ESSENTIAL("essential", "Essential", "Rep counter and force gauge only", listOf(HudPage.EXECUTION)),
        BIOMECHANICS("biomechanics", "Biomechanics", "Execution + live velocity/force stats", listOf(HudPage.EXECUTION, HudPage.STATS)),
        FULL("full", "Full", "All pages including exercise video", listOf(HudPage.EXECUTION, HudPage.INSTRUCTION, HudPage.STATS));

        companion object {
            fun fromKey(key: String): HudPreset = entries.find { it.key == key } ?: FULL
        }
    }
    ```
    Note: EXECUTION is present in every preset. Default fallback is FULL (no behavior change for existing users).

    **2. Add hudPreset field to UserPreferences.kt:**
    Add `val hudPreset: String = HudPreset.FULL.key` as the last field in the data class. Import HudPreset. Default is "full" so existing users see all pages.

    **3. Add setHudPreset to PreferencesManager interface and implementation:**
    - Add `suspend fun setHudPreset(preset: String)` to the `PreferencesManager` interface (after `setColorBlindModeEnabled`).
    - Add `private const val KEY_HUD_PRESET = "hud_preset"` to the companion object.
    - Add `hudPreset = settings.getStringOrNull(KEY_HUD_PRESET) ?: HudPreset.FULL.key` to `loadPreferences()`.
    - Add implementation:
      ```kotlin
      override suspend fun setHudPreset(preset: String) {
          settings.putString(KEY_HUD_PRESET, preset)
          updateAndEmit { copy(hudPreset = preset) }
      }
      ```
    - Import HudPreset.

    **4. Add hudPreset StateFlow and setter to SettingsManager.kt:**
    After the `colorBlindModeEnabled` block, add:
    ```kotlin
    val hudPreset: StateFlow<String> = userPreferences
        .map { it.hudPreset }
        .stateIn(scope, SharingStarted.Eagerly, HudPreset.FULL.key)

    fun setHudPreset(preset: String) {
        scope.launch { preferencesManager.setHudPreset(preset) }
    }
    ```
    Import HudPreset.

    **5. Add hudPreset delegation to MainViewModel.kt:**
    After the `setColorBlindModeEnabled` line (~line 207), add:
    ```kotlin
    val hudPreset: StateFlow<String> get() = settingsManager.hudPreset
    fun setHudPreset(preset: String) = settingsManager.setHudPreset(preset)
    ```
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileCommonMainKotlinMetadata --no-daemon 2>&1 | tail -5</automated>
  </verify>
  <done>HudPage and HudPreset enums exist with stable string keys. EXECUTION is in every preset. Preference pipeline wired from UserPreferences through MainViewModel. Common code compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Fix FakePreferencesManager and add SettingsManager hudPreset test</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakePreferencesManager.kt
    androidApp/src/androidTest/kotlin/com/devil/phoenixproject/testutil/FakePreferencesManager.kt
    shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManagerTest.kt
  </files>
  <action>
    **1. Fix commonTest FakePreferencesManager** (`shared/src/commonTest/.../FakePreferencesManager.kt`):
    - Add missing `setColorBlindModeEnabled` override (pre-existing Phase 17 gap):
      ```kotlin
      override suspend fun setColorBlindModeEnabled(enabled: Boolean) {
          _preferencesFlow.value = _preferencesFlow.value.copy(colorBlindModeEnabled = enabled)
      }
      ```
    - Add new `setHudPreset` override:
      ```kotlin
      override suspend fun setHudPreset(preset: String) {
          _preferencesFlow.value = _preferencesFlow.value.copy(hudPreset = preset)
      }
      ```

    **2. Fix androidTest FakePreferencesManager** (`androidApp/src/androidTest/.../FakePreferencesManager.kt`):
    - Same two additions: `setColorBlindModeEnabled` (pre-existing gap) and `setHudPreset`.

    **3. Add hudPreset test to SettingsManagerTest.kt:**
    Add a new test method after the existing tests:
    ```kotlin
    @Test
    fun `hudPreset defaults to full and updates on change`() = runTest {
        val managerScope = CoroutineScope(coroutineContext + SupervisorJob())
        try {
            val manager = SettingsManager(fakePreferencesManager, fakeBleRepository, managerScope)

            // Default is "full"
            assertEquals("full", manager.hudPreset.value)

            // Change to essential
            manager.setHudPreset("essential")
            advanceUntilIdle()
            assertEquals("essential", fakePreferencesManager.preferencesFlow.value.hudPreset)
            assertEquals("essential", manager.hudPreset.value)

            // Change to biomechanics
            manager.setHudPreset("biomechanics")
            advanceUntilIdle()
            assertEquals("biomechanics", manager.hudPreset.value)
        } finally {
            managerScope.cancel()
        }
    }
    ```
    Import `assertEquals` if not already present (it is).
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testAndroidHostTest --tests "com.devil.phoenixproject.presentation.manager.SettingsManagerTest" --no-daemon 2>&1 | tail -10</automated>
  </verify>
  <done>Both FakePreferencesManager files implement setColorBlindModeEnabled (pre-existing fix) and setHudPreset. SettingsManagerTest passes with hudPreset default and update assertions.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileCommonMainKotlinMetadata` passes (domain models + pipeline compile)
2. `./gradlew :shared:testAndroidHostTest --tests "*.SettingsManagerTest"` passes (hudPreset test + existing tests)
3. HudModels.kt exists with HudPage and HudPreset enums
4. Every HudPreset contains HudPage.EXECUTION
5. UserPreferences.hudPreset defaults to "full"
6. PreferencesManager interface includes setHudPreset
7. SettingsManager exposes hudPreset StateFlow
8. MainViewModel delegates hudPreset to SettingsManager
</verification>

<success_criteria>
- HudPage enum has 3 entries (EXECUTION, INSTRUCTION, STATS) with stable string keys
- HudPreset enum has 3 presets (ESSENTIAL, BIOMECHANICS, FULL) each containing EXECUTION
- Preference pipeline is complete: UserPreferences -> PreferencesManager -> SettingsManager -> MainViewModel
- Default is FULL (no change for existing users)
- Both FakePreferencesManager files are fixed (colorBlindModeEnabled + hudPreset)
- SettingsManagerTest passes with new hudPreset test
</success_criteria>

<output>
After completion, create `.planning/phases/18-hud-customization/18-01-SUMMARY.md`
</output>

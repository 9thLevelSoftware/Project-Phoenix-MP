---
phase: 06-protocol-parser
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolParser.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolModels.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/ProtocolParserTest.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: true

must_haves:
  truths:
    - "parseRepPacket handles both legacy 6-byte and modern 24-byte formats"
    - "parseMonitorPacket extracts position, load, and status correctly"
    - "parseDiagnosticPacket detects fault codes"
    - "parseHeuristicPacket extracts concentric/eccentric statistics"
    - "All parsing functions return null for packets smaller than minimum size"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolParser.kt"
      provides: "All 4 packet parsing functions"
      contains: "fun parseRepPacket"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolModels.kt"
      provides: "Intermediate packet data classes"
      contains: "data class MonitorPacket"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/ProtocolParserTest.kt"
      provides: "Unit tests for packet parsers"
      contains: "parseRepPacket parses"
  key_links:
    - from: "KableBleRepository.kt"
      to: "ProtocolParser.kt"
      via: "import and function calls"
      pattern: "import.*parseMonitorPacket|parseRepPacket"
    - from: "ProtocolParser.kt"
      to: "ProtocolModels.kt"
      via: "return types"
      pattern: "MonitorPacket|DiagnosticPacket"
---

<objective>
Extract packet parsing functions from KableBleRepository to ProtocolParser.kt, add intermediate data classes, and update KableBleRepository to use the extracted functions.

Purpose: Complete the ProtocolParser extraction, making all byte parsing stateless and unit-testable. This enables testing protocol parsing without BLE connection.

Output: Complete ProtocolParser.kt with all parsing functions, ProtocolModels.kt with data classes, comprehensive tests, and KableBleRepository updated to use extracted parsers.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-protocol-parser/06-RESEARCH.md
@.planning/phases/06-protocol-parser/06-01-SUMMARY.md

# Source files for extraction
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt (RepNotification definition)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/HeuristicStatistics.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProtocolModels.kt with intermediate data classes</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolModels.kt</files>
  <action>
    Create ProtocolModels.kt with two intermediate data classes for parsed packet data:

    ```kotlin
    package com.devil.phoenixproject.data.ble

    /**
     * Raw parsed monitor data before validation/processing.
     * Position in mm (raw / 10.0f), load in kg (raw / 100.0f).
     * Created by parseMonitorPacket().
     */
    data class MonitorPacket(
        val ticks: Int,
        val posA: Float,    // mm
        val posB: Float,    // mm
        val loadA: Float,   // kg
        val loadB: Float,   // kg
        val status: Int     // Status flags (0 if not present)
    )

    /**
     * Raw parsed diagnostic data.
     * Created by parseDiagnosticPacket().
     */
    data class DiagnosticPacket(
        val seconds: Int,
        val faults: List<Short>,    // 4 fault codes
        val temps: List<Byte>,      // 8 temperature readings
        val hasFaults: Boolean
    )
    ```

    NOTE: RepNotification already exists in BleRepository.kt. HeuristicStatistics already exists in domain/model/. Do not duplicate them.
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5`</verify>
  <done>ProtocolModels.kt exists with MonitorPacket and DiagnosticPacket data classes</done>
</task>

<task type="auto">
  <name>Task 2: Add packet parsing functions to ProtocolParser.kt</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/ProtocolParser.kt</files>
  <action>
    Add 4 packet parsing functions to ProtocolParser.kt (after the byte utilities from 06-01):

    1. **parseRepPacket(data, hasOpcodePrefix, timestamp)** -> RepNotification?
       - Return null if effectiveSize < 6
       - If effectiveSize >= 24: parse modern format (all 8 fields)
       - Else: parse legacy format (u16 counters only)
       - CRITICAL: Two-tier ONLY (< 24 = legacy, >= 24 = modern) per Issue #210 warning
       - offset = 1 if hasOpcodePrefix, else 0
       - Import RepNotification from BleRepository.kt

    2. **parseMonitorPacket(data)** -> MonitorPacket?
       - Return null if size < 16
       - Parse: ticksLow, ticksHigh -> combined ticks
       - posA = getInt16LE(4) / 10.0f (signed for negative positions)
       - posB = getInt16LE(10) / 10.0f
       - loadA = getUInt16LE(8) / 100.0f
       - loadB = getUInt16LE(14) / 100.0f
       - status = getUInt16LE(16) if size >= 18, else 0

    3. **parseDiagnosticPacket(data)** -> DiagnosticPacket?
       - Return null if size < 20
       - seconds = getInt32LE(0)
       - faults: 4 shorts at offsets 4, 6, 8, 10
       - temps: 8 bytes at offsets 12-19
       - hasFaults = any fault != 0

    4. **parseHeuristicPacket(data, timestamp)** -> HeuristicStatistics?
       - Return null if size < 48
       - concentric: 6 floats at offsets 0-20
       - eccentric: 6 floats at offsets 24-44
       - Import HeuristicStatistics, HeuristicPhaseStatistics from domain.model

    All functions are pure: no logging, no state mutation, no side effects.
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5`</verify>
  <done>All 4 packet parsing functions exist in ProtocolParser.kt</done>
</task>

<task type="auto">
  <name>Task 3: Add packet parsing tests to ProtocolParserTest.kt</name>
  <files>shared/src/commonTest/kotlin/com/devil/phoenixproject/data/ble/ProtocolParserTest.kt</files>
  <action>
    Add tests for all 4 packet parsers (extend existing test file from 06-01):

    **Rep Packet Tests (Issue #210 critical):**
    ```kotlin
    @Test fun `parseRepPacket returns null for short data`()
    @Test fun `parseRepPacket parses legacy 6-byte format`()
    @Test fun `parseRepPacket parses modern 24-byte format`()
    @Test fun `parseRepPacket handles opcode prefix correctly`()
    ```

    Use golden test vectors:
    - Legacy 6-byte: [0x05, 0x00, 0x00, 0x00, 0x03, 0x00] -> top=5, complete=3
    - Modern 24-byte: See 06-RESEARCH.md for exact bytes

    **Monitor Packet Tests:**
    ```kotlin
    @Test fun `parseMonitorPacket returns null for short data`()
    @Test fun `parseMonitorPacket parses position correctly`()
    @Test fun `parseMonitorPacket parses load correctly`()
    @Test fun `parseMonitorPacket parses status flags`()
    ```

    **Diagnostic Packet Tests:**
    ```kotlin
    @Test fun `parseDiagnosticPacket returns null for short data`()
    @Test fun `parseDiagnosticPacket detects faults`()
    @Test fun `parseDiagnosticPacket parses temps`()
    ```

    **Heuristic Packet Tests:**
    ```kotlin
    @Test fun `parseHeuristicPacket returns null for short data`()
    @Test fun `parseHeuristicPacket parses concentric stats`()
    @Test fun `parseHeuristicPacket parses eccentric stats`()
    ```

    **Edge Case Tests:**
    ```kotlin
    @Test fun `handles exactly minimum size packets`()
    ```
  </action>
  <verify>Tests pass: `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.data.ble.ProtocolParserTest" 2>&1 | tail -20`</verify>
  <done>All packet parsing tests pass</done>
</task>

<task type="auto">
  <name>Task 4: Update KableBleRepository to use extracted parsers</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt</files>
  <action>
    Update KableBleRepository.kt to use the extracted parsing functions:

    1. Add imports at top:
       ```kotlin
       import com.devil.phoenixproject.data.ble.parseRepPacket
       import com.devil.phoenixproject.data.ble.parseMonitorPacket
       import com.devil.phoenixproject.data.ble.parseDiagnosticPacket
       import com.devil.phoenixproject.data.ble.parseHeuristicPacket
       import com.devil.phoenixproject.data.ble.MonitorPacket
       import com.devil.phoenixproject.data.ble.DiagnosticPacket
       ```

    2. Update parseRepNotification() (~line 2442):
       - Call parseRepPacket(data, hasOpcodePrefix = true, timestamp = currentTimeMillis())
       - If null, log warning and return
       - Otherwise use result for emission and logging

    3. Update parseRepsCharacteristicData() (~line 2545):
       - Call parseRepPacket(data, hasOpcodePrefix = false, timestamp = currentTimeMillis())
       - Same null handling as above

    4. Update parseDiagnosticData() (~line 1151):
       - Call parseDiagnosticPacket(bytes)
       - If null, return early
       - Use result fields for logging and fault checking
       - Keep stateful logic (lastDiagnosticFaults comparison) in KableBleRepository

    5. Update parseHeuristicData() (~line 1195):
       - Call parseHeuristicPacket(bytes, timestamp = currentTimeMillis())
       - If null, return early
       - Emit result to _heuristicData flow

    6. Update parseMonitorData() (~line 1910):
       - Call parseMonitorPacket(data)
       - If null, log warning and return
       - Use packet.posA, packet.loadA, etc. for further processing
       - Keep stateful logic (position validation, velocity calculation, EMA) in KableBleRepository

    7. Update parseMetricsPacket() (~line 2386):
       - This function uses BIG-ENDIAN. Create inline parsing (it's simple) or leave as-is.
       - The parseMetricsPacket is already extracting to WorkoutMetric directly with handle detection logic.
       - DECISION: Leave parseMetricsPacket() as-is for now - it mixes parsing with handle detection state which is Phase 9 work.

    8. REMOVE the private utility functions (lines 2634-2683):
       - getUInt16LE, getInt16LE, getUInt16BE, getInt32LE, getFloatLE, toHexString
       - These are now in ProtocolParser.kt

    NOTE: The extracted parsers are pure. Keep all stateful logic (logging, flow emission, validation against previous values, EMA calculation) in KableBleRepository. The parsers only return raw parsed data.
  </action>
  <verify>
    Build compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5`
    All tests pass: `./gradlew :shared:testDebugUnitTest 2>&1 | grep -E "passed|failed"`
  </verify>
  <done>KableBleRepository uses extracted parsers, utility functions removed, build passes</done>
</task>

</tasks>

<verification>
```bash
# Full verification
./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.data.ble.ProtocolParserTest"
./gradlew :androidApp:assembleDebug

# Line count reduction check (should be ~50-80 lines fewer)
wc -l shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
```
</verification>

<success_criteria>
1. All 4 packet parsing functions extracted to ProtocolParser.kt
2. ProtocolModels.kt contains MonitorPacket and DiagnosticPacket
3. All unit tests pass (byte utilities + packet parsers)
4. KableBleRepository uses imported parsing functions
5. Private utility functions removed from KableBleRepository
6. Android build compiles successfully
7. No functional change to BLE behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-protocol-parser/06-02-SUMMARY.md`
</output>

---
phase: 20-readiness-briefing
plan: 02
type: execute
wave: 2
depends_on:
  - "20-01"
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ReadinessBriefingCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
autonomous: true
requirements:
  - BRIEF-02
  - BRIEF-03
  - BRIEF-04

must_haves:
  truths:
    - "Elite tier user with 28+ days of training history sees a readiness card with Green/Yellow/Red status and 0-100 score before their first set"
    - "User with insufficient data sees an 'Insufficient Data' card explaining they need 28+ days of training history"
    - "User can dismiss the readiness briefing card and proceed with their workout"
    - "Readiness briefing card never reappears after dismissal during the same workout session"
    - "Readiness card displays 'Connect to Portal for full readiness model' upsell text"
    - "FREE and PHOENIX users do not see the readiness card at all"
    - "Readiness card uses AccessibilityTheme.colors.statusGreen/Yellow/Red for WCAG compliance"
    - "Readiness status has both icon and text label alongside color (WCAG 1.4.1)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ReadinessBriefingCard.kt"
      provides: "ReadinessBriefingCard composable with dismiss, portal link, AccessibilityColors status rendering"
      min_lines: 60
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt"
      provides: "Readiness computation in LaunchedEffect, card rendering in WorkoutState.Idle, Elite tier gating"
  key_links:
    - from: "ActiveWorkoutScreen.kt"
      to: "ReadinessEngine.computeReadiness"
      via: "LaunchedEffect coroutine"
      pattern: "ReadinessEngine\\.computeReadiness"
    - from: "ActiveWorkoutScreen.kt"
      to: "SmartSuggestionsRepository.getSessionSummariesSince"
      via: "koinInject repository"
      pattern: "getSessionSummariesSince"
    - from: "ActiveWorkoutScreen.kt"
      to: "SubscriptionManager.hasEliteAccess"
      via: "collectAsState"
      pattern: "hasEliteAccess"
    - from: "ReadinessBriefingCard.kt"
      to: "AccessibilityColors"
      via: "AccessibilityTheme.colors"
      pattern: "statusGreen|statusYellow|statusRed"
---

<objective>
Create the ReadinessBriefingCard composable and wire it into ActiveWorkoutScreen with Elite tier gating, dismissible state, and Portal upsell link.

Purpose: BRIEF-02/03/04 require a pre-workout readiness card that Elite users see before their first set, which is always dismissible (advisory only) and includes a Portal upsell. The card must use accessible colors with text+icon secondary signals per WCAG Board condition (BOARD-02).

Output: ReadinessBriefingCard.kt composable + modified ActiveWorkoutScreen.kt with readiness data computation and card rendering.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-readiness-briefing/20-RESEARCH.md
@.planning/phases/20-readiness-briefing/20-01-SUMMARY.md

<interfaces>
<!-- Types created by Plan 01 that this plan depends on -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/ReadinessModels.kt (created by Plan 01):
```kotlin
enum class ReadinessStatus { GREEN, YELLOW, RED }

sealed class ReadinessResult {
    object InsufficientData : ReadinessResult()
    data class Ready(
        val score: Int,              // 0-100
        val status: ReadinessStatus, // GREEN/YELLOW/RED
        val acwr: Float,             // Raw ACWR ratio
        val acuteVolumeKg: Float,    // 7-day total volume
        val chronicWeeklyAvgKg: Float // 28-day weekly average
    ) : ReadinessResult()
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/ReadinessEngine.kt (created by Plan 01):
```kotlin
object ReadinessEngine {
    fun computeReadiness(sessions: List<SessionSummary>, nowMs: Long): ReadinessResult
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SmartSuggestionsRepository.kt:
```kotlin
interface SmartSuggestionsRepository {
    suspend fun getSessionSummariesSince(sinceTimestamp: Long): List<SessionSummary>
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/subscription/SubscriptionManager.kt:
```kotlin
class SubscriptionManager {
    val hasEliteAccess: StateFlow<Boolean>
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt:
```kotlin
data class AccessibilityColors(
    val statusGreen: Color,
    val statusYellow: Color,
    val statusRed: Color,
    // ... other fields
)

object AccessibilityTheme {
    val colors: AccessibilityColors @Composable @ReadOnlyComposable get()
}
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SmartInsightsTab.kt (ELITE GATING PATTERN):
```kotlin
val subscriptionManager: SubscriptionManager = koinInject()
val hasEliteAccess by subscriptionManager.hasEliteAccess.collectAsState()
if (hasEliteAccess) { /* show feature */ }
```

From ActiveWorkoutScreen.kt (EXISTING STRUCTURE - readiness card placement):
```kotlin
// Line 83: subscriptionManager already injected via koinInject()
// Line 84: hasProAccess already collected
// hasEliteAccess is NOT yet collected -- must add

// WorkoutTab is called at line 379 with WorkoutUiState
// The readiness card should appear BEFORE WorkoutTab in the Scaffold content,
// OR be passed as state to WorkoutTab for rendering in the Idle branch.

// APPROACH: Add readiness computation + card rendering directly in ActiveWorkoutScreen,
// showing the card as an overlay/dialog above the WorkoutTab when in Idle state.
// This avoids modifying WorkoutTab's already-complex parameter list.
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReadinessBriefingCard composable</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ReadinessBriefingCard.kt</files>
  <action>
Create ReadinessBriefingCard.kt in the presentation/components directory following the existing card patterns (SetSummaryCard, SmartInsightsTab).

The composable accepts:
- `result: ReadinessResult` (sealed class -- render differently for Ready vs InsufficientData)
- `onDismiss: () -> Unit` (BRIEF-03: always dismissible)
- `onPortalLink: () -> Unit` (BRIEF-04: upsell callback)
- `modifier: Modifier = Modifier`

For `ReadinessResult.Ready`:
- Card with rounded corners, surface color background, subtle border using the status color
- Header row: status icon (CheckCircle for GREEN, Warning for YELLOW, Error for RED) + status label text ("Ready", "Caution", "Overreaching") + score badge showing the 0-100 number
- Pre-compute the status color BEFORE any Canvas or draw operations using `val colors = AccessibilityTheme.colors` at the top of the composable (per v0.5.1 decision about AccessibilityTheme compatibility)
- Status color from `AccessibilityTheme.colors.statusGreen/statusYellow/statusRed` (WCAG compliant)
- Body text with brief advisory message varying by status:
  - GREEN: "Your training load is well-balanced. Train normally."
  - YELLOW: "Your recent training load is elevated. Consider moderate intensity."
  - RED: "Your training load suggests overreaching. Consider a lighter session or active recovery."
- ACWR detail line: "Load ratio: {acwr formatted to 1 decimal}" in smaller text
- Portal upsell: TextButton with "Connect to Portal for full readiness model" text, calls onPortalLink (BRIEF-04)
- Dismiss button: IconButton with Close icon in top-right corner, calls onDismiss

For `ReadinessResult.InsufficientData`:
- Simpler card with info icon and message: "Not enough training data yet. Train for 28+ days to enable readiness tracking."
- Same dismiss button in top-right
- Same Portal upsell link at bottom

Import Icons from `androidx.compose.material.icons.filled` (CheckCircle, Warning, Error, Close, Info).
Use Spacing values from `com.devil.phoenixproject.ui.theme.Spacing` for consistent padding.
  </action>
  <verify>
Build compiles: `cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileDebugKotlinAndroid --no-daemon 2>&1 | tail -10`
  </verify>
  <done>ReadinessBriefingCard.kt exists with both Ready and InsufficientData rendering paths, uses AccessibilityColors for status, has dismiss and portal upsell callbacks, includes text+icon secondary signals for WCAG compliance</done>
</task>

<task type="auto">
  <name>Task 2: Wire readiness computation and card into ActiveWorkoutScreen</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt</files>
  <action>
Modify ActiveWorkoutScreen.kt to add readiness briefing card rendering. The card appears as an overlay/inset above the main WorkoutTab content when in Idle state before the first set.

1. Add imports at top:
   - `import com.devil.phoenixproject.domain.premium.ReadinessEngine`
   - `import com.devil.phoenixproject.domain.model.ReadinessResult`
   - `import com.devil.phoenixproject.data.repository.SmartSuggestionsRepository`
   - `import com.devil.phoenixproject.presentation.components.ReadinessBriefingCard`

2. Add Elite tier access check (the existing `subscriptionManager` is already injected at line ~83):
   ```kotlin
   val hasEliteAccess by subscriptionManager.hasEliteAccess.collectAsState()
   ```

3. Add readiness state variables (near other state declarations, around line ~72):
   ```kotlin
   var readinessDismissed by remember { mutableStateOf(false) }
   var readinessResult by remember { mutableStateOf<ReadinessResult?>(null) }
   ```

4. Add LaunchedEffect to compute readiness once on screen open (Elite users only):
   ```kotlin
   if (hasEliteAccess) {
       val smartSuggestionsRepo: SmartSuggestionsRepository = koinInject()
       LaunchedEffect(Unit) {
           val twentyEightDaysMs = 28L * 24 * 60 * 60 * 1000
           val nowMs = com.devil.phoenixproject.util.currentTimeMillis()
           val summaries = smartSuggestionsRepo.getSessionSummariesSince(nowMs - twentyEightDaysMs)
           readinessResult = ReadinessEngine.computeReadiness(summaries, nowMs)
       }
   }
   ```

5. Inside the Scaffold content block (after `WorkoutTab` call at line ~379), add the readiness card overlay. Show it only when:
   - `hasEliteAccess` is true
   - `!readinessDismissed`
   - `readinessResult != null`
   - `workoutState is WorkoutState.Idle` (before first set -- MUST NOT show during active workout)

   Render it as a Box overlay positioned at the bottom of the screen (above the start button area) or as a Column item before WorkoutTab:
   ```kotlin
   // Readiness briefing card -- shown in Idle state for Elite users (BRIEF-02)
   if (hasEliteAccess && !readinessDismissed && readinessResult != null && workoutState is WorkoutState.Idle) {
       ReadinessBriefingCard(
           result = readinessResult!!,
           onDismiss = { readinessDismissed = true },
           onPortalLink = { /* Portal deep link -- placeholder for now */ },
           modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)
       )
   }
   ```

   The best placement: Wrap the Scaffold content in a Column, with the readiness card ABOVE the WorkoutTab. This ensures the card appears at the top of the screen in Idle state and disappears completely once dismissed or workout starts.

6. Ensure the `readinessDismissed` flag persists for the entire screen session (it does via `remember`) so once dismissed, the card never comes back during this workout session. This is critical for BRIEF-03 (advisory only).

7. The card MUST NOT block the workout. The user can always tap "Start Workout" regardless of whether the readiness card is visible. The card is purely informational, sitting above the workout controls.

Do NOT modify WorkoutTab.kt or WorkoutUiState.kt -- keep the readiness card self-contained in ActiveWorkoutScreen to minimize blast radius.
  </action>
  <verify>
Build compiles: `cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:compileDebugKotlinAndroid --no-daemon 2>&1 | tail -10`
Full test suite passes: `cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testDebugUnitTest --no-daemon 2>&1 | tail -10`
  </verify>
  <done>
ActiveWorkoutScreen computes readiness for Elite users on screen open, shows ReadinessBriefingCard in Idle state, card is dismissible and never reappears after dismissal, non-Elite users see nothing, card does not block workout start
  </done>
</task>

</tasks>

<verification>
1. Build compiles: `./gradlew :shared:compileDebugKotlinAndroid --no-daemon`
2. All unit tests pass: `./gradlew :shared:testDebugUnitTest --no-daemon`
3. ReadinessEngineTest (from Plan 01) still passes after UI wiring
4. Grep verification:
   - `grep -r "ReadinessBriefingCard" shared/src/commonMain/` shows card composable and ActiveWorkoutScreen usage
   - `grep -r "hasEliteAccess" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt` confirms tier gating
   - `grep -r "readinessDismissed" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt` confirms dismissible state
   - `grep -r "statusGreen\|statusYellow\|statusRed" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ReadinessBriefingCard.kt` confirms AccessibilityColors usage
   - `grep -r "Connect to Portal" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ReadinessBriefingCard.kt` confirms BRIEF-04 upsell text
</verification>

<success_criteria>
- ReadinessBriefingCard renders for both Ready and InsufficientData states with appropriate content
- Elite tier users see the readiness card in WorkoutState.Idle before their first set
- FREE and PHOENIX users never see the readiness card
- Card is dismissible and stays dismissed for the session (BRIEF-03)
- Card includes "Connect to Portal for full readiness model" text (BRIEF-04)
- Status colors use AccessibilityTheme.colors.statusGreen/Yellow/Red with text+icon labels (WCAG)
- Card does not appear during Active, Countdown, Resting, SetSummary, or Completed states
- Full project compiles and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/20-readiness-briefing/20-02-SUMMARY.md`
</output>

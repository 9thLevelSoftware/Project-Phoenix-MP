---
phase: 02-led-biofeedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/LedFeedback.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackController.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/util/RunningAverage.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackControllerTest.kt
autonomous: true

must_haves:
  truths:
    - "VelocityZone enum maps absolute velocity (mm/s) to one of 6 LED color zones"
    - "LedFeedbackController throttles BLE color commands to max 2Hz (500ms minimum interval)"
    - "Zone changes require 3 consecutive samples in new zone before LED switches (hysteresis)"
    - "TUT/TUT Beast modes use tempo-guide feedback (green=correct tempo, red=too fast)"
    - "Echo mode uses load-matching feedback (green=target matched, red=off target)"
    - "PR celebration fires a 3.6s rapid color cycle then restores normal feedback"
    - "Rest periods set LED to blue (index 0)"
    - "RunningAverage utility class exists for quality scoring pre-requisite"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/LedFeedback.kt"
      provides: "VelocityZone enum, LedFeedbackMode enum"
      contains: "enum class VelocityZone"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackController.kt"
      provides: "LED feedback controller with throttling, hysteresis, mode-specific resolvers, PR celebration"
      contains: "class LedFeedbackController"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/util/RunningAverage.kt"
      provides: "RunningAverage utility class"
      contains: "class RunningAverage"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackControllerTest.kt"
      provides: "Tests for velocity zone resolution, hysteresis, throttling, mode-specific behavior"
      min_lines: 80
  key_links:
    - from: "LedFeedbackController"
      to: "BleRepository.setColorScheme"
      via: "scope.launch with throttle check"
      pattern: "bleRepository\\.setColorScheme"
    - from: "VelocityZone"
      to: "ColorSchemes indices"
      via: "schemeIndex property matching ColorSchemes.ALL order"
      pattern: "schemeIndex.*Int"
---

<objective>
Create the LedFeedbackController engine with velocity zone mapping, mode-specific feedback resolvers (TUT tempo guide, Echo load matching), hysteresis/throttling for flicker prevention, PR celebration flash, and rest period handling. Also create RunningAverage utility (roadmap pre-requisite).

Purpose: This is the core LED biofeedback brain -- all subsequent plans wire it into the workout flow and settings UI. Covers LED-01, LED-02, LED-03, LED-04, LED-05, LED-07 logic.
Output: LedFeedbackController class, VelocityZone enum, LedFeedbackMode enum, RunningAverage utility, unit tests.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/specs/02-realtime-feedback.md (Section 2: LED Biofeedback System)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/ColorScheme.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt (ProgramMode, WorkoutMode, RepPhase)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VelocityZone, LedFeedbackMode enums and RunningAverage utility</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/LedFeedback.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/util/RunningAverage.kt
  </files>
  <action>
Create `LedFeedback.kt` in domain/model/ with:

1. `VelocityZone` enum with `schemeIndex: Int` property. Values: REST(0), CONTROLLED(1), MODERATE(2), FAST(3), VERY_FAST(4), EXPLOSIVE(5). Add companion `fromVelocity(absVelocity: Double): VelocityZone` using thresholds from spec: <20=REST, <150=CONTROLLED, <300=MODERATE, <500=FAST, <700=VERY_FAST, else=EXPLOSIVE.

2. `LedFeedbackMode` enum: VELOCITY_ZONE, TEMPO_GUIDE, AUTO. AUTO means mode-dependent (TUT/TUTBeast -> TEMPO_GUIDE, Echo -> load matching, everything else -> VELOCITY_ZONE).

Create `RunningAverage.kt` in util/ with:
- `class RunningAverage` with `private var sum = 0.0`, `private var count = 0`
- `fun add(value: Float)` - adds to running sum and increments count
- `fun average(): Float` - returns sum/count or 0f if count==0
- `fun reset()` - zeroes sum and count
- `fun count(): Int` - returns count

These are pure domain models with no dependencies beyond kotlin stdlib.
  </action>
  <verify>Build compiles: `./gradlew :shared:compileKotlinMetadata`</verify>
  <done>VelocityZone.fromVelocity correctly maps velocity ranges, LedFeedbackMode has 3 values, RunningAverage accumulates correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create LedFeedbackController with throttling, hysteresis, mode resolvers, and tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackController.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/LedFeedbackControllerTest.kt
  </files>
  <action>
Create `LedFeedbackController.kt` in presentation/manager/ following the spec (Section 2.3-2.6):

```kotlin
class LedFeedbackController(
    private val bleRepository: BleRepository,
    private val scope: CoroutineScope
) {
```

**Core state:**
- `MIN_COLOR_INTERVAL_MS = 500L` (max 2Hz BLE writes)
- `ZONE_STABILITY_THRESHOLD = 3` (hysteresis: 3 consecutive samples before zone switch)
- `lastColorCommandTime: Long`, `lastSentSchemeIndex: Int = -1`
- `currentZone: VelocityZone = VelocityZone.REST`
- `zoneStabilityCount: Int = 0`
- `feedbackSuspended: Boolean = false` (true during PR celebration)
- `celebrationJob: Job? = null`
- `enabled: Boolean = false` (master toggle, set from preferences)
- `currentMode: LedFeedbackMode = LedFeedbackMode.AUTO`
- `userColorSchemeIndex: Int = 0` (to restore after workout)

**Public API:**
- `fun setEnabled(enabled: Boolean)` - master toggle
- `fun setMode(mode: LedFeedbackMode)` - feedback mode
- `fun setUserColorScheme(index: Int)` - remember user's static color for restore
- `fun updateMetrics(velocity: Double, repPhase: RepPhase, workoutMode: WorkoutMode, echoLoadRatio: Float = 0f)` - main update call, called from metric flow
- `fun onRestPeriodStart()` - sets LED to blue (index 0)
- `fun onRestPeriodEnd()` - resumes normal feedback
- `fun triggerPRCelebration()` - fires rapid color cycle per spec (3 cycles x 6 colors x 200ms = 3.6s)
- `fun onWorkoutEnd()` - restores user's static color, resets state
- `fun onDisconnect()` - resets lastSentSchemeIndex to -1
- `fun reset()` - full state reset

**Internal resolvers (private):**
- `resolveVelocityZone(velocity: Double, repPhase: RepPhase): VelocityZone` - uses `VelocityZone.fromVelocity(abs(velocity))` but returns REST if repPhase is IDLE and velocity < 20
- `resolveTempoZone(velocity: Double, workoutMode: WorkoutMode): VelocityZone` - per spec Section 2.5 TUT ranges. TUT: target 250-350 mm/s, TUT Beast: target 150-250 mm/s. Returns CONTROLLED(green) if in range, FAST(yellow) if slightly above, EXPLOSIVE(red) if well above, MODERATE(teal) if below.
- `resolveEchoZone(echoLoadRatio: Float): VelocityZone` - per spec Section 2.5 Echo. 0.90-1.10=CONTROLLED(green), 0.75-1.25=FAST(yellow), else=EXPLOSIVE(red).
- `resolveEffectiveMode(workoutMode: WorkoutMode): LedFeedbackMode` - when AUTO: TUT/TUTBeast -> TEMPO_GUIDE, otherwise -> VELOCITY_ZONE. (Echo uses VELOCITY_ZONE for the zone resolution, but the updateMetrics method detects Echo and calls resolveEchoZone directly.)
- `applyZoneWithHysteresis(targetZone: VelocityZone)` - per spec Section 2.7
- `sendColorIfThrottled(schemeIndex: Int)` - checks MIN_COLOR_INTERVAL_MS and lastSentSchemeIndex, fires scope.launch { bleRepository.setColorScheme(schemeIndex) }

**IMPORTANT implementation notes:**
- Check `enabled` at top of `updateMetrics` -- if false, return immediately
- Check `feedbackSuspended` (during celebration) -- if true, return
- Check `bleRepository.discoModeActive.value` -- if disco mode active, return (spec Section 2.8)
- Use `currentTimeMillis()` from `com.devil.phoenixproject.domain.model.currentTimeMillis` for timestamp (already used in codebase)
- The `updateMetrics` method should determine effective mode: if workoutMode is Echo, use resolveEchoZone with echoLoadRatio. If effective mode is TEMPO_GUIDE, use resolveTempoZone. Otherwise use resolveVelocityZone.
- PR celebration sequence: Purple(6), Yellow(3), Green(1), Pink(4), Red(5), Teal(2) repeated 3 times with 200ms delay per color change

**Tests** in `LedFeedbackControllerTest.kt`:
- Use a FakeBleRepository or mock that captures setColorScheme calls. The codebase already has `SimulatorBleRepository` -- check if it can be used, otherwise create a minimal test double.
- Test VelocityZone.fromVelocity thresholds (boundary values: 0, 19, 20, 149, 150, 299, 300, 499, 500, 699, 700, 1000)
- Test hysteresis: 2 samples in new zone should NOT trigger color change, 3 should
- Test throttling: two rapid zone changes within 500ms should only send one BLE command
- Test resolveTempoZone for TUT mode: velocity in range returns green, above returns yellow/red
- Test resolveEchoZone: ratio 1.0 returns green, 0.8 returns yellow, 0.5 returns red
- Test disabled state: updateMetrics does nothing when enabled=false
- Test onRestPeriodStart sends blue (index 0)
- Test onWorkoutEnd restores user color scheme

Target: 10-15 test methods covering the critical paths. Use `kotlinx.coroutines.test.runTest` for coroutine tests.
  </action>
  <verify>`./gradlew :shared:testDebugUnitTest --tests "*LedFeedbackControllerTest*"` passes</verify>
  <done>LedFeedbackController throttles at 500ms, hysteresis requires 3 samples, mode-specific resolvers return correct zones, PR celebration cycles colors, rest sets blue, all tests pass</done>
</task>

</tasks>

<verification>
- `./gradlew :shared:compileKotlinMetadata` compiles without errors
- `./gradlew :shared:testDebugUnitTest --tests "*LedFeedbackControllerTest*"` all tests pass
- VelocityZone boundary values are correct per spec
- LedFeedbackController never sends BLE commands faster than 500ms apart
- Hysteresis prevents zone flicker (requires 3 consecutive samples)
</verification>

<success_criteria>
- VelocityZone enum correctly maps 6 velocity ranges to ColorSchemes indices
- LedFeedbackController implements throttling (500ms min), hysteresis (3 samples), and mode-specific resolvers
- TUT/TUT Beast tempo guide feedback works (green=in range, yellow=slightly fast, red=too fast, teal=too slow)
- Echo load matching feedback works (green=matched, yellow=slightly off, red=mismatch)
- PR celebration fires 3.6s color cycle and restores normal feedback
- Rest periods set blue, workout end restores user color
- RunningAverage utility class created for future quality scoring use
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-led-biofeedback/02-01-SUMMARY.md`
</output>

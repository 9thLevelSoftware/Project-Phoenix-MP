---
phase: 02-led-biofeedback
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
autonomous: false

must_haves:
  truths:
    - "User can toggle LED biofeedback on/off in settings"
    - "LED biofeedback toggle is hidden for Free tier users (GATE-01)"
    - "Machine LEDs change color based on velocity zone during an active set"
    - "LED color transitions are smooth without visible flicker during rapid velocity changes"
    - "TUT/TUT Beast modes show tempo guide feedback during the set"
    - "Echo mode shows load matching feedback during the set"
    - "LEDs show blue during rest periods"
    - "PR achievement triggers celebration flash sequence"
    - "User's chosen static color scheme is restored when workout ends"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt"
      provides: "ledFeedbackEnabled preference field"
      contains: "ledFeedbackEnabled"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "LedFeedbackController wiring into metric flow"
      contains: "ledFeedbackController"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt"
      provides: "LED biofeedback toggle gated to Phoenix tier"
      contains: "ledFeedbackEnabled"
  key_links:
    - from: "ActiveSessionEngine.handleMonitorMetric"
      to: "LedFeedbackController.updateMetrics"
      via: "direct call when workout is Active"
      pattern: "ledFeedbackController\\.updateMetrics"
    - from: "ActiveSessionEngine (rest period)"
      to: "LedFeedbackController.onRestPeriodStart/End"
      via: "called when WorkoutState transitions to/from Resting"
      pattern: "ledFeedbackController\\.onRestPeriod"
    - from: "ActiveSessionEngine (PR detection)"
      to: "LedFeedbackController.triggerPRCelebration"
      via: "called when new PR is detected"
      pattern: "ledFeedbackController\\.triggerPRCelebration"
    - from: "SettingsTab toggle"
      to: "PreferencesManager.setLedFeedbackEnabled"
      via: "SettingsManager forwarding"
      pattern: "setLedFeedbackEnabled"
    - from: "SettingsTab visibility"
      to: "FeatureGate.isEnabled(LED_BIOFEEDBACK)"
      via: "conditional rendering gated to Phoenix tier"
      pattern: "FeatureGate\\.isEnabled.*LED_BIOFEEDBACK"
---

<objective>
Wire LedFeedbackController into the workout flow, add user preferences for LED feedback toggle, add settings UI gated to Phoenix tier, and integrate with ActiveSessionEngine's metric flow, rest periods, and PR detection.

Purpose: This plan connects the LED engine (Plan 01) to the real workout data stream and user-facing controls. After this plan, LED biofeedback is fully functional end-to-end.
Output: Working LED biofeedback feature with settings toggle, tier gating, and real-time BLE color commands during workouts.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-led-biofeedback/02-01-SUMMARY.md
@.planning/specs/02-realtime-feedback.md (Sections 2.3, 2.5, 2.8, 2.9)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LED feedback preference and PreferencesManager support</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/UserPreferences.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/preferences/PreferencesManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
  </files>
  <action>
**UserPreferences.kt:** Add `val ledFeedbackEnabled: Boolean = false` field. Default OFF per spec (user must opt-in).

**PreferencesManager.kt:**
1. Add `KEY_LED_FEEDBACK_ENABLED = "led_feedback_enabled"` constant
2. Add `suspend fun setLedFeedbackEnabled(enabled: Boolean)` to the interface
3. In DefaultPreferencesManager: implement setLedFeedbackEnabled similar to other boolean prefs (save to settings, updateAndEmit with copy)
4. In loadFromSettings(): read `settings.getBoolean(KEY_LED_FEEDBACK_ENABLED, false)` into `ledFeedbackEnabled`

**SettingsManager.kt:**
1. Add `val ledFeedbackEnabled: StateFlow<Boolean>` derived from userPreferences: `userPreferences.map { it.ledFeedbackEnabled }.stateIn(scope, SharingStarted.Eagerly, false)`
2. Add `fun setLedFeedbackEnabled(enabled: Boolean)` method that launches `preferencesManager.setLedFeedbackEnabled(enabled)` in scope

Follow exact patterns from existing preferences (stopAtTop, stallDetectionEnabled, audioRepCountEnabled).
  </action>
  <verify>`./gradlew :shared:compileKotlinMetadata` compiles</verify>
  <done>ledFeedbackEnabled preference persists across app restarts, SettingsManager exposes it as StateFlow</done>
</task>

<task type="auto">
  <name>Task 2: Wire LedFeedbackController into ActiveSessionEngine and workout flow</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  </files>
  <action>
**WorkoutCoordinator.kt:**
Add `val ledFeedbackController: LedFeedbackController` as a property. It will be constructed and held here since WorkoutCoordinator is the central state holder that ActiveSessionEngine and DWSM both access.

**PresentationModule.kt (or wherever WorkoutCoordinator is created in DI):**
Create LedFeedbackController with the bleRepository and scope, pass it when constructing WorkoutCoordinator.

**ActiveSessionEngine.kt -- Integration points:**

1. **In `initializeForWorkout()` (or wherever workout initialization happens):**
   - Read `settingsManager.ledFeedbackEnabled.value` and call `coordinator.ledFeedbackController.setEnabled(it)`
   - Set user's current color scheme: `coordinator.ledFeedbackController.setUserColorScheme(settingsManager.userPreferences.value.colorScheme)`
   - Determine the workout mode and set the controller's mode accordingly

2. **In `handleMonitorMetric(metric)` when state is Active:**
   Add at the end of the Active block (after existing position tracking):
   ```kotlin
   // LED Biofeedback: update controller with current velocity and phase
   val repCount = repCounter.getRepCount()
   val workoutMode = coordinator._workoutParameters.value.let { params ->
       params.programMode.toWorkoutMode(params.echoLevel)
   }
   coordinator.ledFeedbackController.updateMetrics(
       velocity = maxOf(kotlin.math.abs(metric.velocityA), kotlin.math.abs(metric.velocityB)),
       repPhase = repCount.activeRepPhase,
       workoutMode = workoutMode,
       echoLoadRatio = calculateEchoLoadRatio(metric) // helper function
   )
   ```

3. **Add `calculateEchoLoadRatio(metric: WorkoutMetric): Float` private helper:**
   - If not Echo mode, return 0f
   - Get heuristic data from `bleRepository.heuristicData.value`
   - If heuristic data has target load info, compute actual/target ratio
   - Otherwise return 1.0f (assume matched as fallback)

4. **In rest period transition (when WorkoutState changes to Resting):**
   Call `coordinator.ledFeedbackController.onRestPeriodStart()`

5. **In rest period end (when transitioning out of Resting to Active/SetReady):**
   Call `coordinator.ledFeedbackController.onRestPeriodEnd()`

6. **In PR detection (wherever `checkForPersonalRecords` or similar fires):**
   After a PR is detected, call `coordinator.ledFeedbackController.triggerPRCelebration()`

7. **In workout end/stop (where stopWorkout or completeSet is called):**
   Call `coordinator.ledFeedbackController.onWorkoutEnd()` -- this restores the user's static color scheme

8. **In disconnect handler (if exists):**
   Call `coordinator.ledFeedbackController.onDisconnect()`

**IMPORTANT:** Search for where PR detection happens in ActiveSessionEngine. Look for `personalRecordRepository` or `checkForPR` or similar calls. The PR celebration trigger must go AFTER a new PR is confirmed, not before.

**IMPORTANT:** Search for where rest period state transitions happen. Look for `WorkoutState.Resting` being set. The rest period hooks must be called at those exact transition points.
  </action>
  <verify>`./gradlew :shared:compileKotlinMetadata` compiles. `./gradlew :shared:testDebugUnitTest` existing tests still pass (no regressions).</verify>
  <done>LedFeedbackController receives velocity data on every MONITOR metric during active workout, sends throttled color commands via BLE, responds to rest/PR/workout-end transitions</done>
</task>

<task type="auto">
  <name>Task 3: Add LED biofeedback toggle to Settings UI with Phoenix tier gating</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SettingsTab.kt
  </files>
  <action>
Add an "LED Biofeedback" toggle in the Settings screen, positioned AFTER the existing LED Color Scheme section (look for color scheme picker or "colorScheme" references in SettingsTab.kt).

**Implementation:**

1. Find the LED Color Scheme section in SettingsTab.kt. Add a new section directly below it.

2. Gate the section visibility using FeatureGate:
   ```kotlin
   // LED Biofeedback toggle - Phoenix tier only (GATE-01)
   // For now, hardcode tier check since subscription billing isn't wired yet.
   // Use FeatureGate.isEnabled(FeatureGate.Feature.LED_BIOFEEDBACK, currentTier)
   // where currentTier comes from SubscriptionManager or is hardcoded as PHOENIX for testing.
   ```

3. The toggle should:
   - Show "LED Biofeedback" label with a switch
   - Show subtitle: "Dynamic LED colors based on workout performance"
   - When toggled, call `viewModel.setLedFeedbackEnabled(enabled)` (or through SettingsManager)
   - Read current state from `viewModel.ledFeedbackEnabled` (or through SettingsManager state)

4. For tier gating: Since subscription billing is not yet wired, the simplest approach is to check `FeatureGate.isEnabled(FeatureGate.Feature.LED_BIOFEEDBACK, SubscriptionTier.PHOENIX)` which will return true. For actual gating, we need the user's real tier. Check how the codebase currently handles the user's subscription tier -- look at SubscriptionManager. If there's no easy way to get the current tier, gate behind a check that makes it visible only when tier is >= PHOENIX. For development/testing, the toggle can be visible (since all testers are effectively PHOENIX).

5. Add a note below the toggle when enabled: "Overrides static LED color during workouts. Your chosen color restores after each set."

Follow the exact UI pattern used by other toggle settings in SettingsTab.kt (e.g., stallDetectionEnabled, audioRepCountEnabled).
  </action>
  <verify>`./gradlew :androidApp:assembleDebug` compiles the full Android app</verify>
  <done>LED Biofeedback toggle appears in Settings, is gated to Phoenix tier, toggles the preference, shows explanatory subtitle</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify LED biofeedback on real hardware</name>
  <what-built>Complete LED biofeedback feature: velocity-zone LED colors during workouts, mode-specific feedback for TUT/Echo, PR celebration flash, rest period blue LEDs, settings toggle with tier gating</what-built>
  <how-to-verify>
    1. Open the app Settings tab
    2. Verify "LED Biofeedback" toggle is visible (below LED Color Scheme section)
    3. Enable the toggle
    4. Connect to Vitruvian machine
    5. Start a workout (Old School or Pump mode)
    6. During the set, observe LED color changes as you move:
       - At rest: Blue
       - Slow controlled movement: Green
       - Moderate speed: Teal
       - Fast/explosive: Yellow/Pink/Red
    7. Verify no flicker -- colors should transition smoothly
    8. If testing TUT mode: verify green when at correct tempo
    9. Complete set -- verify rest period shows blue LEDs
    10. After workout, verify your chosen static LED color restores
    11. Disable the toggle in settings -- verify LEDs revert to static behavior
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues seen during testing</resume-signal>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` compiles
- `./gradlew :shared:testDebugUnitTest` all tests pass (existing + Plan 01 tests)
- Settings toggle visible and functional
- LED feedback preference persists across app restart
- LedFeedbackController wired into ActiveSessionEngine metric flow
- Rest period, PR celebration, and workout end transitions all handled
</verification>

<success_criteria>
- LED biofeedback toggle in Settings, gated to Phoenix tier (LED-06, GATE-01)
- Velocity-zone LED colors during active workout (LED-01)
- No flicker -- throttled to 2Hz with 3-sample hysteresis (LED-02)
- TUT/TUT Beast tempo guide feedback (LED-03)
- Echo mode load matching feedback (LED-04)
- PR celebration flash (LED-05)
- Blue LEDs during rest periods (LED-07)
- User's static color restored after workout
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-led-biofeedback/02-02-SUMMARY.md`
</output>

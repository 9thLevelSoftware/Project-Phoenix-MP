---
phase: 05-repmetric-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/RepMetricPersistenceTest.kt
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "RepMetricData objects created during rep scoring are persisted to RepMetric table at set completion"
    - "Persisted rep metrics are associated with the correct session ID"
    - "Rep metrics can be queried back by session ID after workout completion"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "RepMetricRepository integration and rep metric accumulation/persistence"
      contains: "repMetricRepository"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/RepMetricPersistenceTest.kt"
      provides: "Test verifying rep metrics are persisted at set completion"
      contains: "repMetricRepository"
  key_links:
    - from: "ActiveSessionEngine.scoreCurrentRep()"
      to: "coordinator.setRepMetrics (accumulation list)"
      via: "add RepMetricData to list on each scored rep"
      pattern: "setRepMetrics\\.add"
    - from: "ActiveSessionEngine.handleSetCompletion()"
      to: "RepMetricRepository.saveRepMetrics()"
      via: "coroutine launch in handleSetCompletion after saveWorkoutSession"
      pattern: "repMetricRepository\\.saveRepMetrics"
    - from: "DefaultWorkoutSessionManager constructor"
      to: "ActiveSessionEngine constructor"
      via: "repMetricRepository parameter passthrough"
      pattern: "repMetricRepository = repMetricRepository"
---

<objective>
Wire RepMetricRepository into the workout flow so per-rep metric data persists to the database during workouts.

Purpose: Closes DATA-01 gap — RepMetric table schema and repository were created in Phase 1 but never integrated into ActiveSessionEngine. Per-rep force curve data is currently lost after each workout.

Output: RepMetricData objects are accumulated during each set and persisted to the RepMetric table at set completion, queryable by session ID.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation/01-02-SUMMARY.md

Key source files:
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire RepMetricRepository and persist rep metrics at set completion</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  </files>
  <action>
    **Step 1: Add accumulation list to WorkoutCoordinator**

    In `WorkoutCoordinator.kt`, add a mutable list to accumulate RepMetricData for the current set:
    ```kotlin
    internal val setRepMetrics = mutableListOf<RepMetricData>()
    ```
    Add the import for `RepMetricData` if not already present. Place it near `collectedMetrics` (line ~195).

    **Step 2: Add RepMetricRepository to ActiveSessionEngine constructor**

    Add `private val repMetricRepository: RepMetricRepository` as a constructor parameter to `ActiveSessionEngine` (after `syncTriggerManager`). Add the import for `RepMetricRepository`.

    **Step 3: Accumulate RepMetricData in scoreCurrentRep()**

    In `ActiveSessionEngine.scoreCurrentRep()` (line ~543-577), after creating `repData` and before scoring, add:
    ```kotlin
    coordinator.setRepMetrics.add(repData)
    ```
    This captures every scored rep's metric data for later persistence.

    **Step 4: Persist rep metrics in handleSetCompletion()**

    In `ActiveSessionEngine.handleSetCompletion()`, AFTER `saveWorkoutSession()` (line ~1792) and BEFORE the quality summary capture (line ~1794), add:
    ```kotlin
    // Persist per-rep metric data (GATE-04: captured for all tiers)
    val sessionId = coordinator.currentSessionId
    val repMetricsToSave = coordinator.setRepMetrics.toList()
    if (sessionId != null && repMetricsToSave.isNotEmpty()) {
        try {
            repMetricRepository.saveRepMetrics(sessionId, repMetricsToSave)
            Logger.d { "Persisted ${repMetricsToSave.size} rep metrics for session $sessionId" }
        } catch (e: Exception) {
            Logger.e(e) { "Failed to persist rep metrics for session $sessionId" }
        }
    }
    coordinator.setRepMetrics.clear()
    ```

    Also clear `setRepMetrics` in the existing `resetForNewWorkout()` method (search for it — it clears `collectedMetrics`, add `setRepMetrics.clear()` adjacent to that).

    **Step 5: Pass RepMetricRepository through DefaultWorkoutSessionManager**

    In `DefaultWorkoutSessionManager.kt`:
    - Add `private val repMetricRepository: RepMetricRepository` constructor parameter (after `syncTriggerManager`)
    - Add import for `com.devil.phoenixproject.data.repository.RepMetricRepository`
    - Pass it to `ActiveSessionEngine` constructor: `repMetricRepository = repMetricRepository`

    **Step 6: Inject RepMetricRepository in MainViewModel**

    In `MainViewModel.kt`:
    - Add `private val repMetricRepository: RepMetricRepository` as a constructor parameter (find where other repositories are declared, add after the last repository)
    - Add import for `com.devil.phoenixproject.data.repository.RepMetricRepository`
    - Pass it to `DefaultWorkoutSessionManager` constructor: `repMetricRepository = repMetricRepository`

    NOTE: MainViewModel uses Koin injection. Check how other repositories are injected (likely via `by inject()` or constructor parameter from Koin module). Follow the same pattern exactly.

    **Important:** Do NOT add any subscription tier gating to the persistence. Per GATE-04, data is captured for ALL users regardless of tier.
  </action>
  <verify>
    Run `./gradlew :shared:compileKotlinJvm 2>&1 | tail -20` to verify compilation succeeds.
    Run `./gradlew :androidApp:assembleDebug 2>&1 | tail -20` to verify full Android build succeeds.
    Grep for `repMetricRepository.saveRepMetrics` in ActiveSessionEngine to confirm wiring.
    Grep for `setRepMetrics.add` in ActiveSessionEngine to confirm accumulation.
    Grep for `setRepMetrics.clear` in ActiveSessionEngine to confirm cleanup.
  </verify>
  <done>
    RepMetricRepository is injected through MainViewModel -> DWSM -> ActiveSessionEngine.
    RepMetricData is accumulated per-rep in scoreCurrentRep() and persisted at set completion in handleSetCompletion().
    setRepMetrics list is cleared after persistence and on workout reset.
    Full Android build compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add persistence test and update test harness</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/RepMetricPersistenceTest.kt
  </files>
  <action>
    **Step 1: Create FakeRepMetricRepository**

    Check if a fake already exists in testutil/. If not, create one in `DWSMTestHarness.kt` or a separate file in testutil/:
    ```kotlin
    class FakeRepMetricRepository : RepMetricRepository {
        val savedMetrics = mutableMapOf<String, List<RepMetricData>>()

        override suspend fun saveRepMetrics(sessionId: String, metrics: List<RepMetricData>) {
            savedMetrics[sessionId] = (savedMetrics[sessionId] ?: emptyList()) + metrics
        }
        override suspend fun getRepMetrics(sessionId: String): List<RepMetricData> {
            return savedMetrics[sessionId] ?: emptyList()
        }
        override suspend fun deleteRepMetrics(sessionId: String) {
            savedMetrics.remove(sessionId)
        }
        override suspend fun getRepMetricCount(sessionId: String): Long {
            return (savedMetrics[sessionId]?.size ?: 0).toLong()
        }
    }
    ```

    **Step 2: Update DWSMTestHarness**

    Add `val fakeRepMetricRepo = FakeRepMetricRepository()` alongside other fakes.
    Pass `repMetricRepository = fakeRepMetricRepo` to the `DefaultWorkoutSessionManager` constructor.

    **Step 3: Create RepMetricPersistenceTest**

    Create `shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/RepMetricPersistenceTest.kt`:

    Follow the existing test pattern in DWSMWorkoutLifecycleTest.kt (uses DWSMTestHarness, TestScope, etc.).

    Write a test that:
    1. Creates harness, starts a workout (set coordinator state to Active, assign a sessionId)
    2. Simulates rep scoring by calling `activeSessionEngine.scoreCurrentRep()` (note: it's private, so instead simulate via `handleRepNotification` or directly add RepMetricData to `coordinator.setRepMetrics` and trigger `handleSetCompletion`)
    3. After handleSetCompletion completes, asserts `fakeRepMetricRepo.savedMetrics` contains the expected session ID with the correct number of rep metrics
    4. Verifies `coordinator.setRepMetrics` is empty after completion (cleared)

    Since `scoreCurrentRep` is private, the simplest approach is:
    - Directly add RepMetricData objects to `coordinator.setRepMetrics` (it's internal, accessible from test)
    - Then trigger `handleSetCompletion()` (it's internal)
    - Assert persistence happened

    **Step 4: Run all tests**

    Run `./gradlew :androidApp:testDebugUnitTest` to verify all existing tests still pass and the new test passes.
  </action>
  <verify>
    Run `./gradlew :androidApp:testDebugUnitTest 2>&1 | tail -30` — all tests pass including new RepMetricPersistenceTest.
    Verify test file exists and contains assertions on `fakeRepMetricRepo.savedMetrics`.
    Verify DWSMTestHarness includes `fakeRepMetricRepo` and passes it to DWSM.
  </verify>
  <done>
    FakeRepMetricRepository exists for test use.
    DWSMTestHarness passes RepMetricRepository to DWSM (all existing tests still compile and pass).
    RepMetricPersistenceTest verifies: (a) rep metrics are persisted at set completion with correct session ID, (b) setRepMetrics list is cleared after persistence, (c) persisted count matches accumulated count.
    All unit tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:assembleDebug` — full Android build compiles
2. `./gradlew :androidApp:testDebugUnitTest` — all tests pass (existing 38+ characterization tests + new persistence test)
3. Grep confirms: `repMetricRepository.saveRepMetrics` called in handleSetCompletion
4. Grep confirms: `setRepMetrics.add(repData)` called in scoreCurrentRep
5. Grep confirms: `setRepMetrics.clear()` called in handleSetCompletion and resetForNewWorkout
6. No subscription tier checks in the persistence path (GATE-04 compliance)
</verification>

<success_criteria>
- DATA-01 requirement SATISFIED: Per-rep metric data persists to RepMetric table during workouts
- RepMetricRepository.saveRepMetrics() is called during set completion in ActiveSessionEngine
- Per-rep force curve data (position, velocity, load arrays) is persisted to RepMetric table
- Persisted data can be queried back by session ID (verified by test using FakeRepMetricRepository)
- All existing tests continue to pass (no regressions)
- No tier gating on data persistence (GATE-04)
</success_criteria>

<output>
After completion, create `.planning/phases/05-repmetric-persistence/05-01-SUMMARY.md`
</output>

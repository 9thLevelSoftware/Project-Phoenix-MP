---
phase: 14-cv-form-check-domain-logic
plan: 02
type: tdd
wave: 2
depends_on:
  - 14-01
files_modified:
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngineTest.kt
autonomous: true
requirements:
  - CV-07
  - CV-08

must_haves:
  truths:
    - "Squat rules detect shallow depth, forward lean, and knee valgus at correct severities"
    - "Deadlift/RDL rules detect back rounding and excessive knee bend"
    - "Overhead press rules detect elbow hyperextension and backward lean"
    - "Curl rules detect shoulder drift and body swing"
    - "Row rules detect forward lean and incomplete pull"
    - "Low pose confidence skips evaluation entirely (returns empty violations)"
    - "Form score calculation returns 100 for no violations, degrades proportionally with severity"
    - "No form check source file imports BLE, weight control, or machine operations (CV-08 architectural test)"
  artifacts:
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngineTest.kt"
      provides: "Comprehensive test suite for FormRulesEngine covering all 5 exercises, form score, confidence gating, and CV-08 compliance"
      min_lines: 150
  key_links:
    - from: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngineTest.kt"
      to: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt"
      via: "imports and calls FormRulesEngine.evaluate(), FormRulesEngine.calculateFormScore()"
      pattern: "FormRulesEngine\\.evaluate"
---

<objective>
Create a comprehensive test suite for the FormRulesEngine, verifying all 5 exercise rule sets, form score calculation, confidence gating, and CV-08 architectural compliance.

Purpose: Validate that the form rules engine (CV-07) correctly identifies form violations for squat, deadlift/RDL, overhead press, curl, and row exercises, and that the engine remains advisory-only (CV-08) with no machine control coupling.

Output: FormRulesEngineTest.kt with passing tests covering happy paths, violation detection, edge cases, and architectural constraints.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cv-form-check-domain-logic/14-RESEARCH.md
@.planning/phases/14-cv-form-check-domain-logic/14-01-SUMMARY.md

# Existing test patterns to mirror
@shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/VbtEngineTest.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorerTest.kt

# Implementation to test
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt
</context>

<feature>
  <name>FormRulesEngine Test Suite</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngineTest.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt
  </files>
  <behavior>
    Test the FormRulesEngine against known good and bad joint angle inputs for all 5 exercises.

    **Helper function:**
    - `createAngles(vararg pairs: Pair<JointAngleType, Float>, confidence: Float = 1.0f, timestamp: Long = 0L): JointAngles`

    **Test cases by exercise:**

    SQUAT:
    - Good form (knee 95deg, lean 20deg, valgus 3deg) -> 0 violations
    - Shallow depth (knee 165deg) -> INFO violation with depth cue
    - Forward lean (trunk 50deg) -> WARNING violation with chest-up cue
    - Knee valgus (15deg) -> CRITICAL violation with knees-out cue
    - Multiple simultaneous violations -> all returned

    DEADLIFT/RDL:
    - Good form (trunk 40deg, knee 155deg) -> 0 violations
    - Back rounding (trunk 80deg) -> CRITICAL violation
    - Excessive knee bend (knee 120deg) -> WARNING violation

    OVERHEAD PRESS:
    - Good form (elbow 120deg, trunk 5deg) -> 0 violations
    - Elbow hyperextension (175deg) -> WARNING violation
    - Backward lean (trunk 20deg) -> CRITICAL violation

    CURL:
    - Good form (shoulder 10deg, trunk 5deg) -> 0 violations
    - Shoulder drift (30deg) -> WARNING violation
    - Body swing (trunk 20deg) -> WARNING violation

    ROW:
    - Good form (trunk 10deg, elbow 70deg) -> 0 violations
    - Forward lean (trunk 35deg) -> WARNING violation
    - Incomplete pull (elbow 165deg) -> INFO violation

    CONFIDENCE GATING:
    - Low confidence (0.3) with bad angles -> 0 violations (skipped)
    - Exactly at threshold (0.5) -> evaluates normally
    - Above threshold (0.8) -> evaluates normally

    FORM SCORE:
    - Empty assessments -> 100
    - All clean assessments (no violations) -> 100
    - Assessments with INFO violations -> score > 75
    - Assessments with CRITICAL violations -> score < 50
    - Single frame with max violations -> score approaches 0

    CV-08 ARCHITECTURAL TEST:
    - Read FormRulesEngine.kt and FormCheckModels.kt source files
    - Assert neither file contains imports from `data.ble`, `BleRepository`, `WorkoutCoordinator`, or `weight` adjustment code
    - This can be done by checking FormRulesEngine.getRulesForExercise() returns only FormRule objects with string-only display data (no action commands)

    RULE COVERAGE:
    - Every ExerciseFormType has at least 2 rules
    - getRulesForExercise returns non-empty for all 5 types
  </behavior>
  <implementation>
    Follow VbtEngineTest.kt and RepQualityScorerTest.kt patterns:
    - Package: `com.devil.phoenixproject.domain.premium`
    - Import `kotlin.test.Test`, `kotlin.test.assertEquals`, `kotlin.test.assertTrue`, `kotlin.test.assertFalse`
    - Import all form check model types from `domain.model`
    - Organize tests by exercise type with section comments
    - Use descriptive test names with backtick syntax: `fun \`squat with good form returns no violations\`()`
    - Run with: `./gradlew :shared:testAndroidHostTest` (per MEMORY.md AGP 9.0 note) or fallback `./gradlew :shared:testDebugUnitTest`
  </implementation>
</feature>

<verification>
1. `./gradlew :shared:testAndroidHostTest 2>&1 | tail -20` -- all tests pass (try `testDebugUnitTest` as fallback)
2. Test count >= 20 covering all 5 exercises + confidence + form score + architectural compliance
3. No test uses mocks or DI -- all tests are pure function calls on the stateless engine object
</verification>

<success_criteria>
- FormRulesEngineTest.kt exists with 20+ tests
- All tests pass on first run
- Every ExerciseFormType has at least 2 test cases (good form + violation)
- Confidence gating tested (below threshold, at threshold, above threshold)
- Form score calculation tested (empty, clean, info-only, critical-heavy)
- CV-08 compliance verified via architectural assertions
- Test file follows existing project test conventions (backtick names, section comments, helper functions)
</success_criteria>

<output>
After completion, create `.planning/phases/14-cv-form-check-domain-logic/14-02-SUMMARY.md`
</output>

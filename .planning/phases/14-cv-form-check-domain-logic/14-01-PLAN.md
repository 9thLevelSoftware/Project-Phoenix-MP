---
phase: 14-cv-form-check-domain-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt
autonomous: true
requirements:
  - CV-07
  - CV-08

must_haves:
  truths:
    - "Given joint angles for any of the 5 supported exercises, the engine returns correct violations with severity and corrective cues"
    - "The engine skips evaluation when pose confidence is below threshold"
    - "Form violations contain only display data (message, severity, cue) -- no machine control references"
    - "Form score calculation produces 0-100 from a list of assessments weighted by violation severity"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt"
      provides: "JointAngleType enum, FormViolationSeverity enum, ExerciseFormType enum, JointAngles data class, FormRule data class, FormViolation data class, FormAssessment data class"
      contains: "enum class JointAngleType"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt"
      provides: "FormRulesEngine object with evaluate() and calculateFormScore() functions plus per-exercise rule sets"
      contains: "object FormRulesEngine"
  key_links:
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt"
      to: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt"
      via: "imports JointAngles, FormRule, FormViolation, FormAssessment, ExerciseFormType, JointAngleType, FormViolationSeverity"
      pattern: "import com\\.devil\\.phoenixproject\\.domain\\.model\\."
---

<objective>
Create the CV form check domain models and form rules engine in commonMain.

Purpose: Implement exercise-specific form evaluation logic (CV-07) as a pure domain engine that receives joint angle data and returns advisory-only violations (CV-08). This provides the foundation that Phase 15 (MediaPipe integration) and Phase 16 (UI + persistence) build upon.

Output: Two source files -- FormCheckModels.kt (domain models) and FormRulesEngine.kt (stateless engine with per-exercise rule sets and form score calculation).
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-cv-form-check-domain-logic/14-RESEARCH.md

# Existing engine patterns to mirror
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/BiomechanicsEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/BiomechanicsModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorer.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create form check domain models</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt</files>
  <action>
Create `FormCheckModels.kt` in `domain/model/` with these types (package `com.devil.phoenixproject.domain.model`):

1. **`JointAngleType` enum** -- body joint angles evaluable from MediaPipe landmarks:
   - LEFT_KNEE, RIGHT_KNEE, LEFT_HIP, RIGHT_HIP, LEFT_ELBOW, RIGHT_ELBOW, LEFT_SHOULDER, RIGHT_SHOULDER, TRUNK_LEAN, KNEE_VALGUS_LEFT, KNEE_VALGUS_RIGHT

2. **`FormViolationSeverity` enum** -- INFO, WARNING, CRITICAL

3. **`ExerciseFormType` enum** -- SQUAT, DEADLIFT_RDL, OVERHEAD_PRESS, CURL, ROW

4. **`JointAngles` data class** -- single-frame joint angle snapshot:
   - `angles: Map<JointAngleType, Float>` (degrees)
   - `timestamp: Long`
   - `confidence: Float = 1.0f` (overall pose confidence 0-1)

5. **`FormRule` data class** -- threshold rule definition:
   - `jointAngle: JointAngleType`
   - `minDegrees: Float`
   - `maxDegrees: Float`
   - `severity: FormViolationSeverity`
   - `violationMessage: String`
   - `correctiveCue: String`

6. **`FormViolation` data class** -- detected violation (display data only, no machine control):
   - `rule: FormRule`
   - `actualDegrees: Float`
   - `severity: FormViolationSeverity`
   - `message: String`
   - `correctiveCue: String`
   - `timestamp: Long`

7. **`FormAssessment` data class** -- result for single frame evaluation:
   - `violations: List<FormViolation>`
   - `exerciseType: ExerciseFormType`
   - `timestamp: Long`

Add KDoc comments to each type explaining its role. Include a file-level comment noting this is consumed by FormRulesEngine (Phase 14) and will be used by Phase 15 (MediaPipe) and Phase 16 (UI/persistence).

CRITICAL (CV-08): FormViolation MUST NOT contain any fields referencing weight adjustment, machine control, workout modification, or BLE operations. It contains ONLY display data (strings, enums, numbers).
  </action>
  <verify>File compiles: `./gradlew :shared:compileCommonMainKotlinMetadata 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>FormCheckModels.kt exists with all 7 types, proper KDoc, and zero references to BLE/weight/machine control</done>
</task>

<task type="auto">
  <name>Task 2: Create form rules engine with per-exercise rule sets and form score calculation</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt</files>
  <action>
Create `FormRulesEngine.kt` in `domain/premium/` as a stateless `object` (package `com.devil.phoenixproject.domain.premium`). Follow the SmartSuggestionsEngine/RepQualityScorer patterns.

**Engine structure:**

1. **Private rule registry** -- `Map<ExerciseFormType, List<FormRule>>` initialized from per-exercise private functions.

2. **`evaluate(angles: JointAngles, exerciseType: ExerciseFormType, minConfidence: Float = 0.5f): FormAssessment`**:
   - Return empty assessment if `angles.confidence < minConfidence`
   - Look up rules for the exercise type
   - For each rule, check if the corresponding angle exists in the angles map
   - If angle is outside `[minDegrees, maxDegrees]`, create a FormViolation
   - Return FormAssessment with collected violations

3. **`calculateFormScore(assessments: List<FormAssessment>): Int`**:
   - Empty list returns 100
   - For each assessment, sum deductions by severity: INFO=1, WARNING=3, CRITICAL=5
   - Score = (100 - avgDeductionPerFrame * 25).coerceIn(0, 100).toInt()
   - This means ~2 avg deductions/frame = score of 50

4. **`getRulesForExercise(exerciseType: ExerciseFormType): List<FormRule>`** -- public accessor for rule inspection

5. **Per-exercise rule functions** (private), each returning `List<FormRule>`:

   **squatRules():**
   - LEFT_KNEE/RIGHT_KNEE: max 160 deg (shallow depth), severity INFO, cue "lower hips to parallel"
   - TRUNK_LEAN: max 45 deg (forward lean), severity WARNING, cue "chest up, core braced"
   - KNEE_VALGUS_LEFT/RIGHT: max 10 deg (inward collapse), severity CRITICAL, cue "push knees out over toes"

   **deadliftRdlRules():**
   - TRUNK_LEAN: max 75 deg (back rounding), severity CRITICAL, cue "chest proud, hinge at hips"
   - LEFT_KNEE/RIGHT_KNEE: min 130 deg, max 180 deg (excessive knee bend), severity WARNING, cue "slight knee bend, push hips back"

   **overheadPressRules():**
   - LEFT_ELBOW/RIGHT_ELBOW: max 170 deg (hyperextension at lockout), severity WARNING, cue "slight bend at lockout"
   - TRUNK_LEAN: min -15, max 15 deg (backward lean), severity CRITICAL, cue "brace core, torso upright"

   **curlRules():**
   - LEFT_SHOULDER/RIGHT_SHOULDER: max 25 deg (shoulder drift), severity WARNING, cue "elbows pinned to sides"
   - TRUNK_LEAN: min -10, max 15 deg (body swing), severity WARNING, cue "brace core, no momentum"

   **rowRules():**
   - TRUNK_LEAN: min -15, max 30 deg (forward lean), severity WARNING, cue "torso upright, pull with back"
   - LEFT_ELBOW/RIGHT_ELBOW: min 30, max 160 deg (incomplete pull), severity INFO, cue "pull elbows behind body, squeeze shoulder blades"

Add comprehensive KDoc to the object and evaluate() function. Include a prominent warning comment about CV-08 (advisory only). See 14-RESEARCH.md for exact threshold values and biomechanics sources.

CRITICAL (CV-08): This file MUST NOT import anything from `data/ble/`, `BleRepository`, `WorkoutCoordinator`, or any weight/machine control interface. The engine produces display data ONLY.
  </action>
  <verify>
Full compile check: `./gradlew :shared:compileCommonMainKotlinMetadata 2>&1 | tail -5` shows BUILD SUCCESSFUL.
Verify no BLE imports: `grep -r "ble\|BleRepository\|WorkoutCoordinator\|weight" shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt` returns empty (no matches).
  </verify>
  <done>FormRulesEngine object exists with evaluate(), calculateFormScore(), getRulesForExercise(), and all 5 exercise rule sets. Zero imports from BLE/machine control packages.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileCommonMainKotlinMetadata` -- both new files compile without errors
2. `grep -rn "import.*ble\|import.*BleRepository\|import.*WorkoutCoordinator" shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FormRulesEngine.kt shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/FormCheckModels.kt` returns empty -- CV-08 architectural compliance
3. FormRulesEngine.getRulesForExercise returns non-empty list for all 5 ExerciseFormType values
</verification>

<success_criteria>
- FormCheckModels.kt contains all 7 domain types with KDoc
- FormRulesEngine.kt contains stateless engine with 5 exercise rule sets, evaluate(), calculateFormScore()
- Both files compile successfully in commonMain
- No references to BLE, weight control, or machine operations anywhere in form check code (CV-08)
- Engine follows established project patterns (object/class in domain/premium/, models in domain/model/)
</success_criteria>

<output>
After completion, create `.planning/phases/14-cv-form-check-domain-logic/14-01-SUMMARY.md`
</output>

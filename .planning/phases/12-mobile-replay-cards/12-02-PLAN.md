---
phase: 12-mobile-replay-cards
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RepReplayCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceSparkline.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
autonomous: true

must_haves:
  truths:
    - "Session detail screen displays a scrollable list of rep cards showing each rep in the set"
    - "Each rep card renders a mini force curve sparkline drawn with Canvas"
    - "Rep cards display peak force in kg plus concentric and eccentric durations in seconds"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RepReplayCard.kt"
      provides: "Individual rep card with metrics and sparkline"
      exports: ["RepReplayCard"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceSparkline.kt"
      provides: "Canvas-based force curve mini visualization"
      exports: ["ForceSparkline"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt"
      provides: "Rep list integration in expanded session view"
      contains: "RepReplayCard"
  key_links:
    - from: "RepReplayCard"
      to: "RepMetricData"
      via: "data class parameter"
      pattern: "RepReplayCard.*RepMetricData"
    - from: "ForceSparkline"
      to: "FloatArray (concentricLoadsA + eccentricLoadsA)"
      via: "force parameter"
      pattern: "ForceSparkline.*force.*FloatArray"
    - from: "HistoryTab expanded section"
      to: "RepMetricRepository.getRepMetrics"
      via: "LaunchedEffect fetch"
      pattern: "repMetricRepository\\.getRepMetrics"
---

<objective>
Build replay card UI that shows per-rep details with mini force curve sparklines and timing metrics.

Purpose: Allow users to review each rep's performance visually with force production graph and timing breakdown.

Output: RepReplayCard composable integrated into HistoryTab's expanded session view.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Plan 01 summary (rep boundary detection algorithm)
@.planning/phases/12-mobile-replay-cards/12-01-SUMMARY.md

# Existing force curve mini-graph for Canvas pattern reference
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceCurveMiniGraph.kt

# RepMetricData model with force arrays and timing
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt

# Repository for fetching rep metrics
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt

# HistoryTab where rep cards will be integrated
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: ForceSparkline Canvas component</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/ForceSparkline.kt</files>
  <action>
Create a compact force curve sparkline component using Canvas, following the pattern from ForceCurveMiniGraph.

**Component API:**
```kotlin
@Composable
fun ForceSparkline(
    forceData: FloatArray,      // Combined concentric + eccentric force values (kg)
    peakIndex: Int?,            // Optional index of peak force for marker
    modifier: Modifier = Modifier,
    lineColor: Color = MaterialTheme.colorScheme.primary,
    peakMarkerColor: Color = MaterialTheme.colorScheme.tertiary
)
```

**Implementation:**
1. Height: 40.dp (compact for card embedding)
2. Padding: 4.dp internal
3. Draw force curve as Path with Stroke(width = 1.5.dp)
4. Normalize Y axis from min to max force in data
5. X axis spans full width proportionally
6. Optional peak marker: small circle at peakIndex position
7. Handle empty array gracefully (show nothing or placeholder line)

Use `Canvas(modifier = Modifier.fillMaxWidth().height(40.dp))` with similar path drawing logic as ForceCurveMiniGraph but simplified (no labels, no click handler).
  </action>
  <verify>
File exists and compiles: `./gradlew :shared:compileDebugKotlin`
  </verify>
  <done>
ForceSparkline renders a 40dp tall force curve from FloatArray data with optional peak marker.
  </done>
</task>

<task type="auto">
  <name>Task 2: RepReplayCard composable with metrics</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RepReplayCard.kt</files>
  <action>
Create the rep replay card that displays a single rep's metrics and sparkline.

**Component API:**
```kotlin
@Composable
fun RepReplayCard(
    repData: RepMetricData,
    weightUnit: WeightUnit,
    formatWeight: (Float, WeightUnit) -> String,
    modifier: Modifier = Modifier
)
```

**Layout (Material 3 Card):**
```
+------------------------------------------+
| Rep 3                           [warmup] |  <- Title row: rep number, optional warmup badge
+------------------------------------------+
| [====== ForceSparkline ================] |  <- Full-width sparkline
+------------------------------------------+
| Peak Force    | Concentric | Eccentric   |  <- Metric labels
| 45.2 kg       | 1.8s       | 2.1s        |  <- Metric values
+------------------------------------------+
```

**Metrics to display:**
- Peak Force: `max(peakForceA, peakForceB)` formatted with weightUnit (kg or lb)
- Concentric Duration: `concentricDurationMs / 1000f` formatted as "X.Xs"
- Eccentric Duration: `eccentricDurationMs / 1000f` formatted as "X.Xs"

**Force data for sparkline:**
Combine `concentricLoadsA + eccentricLoadsA` into single FloatArray for continuous curve.
Peak index = concentricLoadsA.size (transition point).

**Styling:**
- Card with RoundedCornerShape(12.dp)
- surfaceContainerHigh background
- Spacing.small padding
- warmup badge: Surface with tertiaryContainer color if repData.isWarmup
  </action>
  <verify>
File exists and compiles: `./gradlew :shared:compileDebugKotlin`
  </verify>
  <done>
RepReplayCard displays rep number, optional warmup badge, force sparkline, peak force (kg), concentric duration (s), and eccentric duration (s).
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate rep cards into HistoryTab expanded view</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt</files>
  <action>
Add rep replay cards to the expandable session detail section in HistoryTab.

**Integration points:**

1. **In WorkoutHistoryCard's AnimatedVisibility block** (around line 298-362):
   - After CompletedSetsSection, add a new "Rep Details" section
   - Inject RepMetricRepository via koinInject
   - Use LaunchedEffect(session.id) to fetch rep metrics
   - If rep metrics exist, show scrollable column of RepReplayCards

2. **New section structure:**
```kotlin
// After CompletedSetsSection(...)

// Rep Details Section (if metrics exist)
var repMetrics by remember { mutableStateOf<List<RepMetricData>>(emptyList()) }
val repMetricRepository: RepMetricRepository = koinInject()

LaunchedEffect(session.id) {
    repMetrics = repMetricRepository.getRepMetrics(session.id)
}

if (repMetrics.isNotEmpty()) {
    Spacer(modifier = Modifier.height(Spacing.medium))

    Text(
        "Rep Details",
        style = MaterialTheme.typography.titleSmall,
        fontWeight = FontWeight.Bold,
        color = MaterialTheme.colorScheme.primary
    )

    Spacer(modifier = Modifier.height(Spacing.small))

    Column(verticalArrangement = Arrangement.spacedBy(Spacing.small)) {
        repMetrics.forEach { rep ->
            RepReplayCard(
                repData = rep,
                weightUnit = weightUnit,
                formatWeight = formatWeight
            )
        }
    }
}
```

3. **Add imports at top of file:**
```kotlin
import com.devil.phoenixproject.data.repository.RepMetricRepository
import com.devil.phoenixproject.domain.model.RepMetricData
import com.devil.phoenixproject.presentation.components.RepReplayCard
```

4. **Same pattern for GroupedRoutineCard** (around line 783-838):
   - Add rep details section after each session's SetSummaryCard in the expanded view
  </action>
  <verify>
1. Compile: `./gradlew :shared:compileDebugKotlin`
2. Build app: `./gradlew :androidApp:assembleDebug`
  </verify>
  <done>
HistoryTab shows per-rep replay cards with sparklines when expanding a session that has RepMetric data stored.
  </done>
</task>

</tasks>

<verification>
1. Build completes without errors: `./gradlew :androidApp:assembleDebug`
2. ForceSparkline.kt exists with Canvas drawing implementation
3. RepReplayCard.kt exists with metrics display layout
4. HistoryTab.kt imports RepMetricRepository and RepReplayCard
5. Expanded session view fetches and displays rep metrics
</verification>

<success_criteria>
- ForceSparkline draws force curve at 40dp height using Canvas
- RepReplayCard shows: rep number, warmup badge, sparkline, peak force (kg), concentric (s), eccentric (s)
- HistoryTab expanded section shows scrollable rep cards when RepMetric data exists
- App builds and runs without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/12-mobile-replay-cards/12-02-SUMMARY.md`
</output>

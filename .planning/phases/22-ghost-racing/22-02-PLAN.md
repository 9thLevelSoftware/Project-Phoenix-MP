---
phase: 22-ghost-racing
plan: 02
type: execute
wave: 2
depends_on:
  - 22-01
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
autonomous: true
requirements:
  - GHOST-01
  - GHOST-03

must_haves:
  truths:
    - "Ghost session is pre-loaded into memory at workout start (no DB reads during active set)"
    - "Per-rep AHEAD/BEHIND/TIED verdict is emitted via StateFlow after each rep completes"
    - "Ghost comparisons accumulate in a list for end-of-set summary computation"
    - "BEYOND verdict is emitted when current rep exceeds ghost session rep count"
    - "Ghost state resets between sets (ghostRepComparisons cleared, verdict nulled)"
    - "Just Lift mode (exerciseId == null) skips ghost loading entirely"
    - "WorkoutState.SetSummary includes ghostSetSummary field for Plan 03 UI rendering"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt"
      provides: "Ghost state fields (_ghostSession, _latestGhostVerdict, ghostRepComparisons)"
      contains: "_ghostSession"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "Ghost pre-loading in startWorkout, ghost comparison in rep processing, ghost summary in set completion"
      contains: "ghostSession"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt"
      provides: "findBestGhostSession() interface method"
      contains: "findBestGhostSession"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt"
      provides: "findBestGhostSession() implementation using selectBestGhostSession SQL query"
      contains: "findBestGhostSession"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt"
      provides: "ghostSetSummary field on WorkoutState.SetSummary"
      contains: "ghostSetSummary"
  key_links:
    - from: "ActiveSessionEngine.kt"
      to: "WorkoutRepository.kt"
      via: "findBestGhostSession() call in startWorkout coroutine"
      pattern: "findBestGhostSession"
    - from: "ActiveSessionEngine.kt"
      to: "GhostRacingEngine.kt"
      via: "compareRep() call after processBiomechanicsForRep"
      pattern: "GhostRacingEngine\\.compareRep"
    - from: "ActiveSessionEngine.kt"
      to: "WorkoutCoordinator.kt"
      via: "_ghostSession.value, _latestGhostVerdict.value, ghostRepComparisons"
      pattern: "coordinator\\._ghostSession|coordinator\\._latestGhostVerdict|coordinator\\.ghostRepComparisons"
    - from: "ActiveSessionEngine.kt"
      to: "BiomechanicsRepository.kt"
      via: "getRepBiomechanics() call for ghost rep velocity data"
      pattern: "biomechanicsRepository\\.getRepBiomechanics"
---

<objective>
Wire ghost racing into the workout lifecycle: pre-load ghost session at workout start, compare reps in real-time, accumulate results, and produce a set summary with ghost delta.

Purpose: Connect the GhostRacingEngine (Plan 01) to the ActiveSessionEngine/WorkoutCoordinator state bus so that ghost data flows from DB to memory at workout start, rep comparisons happen in real-time, and the set summary carries ghost results for Plan 03's UI.

Output: WorkoutCoordinator ghost state fields, ActiveSessionEngine ghost lifecycle (load/compare/summarize/reset), WorkoutRepository.findBestGhostSession(), WorkoutState.SetSummary.ghostSetSummary field
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ghost-racing/22-RESEARCH.md
@.planning/phases/22-ghost-racing/22-01-SUMMARY.md

Source references (read during execution):
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BiomechanicsRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/GhostModels.kt (created in Plan 01)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngine.kt (created in Plan 01)

<interfaces>
<!-- From Plan 01 (GhostModels.kt) -->
```kotlin
data class GhostSession(
    val sessionId: String,
    val exerciseName: String,
    val weightPerCableKg: Float,
    val workingReps: Int,
    val avgMcvMmS: Float,
    val repVelocities: List<Float>,       // indexed by repNumber-1
    val repPeakPositions: List<Float>     // indexed by repNumber-1
)

enum class GhostVerdict { AHEAD, BEHIND, TIED, BEYOND }

data class GhostRepComparison(
    val repNumber: Int,
    val currentMcvMmS: Float,
    val ghostMcvMmS: Float,
    val deltaMcvMmS: Float,
    val verdict: GhostVerdict
)

data class GhostSetSummary(
    val totalDeltaMcvMmS: Float,
    val avgDeltaMcvMmS: Float,
    val repsCompared: Int,
    val repsAhead: Int,
    val repsBehind: Int,
    val repsBeyondGhost: Int,
    val overallVerdict: GhostVerdict
)

data class GhostSessionCandidate(
    val id: String,
    val exerciseName: String?,
    val weightPerCableKg: Float,
    val workingReps: Int,
    val avgMcvMmS: Float
)
```

<!-- From Plan 01 (GhostRacingEngine.kt) -->
```kotlin
object GhostRacingEngine {
    fun findBestSession(candidates: List<GhostSessionCandidate>, exerciseId: String, mode: String, weightPerCableKg: Float, weightToleranceKg: Float = 5f): GhostSessionCandidate?
    fun compareRep(currentMcvMmS: Float, ghostMcvMmS: Float): GhostVerdict
    fun computeSetDelta(comparisons: List<GhostRepComparison>): GhostSetSummary
}
```

<!-- From WorkoutCoordinator.kt - existing state field pattern -->
```kotlin
// Existing pattern for biomechanics state:
val biomechanicsEngine = BiomechanicsEngine()
val latestRepResult: StateFlow<BiomechanicsRepResult?> get() = biomechanicsEngine.latestRepResult
```

<!-- From ActiveSessionEngine.kt - existing rep processing location (line ~522) -->
```kotlin
val repCountAfter = repCounter.getRepCount().totalReps
if (repCountAfter > repCountBefore) {
    scoreCurrentRep(repCountAfter)
    val now = KmpUtils.currentTimeMillis()
    coordinator.repBoundaryTimestamps.add(now)
    processBiomechanicsForRep(repCountAfter, now)
    // Ghost comparison goes AFTER processBiomechanicsForRep
}
```

<!-- From BiomechanicsRepository.kt -->
```kotlin
interface BiomechanicsRepository {
    suspend fun getRepBiomechanics(sessionId: String): List<BiomechanicsRepResult>
}
```

<!-- From WorkoutState.SetSummary (Models.kt) -->
```kotlin
data class SetSummary(
    ...,
    val biomechanicsSummary: BiomechanicsSetSummary? = null,
    val formScore: Int? = null
    // ghostSetSummary will be added here
) : WorkoutState()
```

<!-- Fake repositories that need stub methods -->
Files to update with stub findBestGhostSession():
- shared/src/commonTest/kotlin/.../testutil/FakeWorkoutRepository.kt
- androidApp/src/androidTest/kotlin/.../testutil/FakeWorkoutRepository.kt
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkoutCoordinator ghost state fields + WorkoutRepository.findBestGhostSession</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  </files>
  <action>
1. **WorkoutCoordinator.kt** -- Add ghost state fields following the biomechanicsEngine pattern. Add these after the existing form check state fields (around line 300+):

   ```kotlin
   // ===== Ghost Racing State (Phase 22) =====
   internal val _ghostSession = MutableStateFlow<GhostSession?>(null)
   val ghostSession: StateFlow<GhostSession?> = _ghostSession.asStateFlow()

   internal val _latestGhostVerdict = MutableStateFlow<GhostRepComparison?>(null)
   val latestGhostVerdict: StateFlow<GhostRepComparison?> = _latestGhostVerdict.asStateFlow()

   /** Accumulates per-rep ghost comparisons for the current set. Cleared on set reset. */
   internal val ghostRepComparisons = mutableListOf<GhostRepComparison>()
   ```

   Add the necessary imports for GhostSession, GhostRepComparison from domain/model/GhostModels.kt.

2. **WorkoutRepository.kt** -- Add interface method:
   ```kotlin
   suspend fun findBestGhostSession(
       exerciseId: String,
       mode: String,
       weightPerCableKg: Float,
       weightToleranceKg: Float
   ): GhostSessionCandidate?
   ```
   Import GhostSessionCandidate.

3. **SqlDelightWorkoutRepository.kt** -- Implement findBestGhostSession using the selectBestGhostSession SQL query (added in Plan 01):
   ```kotlin
   override suspend fun findBestGhostSession(
       exerciseId: String,
       mode: String,
       weightPerCableKg: Float,
       weightToleranceKg: Float
   ): GhostSessionCandidate? = withContext(Dispatchers.IO) {
       database.vitruvianDatabaseQueries.selectBestGhostSession(
           exerciseId = exerciseId,
           mode = mode,
           weightPerCableKg_ = weightPerCableKg.toDouble(),
           weightToleranceKg = weightToleranceKg.toDouble()
       ).executeAsOneOrNull()?.let { row ->
           GhostSessionCandidate(
               id = row.id,
               exerciseName = row.exerciseName,
               weightPerCableKg = row.weightPerCableKg.toFloat(),
               workingReps = row.workingReps.toInt(),
               avgMcvMmS = row.avgMcvMmS?.toFloat() ?: 0f
           )
       }
   }
   ```
   Note: SQLDelight may generate parameter names differently -- check the generated code. The query uses positional `?` parameters, so map them in order: exerciseId, mode, weightPerCableKg (for ABS comparison), weightToleranceKg.

4. **Models.kt** -- Add `ghostSetSummary` field to `WorkoutState.SetSummary`:
   ```kotlin
   data class SetSummary(
       ...,
       val formScore: Int? = null,
       // Ghost Racing summary (null if ghost racing was not active for this set)
       val ghostSetSummary: GhostSetSummary? = null
   ) : WorkoutState()
   ```
   Import GhostSetSummary.

5. **Update fake repositories** -- Add stub `findBestGhostSession` to both FakeWorkoutRepository files:
   - `shared/src/commonTest/kotlin/.../testutil/FakeWorkoutRepository.kt`
   - `androidApp/src/androidTest/kotlin/.../testutil/FakeWorkoutRepository.kt`
   Both return `null` (no ghost session in tests by default).

6. Build to verify: `./gradlew :androidApp:assembleDebug`

Commit: `feat(22-02): add ghost state fields to WorkoutCoordinator and findBestGhostSession repository method`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug 2>&1 | tail -10</automated>
  </verify>
  <done>WorkoutCoordinator has _ghostSession, _latestGhostVerdict, ghostRepComparisons. WorkoutRepository.findBestGhostSession() compiles and links to SQL query. WorkoutState.SetSummary has ghostSetSummary field. All fake repos updated. Full build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: ActiveSessionEngine ghost lifecycle (pre-load, compare, summarize, reset)</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  </files>
  <action>
1. **Ghost pre-loading in startWorkout()** -- Inside the `coordinator.workoutJob = scope.launch { ... }` block in startWorkout(), AFTER the workout parameters and exercise type detection are resolved (around line 1340-1360) but BEFORE the countdown/BLE commands, add ghost session loading:

   ```kotlin
   // Pre-load ghost session for real-time comparison (Phase 22)
   // Only when exercise is known (not Just Lift mode) -- no DB reads during active set
   val exerciseId = params.selectedExerciseId
   if (exerciseId != null && exerciseId.isNotBlank() && !isBodyweight) {
       scope.launch {
           try {
               val candidate = workoutRepository.findBestGhostSession(
                   exerciseId = exerciseId,
                   mode = params.programMode.name,
                   weightPerCableKg = params.weightPerCableKg,
                   weightToleranceKg = 5f
               )
               if (candidate != null) {
                   val repBio = biomechanicsRepository.getRepBiomechanics(candidate.id)
                   coordinator._ghostSession.value = GhostSession(
                       sessionId = candidate.id,
                       exerciseName = candidate.exerciseName ?: "",
                       weightPerCableKg = candidate.weightPerCableKg,
                       workingReps = candidate.workingReps,
                       avgMcvMmS = candidate.avgMcvMmS,
                       repVelocities = repBio.map { it.velocity.meanConcentricVelocityMmS },
                       repPeakPositions = repBio.map { it.velocity.peakVelocityMmS }
                       // Using peak velocity as proxy for peak position since RepBiomechanics
                       // stores velocity data, not raw position traces (research recommendation)
                   )
                   Logger.d { "Ghost session loaded: ${candidate.id}, ${repBio.size} reps, avgMcv=${candidate.avgMcvMmS}" }
               } else {
                   coordinator._ghostSession.value = null
                   Logger.d { "No ghost session found for exerciseId=$exerciseId, mode=${params.programMode.name}, weight=${params.weightPerCableKg}kg" }
               }
           } catch (e: Exception) {
               Logger.e(e) { "Failed to load ghost session" }
               coordinator._ghostSession.value = null
           }
       }
   } else {
       coordinator._ghostSession.value = null
   }
   ```

   IMPORTANT: This launches in a separate coroutine so it does NOT block workout start. The ghost overlay simply won't show until loading completes (graceful degradation).

2. **Ghost comparison after rep completion** -- In the `if (repCountAfter > repCountBefore)` block (around line 523-549), AFTER `processBiomechanicsForRep(repCountAfter, now)` and AFTER the exercise auto-detection block, add ghost comparison:

   ```kotlin
   // Ghost racing: compare current rep against ghost (Phase 22)
   val ghostSession = coordinator._ghostSession.value
   if (ghostSession != null) {
       // Wait briefly for biomechanics to process, then compare
       // Use the latest biomechanics rep result for current MCV
       scope.launch {
           // Small delay to let processBiomechanicsForRep complete on Default dispatcher
           kotlinx.coroutines.delay(50)
           val latestBio = coordinator.biomechanicsEngine.latestRepResult.value
           if (latestBio != null && latestBio.repNumber == repCountAfter) {
               val currentMcv = latestBio.velocity.meanConcentricVelocityMmS
               val ghostRepIndex = repCountAfter - 1  // 0-based index (Pitfall 2: off-by-one)
               if (ghostRepIndex < ghostSession.repVelocities.size) {
                   val ghostMcv = ghostSession.repVelocities[ghostRepIndex]
                   val comparison = GhostRepComparison(
                       repNumber = repCountAfter,
                       currentMcvMmS = currentMcv,
                       ghostMcvMmS = ghostMcv,
                       deltaMcvMmS = currentMcv - ghostMcv,
                       verdict = GhostRacingEngine.compareRep(currentMcv, ghostMcv)
                   )
                   coordinator.ghostRepComparisons.add(comparison)
                   coordinator._latestGhostVerdict.value = comparison
               } else {
                   // Beyond ghost rep count -- user exceeded their PB
                   val comparison = GhostRepComparison(
                       repNumber = repCountAfter,
                       currentMcvMmS = currentMcv,
                       ghostMcvMmS = 0f,
                       deltaMcvMmS = 0f,
                       verdict = GhostVerdict.BEYOND
                   )
                   coordinator.ghostRepComparisons.add(comparison)
                   coordinator._latestGhostVerdict.value = comparison
               }
           }
       }
   }
   ```

3. **Ghost summary at set completion** -- In `handleSetCompletion()` (around line 2069-2074 where biomechanics/formScore/qualitySummary are attached to the SetSummary), add ghost set summary computation BEFORE the `baseSummary.copy(...)` call:

   ```kotlin
   // Compute ghost set delta BEFORE resetting ghost state
   val ghostSetSummary = if (coordinator.ghostRepComparisons.isNotEmpty()) {
       GhostRacingEngine.computeSetDelta(coordinator.ghostRepComparisons.toList())
   } else null
   ```

   Then include it in the SetSummary copy:
   ```kotlin
   val summary = baseSummary.copy(
       qualitySummary = qualitySummary,
       biomechanicsSummary = biomechanicsSummary,
       formScore = formScore,
       ghostSetSummary = ghostSetSummary
   )
   ```

4. **Ghost state reset between sets** -- In the same handleSetCompletion block, AFTER the SetSummary is constructed and ALONGSIDE the existing resets (biomechanics engine reset, formAssessments.clear(), etc.), add:

   ```kotlin
   // Reset ghost comparison state for next set (keep ghostSession loaded for multi-set workouts)
   coordinator.ghostRepComparisons.clear()
   coordinator._latestGhostVerdict.value = null
   ```

   NOTE: Do NOT null out `coordinator._ghostSession.value` -- the ghost session stays loaded for the entire workout. Only the per-set comparisons reset.

5. **Ghost state cleanup on workout stop/complete** -- Find the workout cleanup/stop method (where biomechanicsEngine.reset() is called for final cleanup, around line 1286). Also null out the ghost session:
   ```kotlin
   coordinator._ghostSession.value = null
   coordinator._latestGhostVerdict.value = null
   coordinator.ghostRepComparisons.clear()
   ```

6. Add necessary imports at top of ActiveSessionEngine.kt:
   - `import com.devil.phoenixproject.domain.model.GhostRepComparison`
   - `import com.devil.phoenixproject.domain.model.GhostSession`
   - `import com.devil.phoenixproject.domain.model.GhostVerdict`
   - `import com.devil.phoenixproject.domain.premium.GhostRacingEngine`

7. Build and run tests: `./gradlew :androidApp:assembleDebug && ./gradlew :shared:testDebugUnitTest`

Commit: `feat(22-02): wire ghost racing lifecycle into ActiveSessionEngine`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug 2>&1 | tail -10 && ./gradlew :shared:testDebugUnitTest 2>&1 | tail -10</automated>
  </verify>
  <done>ActiveSessionEngine pre-loads ghost session at workout start (no DB during set). Per-rep comparison emits AHEAD/BEHIND/TIED/BEYOND. Set summary includes ghostSetSummary. Ghost state resets between sets but session persists across multi-set workout. Full build and all tests pass.</done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` -- full build succeeds with all ghost wiring
- `./gradlew :shared:testDebugUnitTest` -- all existing tests pass (no regressions)
- WorkoutCoordinator.ghostSession StateFlow is publicly readable for UI layer
- WorkoutCoordinator.latestGhostVerdict StateFlow is publicly readable for UI layer
- WorkoutState.SetSummary.ghostSetSummary field exists and is nullable
- ActiveSessionEngine loads ghost in startWorkout, compares in rep processing, summarizes at set end
- Ghost state resets between sets but ghost session persists across workout
</verification>

<success_criteria>
- Ghost session pre-loaded in separate coroutine at workout start (non-blocking)
- Rep comparison uses repNumber-1 indexing (Pitfall 2 addressed)
- Just Lift mode (null exerciseId) skips ghost loading
- BEYOND verdict when exceeding ghost rep count (Pitfall 4 addressed)
- No DB reads during active set metric processing
- ghostSetSummary available on WorkoutState.SetSummary for Plan 03 UI
- All fake repositories updated with stub methods
- Full build and test suite pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-ghost-racing/22-02-SUMMARY.md`
</output>

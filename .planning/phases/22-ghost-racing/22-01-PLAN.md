---
phase: 22-ghost-racing
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/GhostModels.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngine.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngineTest.kt
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
autonomous: true
requirements:
  - GHOST-01
  - GHOST-03
  - GHOST-04

must_haves:
  truths:
    - "GhostRacingEngine.findBestSession() selects the session with highest avgMcvMmS matching exerciseId + mode within weight tolerance"
    - "GhostRacingEngine.compareRep() returns AHEAD when current MCV exceeds ghost MCV by >5%, BEHIND when below, TIED within tolerance"
    - "GhostRacingEngine.computeSetDelta() correctly aggregates per-rep deltas into an overall verdict"
    - "BEYOND verdict is returned when current rep index exceeds ghost session rep count"
    - "selectBestGhostSession SQL query returns the best session filtered by exerciseId, mode, and weight tolerance"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/GhostModels.kt"
      provides: "GhostSession, GhostVerdict, GhostRepComparison, GhostSetSummary domain types"
      exports: ["GhostSession", "GhostVerdict", "GhostRepComparison", "GhostSetSummary"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngine.kt"
      provides: "Stateless computation engine for ghost matching and velocity comparison"
      exports: ["GhostRacingEngine"]
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngineTest.kt"
      provides: "TDD test suite for all engine functions"
      min_lines: 80
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      provides: "selectBestGhostSession SQL query"
      contains: "selectBestGhostSession"
  key_links:
    - from: "GhostRacingEngineTest.kt"
      to: "GhostRacingEngine.kt"
      via: "direct function calls"
      pattern: "GhostRacingEngine\\.(findBestSession|compareRep|computeSetDelta)"
    - from: "GhostRacingEngine.kt"
      to: "GhostModels.kt"
      via: "return types"
      pattern: "GhostVerdict|GhostRepComparison|GhostSetSummary"
---

<objective>
Create the GhostRacingEngine pure computation engine via TDD, along with domain model types and the SQL query for finding the best ghost session candidate.

Purpose: Establish the stateless computation layer that Plan 02 will wire into the workout lifecycle. Following the ReadinessEngine/RpgAttributeEngine pattern (pure object, no DI, pure functions).

Output: GhostModels.kt domain types, GhostRacingEngine.kt computation object, GhostRacingEngineTest.kt with 10+ test cases, selectBestGhostSession SQL query in VitruvianDatabase.sq
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ghost-racing/22-RESEARCH.md

Source references (read during execution):
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/ReadinessEngine.kt (pattern to follow)
@shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/ReadinessEngineTest.kt (test pattern)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/ReadinessModels.kt (model pattern)
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq (add query here)

<interfaces>
<!-- Existing types this plan references -->

From shared/.../domain/model/BiomechanicsModels.kt:
```kotlin
data class BiomechanicsRepResult(
    val repNumber: Int,
    val velocity: VelocityResult,  // contains meanConcentricVelocityMmS
    ...
)
```

From VitruvianDatabase.sq - WorkoutSession table columns used by ghost query:
```sql
-- Relevant columns for ghost session matching:
-- id TEXT NOT NULL PRIMARY KEY
-- mode TEXT NOT NULL
-- weightPerCableKg REAL NOT NULL
-- workingReps INTEGER NOT NULL DEFAULT 0
-- exerciseId TEXT
-- exerciseName TEXT
-- avgMcvMmS REAL  (added in migration 15)
```

From VitruvianDatabase.sq - RepBiomechanics table:
```sql
CREATE TABLE RepBiomechanics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    sessionId TEXT NOT NULL,
    repNumber INTEGER NOT NULL,
    mcvMmS REAL NOT NULL,
    peakVelocityMmS REAL NOT NULL,
    ...
);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Domain models and failing tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/GhostModels.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngineTest.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngine.kt
  </files>
  <action>
1. Create `GhostModels.kt` in `domain/model/` with these types:
   - `GhostSession` data class: sessionId (String), exerciseName (String), weightPerCableKg (Float), workingReps (Int), avgMcvMmS (Float), repVelocities (List of Float, indexed by repNumber-1), repPeakPositions (List of Float, indexed by repNumber-1)
   - `GhostVerdict` enum: AHEAD, BEHIND, TIED, BEYOND
   - `GhostRepComparison` data class: repNumber (Int), currentMcvMmS (Float), ghostMcvMmS (Float), deltaMcvMmS (Float -- positive = faster than ghost), verdict (GhostVerdict)
   - `GhostSetSummary` data class: totalDeltaMcvMmS (Float), avgDeltaMcvMmS (Float), repsCompared (Int), repsAhead (Int), repsBehind (Int), repsBeyondGhost (Int), overallVerdict (GhostVerdict)
   - `GhostSessionCandidate` data class: id (String), exerciseName (String?), weightPerCableKg (Float), workingReps (Int), avgMcvMmS (Float). This is the lightweight DB-result type before loading full rep data.

2. Create `GhostRacingEngine.kt` as an empty `object` with stub functions that throw `TODO()`:
   - `fun findBestSession(candidates: List<GhostSessionCandidate>, exerciseId: String, mode: String, weightPerCableKg: Float, weightToleranceKg: Float = 5f): GhostSessionCandidate?`
   - `fun compareRep(currentMcvMmS: Float, ghostMcvMmS: Float): GhostVerdict`
   - `fun computeSetDelta(comparisons: List<GhostRepComparison>): GhostSetSummary`

3. Create `GhostRacingEngineTest.kt` following ReadinessEngineTest pattern with these test cases:
   - **findBestSession tests (4):**
     - Returns null when candidates list is empty
     - Returns the session with highest avgMcvMmS when multiple candidates exist within weight tolerance
     - Returns null when all candidates are outside weight tolerance
     - Filters by weight tolerance correctly (5kg default)
   - **compareRep tests (4):**
     - Returns AHEAD when current MCV > ghost MCV by > 5%
     - Returns BEHIND when current MCV < ghost MCV by > 5%
     - Returns TIED when delta is within +/- 5%
     - Returns AHEAD when ghost MCV is <= 0 (guard against bad data)
   - **computeSetDelta tests (4):**
     - Returns AHEAD overall when total delta is positive
     - Returns BEHIND overall when total delta is negative
     - Correctly counts repsAhead, repsBehind, repsBeyondGhost
     - Excludes BEYOND reps from delta calculations (they have no ghost data to compare against)

4. Run tests to confirm they FAIL (not compilation errors -- all types must compile, only the TODO() stubs cause test failures).

Commit: `test(22-01): add failing tests for GhostRacingEngine`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testDebugUnitTest 2>&1 | tail -20</automated>
  </verify>
  <done>All 12 test cases compile and fail with TODO/NotImplementedError (RED phase). GhostModels.kt types export correctly. GhostRacingEngine.kt stubs exist.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement GhostRacingEngine + SQL query</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/GhostRacingEngine.kt
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  </files>
  <action>
1. Implement `GhostRacingEngine` functions (replace TODO stubs):

   **findBestSession:** Filter candidates where `ABS(candidate.weightPerCableKg - weightPerCableKg) <= weightToleranceKg` and `candidate.workingReps > 0` and `candidate.avgMcvMmS > 0`. From filtered, return the one with highest avgMcvMmS. Return null if no candidates pass filter.

   **compareRep:** Guard: if ghostMcvMmS <= 0, return AHEAD (bad ghost data). Calculate deltaPercent = ((currentMcvMmS - ghostMcvMmS) / ghostMcvMmS) * 100. Return AHEAD if deltaPercent > 5, BEHIND if deltaPercent < -5, else TIED. Use a private constant TIED_TOLERANCE_PERCENT = 5f.

   **computeSetDelta:** Filter out BEYOND comparisons for delta calculation. Sum deltaMcvMmS of remaining. Average = totalDelta / compared.size (guard: if empty, 0). Count repsAhead, repsBehind, repsBeyondGhost. Overall verdict: AHEAD if avgDelta > 0, BEHIND if < 0, TIED if == 0.

2. Add `selectBestGhostSession` named query to VitruvianDatabase.sq (append near other SELECT queries for WorkoutSession, around line 870+):
   ```sql
   selectBestGhostSession:
   SELECT id, exerciseName, weightPerCableKg, workingReps, avgMcvMmS
   FROM WorkoutSession
   WHERE exerciseId = ?
     AND mode = ?
     AND avgMcvMmS IS NOT NULL
     AND avgMcvMmS > 0
     AND workingReps > 0
     AND ABS(weightPerCableKg - ?) <= ?
   ORDER BY avgMcvMmS DESC
   LIMIT 1;
   ```

3. Run all tests -- all 12 GhostRacingEngine tests must pass. Also run `./gradlew :shared:testDebugUnitTest` to verify no regressions across the full shared module test suite.

4. Build the full project to verify SQLDelight query compiles: `./gradlew :androidApp:assembleDebug`

Commit: `feat(22-01): implement GhostRacingEngine and selectBestGhostSession query`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.GhostRacingEngineTest" 2>&1 | tail -20 && ./gradlew :androidApp:assembleDebug 2>&1 | tail -5</automated>
  </verify>
  <done>All 12 GhostRacingEngineTest cases pass (GREEN). selectBestGhostSession SQL query compiles via SQLDelight. Full project builds cleanly.</done>
</task>

</tasks>

<verification>
- `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.GhostRacingEngineTest"` -- all 12 tests pass
- `./gradlew :androidApp:assembleDebug` -- full build succeeds (SQLDelight query valid)
- GhostModels.kt exports all 5 types (GhostSession, GhostVerdict, GhostRepComparison, GhostSetSummary, GhostSessionCandidate)
- GhostRacingEngine.kt is a stateless `object` with no DI dependencies (follows ReadinessEngine pattern)
</verification>

<success_criteria>
- 12+ TDD tests pass covering findBestSession, compareRep, computeSetDelta
- selectBestGhostSession SQL query added to VitruvianDatabase.sq and compiles
- GhostModels.kt contains all domain types needed by Plans 02 and 03
- GhostRacingEngine is a pure stateless object (no suspend, no repository injection)
- Full project assembleDebug succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/22-ghost-racing/22-01-SUMMARY.md`
</output>

---
phase: 22-ghost-racing
plan: 03
type: execute
wave: 3
depends_on:
  - 22-02
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/GhostRacingOverlay.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
autonomous: true
requirements:
  - GHOST-02
  - GHOST-03
  - GHOST-04

must_haves:
  truths:
    - "Two vertical progress bars show current vs ghost position during active set"
    - "AHEAD/BEHIND/TIED/BEYOND verdict badge displays after each rep completes"
    - "Ghost racing overlay renders on ExecutionPage as conditional element (not separate pager page)"
    - "Ghost overlay only shows when ghostSession is non-null AND user has Phoenix+ tier"
    - "End-of-set summary shows velocity delta with reps ahead/behind counts"
    - "All colors use AccessibilityTheme (WCAG Phase 17 mandate)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/GhostRacingOverlay.kt"
      provides: "GhostRacingOverlay composable with dual progress bars and verdict badge"
      min_lines: 60
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt"
      provides: "Ghost overlay rendered in Box overlay zone on ExecutionPage"
      contains: "GhostRacingOverlay"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt"
      provides: "Ghost velocity delta section in set summary card"
      contains: "ghostSetSummary"
  key_links:
    - from: "WorkoutHud.kt"
      to: "GhostRacingOverlay.kt"
      via: "composable invocation"
      pattern: "GhostRacingOverlay\\("
    - from: "WorkoutHud.kt"
      to: "WorkoutCoordinator.kt"
      via: "ghostSession and latestGhostVerdict StateFlow collection"
      pattern: "ghostSession|latestGhostVerdict"
    - from: "SetSummaryCard.kt"
      to: "GhostModels.kt"
      via: "GhostSetSummary rendering"
      pattern: "GhostSetSummary|ghostSetSummary"
    - from: "GhostRacingOverlay.kt"
      to: "AccessibilityTheme"
      via: "WCAG-safe colors for verdict indicators"
      pattern: "AccessibilityTheme\\.colors"
---

<objective>
Build the GhostRacingOverlay composable with dual vertical progress bars and verdict badge, wire it into WorkoutHud's overlay zone on the ExecutionPage, and add ghost velocity delta display to SetSummaryCard.

Purpose: Deliver the visual layer that makes ghost racing visible to users -- real-time position comparison bars during the set, per-rep verdict after each rep, and a summary delta after set completion.

Output: GhostRacingOverlay.kt composable, WorkoutHud.kt overlay integration, SetSummaryCard.kt ghost delta section
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-ghost-racing/22-RESEARCH.md
@.planning/phases/22-ghost-racing/22-01-SUMMARY.md
@.planning/phases/22-ghost-racing/22-02-SUMMARY.md

Source references (read during execution):
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/FormCheckOverlay.kt (overlay pattern reference)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/FormWarningBanner.kt (overlay pattern reference)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/ui/theme/AccessibilityColors.kt (WCAG colors)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/GhostModels.kt (Plan 01 types)

<interfaces>
<!-- From Plan 02 (WorkoutCoordinator ghost state) -->
```kotlin
// WorkoutCoordinator public API for UI:
val ghostSession: StateFlow<GhostSession?>
val latestGhostVerdict: StateFlow<GhostRepComparison?>
```

<!-- From Plan 01 (GhostModels.kt) -->
```kotlin
data class GhostSession(
    val sessionId: String,
    val exerciseName: String,
    val weightPerCableKg: Float,
    val workingReps: Int,
    val avgMcvMmS: Float,
    val repVelocities: List<Float>,
    val repPeakPositions: List<Float>
)

enum class GhostVerdict { AHEAD, BEHIND, TIED, BEYOND }

data class GhostRepComparison(
    val repNumber: Int,
    val currentMcvMmS: Float,
    val ghostMcvMmS: Float,
    val deltaMcvMmS: Float,
    val verdict: GhostVerdict
)

data class GhostSetSummary(
    val totalDeltaMcvMmS: Float,
    val avgDeltaMcvMmS: Float,
    val repsCompared: Int,
    val repsAhead: Int,
    val repsBehind: Int,
    val repsBeyondGhost: Int,
    val overallVerdict: GhostVerdict
)
```

<!-- From WorkoutState.SetSummary (Models.kt, updated in Plan 02) -->
```kotlin
data class SetSummary(
    ...,
    val ghostSetSummary: GhostSetSummary? = null
) : WorkoutState()
```

<!-- From WorkoutHud.kt -- overlay zone pattern (lines 319-367) -->
```kotlin
// Existing overlays in the Box zone:
// BalanceBar(...)                    // line 319
// FormCheckOverlay(...)              // line 348, gated by isFormCheckEnabled && formType != null
// FormWarningBanner(...)             // line 361, gated by isFormCheckEnabled
// EnhancedCablePositionBar(...)      // lines 271-315, left and right bars
```

<!-- From AccessibilityTheme -->
```kotlin
// AccessibilityTheme.colors provides:
// .success -> green/teal (for AHEAD)
// .error -> red/orange (for BEHIND)
// .warning -> yellow/amber (for TIED)
// .primary -> brand primary
// .onSurfaceVariant -> muted text
```

<!-- From WorkoutHud.kt -- how existing state is collected -->
```kotlin
// Pattern: state collected at top of WorkoutHud composable
val metric by coordinator.latestMetric.collectAsState()
val repCount by coordinator.repCount.collectAsState()
// Ghost state will follow same pattern
```

<!-- From FeatureGate.kt -->
```kotlin
// FeatureGate.isEnabled(Feature.GHOST_RACING, tier) -- already exists
```

<!-- SetSummaryCard.kt signature -->
```kotlin
@Composable
fun SetSummaryCard(
    summary: WorkoutState.SetSummary,
    workoutMode: String,
    weightUnit: WeightUnit,
    ...
)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: GhostRacingOverlay composable + WorkoutHud integration</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/GhostRacingOverlay.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutHud.kt
  </files>
  <action>
1. **Create GhostRacingOverlay.kt** in `presentation/components/`:

   ```kotlin
   @Composable
   fun GhostRacingOverlay(
       currentRepVelocity: Float,     // Current rep MCV (0 if no rep yet)
       ghostRepVelocity: Float,       // Ghost rep MCV for matching rep index
       maxVelocity: Float,            // Max velocity for progress bar scaling (use ghost session avgMcv * 2 or similar)
       verdict: GhostRepComparison?,  // Latest verdict (null before first rep)
       modifier: Modifier = Modifier
   )
   ```

   Layout:
   - A Column containing:
     - Two thin vertical progress bars side by side in a Row (16dp wide each, 120dp tall), with 8dp spacing
     - Left bar labeled "YOU" (uses AccessibilityTheme.colors.primary fill)
     - Right bar labeled "BEST" (uses AccessibilityTheme.colors.onSurfaceVariant.copy(alpha=0.5f) fill)
     - Progress = velocity / maxVelocity, coerced to 0..1
     - Each bar: Column with label Text at top, a Box with background (surface variant) and inner Box with fill color for progress, height-weighted by progress fraction. Use `Modifier.fillMaxHeight(progress)` with `Modifier.align(Alignment.BottomCenter)` for bottom-up fill.
   - Below the bars, a verdict badge (small chip-style):
     - AHEAD -> text "AHEAD", color AccessibilityTheme.colors.success
     - BEHIND -> text "BEHIND", color AccessibilityTheme.colors.error
     - TIED -> text "TIED", color AccessibilityTheme.colors.warning
     - BEYOND -> text "NEW BEST", color AccessibilityTheme.colors.success
     - Include a text label alongside the color (WCAG Phase 17 mandate: secondary visual signal)
   - If verdict is null (no rep completed yet), show "VS GHOST" in muted text
   - Use MaterialTheme.typography.labelSmall for all text, FontWeight.Bold for verdict

   Extract a private `@Composable fun VerticalProgressBar(progress: Float, color: Color, label: String)` helper.

   All colors MUST come from AccessibilityTheme.colors (do NOT use hardcoded Color values). Pre-compute AccessibilityTheme.colors BEFORE any Canvas/draw blocks.

2. **Wire into WorkoutHud.kt**:

   At the top of the WorkoutHud composable (alongside existing state collection), collect ghost state:
   ```kotlin
   val ghostSession by coordinator.ghostSession.collectAsState()
   val latestGhostVerdict by coordinator.latestGhostVerdict.collectAsState()
   ```

   Determine ghost access (tier gating). Follow the existing FormCheckOverlay gating pattern -- look at how `isFormCheckEnabled` is determined and use similar pattern with FeatureGate.GHOST_RACING:
   ```kotlin
   val hasGhostAccess = FeatureGate.isEnabled(Feature.GHOST_RACING, currentTier)
   ```
   Note: `currentTier` should already be available in WorkoutHud's scope. If not, thread it through the same way form check tier is threaded.

   In the Box overlay zone (after the cable position bars, around lines 315-340, BEFORE the FormCheckOverlay), add the ghost overlay:
   ```kotlin
   // Ghost Racing overlay (Phase 22) -- positioned inset from cable bars
   if (ghostSession != null && hasGhostAccess) {
       val currentMetric = metric
       val repVelocity = latestGhostVerdict?.currentMcvMmS ?: 0f
       val ghostVelocity = if (latestGhostVerdict != null && latestGhostVerdict!!.verdict != GhostVerdict.BEYOND) {
           latestGhostVerdict!!.ghostMcvMmS
       } else {
           ghostSession!!.avgMcvMmS  // Show average as baseline before first rep
       }
       val maxVelocity = (ghostSession!!.avgMcvMmS * 2f).coerceAtLeast(100f)

       GhostRacingOverlay(
           currentRepVelocity = repVelocity,
           ghostRepVelocity = ghostVelocity,
           maxVelocity = maxVelocity,
           verdict = latestGhostVerdict,
           modifier = Modifier
               .align(Alignment.CenterStart)
               .padding(start = 48.dp, top = 32.dp)  // Inset from cable bar (Pitfall 6)
       )
   }
   ```

   Add imports:
   - `import com.devil.phoenixproject.presentation.components.GhostRacingOverlay`
   - `import com.devil.phoenixproject.domain.model.GhostVerdict`
   - `import com.devil.phoenixproject.domain.model.FeatureGate` (if not already imported)

3. Build: `./gradlew :androidApp:assembleDebug`

Commit: `feat(22-03): add GhostRacingOverlay composable and wire into WorkoutHud`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug 2>&1 | tail -10</automated>
  </verify>
  <done>GhostRacingOverlay renders dual vertical bars with YOU/BEST labels and verdict badge. WorkoutHud conditionally renders overlay when ghostSession is non-null and tier gate passes. All colors use AccessibilityTheme. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: SetSummaryCard ghost velocity delta display</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  </files>
  <action>
1. **Add ghost delta section to SetSummaryCard.kt**:

   Read the existing SetSummaryCard composable to understand the layout pattern. Look for where biomechanicsSummary is rendered (it will be a conditional section gated on non-null). Follow that exact pattern for ghostSetSummary.

   After the existing sections (biomechanics summary, form score, quality summary), add a ghost racing section:

   ```kotlin
   // Ghost Racing Delta (Phase 22)
   summary.ghostSetSummary?.let { ghost ->
       HorizontalDivider(modifier = Modifier.padding(vertical = 8.dp))

       // Header row with ghost icon
       Row(
           modifier = Modifier.fillMaxWidth(),
           verticalAlignment = Alignment.CenterVertically
       ) {
           Icon(
               imageVector = Icons.Filled.Speed,  // Or Timer, or a relevant icon
               contentDescription = "Ghost Racing",
               modifier = Modifier.size(20.dp),
               tint = AccessibilityTheme.colors.onSurface
           )
           Spacer(modifier = Modifier.width(8.dp))
           Text(
               "vs Personal Best",
               style = MaterialTheme.typography.titleSmall,
               fontWeight = FontWeight.Bold,
               color = AccessibilityTheme.colors.onSurface
           )
       }

       Spacer(modifier = Modifier.height(4.dp))

       // Overall verdict with color
       val (verdictText, verdictColor) = when (ghost.overallVerdict) {
           GhostVerdict.AHEAD -> "FASTER" to AccessibilityTheme.colors.success
           GhostVerdict.BEHIND -> "SLOWER" to AccessibilityTheme.colors.error
           GhostVerdict.TIED -> "MATCHED" to AccessibilityTheme.colors.warning
           GhostVerdict.BEYOND -> "NEW BEST" to AccessibilityTheme.colors.success
       }

       Row(
           modifier = Modifier.fillMaxWidth(),
           horizontalArrangement = Arrangement.SpaceBetween
       ) {
           Text(
               verdictText,
               style = MaterialTheme.typography.headlineSmall,
               fontWeight = FontWeight.Bold,
               color = verdictColor
           )
           // Average velocity delta
           val deltaSign = if (ghost.avgDeltaMcvMmS >= 0) "+" else ""
           Text(
               "${deltaSign}${String.format("%.1f", ghost.avgDeltaMcvMmS)} mm/s avg",
               style = MaterialTheme.typography.bodyMedium,
               color = AccessibilityTheme.colors.onSurfaceVariant
           )
       }

       // Rep breakdown: X ahead, Y behind, Z beyond
       Row(
           modifier = Modifier.fillMaxWidth(),
           horizontalArrangement = Arrangement.spacedBy(12.dp)
       ) {
           if (ghost.repsAhead > 0) {
               Text(
                   "${ghost.repsAhead} ahead",
                   style = MaterialTheme.typography.bodySmall,
                   color = AccessibilityTheme.colors.success
               )
           }
           if (ghost.repsBehind > 0) {
               Text(
                   "${ghost.repsBehind} behind",
                   style = MaterialTheme.typography.bodySmall,
                   color = AccessibilityTheme.colors.error
               )
           }
           if (ghost.repsBeyondGhost > 0) {
               Text(
                   "${ghost.repsBeyondGhost} beyond ghost",
                   style = MaterialTheme.typography.bodySmall,
                   color = AccessibilityTheme.colors.success
               )
           }
       }
   }
   ```

   Add imports:
   - `import com.devil.phoenixproject.domain.model.GhostVerdict`
   - `import com.devil.phoenixproject.ui.theme.AccessibilityTheme` (likely already imported)

   Note: Use `String.format("%.1f", value)` for the delta display. If this causes KMP issues (expect/actual String.format), use `((ghost.avgDeltaMcvMmS * 10).roundToInt() / 10f).toString()` instead.

2. Build and run tests: `./gradlew :androidApp:assembleDebug && ./gradlew :shared:testDebugUnitTest`

Commit: `feat(22-03): add ghost velocity delta section to SetSummaryCard`
  </action>
  <verify>
    <automated>cd C:/Users/dasbl/AndroidStudioProjects/Project-Phoenix-MP && ./gradlew :androidApp:assembleDebug 2>&1 | tail -10 && ./gradlew :shared:testDebugUnitTest 2>&1 | tail -10</automated>
  </verify>
  <done>SetSummaryCard shows ghost velocity delta section with overall verdict (FASTER/SLOWER/MATCHED), average delta in mm/s, and rep breakdown (X ahead, Y behind, Z beyond). All colors use AccessibilityTheme. Build and tests pass.</done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` -- full build succeeds with all UI components
- `./gradlew :shared:testDebugUnitTest` -- all existing tests pass
- GhostRacingOverlay shows dual bars with YOU/BEST labels and verdict
- WorkoutHud renders ghost overlay only when ghostSession != null && Phoenix+ tier
- SetSummaryCard shows velocity delta section when ghostSetSummary != null
- Ghost overlay positioned to avoid conflict with cable bars (Pitfall 6)
- All colors use AccessibilityTheme.colors (WCAG mandate)
</verification>

<success_criteria>
- GhostRacingOverlay composable renders dual vertical progress bars with labels
- Verdict badge shows AHEAD/BEHIND/TIED/BEYOND with WCAG-safe colors + text labels
- Ghost overlay renders on ExecutionPage as conditional element (not separate pager page, per success criteria 5)
- Overlay gated by FeatureGate.GHOST_RACING + non-null ghostSession
- SetSummaryCard shows overall verdict, avg delta, and per-rep breakdown
- No hardcoded colors -- all from AccessibilityTheme
- Full project builds and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-ghost-racing/22-03-SUMMARY.md`
</output>

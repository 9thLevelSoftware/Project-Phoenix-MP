---
phase: 03-rep-quality-scoring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorer.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepQuality.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorerTest.kt
autonomous: true

must_haves:
  truths:
    - "Each rep receives a composite quality score 0-100 from four weighted components"
    - "ROM consistency contributes up to 30 points based on deviation from set average"
    - "Velocity consistency contributes up to 25 points based on deviation from set average"
    - "Eccentric control contributes up to 25 points based on ecc:conc time ratio"
    - "Movement smoothness contributes up to 20 points based on velocity variance"
    - "First rep of a set scores 100 (no baseline to compare against)"
    - "Quality trend (improving/stable/declining) is computed from rep score sequence"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepQuality.kt"
      provides: "RepQualityScore data class, QualityTrend enum, SetQualitySummary"
      min_lines: 30
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorer.kt"
      provides: "Stateful scorer that accumulates per-set baselines and scores each rep"
      exports: ["RepQualityScorer"]
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorerTest.kt"
      provides: "Unit tests for all four scoring components and edge cases"
      min_lines: 80
  key_links:
    - from: "RepQualityScorer"
      to: "RepMetricData"
      via: "scoreRep() accepts RepMetricData and returns RepQualityScore"
      pattern: "fun scoreRep.*RepMetricData.*RepQualityScore"
    - from: "RepQualityScorer"
      to: "RunningAverage"
      via: "Uses RunningAverage for ROM and velocity baselines"
      pattern: "RunningAverage"
---

<objective>
Build the RepQualityScorer engine using TDD -- a pure domain class that scores each rep 0-100 based on four weighted components (ROM 30pts, velocity 25pts, eccentric control 25pts, smoothness 20pts).

Purpose: This is the core scoring algorithm that all UI features depend on. TDD ensures the math is correct before any integration work.
Output: RepQualityScorer class with full test coverage, RepQuality domain models.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/RunningAverage.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1 (RED): Write failing tests for RepQualityScorer</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepQuality.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorerTest.kt
  </files>
  <action>
    1. Create RepQuality.kt with the minimal domain models needed for tests to compile (but NOT the scorer):
       - RepQualityScore: data class with composite (Int 0-100), romScore (Float 0-30), velocityScore (Float 0-25),
         eccentricControlScore (Float 0-25), smoothnessScore (Float 0-20), repNumber (Int)
       - QualityTrend: enum IMPROVING, STABLE, DECLINING
       - SetQualitySummary: data class with averageScore (Int), bestScore (Int), worstScore (Int),
         bestRepNumber (Int), worstRepNumber (Int), trend (QualityTrend), repScores (List of RepQualityScore)

    2. Create RepQualityScorerTest.kt with 13+ failing tests. Create a minimal stub RepQualityScorer class
       (in the test file or a separate stub) that compiles but throws NotImplementedError, so tests compile and FAIL.

       Tests to write:
       a. First rep returns perfect ROM (30) + velocity (25) scores; eccentric/smoothness computed from actual data
       b. Consistent reps (same ROM, same velocity each rep) maintain high composite scores (>90)
       c. ROM deviation of 20% from average penalizes ROM component (score drops to ~12/30)
       d. Velocity deviation of 20% penalizes velocity component similarly
       e. Eccentric ratio at 2.0 (ideal) gives full 25 points
       f. Eccentric ratio at 0.5 (fast eccentric) gives low score (~6/25)
       g. Smooth velocity array (low variance) gives high smoothness score (>18/20)
       h. Erratic velocity array (high variance) gives low smoothness score (<10/20)
       i. Trend detects IMPROVING pattern (5+ reps, second half avg > first half avg + 5)
       j. Trend detects DECLINING pattern (5+ reps, second half avg < first half avg - 5)
       k. Trend returns STABLE for consistent scores
       l. SetSummary computes correct averageScore, bestScore, worstScore, bestRepNumber, worstRepNumber
       m. reset() clears all state -- scoring after reset behaves like first rep again

       Use RepMetricData from the existing domain model for test inputs. Each test should construct
       a RepMetricData with specific values and assert on the returned RepQualityScore fields.

    3. Run tests to confirm they FAIL (RED phase):
       `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"`
       All 13+ tests must fail. Commit: `test(03-01): add failing tests for RepQualityScorer`
  </action>
  <verify>
    `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"` -- all tests FAIL (expected RED state).
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles (models + stub compile).
  </verify>
  <done>13+ failing tests exist covering all four scoring components, trend detection, set summary, and reset. RED phase confirmed.</done>
</task>

<task type="auto">
  <name>Task 2 (GREEN): Implement RepQualityScorer to pass all tests</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorer.kt
  </files>
  <action>
    Implement RepQualityScorer in domain/premium/ (alongside FeatureGate). Replace the stub with the full implementation.

    RepQualityScorer class:
    - Constructor: no dependencies (pure domain logic)
    - State: RunningAverage for ROM and velocity baselines, mutableListOf scored reps
    - fun reset(): clears all state for new set
    - fun scoreRep(repData: RepMetricData): RepQualityScore
    - fun getSetSummary(): SetQualitySummary
    - fun getTrend(): QualityTrend

    Scoring algorithm for scoreRep():
    1. ROM Score (0-30): First rep = 30. Subsequent reps: deviation = |repROM - avgROM| / avgROM.
       Score = 30 * max(0, 1 - deviation * 3). Clamp to [0, 30]. Then add repROM to running average.
    2. Velocity Score (0-25): Same pattern using avgVelocityConcentric. First rep = 25.
       Score = 25 * max(0, 1 - deviation * 3). Clamp to [0, 25].
    3. Eccentric Control (0-25): ratio = eccentricDurationMs / concentricDurationMs.
       Ideal ratio = 2.0. Score = 25 * max(0, 1 - |ratio - 2.0| / 2.0).
       Clamp to [0, 25]. If concentricDurationMs == 0, score = 0.
    4. Smoothness (0-20): Compute variance of concentricVelocities array.
       Normalize: coeffOfVariation = sqrt(variance) / mean(concentricVelocities).
       Score = 20 * max(0, 1 - coeffOfVariation * 2). Clamp to [0, 20].
       If array empty or mean == 0, score = 10 (neutral).

    composite = round(romScore + velocityScore + eccentricControlScore + smoothnessScore).toInt().coerceIn(0, 100)

    Trend calculation (getTrend()):
    - Needs >= 3 reps. Split scores into first half and second half.
    - If second half average > first half average + 5: IMPROVING
    - If second half average < first half average - 5: DECLINING
    - Otherwise: STABLE

    Run tests to confirm they PASS:
    `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"`
    All 13+ tests must pass. Commit: `feat(03-01): implement RepQualityScorer engine`
  </action>
  <verify>
    `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"` -- all tests PASS (GREEN state).
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles cleanly.
  </verify>
  <done>All 13+ tests pass. RepQualityScorer correctly scores reps across all four components with trend detection and set summary.</done>
</task>

<task type="auto">
  <name>Task 3 (REFACTOR): Extract scoring helpers and clean up</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RepQualityScorer.kt
  </files>
  <action>
    Review the scoreRep() method. If it exceeds ~40 lines, extract component scoring into private helper methods:
    - private fun scoreRom(repROM: Float): Float
    - private fun scoreVelocity(avgVelocity: Float): Float
    - private fun scoreEccentricControl(eccentricMs: Long, concentricMs: Long): Float
    - private fun scoreSmoothness(velocities: List of Float): Float

    Also review:
    - Ensure all magic numbers are named constants (e.g., ROM_MAX_POINTS = 30f, DEVIATION_MULTIPLIER = 3f, IDEAL_ECCENTRIC_RATIO = 2.0f)
    - Ensure KDoc on public methods
    - Verify no unnecessary allocations in the hot scoring path

    If scoreRep() is already clean and under 40 lines, this task is a no-op -- just confirm tests still pass.

    Run tests to confirm no regressions:
    `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"`
    Commit (if changes made): `refactor(03-01): extract scoring helpers in RepQualityScorer`
  </action>
  <verify>
    `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"` -- all tests still PASS.
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles.
  </verify>
  <done>RepQualityScorer is clean, well-documented, with named constants and extracted helpers if needed. All tests pass.</done>
</task>

</tasks>

<verification>
- `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.RepQualityScorerTest"` passes
- All 13+ tests pass
- `./gradlew :shared:compileCommonMainKotlinMetadata` compiles cleanly
</verification>

<success_criteria>
- RepQualityScorer.scoreRep() returns correct scores for all four components
- First rep scores are handled correctly (perfect baseline for ROM/velocity)
- Trend detection works for improving, stable, and declining patterns
- SetQualitySummary aggregates correctly
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-rep-quality-scoring/03-01-SUMMARY.md`
</output>

---
phase: 03-rep-quality-scoring
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Gamification.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/GamificationManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt
autonomous: true

must_haves:
  truths:
    - "Set summary shows average, best, and worst rep quality scores"
    - "Set summary shows quality trend indicator (improving/stable/declining)"
    - "Set summary includes a mini sparkline of per-rep quality scores"
    - "Component breakdown shows as radar/spider chart accessible via swipe"
    - "Form Master badges defined for quality streaks (3+ consecutive sets above 85)"
    - "Form Master badges are earned when quality streak criteria are met"
    - "Earning a Form Master badge triggers full-screen celebration overlay"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt"
      provides: "SetSummary extended with quality fields"
      contains: "averageQuality"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt"
      provides: "Quality stats section with sparkline and radar chart"
      contains: "QualityStatsSection"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Gamification.kt"
      provides: "Form Master badge definitions using existing BadgeRequirement pattern"
      contains: "FORM_MASTER"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/GamificationManager.kt"
      provides: "Quality streak tracking and badge earning logic"
      contains: "qualityStreak"
  key_links:
    - from: "SetSummaryCard"
      to: "SetQualitySummary"
      via: "SetSummary contains SetQualitySummary passed to card"
      pattern: "setQualitySummary"
    - from: "ActiveSessionEngine.handleSetCompletion"
      to: "RepQualityScorer.getSetSummary"
      via: "Set summary includes quality data from scorer before reset"
      pattern: "getSetSummary"
    - from: "GamificationManager"
      to: "QualityStreak"
      via: "Checks quality streak after set completion and awards Form Master badges"
      pattern: "qualityStreak|FORM_MASTER"
    - from: "BadgeCelebrationDialog"
      to: "Badge"
      via: "Existing celebration dialog handles Form Master badges like any other badge"
      pattern: "BadgeCelebrationDialog"
---

<objective>
Enhance the set summary with quality metrics (average/best/worst, trend sparkline, radar chart), define Form Master badges for quality achievements, wire badge earning into GamificationManager, and ensure celebration overlay fires when badges are earned.

Purpose: Users see actionable quality feedback after completing a set, can earn badges for consistent form, and get celebrated with a full-screen overlay (per user decision).
Output: Enhanced SetSummaryCard with quality section, Form Master badge definitions with earning logic and celebration.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-rep-quality-scoring/03-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Gamification.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepQuality.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/GamificationManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/BadgeCelebrationDialog.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SetSummary with quality data and wire in ActiveSessionEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  </files>
  <action>
    1. In Models.kt, extend WorkoutState.SetSummary with quality fields:
       - `val qualitySummary: SetQualitySummary? = null` (null for Free tier or if scorer wasn't active)
       Import SetQualitySummary from domain.model.RepQuality.

    2. In ActiveSessionEngine.handleSetCompletion():
       - BEFORE calling `coordinator.repQualityScorer.reset()`, capture the quality summary:
         ```
         val qualitySummary = coordinator.repQualityScorer.getSetSummary()
         ```
       - Pass `qualitySummary` to the SetSummary constructor when building the summary object.
       - Only include quality data if FeatureGate.isEnabled(Feature.REP_QUALITY_SCORE, currentTier) -- pass null otherwise.
       - Get the current tier from settingsManager or wherever it's accessible (check how LED biofeedback does it in 02-02).
       - THEN reset the scorer after capturing the summary.

    3. Verify the SetSummary changes don't break any existing code that creates SetSummary instances (search for `SetSummary(` across the codebase). The new field has a default value so existing call sites should be fine.
  </action>
  <verify>
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles.
    `./gradlew :shared:testDebugUnitTest` passes (no regressions in existing tests that construct SetSummary).
  </verify>
  <done>SetSummary carries quality data from the scorer, captured before reset, gated by tier.</done>
</task>

<task type="auto">
  <name>Task 2: Add quality section to SetSummaryCard with sparkline and radar chart</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/SetSummaryCard.kt
  </files>
  <action>
    Add a quality stats section to SetSummaryCard that appears when `summary.qualitySummary != null`:

    1. QualityStatsSection composable (inside SetSummaryCard.kt or a new file if card is already large):
       - Header: "Rep Quality" with trend indicator icon (arrow up = improving, horizontal = stable, arrow down = declining)
       - Stats row: Average score (large, color-coded), Best rep (#N: score), Worst rep (#N: score)
       - Mini sparkline: A simple Canvas-drawn line chart showing each rep's quality score.
         Implementation: Canvas with drawLine connecting points. X = rep index evenly spaced, Y = score mapped from 0-100 to canvas height. Line color follows gradient (same color scale as HUD indicator). Keep it small (~60dp height, full width).
       - Trend label: "Improving" / "Stable" / "Declining" with corresponding color (green/gray/red)

    2. Radar chart section (swipeable):
       - Use a HorizontalPager (or simple swipe detection with AnimatedContent) to flip between stats view and radar view.
       - Per user decision: "swipe gesture to flip between stats view and radar view"
       - Radar/spider chart: Canvas-drawn pentagon (4 axes: ROM, Velocity, Eccentric, Smoothness).
         Each axis goes from center (0) to edge (max points for that component: 30, 25, 25, 20).
         Plot the AVERAGE component scores across all reps in the set.
         Fill the polygon with semi-transparent green, outline with solid green.
         Label each axis with the component name and score.
       - If HorizontalPager is not available in the current Compose version, use a simple `var showRadar by remember { mutableStateOf(false) }` with a tap/swipe toggle and AnimatedContent.

    3. Component improvement tip (per user decision: "weakest component highlighted with brief improvement tip"):
       - Identify the weakest component by comparing each component's score as a percentage of its max (e.g., rom/30, velocity/25, etc.)
       - Show a brief tip based on weakest component:
         - ROM: "Try to maintain consistent range of motion each rep"
         - Velocity: "Keep a steady tempo throughout the set"
         - Eccentric: "Focus on a controlled 2-second lowering phase"
         - Smoothness: "Avoid jerky movements -- smooth and steady wins"

    4. Place the QualityStatsSection after the existing metrics section in SetSummaryCard, before the RPE section.
       Only render when `summary.qualitySummary != null` (already tier-gated from Task 1).
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` builds successfully.
  </verify>
  <done>SetSummaryCard shows quality stats with sparkline, swipeable radar chart, trend indicator, and improvement tip for weakest component. Only visible for Phoenix+ tier users.</done>
</task>

<task type="auto">
  <name>Task 3: Define Form Master badges for quality achievements</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Gamification.kt
  </files>
  <action>
    1. Add a new BadgeRequirement subclass for quality streaks:
       ```kotlin
       /** Consecutive sets with quality score above threshold */
       data class QualityStreak(val sets: Int, val minScore: Int) : BadgeRequirement()
       ```

    2. Add "Form Master" to BadgeCategory (or use existing CONSISTENCY category -- use CONSISTENCY since quality streaks are a form of consistency). Per user decision, use existing categories.

    3. Define Form Master badge instances. Per user decision: "Bronze/Silver/Gold based on streak length or quality threshold". Claude's discretion on exact thresholds:
       - FORM_MASTER_BRONZE: QualityStreak(sets=3, minScore=85) -- 3 consecutive sets above 85
       - FORM_MASTER_SILVER: QualityStreak(sets=5, minScore=85) -- 5 consecutive sets above 85
       - FORM_MASTER_GOLD: QualityStreak(sets=10, minScore=90) -- 10 consecutive sets above 90

    4. Add getProgressDescription and getTargetValue handling for QualityStreak in Badge class:
       - getProgressDescription: "$currentValue/${req.sets} sets (>${req.minScore})"
       - getTargetValue: req.sets

    5. Create a companion object or top-level val holding the Form Master badges list. Follow whatever pattern the existing badge definitions use (check if there's a BadgeRegistry or similar).

    6. Per GATE-02 and user decision: badges are "visible only to Phoenix+ tier users". The gating will be enforced at the UI layer (badge display checks FeatureGate), not in the model definitions.
  </action>
  <verify>
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles.
    `./gradlew :shared:testDebugUnitTest` passes.
  </verify>
  <done>Form Master badges (Bronze/Silver/Gold) defined with QualityStreak requirement. Badge visibility gated at UI layer.</done>
</task>

<task type="auto">
  <name>Task 4: Wire Form Master badge earning and celebration into GamificationManager</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/GamificationManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt
  </files>
  <action>
    Per user decision: "Announcement: full-screen celebration overlay (like PR achievements)". Badge earning
    logic MUST be implemented, not deferred, so that earning a Form Master badge triggers the existing
    BadgeCelebrationDialog/BatchedBadgeCelebrationDialog celebration flow.

    1. Add quality streak tracking state to GamificationManager:
       - `private var consecutiveQualitySets: Int = 0` -- tracks current streak of sets with average quality >= threshold
       - `fun resetQualityStreak()` -- called when a set breaks the streak (average quality below threshold)

    2. Add a new method to GamificationManager:
       ```kotlin
       suspend fun processSetQualityEvent(averageSetQuality: Int) {
           // Update streak: if averageSetQuality >= 85 (the minimum Form Master threshold), increment
           // Otherwise, reset streak to 0
           if (averageSetQuality >= 85) {
               consecutiveQualitySets++
           } else {
               consecutiveQualitySets = 0
               return // No badge check needed if streak broken
           }

           // Check Form Master badge criteria against current streak
           // Use gamificationRepository to check if each Form Master badge is already earned
           // If streak meets a badge's QualityStreak.sets requirement and badge not yet earned, award it
           // Emit earned badges via _badgeEarnedEvents (same flow as existing badges)
       }
       ```

    3. Wire the call site: In ActiveSessionEngine.handleSetCompletion() (or wherever processPostSaveEvents
       is called), AFTER capturing the SetQualitySummary, call:
       ```kotlin
       gamificationManager.processSetQualityEvent(qualitySummary.averageScore)
       ```
       Only call if qualitySummary is non-null (i.e., quality scoring was active / Phoenix+ tier).

    4. In GamificationRepository (or wherever badge checking happens), add support for the QualityStreak
       BadgeRequirement type in the `checkAndAwardBadges()` method. The existing pattern likely uses a
       when-branch on BadgeRequirement subtype -- add the QualityStreak branch that compares against the
       streak count passed in or stored. If the repository uses a different pattern (e.g., stats-based),
       adapt accordingly -- check how existing badges like StreakDays are evaluated.

    5. The existing celebration UI already handles this: GamificationManager emits to `_badgeEarnedEvents`,
       which is collected by MainViewModel, which shows BadgeCelebrationDialog/BatchedBadgeCelebrationDialog.
       Verify this flow exists by checking MainViewModel for `badgeEarnedEvents` collection. The existing
       BadgeCelebrationDialog already renders any Badge with its tier color, icon, and full-screen overlay.
       No new celebration UI needed -- Form Master badges will use the same dialog.

    6. Ensure the quality streak counter persists across the workout session but resets when starting a new
       workout (or keep it session-scoped if that matches the user decision of "3 consecutive sets"). If the
       user decision means "3 consecutive sets within a single workout", reset in startWorkout(). If it means
       "across workouts", persist via GamificationRepository. Default to within-session (simpler, and "consecutive
       sets" most naturally means within a workout).
  </action>
  <verify>
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles.
    `./gradlew :shared:testDebugUnitTest` passes.
    `./gradlew :androidApp:assembleDebug` builds successfully.
    Verify: GamificationManager has processSetQualityEvent method. Quality streak tracking is wired.
    Verify: BadgeCelebrationDialog flow handles Form Master badges (grep for badgeEarnedEvents collection in MainViewModel).
  </verify>
  <done>Form Master badges are earned when quality streak criteria are met during a workout. Earning triggers the existing full-screen BadgeCelebrationDialog celebration overlay (per user decision). Streak is session-scoped and resets on new workout.</done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` compiles without errors
- `./gradlew :shared:testDebugUnitTest` -- all tests pass
- SetSummary carries qualitySummary when scorer was active
- SetSummaryCard renders quality section with sparkline, radar chart, trend, and improvement tip
- Form Master badges defined with Bronze/Silver/Gold tiers
- Form Master badge earning wired into GamificationManager via processSetQualityEvent
- Earning a badge emits through badgeEarnedEvents and triggers BadgeCelebrationDialog
</verification>

<success_criteria>
- Set summary displays average, best, worst quality scores and trend indicator
- Sparkline renders per-rep quality curve
- Radar chart shows component balance (accessible via swipe)
- Weakest component gets improvement tip
- Form Master badges defined with quality streak requirements
- Badge earning logic fires when 3+ consecutive sets above 85 quality
- Full-screen celebration overlay appears when badge is earned (using existing BadgeCelebrationDialog)
- No regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-rep-quality-scoring/03-03-SUMMARY.md`
</output>

---
phase: 03-rep-quality-scoring
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
autonomous: true

must_haves:
  truths:
    - "Per-rep quality score displays on the workout HUD after each rep is counted"
    - "Score display uses gradient color (red-yellow-green) and flashes briefly (0.5-1s)"
    - "Excellent reps (95+) get a subtle sparkle/pulse animation"
    - "Quality score is only visible to Phoenix+ tier users"
    - "Free tier users see no quality score indicator"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt"
      provides: "RepQualityScorer instance, latestRepQuality StateFlow"
      contains: "repQualityScorer"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt"
      provides: "Scorer invocation after each rep notification"
      contains: "scoreRep"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt"
      provides: "RepQualityIndicator composable showing score with color gradient"
      contains: "RepQualityIndicator"
  key_links:
    - from: "ActiveSessionEngine.handleRepNotification"
      to: "RepQualityScorer.scoreRep"
      via: "Called after rep counter processes notification, score stored in coordinator"
      pattern: "repQualityScorer.*scoreRep"
    - from: "WorkoutTab"
      to: "WorkoutCoordinator.latestRepQuality"
      via: "StateFlow collected by WorkoutTab for HUD display"
      pattern: "latestRepQuality"
    - from: "WorkoutTab"
      to: "FeatureGate.isEnabled(REP_QUALITY_SCORE)"
      via: "Gating check before rendering quality indicator"
      pattern: "FeatureGate.*REP_QUALITY_SCORE"
---

<objective>
Wire RepQualityScorer into the workout flow and display per-rep quality scores on the workout HUD with color-coded flash animation and tier gating.

Purpose: Users see real-time quality feedback during workouts, motivating consistent form.
Output: Quality score visible on HUD after each rep for Phoenix+ users.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-rep-quality-scoring/03-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Models.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire RepQualityScorer into workout flow</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/ActiveSessionEngine.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutUiState.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  </files>
  <action>
    1. WorkoutCoordinator: Add `val repQualityScorer = RepQualityScorer()`. Add `internal val _latestRepQuality = MutableStateFlow<RepQualityScore?>(null)` and public `val latestRepQuality: StateFlow<RepQualityScore?> = _latestRepQuality.asStateFlow()`. Import RepQualityScore from domain.model.RepQuality.

    2. ActiveSessionEngine.handleRepNotification(): After the existing `coordinator._repCount.value = repCounter.getRepCount()` line, add scoring logic:
       - Build a RepMetricData from the current rep's data. Since full per-rep metric data may not be available at notification time (it's accumulated during the rep), use a simplified approach: create a RepMetricData using the available summary data from the current metrics collection. Specifically:
         - Get the rep count from repCounter.getRepCount()
         - Use coordinator.collectedMetrics to compute ROM (max position - min position), velocity stats, and phase durations for the current rep window
         - Call `coordinator.repQualityScorer.scoreRep(repData)` and store result in `coordinator._latestRepQuality.value`
       - IMPORTANT: Only score if the rep counter actually incremented (compare before/after rep count). This avoids double-scoring.
       - Note: The scoring uses RepMetricData which has rangeOfMotionMm, avgVelocityConcentric, concentricDurationMs, eccentricDurationMs, concentricVelocities. For the HUD display, approximate values from collected WorkoutMetrics are sufficient. Perfect accuracy comes from the persisted RepMetric data.

    3. ActiveSessionEngine.handleSetCompletion(): Before calculating the set summary, call `coordinator.repQualityScorer.reset()` and clear `coordinator._latestRepQuality.value = null`. This ensures a fresh scorer for the next set.

    4. ActiveSessionEngine: In the startWorkout flow (where repCounter.reset() is called), also reset the quality scorer: `coordinator.repQualityScorer.reset()` and `coordinator._latestRepQuality.value = null`.

    5. WorkoutUiState: Add `val latestRepQualityScore: Int? = null` field. This is the simplified score value passed to the UI.

    6. MainViewModel (or wherever WorkoutUiState is assembled): Map `coordinator.latestRepQuality` into `WorkoutUiState.latestRepQualityScore`. Check FeatureGate.isEnabled(Feature.REP_QUALITY_SCORE, currentTier) before exposing the score -- if not enabled, pass null.
  </action>
  <verify>
    `./gradlew :shared:compileCommonMainKotlinMetadata` compiles cleanly.
    `./gradlew :androidApp:assembleDebug` builds successfully.
  </verify>
  <done>RepQualityScorer is instantiated in WorkoutCoordinator, invoked on each rep in ActiveSessionEngine, reset on set completion and workout start, and score flows through to WorkoutUiState gated by FeatureGate.</done>
</task>

<task type="auto">
  <name>Task 2: Add RepQualityIndicator to workout HUD</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/WorkoutTab.kt
  </files>
  <action>
    Create a `RepQualityIndicator` composable within WorkoutTab.kt (or a new file in presentation/components/ if WorkoutTab is already very large -- check file size first):

    1. RepQualityIndicator composable:
       - Parameters: score (Int), visible (Boolean), onDismiss (() -> Unit)
       - Renders a centered, prominent score number (e.g., "87") with large font (32-40sp)
       - Color gradient based on score:
         - 0-39: Red (Color(0xFFE53935))
         - 40-59: Orange (Color(0xFFFF9800))
         - 60-79: Yellow (Color(0xFFFDD835))
         - 80-94: Green (Color(0xFF43A047))
         - 95-100: Bright green (Color(0xFF00E676)) with subtle pulse animation
       - AnimatedVisibility with fadeIn/fadeOut transition
       - Auto-dismiss after 800ms using LaunchedEffect(score) { delay(800); onDismiss() }
       - For 95+ scores: Add a subtle scale pulse animation (1.0 -> 1.15 -> 1.0 over 400ms) using animateFloatAsState
       - Background: semi-transparent dark pill shape behind the score for readability
       - Position: Overlay on top of the workout metrics area, centered horizontally

    2. In WorkoutTab's Active state rendering section, add the RepQualityIndicator:
       - Track visibility with `var showQualityScore by remember { mutableStateOf(false) }` and `var displayedScore by remember { mutableIntStateOf(0) }`
       - Use LaunchedEffect(latestRepQualityScore) to trigger: when score changes from null to non-null, set displayedScore and showQualityScore = true
       - Only render if score is non-null (already gated by FeatureGate in Task 1)
       - Place in a Box overlay above the existing workout metrics

    3. Per user decision: "center-prominent display", "quick flash timing (0.5-1s)", "gradient color scale", "subtle sparkle/pulse for 95+". All honored above.
  </action>
  <verify>
    `./gradlew :androidApp:assembleDebug` builds successfully.
    Manual verification: quality indicator renders during workout (requires hardware or mock -- will verify in Plan 03 checkpoint).
  </verify>
  <done>RepQualityIndicator composable shows score with color gradient after each rep, auto-dismisses after 800ms, pulses for excellent reps (95+), and is gated to Phoenix+ users.</done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` compiles without errors
- `./gradlew :shared:testDebugUnitTest` -- all existing tests pass (no regressions)
- RepQualityScorer is wired: constructed in WorkoutCoordinator, called in handleRepNotification, reset in handleSetCompletion
- FeatureGate check prevents Free tier from seeing scores
</verification>

<success_criteria>
- Per-rep quality score flows from ActiveSessionEngine through WorkoutCoordinator to WorkoutTab
- Quality indicator renders with color gradient and auto-dismiss
- Excellent reps (95+) show pulse animation
- Free tier users see no quality indicator
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-rep-quality-scoring/03-02-SUMMARY.md`
</output>

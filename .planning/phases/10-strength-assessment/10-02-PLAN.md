---
phase: 10-strength-assessment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/AssessmentRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightAssessmentRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavigationRoutes.kt
autonomous: true

must_haves:
  truths:
    - "Assessment results can be saved to and retrieved from the database"
    - "Assessment sessions are stored as WorkoutSession with routineName = __ASSESSMENT__"
    - "Saving an assessment updates the exercise's oneRepMaxKg field"
    - "Navigation route for assessment wizard is registered"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/AssessmentRepository.kt"
      provides: "Interface for assessment CRUD operations"
      min_lines: 20
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightAssessmentRepository.kt"
      provides: "SQLDelight implementation using existing AssessmentResult queries"
      exports: ["SqlDelightAssessmentRepository"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt"
      provides: "Koin registration for AssessmentRepository"
      contains: "AssessmentRepository"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavigationRoutes.kt"
      provides: "StrengthAssessment route"
      contains: "StrengthAssessment"
  key_links:
    - from: "SqlDelightAssessmentRepository"
      to: "VitruvianDatabase"
      via: "db.vitruvianDatabaseQueries"
      pattern: "insertAssessmentResult|selectAssessmentsByExercise"
    - from: "SqlDelightAssessmentRepository"
      to: "ExerciseRepository"
      via: "updateOneRepMax call"
      pattern: "updateOneRepMax"
    - from: "SqlDelightAssessmentRepository"
      to: "WorkoutRepository"
      via: "saveSession call"
      pattern: "saveSession"
---

<objective>
Create the assessment repository layer and register navigation route for the assessment wizard.

Purpose: Bridge between the domain assessment engine (Plan 01) and the database. Handles persisting assessment results to the AssessmentResult table (created in Phase 9), creating assessment WorkoutSessions with the `__ASSESSMENT__` marker, and updating Exercise.oneRepMaxKg. Also registers the navigation route so Plan 03 can build the UI.

Output: Working repository with DI registration and navigation route.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/ExerciseRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/WorkoutRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightExerciseRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavigationRoutes.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssessmentRepository interface and SQLDelight implementation</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/AssessmentRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightAssessmentRepository.kt
  </files>
  <action>
    Create AssessmentRepository.kt interface with these methods:
    - suspend fun saveAssessment(exerciseId: String, estimatedOneRepMaxKg: Float, loadVelocityDataJson: String, sessionId: String?, userOverrideKg: Float? = null): Long
    - fun getAssessmentsByExercise(exerciseId: String): Flow<List<AssessmentResultEntity>>
    - suspend fun getLatestAssessment(exerciseId: String): AssessmentResultEntity?
    - suspend fun deleteAssessment(id: Long)
    - suspend fun saveAssessmentSession(exerciseId: String, exerciseName: String, estimatedOneRepMaxKg: Float, loadVelocityDataJson: String, userOverrideKg: Float?, totalReps: Int, durationMs: Long, weightPerCableKg: Float): String (returns session ID)

    Define data class AssessmentResultEntity(id: Long, exerciseId: String, estimatedOneRepMaxKg: Float, loadVelocityData: String, assessmentSessionId: String?, userOverrideKg: Float?, createdAt: Long) in the same file.

    Create SqlDelightAssessmentRepository.kt implementing AssessmentRepository:
    - Constructor takes VitruvianDatabase, WorkoutRepository, and ExerciseRepository
    - Use db.vitruvianDatabaseQueries for AssessmentResult CRUD (queries already exist: insertAssessmentResult, selectAssessmentsByExercise, selectLatestAssessment, deleteAssessmentResult)
    - saveAssessmentSession creates a WorkoutSession with:
      - routineName = "__ASSESSMENT__"
      - mode = "OldSchool" (assessment uses standard concentric/eccentric)
      - exerciseId and exerciseName from params
      - Other fields from params (totalReps, duration, weightPerCableKg)
      Then calls workoutRepository.saveSession(), then insertAssessmentResult with the session ID, then exerciseRepository.updateOneRepMax() with the final 1RM (userOverrideKg if non-null, else estimatedOneRepMaxKg).
      Returns the session ID.
    - Map database results using a mapper lambda matching the AssessmentResult table columns (id, exerciseId, estimatedOneRepMaxKg, loadVelocityData, assessmentSessionId, userOverrideKg, createdAt)
    - Use Dispatchers.IO for database operations (match SqlDelightExerciseRepository pattern)
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>AssessmentRepository interface exists with CRUD methods. SqlDelightAssessmentRepository implements it using existing SQLDelight queries. saveAssessmentSession creates a WorkoutSession with __ASSESSMENT__ marker and updates exercise 1RM.</done>
</task>

<task type="auto">
  <name>Task 2: Register AssessmentRepository in Koin and add navigation route</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/navigation/NavigationRoutes.kt
  </files>
  <action>
    In DataModule.kt:
    - Add import for SqlDelightAssessmentRepository and AssessmentRepository
    - Add Koin binding: single<AssessmentRepository> { SqlDelightAssessmentRepository(get(), get(), get()) }
    - The three get() resolve to VitruvianDatabase, WorkoutRepository, ExerciseRepository (all already registered)

    In NavigationRoutes.kt:
    - Add new route object: object StrengthAssessment : NavigationRoutes("strength_assessment/{exerciseId}") { fun createRoute(exerciseId: String) = "strength_assessment/$exerciseId" }
    - Also add a no-arg variant for launching without pre-selected exercise: object StrengthAssessmentPicker : NavigationRoutes("strength_assessment_picker")
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>AssessmentRepository is available via Koin DI. StrengthAssessment and StrengthAssessmentPicker navigation routes are registered in NavigationRoutes.</done>
</task>

</tasks>

<verification>
- `./gradlew :shared:compileKotlinAndroid` passes
- AssessmentRepository interface has saveAssessment, getAssessmentsByExercise, getLatestAssessment, deleteAssessment, saveAssessmentSession methods
- SqlDelightAssessmentRepository uses existing SQLDelight queries (no schema changes needed)
- DataModule.kt has AssessmentRepository Koin binding
- NavigationRoutes.kt has StrengthAssessment and StrengthAssessmentPicker routes
</verification>

<success_criteria>
- Assessment results can be persisted via repository using existing AssessmentResult table queries
- Assessment session creation produces WorkoutSession with routineName = "__ASSESSMENT__"
- Exercise 1RM is updated when assessment is saved
- Navigation routes are registered for use by Plan 03
- Full Android compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-strength-assessment/10-02-SUMMARY.md`
</output>

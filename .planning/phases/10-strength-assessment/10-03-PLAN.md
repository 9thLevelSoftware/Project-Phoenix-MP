---
phase: 10-strength-assessment
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/AssessmentViewModel.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/AssessmentWizardScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
autonomous: true

must_haves:
  truths:
    - "User can select an exercise to assess from a list"
    - "User sees video demonstration and text instructions before starting"
    - "User records 3-5 progressive-weight sets with real-time velocity display"
    - "System identifies when velocity drops below threshold and suggests stopping"
    - "User sees estimated 1RM and can accept or enter manual override"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/AssessmentViewModel.kt"
      provides: "State management for multi-step assessment wizard"
      exports: ["AssessmentViewModel"]
      min_lines: 120
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/AssessmentWizardScreen.kt"
      provides: "Multi-step assessment UI (exercise picker, instruction, loading, results)"
      min_lines: 200
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt"
      provides: "Koin registration for AssessmentViewModel"
      contains: "AssessmentViewModel"
  key_links:
    - from: "AssessmentViewModel"
      to: "AssessmentEngine"
      via: "estimateOneRepMax call"
      pattern: "estimateOneRepMax|shouldStopAssessment|suggestNextWeight"
    - from: "AssessmentViewModel"
      to: "AssessmentRepository"
      via: "saveAssessmentSession call"
      pattern: "saveAssessmentSession"
    - from: "AssessmentViewModel"
      to: "ExerciseRepository"
      via: "getVideos, getAllExercises"
      pattern: "getVideos|getAllExercises"
    - from: "AssessmentWizardScreen"
      to: "AssessmentViewModel"
      via: "collectAsState"
      pattern: "viewModel\\."
---

<objective>
Build the assessment wizard ViewModel and multi-step UI screen for the guided strength assessment flow.

Purpose: This is the user-facing assessment experience. A multi-step wizard guides the user through exercise selection, video instruction, progressive-weight sets with velocity feedback, and results presentation with accept/override capability.

Output: Complete assessment wizard screen with ViewModel wired to the domain engine and repository.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-strength-assessment/10-01-SUMMARY.md
@.planning/phases/10-strength-assessment/10-02-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/OneRepMaxInputScreen.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/ExerciseLibraryViewModel.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/VideoPlayer.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/JustLiftScreen.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/assessment/AssessmentEngine.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/assessment/AssessmentModels.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/AssessmentRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssessmentViewModel with multi-step wizard state management</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/AssessmentViewModel.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/PresentationModule.kt
  </files>
  <action>
    Create AssessmentViewModel extending ViewModel with these dependencies (injected via constructor):
    - exerciseRepository: ExerciseRepository
    - assessmentRepository: AssessmentRepository
    - assessmentEngine: AssessmentEngine

    Define sealed class AssessmentStep:
    - ExerciseSelection (list of exercises, search query)
    - Instruction (selected exercise, video URLs from exerciseRepository.getVideos())
    - ProgressiveLoading (current set number, suggested weight, recorded sets list, latest velocity, should-stop flag)
    - Results (estimated 1RM, R-squared, load-velocity points, override field value)
    - Saving (in-progress indicator)
    - Complete (final 1RM value, exercise name)

    State flows:
    - _currentStep: MutableStateFlow<AssessmentStep> (starts at ExerciseSelection)
    - _exercises: StateFlow<List<Exercise>> from exerciseRepository.getAllExercises()
    - selectedExercise: Exercise? (set when user picks one)

    Methods:
    - selectExercise(exercise: Exercise): Loads videos via exerciseRepository.getVideos(), transitions to Instruction step. If no videos found, skip to ProgressiveLoading.
    - startAssessment(): Transitions from Instruction to ProgressiveLoading with initial suggested weight (use suggestNextWeight starting from exercise's existing oneRepMaxKg * 0.4, or 20kg if no 1RM set, with velocity 1.2 m/s to get a reasonable first jump)
    - recordSet(loadKg: Float, reps: Int, meanVelocityMs: Float, peakVelocityMs: Float): Adds AssessmentSetResult to recorded sets list, calls shouldStopAssessment(meanVelocityMs). If should stop OR 5 sets recorded, call estimateOneRepMax and transition to Results. Otherwise update suggested weight via suggestNextWeight and stay on ProgressiveLoading.
    - acceptResult(overrideKg: Float? = null): Transitions to Saving, calls assessmentRepository.saveAssessmentSession() with all collected data. On success transitions to Complete. The override value (if non-null and > 0) replaces the estimated 1RM for the exercise record.
    - reset(): Returns to ExerciseSelection step.

    IMPORTANT: The recordSet method is called AFTER the user completes a set on the actual machine. The UI for this step shows: current set number, suggested weight to load, and after completing a set the user enters the actual weight used and the mean velocity displayed during the set. This is NOT a simulated workout - the user physically performs reps on the Vitruvian machine and then logs the results.

    In PresentationModule.kt:
    - Add: viewModel { AssessmentViewModel(get(), get(), get()) }
    - Add import for AssessmentViewModel
    - Also add: single { AssessmentEngine() } in DomainModule.kt (or keep it as factory in PresentationModule - check which is more appropriate given it's stateless)

    Actually, AssessmentEngine is stateless so register it as single in DomainModule.kt:
    - In shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt add: single { AssessmentEngine() }
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>AssessmentViewModel manages multi-step wizard state (ExerciseSelection -> Instruction -> ProgressiveLoading -> Results -> Saving -> Complete). AssessmentEngine registered in DomainModule. AssessmentViewModel registered in PresentationModule.</done>
</task>

<task type="auto">
  <name>Task 2: Create AssessmentWizardScreen with all wizard steps</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/AssessmentWizardScreen.kt
  </files>
  <action>
    Create AssessmentWizardScreen composable that renders the current wizard step from AssessmentViewModel.

    Screen structure (single composable that switches content based on currentStep):

    1. ExerciseSelection step:
       - Title: "Strength Assessment"
       - Subtitle: "Select an exercise to test your 1RM"
       - Search field (filters exercises by name)
       - LazyColumn of exercises, each as a Card showing name + muscle group
       - Tap exercise -> viewModel.selectExercise(exercise)
       - Follow ExercisesTab pattern for list rendering

    2. Instruction step:
       - Title: exercise.displayName
       - If videos available: Show video thumbnail/player using existing VideoPlayer component (tutorial video preferred, else first available)
       - Text instructions card:
         "You will perform 3-5 sets at progressively heavier weights."
         "Perform 3 reps per set with maximum intent on the concentric (lifting) phase."
         "The system will track your velocity to estimate your one-rep max."
         "Start light (~40% of estimated max) and increase weight each set."
       - "Begin Assessment" primary button -> viewModel.startAssessment()
       - "Back" text button -> viewModel.reset()

    3. ProgressiveLoading step:
       - Top: Step indicator "Set {n} of up to 5"
       - Card showing: "Suggested Weight: {suggestedWeight} kg" (large text, prominent)
       - If recorded sets exist: List of completed sets showing set#, weight, velocity with color coding:
         - Green: velocity > 0.8 m/s (light)
         - Yellow: velocity 0.5-0.8 m/s (moderate)
         - Orange: velocity 0.3-0.5 m/s (heavy)
         - Red: velocity < 0.3 m/s (at/past threshold)
       - If shouldStop flag is true: Warning banner "Velocity threshold reached - assessment complete"
       - Input section (shown when not shouldStop):
         - "Actual Weight Used (kg)" OutlinedTextField with number keyboard
         - "Mean Velocity (m/s)" OutlinedTextField with decimal keyboard (pre-populated if BLE data available, but user can override)
         - "Log Set" button -> viewModel.recordSet(weight, 3, velocity, velocity)
       - If shouldStop: "View Results" button -> automatic transition already handled by ViewModel
       - "Cancel Assessment" text button

    4. Results step:
       - Title: "Assessment Complete"
       - Large display: "Estimated 1RM: {value} kg" with prominent styling
       - Regression quality indicator: if R^2 > 0.9 show "High confidence", 0.7-0.9 "Moderate confidence", <0.7 "Low confidence - consider retesting"
       - Load-velocity scatter display: Simple list showing each data point (weight -> velocity) since Canvas scatter plot would be too complex for this plan
       - "Override 1RM" section: OutlinedTextField allowing manual entry with helper text "Enter your own estimate if you disagree"
       - "Accept & Save" primary button -> viewModel.acceptResult(overrideValue)
       - "Discard" outlined button -> viewModel.reset()

    5. Saving step:
       - CircularProgressIndicator with "Saving assessment..." text

    6. Complete step:
       - Success icon (checkmark)
       - "1RM Updated!" title
       - "{exerciseName}: {finalValue} kg" subtitle
       - "Done" button -> navigate back (onNavigateBack callback)

    Use Material3 components throughout. Follow existing screen patterns:
    - MaterialTheme.colorScheme for colors
    - Spacing object for padding
    - RoundedCornerShape for cards
    - screenBackgroundBrush for background (from ThemeMode)

    The composable signature: AssessmentWizardScreen(viewModel: AssessmentViewModel, exerciseId: String? = null, themeMode: ThemeMode, onNavigateBack: () -> Unit)
    - If exerciseId is provided, auto-select that exercise on launch via LaunchedEffect
  </action>
  <verify>File compiles: `./gradlew :shared:compileKotlinAndroid 2>&1 | tail -5` shows BUILD SUCCESSFUL</verify>
  <done>AssessmentWizardScreen renders all 6 wizard steps. Exercise selection shows searchable list. Instruction step shows video and text. ProgressiveLoading captures set data with velocity color coding. Results shows 1RM with confidence and override option. Complete confirms save.</done>
</task>

</tasks>

<verification>
- `./gradlew :shared:compileKotlinAndroid` passes
- AssessmentViewModel has all 6 step states and transition methods
- AssessmentWizardScreen renders content for each step
- ViewModel is wired to AssessmentEngine for 1RM calculation
- ViewModel is wired to AssessmentRepository for persistence
- DI registrations are correct (DomainModule for engine, PresentationModule for ViewModel)
</verification>

<success_criteria>
- Multi-step wizard UI compiles and renders all steps
- Exercise selection filters and selects exercises
- Instruction step shows video (when available) and text guidance
- Progressive loading step captures weight and velocity per set with visual feedback
- Results step displays estimated 1RM with confidence and allows override
- Save flow persists assessment and updates exercise 1RM
- Full Android compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/10-strength-assessment/10-03-SUMMARY.md`
</output>

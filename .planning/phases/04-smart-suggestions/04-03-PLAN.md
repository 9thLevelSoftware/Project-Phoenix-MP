---
phase: 04-smart-suggestions
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/InsightsTab.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/MainScreen.kt
autonomous: false
must_haves:
  truths:
    - "App shows weekly volume breakdown per muscle group (sets, reps, total kg)"
    - "Push/pull/legs balance analysis surfaces imbalances with corrective suggestions"
    - "User receives prompts for neglected exercises (>14 days) and stalled exercises (plateau detection)"
    - "Time-of-day analysis is available for Elite tier users showing optimal training windows"
    - "All smart suggestion features are hidden from non-Elite users"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/InsightsTab.kt"
      provides: "Smart Suggestions UI with all 5 insight sections"
      min_lines: 150
  key_links:
    - from: "InsightsTab.kt"
      to: "SmartSuggestionsEngine"
      via: "direct function calls with repository data"
      pattern: "SmartSuggestionsEngine\\.compute"
    - from: "InsightsTab.kt"
      to: "SubscriptionManager.hasEliteAccess"
      via: "collectAsState for gating"
      pattern: "hasEliteAccess.*collectAsState"
    - from: "InsightsTab.kt"
      to: "SmartSuggestionsRepository"
      via: "koinInject for data loading"
      pattern: "koinInject.*SmartSuggestionsRepository"
---

<objective>
Build the Smart Suggestions UI as an InsightsTab composable, wiring the SmartSuggestionsEngine to real data via SmartSuggestionsRepository, gated behind Elite tier subscription.

Purpose: Deliver actionable training insights to Elite users -- the final user-facing feature of the v0.4.5 milestone.
Output: InsightsTab with 5 insight cards + Elite gating + navigation integration.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-smart-suggestions/04-01-SUMMARY.md
@.planning/phases/04-smart-suggestions/04-02-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/PremiumFeatureGate.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/HistoryTab.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InsightsTab with all 5 suggestion sections</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/InsightsTab.kt
  </files>
  <action>
    Create InsightsTab.kt as a new Compose screen with the following structure:

    1. **Elite Gating (SUGG-06 / GATE-03):**
       - Inject SubscriptionManager via koinInject
       - Collect `hasEliteAccess` as state
       - If not Elite, show `PremiumFeatureGate` composable (already exists) with featureName="Smart Insights" and featureDescription="Unlock with Elite tier to get personalized training insights". Modify the gate text to say "Upgrade to Elite" instead of "Upgrade to Pro".
       - NOTE: Since PremiumFeatureGate uses `hasProAccess`, create a local wrapper or pass a custom check. Simplest approach: wrap the entire tab content in `if (hasEliteAccess) { ... } else { LockedFeatureOverlay(...) }` using the existing LockedFeatureOverlay composable directly.

    2. **Data Loading:**
       - Inject SmartSuggestionsRepository via koinInject
       - In LaunchedEffect(Unit), load:
         - sessionSummaries = repository.getSessionSummariesSince(nowMs - 28 days) // 4 weeks for balance
         - exerciseLastPerformed = repository.getExerciseLastPerformed()
         - weightHistory = repository.getExerciseWeightHistory()
       - Store in remember { mutableStateOf } variables
       - Show a simple loading indicator while data loads

    3. **Layout:** LazyColumn with 5 card sections:

       **Section A - Weekly Volume (SUGG-01):**
       - Call SmartSuggestionsEngine.computeWeeklyVolume(sessions, nowMs)
       - Card with title "This Week's Volume"
       - List each MuscleGroupVolume as a row: muscle group name | sets | reps | total kg
       - Use a simple table-like layout with Rows
       - If empty, show "No workouts this week" placeholder

       **Section B - Balance Analysis (SUGG-02):**
       - Call SmartSuggestionsEngine.analyzeBalance(sessions, nowMs)
       - Card with title "Training Balance"
       - Show 3 horizontal progress bars for Push/Pull/Legs with percentage labels
       - Below bars, list any BalanceImbalance items as warning-styled text
       - If no imbalances, show "Your training is well-balanced" in green

       **Section C - Neglected Exercises (SUGG-03):**
       - Call SmartSuggestionsEngine.findNeglectedExercises(exerciseLastPerformed, nowMs)
       - Card with title "Exercise Variety"
       - List top 5 neglected exercises: name, muscle group, "X days ago" label
       - Use orange/warning color for >30 days, yellow for >14 days
       - If none neglected, show "Great variety! All exercises performed recently."

       **Section D - Plateau Detection (SUGG-04):**
       - Call SmartSuggestionsEngine.detectPlateaus(weightHistory)
       - Card with title "Plateau Alert"
       - List plateaued exercises with current weight and suggestion text
       - Use an info icon + suggestion text per plateau
       - If no plateaus, show "No plateaus detected. Keep progressing!"

       **Section E - Optimal Training Time (SUGG-05):**
       - Call SmartSuggestionsEngine.analyzeTimeOfDay(sessions)
       - Card with title "Best Training Window"
       - Show the optimal window prominently (e.g., "You perform best in the MORNING")
       - Below, show session counts per window as a simple bar chart (Compose Canvas or just horizontal bars)
       - If not enough data, show "Train more to unlock time insights (need 10+ sessions)"

    4. **Styling:**
       - Follow existing card patterns from HistoryTab (Card with Modifier.fillMaxWidth().padding(horizontal = 16.dp))
       - Use MaterialTheme.colorScheme for all colors
       - Section titles as Text with titleMedium style
       - Content text as bodyMedium
       - Spacing: 12dp between sections, 8dp internal padding
  </action>
  <verify>
    `./gradlew :shared:compileDebugKotlinAndroid` succeeds.
  </verify>
  <done>
    - InsightsTab.kt created with all 5 suggestion sections
    - Elite tier gating wraps entire tab (non-Elite sees LockedFeatureOverlay)
    - Data loads from SmartSuggestionsRepository and feeds SmartSuggestionsEngine
    - Compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate InsightsTab into MainScreen navigation</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/MainScreen.kt
  </files>
  <action>
    Add InsightsTab as a new tab in the main navigation. Look at how the existing tabs (Workout, History, Exercises, Settings) are structured in MainScreen.kt.

    1. Add a new navigation item for Insights:
       - Icon: Icons.Default.Lightbulb (or Icons.Default.TipsAndUpdates if available, otherwise AutoAwesome or Stars)
       - Label: "Insights"
       - Position: After Exercises tab, before Settings tab

    2. Add the InsightsTab composable to the when/navigation block that renders tab content.

    3. Keep it simple -- the InsightsTab handles its own data loading and gating internally.

    Important: Check the exact navigation pattern used (BottomNavigation with NavController, or simple tab index). Match the existing pattern exactly. Do NOT change the navigation architecture.
  </action>
  <verify>
    `./gradlew :shared:compileDebugKotlinAndroid` succeeds.
    `./gradlew :androidApp:assembleDebug` succeeds (full app builds).
  </verify>
  <done>
    - Insights tab appears in bottom navigation between Exercises and Settings
    - Tapping Insights tab shows InsightsTab composable
    - Full Android app builds without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Smart Suggestions feature: InsightsTab with 5 insight sections (weekly volume, balance analysis, neglected exercises, plateau detection, time-of-day), gated to Elite tier, integrated into main navigation.
  </what-built>
  <how-to-verify>
    1. Build and install: `./gradlew :androidApp:installDebug`
    2. Open app -- verify new "Insights" tab appears in bottom navigation
    3. Tap Insights tab:
       - If FREE tier: Should show locked overlay with "Upgrade to Elite" messaging
       - If Elite tier (set subscription_status to "elite" in DB): Should show all 5 insight sections
    4. With workout history data, verify:
       - Weekly Volume section shows muscle group breakdown
       - Balance section shows push/pull/legs bars
       - Neglected exercises appear if any are >14 days stale
       - Plateau alerts appear if applicable
       - Time-of-day section shows training window analysis
    5. Verify no crashes when workout history is empty
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
```bash
./gradlew :shared:compileDebugKotlinAndroid
./gradlew :androidApp:assembleDebug
./gradlew :shared:testDebugUnitTest
```
All pass. No regressions.
</verification>

<success_criteria>
- InsightsTab shows all 5 suggestion types with real data from repository
- Non-Elite users see locked overlay (SUGG-06 / GATE-03)
- Elite users see all insights
- Insights tab accessible from main navigation
- App builds and runs without crashes
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-suggestions/04-03-SUMMARY.md`
</output>

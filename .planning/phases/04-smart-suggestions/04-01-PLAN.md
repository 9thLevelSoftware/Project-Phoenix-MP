---
phase: 04-smart-suggestions
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/SmartSuggestions.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngineTest.kt
autonomous: true
must_haves:
  truths:
    - "Engine computes weekly volume per muscle group from session data"
    - "Engine classifies muscle groups into Push/Pull/Legs and detects imbalances"
    - "Engine identifies neglected exercises (>14 days since last performed)"
    - "Engine detects plateaued exercises from weight history"
    - "Engine identifies optimal training windows from session timestamps"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/SmartSuggestions.kt"
      provides: "Domain models for all suggestion types"
      contains: "data class WeeklyVolumeReport"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt"
      provides: "Pure computation engine for all 5 suggestion types"
      exports: ["SmartSuggestionsEngine"]
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngineTest.kt"
      provides: "Full test coverage for all suggestion algorithms"
      min_lines: 100
  key_links:
    - from: "SmartSuggestionsEngine"
      to: "SmartSuggestions.kt models"
      via: "function return types"
      pattern: "fun compute.*:.*Report"
---

<objective>
TDD-build the SmartSuggestionsEngine: a pure domain computation engine that takes workout session data and produces five types of training insights (weekly volume, push/pull/legs balance, exercise neglect alerts, plateau detection, and time-of-day analysis).

Purpose: Isolate all suggestion algorithms as pure functions with testable I/O, independent of database or UI.
Output: Tested domain engine + domain models for all suggestion types.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/Exercise.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/WorkoutModels.kt
</context>

<feature>
  <name>SmartSuggestionsEngine - Training Insight Algorithms</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/SmartSuggestions.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngine.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/SmartSuggestionsEngineTest.kt
  </files>
  <behavior>
    **Domain Models (SmartSuggestions.kt):**

    ```kotlin
    // Movement category for push/pull/legs classification
    enum class MovementCategory { PUSH, PULL, LEGS, CORE }

    // Input data for the engine (flattened from DB joins)
    data class SessionSummary(
        val exerciseId: String,
        val exerciseName: String,
        val muscleGroup: String,        // from Exercise table
        val timestamp: Long,            // epoch ms
        val weightPerCableKg: Float,
        val totalReps: Int,
        val workingReps: Int
    )

    // SUGG-01: Volume per muscle group
    data class MuscleGroupVolume(
        val muscleGroup: String,
        val sets: Int,
        val reps: Int,
        val totalKg: Float              // sum of (weightPerCableKg * 2 * workingReps) per session
    )
    data class WeeklyVolumeReport(
        val weekStartTimestamp: Long,
        val volumes: List<MuscleGroupVolume>
    )

    // SUGG-02: Balance analysis
    data class BalanceAnalysis(
        val pushVolume: Float,          // total kg
        val pullVolume: Float,
        val legsVolume: Float,
        val imbalances: List<BalanceImbalance>
    )
    data class BalanceImbalance(
        val category: MovementCategory,
        val ratio: Float,               // e.g. 0.3 when ideal is ~0.33
        val suggestion: String          // e.g. "Add more pull exercises to balance your push:pull ratio"
    )

    // SUGG-03: Neglected exercises
    data class NeglectedExercise(
        val exerciseId: String,
        val exerciseName: String,
        val daysSinceLastPerformed: Int,
        val muscleGroup: String
    )

    // SUGG-04: Plateau detection
    data class PlateauDetection(
        val exerciseId: String,
        val exerciseName: String,
        val currentWeightKg: Float,
        val sessionCount: Int,          // how many sessions at same weight
        val suggestion: String          // e.g. "Try eccentric overload or drop sets"
    )

    // SUGG-05: Time-of-day analysis
    enum class TimeWindow { EARLY_MORNING, MORNING, AFTERNOON, EVENING, NIGHT }
    data class TimeOfDayAnalysis(
        val windowVolumes: Map<TimeWindow, Float>,     // avg volume per session in each window
        val windowCounts: Map<TimeWindow, Int>,        // sessions per window
        val optimalWindow: TimeWindow?,                // best performance window
        val suggestion: String
    )
    ```

    **Engine Methods (SmartSuggestionsEngine.kt):**

    The engine is a stateless object with pure functions. All take List<SessionSummary> as input.

    1. `computeWeeklyVolume(sessions: List<SessionSummary>, nowMs: Long): WeeklyVolumeReport`
       - Filters sessions from current 7-day window (nowMs - 7 days to nowMs)
       - Groups by muscleGroup, sums sets (count of sessions), reps, totalKg
       - totalKg = sum of (weightPerCableKg * 2 * workingReps) for each session

    2. `analyzeBalance(sessions: List<SessionSummary>, nowMs: Long): BalanceAnalysis`
       - Uses classifyMuscleGroup() to map muscleGroup string to MovementCategory
       - Classification: PUSH = Chest, Shoulders, Triceps; PULL = Back, Biceps; LEGS = Legs, Glutes; CORE = Core, Full Body
       - Sums volume (totalKg) per category over last 4 weeks
       - Ideal ratio: ~33% push, ~33% pull, ~33% legs (excluding core)
       - Imbalance threshold: any category < 25% or > 45% of non-core total triggers suggestion

    3. `findNeglectedExercises(sessions: List<SessionSummary>, nowMs: Long): List<NeglectedExercise>`
       - For each unique exercise, find most recent session timestamp
       - Flag exercises where (nowMs - lastTimestamp) > 14 days
       - Sort by days descending (most neglected first)

    4. `detectPlateaus(sessions: List<SessionSummary>): List<PlateauDetection>`
       - Group sessions by exerciseId, sort by timestamp ascending
       - For each exercise, look at last 5+ sessions
       - Plateau = weight hasn't changed by more than 0.5kg across last 4+ consecutive sessions
       - Generate suggestions: vary modes, try progression, change rep ranges

    5. `analyzeTimeOfDay(sessions: List<SessionSummary>): TimeOfDayAnalysis`
       - Map session timestamps to TimeWindow: EARLY_MORNING (5-7), MORNING (7-10), AFTERNOON (10-15), EVENING (15-20), NIGHT (20-5)
       - Calculate average volume per session in each window
       - Optimal = window with highest avg volume (min 3 sessions for statistical relevance)

    6. `internal fun classifyMuscleGroup(muscleGroup: String): MovementCategory`
       - Maps ExerciseCategory-like strings to push/pull/legs/core
       - Case-insensitive matching, defaults to CORE for unknown

    **Test Cases:**

    Volume:
    - Empty sessions -> empty volumes
    - 3 chest sessions this week -> correct sets/reps/kg
    - Sessions outside 7-day window are excluded

    Balance:
    - All push -> imbalance flagged for pull and legs
    - Even distribution -> no imbalances
    - Core-only sessions don't affect push/pull/legs ratio

    Neglect:
    - Exercise last done 20 days ago -> flagged
    - Exercise done 5 days ago -> not flagged
    - Multiple neglected sorted by days desc

    Plateau:
    - 5 sessions same weight -> plateau detected
    - 3 sessions same weight (below threshold) -> no plateau
    - Weight increasing -> no plateau

    Time-of-day:
    - All morning sessions -> morning is optimal
    - Mixed with clear winner -> correct optimal
    - Too few sessions in a window -> not considered optimal
  </behavior>
  <implementation>
    Follow TDD RED-GREEN-REFACTOR cycle:
    1. RED: Write SmartSuggestions.kt models + SmartSuggestionsEngineTest.kt with all test cases (tests fail)
    2. GREEN: Implement SmartSuggestionsEngine.kt to pass all tests
    3. REFACTOR: Clean up if needed

    Use `object SmartSuggestionsEngine` (stateless, no dependencies needed).
    Use injectable `nowMs: Long` parameter (not system clock) for testability, following the timeProvider pattern from LedFeedbackController (Phase 2 decision 02-01).
  </implementation>
</feature>

<verification>
```bash
./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.domain.premium.SmartSuggestionsEngineTest"
```
All tests pass. No regressions in existing tests.
</verification>

<success_criteria>
- SmartSuggestionsEngine computes all 5 suggestion types correctly
- All test cases pass (volume, balance, neglect, plateau, time-of-day)
- Domain models are clean data classes with no framework dependencies
- Engine is a stateless object with pure functions (no DB or DI dependencies)
</success_criteria>

<output>
After completion, create `.planning/phases/04-smart-suggestions/04-01-SUMMARY.md`
</output>

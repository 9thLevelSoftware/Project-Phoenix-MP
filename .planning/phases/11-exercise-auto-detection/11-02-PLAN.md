---
phase: 11-exercise-auto-detection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/ExerciseSignatureRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightExerciseSignatureRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt
autonomous: true

must_haves:
  truths:
    - "Confirmed exercise signatures are stored in ExerciseSignature table and retrievable by exerciseId"
    - "All stored signatures can be loaded as a Map<String, ExerciseSignature> for classifier history input"
    - "SignatureExtractor and ExerciseClassifier are available via Koin DI"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/ExerciseSignatureRepository.kt"
      provides: "Repository interface for signature CRUD"
      contains: "interface ExerciseSignatureRepository"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightExerciseSignatureRepository.kt"
      provides: "SQLDelight implementation mapping to ExerciseSignature table"
      contains: "class SqlDelightExerciseSignatureRepository"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt"
      provides: "Koin registration for ExerciseSignatureRepository"
      contains: "ExerciseSignatureRepository"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt"
      provides: "Koin registration for SignatureExtractor and ExerciseClassifier"
      contains: "SignatureExtractor"
  key_links:
    - from: "SqlDelightExerciseSignatureRepository"
      to: "VitruvianDatabase"
      via: "vitruvianDatabaseQueries"
      pattern: "vitruvianDatabaseQueries\\..*Signature"
    - from: "DataModule.kt"
      to: "SqlDelightExerciseSignatureRepository"
      via: "Koin single binding"
      pattern: "single<ExerciseSignatureRepository>"
---

<objective>
Create the repository layer for persisting exercise signatures and wire all detection components into Koin DI.

Purpose: DETECT-04 (confirmed signatures stored for future matching) requires a repository that maps between the domain ExerciseSignature model and the SQLDelight ExerciseSignature table (already created in Phase 9). This plan also wires SignatureExtractor and ExerciseClassifier into DI so the UI layer can consume them.

Output: Working ExerciseSignatureRepository with Koin registrations.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-infrastructure/09-02-SUMMARY.md
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq (ExerciseSignature queries at line 812)
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightAssessmentRepository.kt (reference pattern for SQLDelight repo)
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExerciseSignatureRepository interface and SQLDelight implementation</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/ExerciseSignatureRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightExerciseSignatureRepository.kt
  </files>
  <action>
**ExerciseSignatureRepository.kt** -- Interface in `data/repository/`:

```kotlin
interface ExerciseSignatureRepository {
    suspend fun getSignaturesByExercise(exerciseId: String): List<ExerciseSignature>
    suspend fun getAllSignaturesAsMap(): Map<String, ExerciseSignature>
    suspend fun saveSignature(exerciseId: String, signature: ExerciseSignature)
    suspend fun updateSignature(id: Long, signature: ExerciseSignature)
    suspend fun deleteSignaturesByExercise(exerciseId: String)
}
```

Import the domain `ExerciseSignature` from `domain.detection.DetectionModels` (created in Plan 01). The domain model and the DB table have matching field names (romMm, durationMs, symmetryRatio, velocityProfile, cableConfig, sampleCount, confidence).

**SqlDelightExerciseSignatureRepository.kt:**

- Constructor takes `VitruvianDatabase` (injected via Koin)
- `private val queries = database.vitruvianDatabaseQueries`
- Uses `withContext(Dispatchers.IO)` for all DB operations (matches codebase pattern)

**Mapping between domain and DB:**
- `velocityProfile`: Store as string (`VelocityShape.name`), parse back with `VelocityShape.valueOf()`
- `cableConfig`: Store as string (`CableUsage.name`), parse back with `CableUsage.valueOf()`
- `createdAt`/`updatedAt`: Use `currentTimeMillis()` from PlatformUtils

**getAllSignaturesAsMap():**
- Call `queries.selectAllSignatures()`
- Group by exerciseId, take the highest-confidence signature per exercise
- Return `Map<String, ExerciseSignature>` (exerciseId -> best signature)

**saveSignature():**
- Call `queries.insertExerciseSignature()` with all fields mapped
- Pass `currentTimeMillis()` for both createdAt and updatedAt

**updateSignature():**
- Call `queries.updateExerciseSignature()` with id and updated fields
- Pass `currentTimeMillis()` for updatedAt only

Follow the same patterns used in `SqlDelightAssessmentRepository` -- use `withContext(Dispatchers.IO)`, private mapper function, Logger.withTag.
  </action>
  <verify>
`./gradlew :androidApp:assembleDebug` compiles without errors.
  </verify>
  <done>ExerciseSignatureRepository interface exists with 5 CRUD methods. SqlDelightExerciseSignatureRepository maps between domain ExerciseSignature and SQLDelight ExerciseSignature table, using string encoding for enums.</done>
</task>

<task type="auto">
  <name>Task 2: Koin DI registration for detection components</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DomainModule.kt
  </files>
  <action>
**DataModule.kt** -- Add after the AssessmentRepository binding:

```kotlin
// Exercise Detection Repository
single<ExerciseSignatureRepository> { SqlDelightExerciseSignatureRepository(get()) }
```

Import both `ExerciseSignatureRepository` and `SqlDelightExerciseSignatureRepository`.

**DomainModule.kt** -- Add after the AssessmentEngine binding:

```kotlin
// Exercise Detection
single { SignatureExtractor() }
single { ExerciseClassifier() }
```

Import `SignatureExtractor` and `ExerciseClassifier` from `domain.detection`.

Both are stateless classes with no constructor dependencies, so they get simple `single {}` bindings (same pattern as `AssessmentEngine()`).
  </action>
  <verify>
`./gradlew :androidApp:assembleDebug` compiles without errors.

Run Koin module verification test: `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.di.KoinModuleVerifyTest"` -- passes (verifies all bindings resolve).
  </verify>
  <done>SignatureExtractor, ExerciseClassifier, and ExerciseSignatureRepository are all registered in Koin and resolvable. Build passes.</done>
</task>

</tasks>

<verification>
- `./gradlew :androidApp:assembleDebug` compiles cleanly
- ExerciseSignatureRepository interface declares getSignaturesByExercise, getAllSignaturesAsMap, saveSignature, updateSignature, deleteSignaturesByExercise
- SqlDelightExerciseSignatureRepository uses VitruvianDatabase queries (insertExerciseSignature, selectAllSignatures, selectSignaturesByExercise, updateExerciseSignature)
- DataModule.kt has `single<ExerciseSignatureRepository>` binding
- DomainModule.kt has `single { SignatureExtractor() }` and `single { ExerciseClassifier() }` bindings
- Koin module verify test passes
</verification>

<success_criteria>
All detection domain and data components are wired into the DI graph. Signatures can be persisted and retrieved. Detection engine classes are injectable.
</success_criteria>

<output>
After completion, create `.planning/phases/11-exercise-auto-detection/11-02-SUMMARY.md`
</output>

---
phase: 11-exercise-auto-detection
plan: 04
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/e2e/WorkoutFlowE2ETest.kt
  - shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModelTest.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After 3-5 reps of a set, the system suggests an exercise name with confidence percentage via a non-blocking bottom sheet"
    - "User can confirm the suggestion or select a different exercise without interrupting the workout"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt"
      provides: "WorkoutUiState receives detectionState from ViewModel"
      contains: "detectionState = detectionState"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt"
      provides: "Detection delegation functions"
      contains: "fun onDetectionConfirmed"
  key_links:
    - from: "ActiveWorkoutScreen.kt"
      to: "MainViewModel.detectionState"
      via: "collectAsState observation"
      pattern: "viewModel\\.detectionState\\.collectAsState"
    - from: "workoutActions"
      to: "MainViewModel.onDetectionConfirmed"
      via: "callback delegation"
      pattern: "onDetectionConfirmed.*viewModel"
    - from: "workoutActions"
      to: "MainViewModel.onDetectionDismissed"
      via: "callback delegation"
      pattern: "onDetectionDismissed.*viewModel"
---

<objective>
Close Phase 11 verification gaps: wire detection state observation and callbacks in ActiveWorkoutScreen

Purpose: The domain layer and UI components are complete, but ActiveWorkoutScreen does not observe detectionState from the ViewModel or wire detection callbacks. This causes the bottom sheet to never appear even though all underlying logic works.

Output: Fully wired auto-detection UI where the bottom sheet appears after 3 reps and user interactions reach the detection manager.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-exercise-auto-detection/11-VERIFICATION.md
@.planning/phases/11-exercise-auto-detection/11-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire detection state and callbacks in ActiveWorkoutScreen</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  </files>
  <action>
**In MainViewModel.kt** (around line 146, after `val detectionState get() = ...`):

Add two delegation functions for detection callbacks:

```kotlin
// ===== Exercise Detection Delegation =====
val detectionState get() = workoutSessionManager.detectionManager.detectionState

suspend fun onDetectionConfirmed(exerciseId: String, exerciseName: String) =
    workoutSessionManager.detectionManager.onExerciseConfirmed(exerciseId, exerciseName)

fun onDetectionDismissed() =
    workoutSessionManager.detectionManager.onDetectionDismissed()
```

**In ActiveWorkoutScreen.kt**:

1. Add import for DetectionState at top of file:
   ```kotlin
   import com.devil.phoenixproject.presentation.manager.DetectionState
   ```

2. Around line 267 (near other collectAsState calls), add detection state observation:
   ```kotlin
   val detectionState by viewModel.detectionState.collectAsState()
   ```

3. In the `remember { WorkoutUiState(...) }` block (around line 272-308):
   - Add `detectionState` to the keys list in `remember(...)`
   - Add parameter: `detectionState = detectionState,` after `latestBiomechanicsResult`

4. In the `workoutActions(...)` call (around line 310-335):
   - Add after `formatWeight = viewModel::formatWeight`:
   ```kotlin
   onDetectionConfirmed = { exerciseId, exerciseName -> viewModel.onDetectionConfirmed(exerciseId, exerciseName) },
   onDetectionDismissed = { viewModel.onDetectionDismissed() }
   ```

Note: The `workoutActions` helper function already accepts these parameters (see WorkoutUiState.kt lines 192-193) - they just need to be passed actual implementations instead of using defaults.
  </action>
  <verify>
Run `./gradlew :androidApp:assembleDebug` - should compile with no errors.

Grep verification:
- `grep "detectionState = detectionState" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/ActiveWorkoutScreen.kt` returns match
- `grep "fun onDetectionConfirmed" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt` returns match
  </verify>
  <done>
ActiveWorkoutScreen observes detectionState from ViewModel and passes it to WorkoutUiState.
WorkoutActions callbacks wire to MainViewModel delegation functions.
The detection bottom sheet will appear when detectionState.isActive becomes true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix test constructors with detectionManager parameter</name>
  <files>
    shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/e2e/WorkoutFlowE2ETest.kt
    shared/src/androidUnitTest/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModelTest.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
  </files>
  <action>
The test files construct MainViewModel and DefaultWorkoutSessionManager without the required `detectionManager` parameter. Add a fake/stub ExerciseDetectionManager to each.

**In DWSMTestHarness.kt** (lines 52-69):

1. Add imports at top:
   ```kotlin
   import com.devil.phoenixproject.domain.detection.ExerciseClassifier
   import com.devil.phoenixproject.domain.detection.SignatureExtractor
   import com.devil.phoenixproject.presentation.manager.ExerciseDetectionManager
   ```

2. Create a fake ExerciseSignatureRepository (or reuse if one exists in testutil/). Simplest approach - create inline:
   ```kotlin
   val fakeSignatureRepo = object : ExerciseSignatureRepository {
       override suspend fun saveSignature(exerciseId: String, signature: ExerciseSignature) {}
       override suspend fun evolveSignature(exerciseId: String, newSample: ExerciseSignature) {}
       override suspend fun getSignature(exerciseId: String): ExerciseSignature? = null
       override suspend fun getAllSignatures(): List<ExerciseSignature> = emptyList()
       override suspend fun getAllSignaturesAsMap(): Map<String, ExerciseSignature> = emptyMap()
   }
   ```

3. Add detectionManager construction after gamificationManager:
   ```kotlin
   val signatureExtractor = SignatureExtractor()
   val exerciseClassifier = ExerciseClassifier(fakeExerciseRepo)
   val detectionManager = ExerciseDetectionManager(
       signatureExtractor = signatureExtractor,
       exerciseClassifier = exerciseClassifier,
       signatureRepository = fakeSignatureRepo
   )
   ```

4. Add `detectionManager = detectionManager,` to the DefaultWorkoutSessionManager constructor call (after `settingsManager` and before `scope`).

**In MainViewModelTest.kt** (around line 75-87):

1. Add imports for ExerciseDetectionManager and dependencies.

2. Create stub detectionManager before MainViewModel construction:
   ```kotlin
   val fakeSignatureRepo = object : ExerciseSignatureRepository { ... } // Same as above
   val detectionManager = ExerciseDetectionManager(
       signatureExtractor = SignatureExtractor(),
       exerciseClassifier = ExerciseClassifier(fakeExerciseRepository),
       signatureRepository = fakeSignatureRepo
   )
   ```

3. Add `detectionManager = detectionManager` to MainViewModel constructor.

**In WorkoutFlowE2ETest.kt** (around line 65-77):

Same pattern as MainViewModelTest - add imports, create stub detectionManager, add to constructor.

Note: If a `FakeExerciseSignatureRepository` already exists in testutil/, use that instead of inline object.
  </action>
  <verify>
Run tests to verify constructors are valid:
```bash
./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.presentation.viewmodel.MainViewModelTest"
./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.e2e.WorkoutFlowE2ETest"
./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.presentation.manager.DWSMWorkoutLifecycleTest"
```

All tests should compile and pass (existing tests should continue to work).
  </verify>
  <done>
Test files compile with detectionManager parameter.
All existing tests continue to pass.
No constructor mismatch errors.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   ```bash
   ./gradlew :androidApp:assembleDebug
   ```
   BUILD SUCCESSFUL

2. Test verification:
   ```bash
   ./gradlew :shared:testDebugUnitTest
   ```
   All tests pass (no constructor errors)

3. Wiring verification (grep checks):
   - `viewModel.detectionState.collectAsState` in ActiveWorkoutScreen.kt
   - `detectionState = detectionState` in WorkoutUiState construction
   - `onDetectionConfirmed = {` with viewModel call in workoutActions
   - `fun onDetectionConfirmed` in MainViewModel.kt
   - `detectionManager = detectionManager` in test constructors
</verification>

<success_criteria>
- ActiveWorkoutScreen observes viewModel.detectionState via collectAsState
- detectionState is included in WorkoutUiState remember keys and construction
- workoutActions passes actual callbacks to onDetectionConfirmed/onDetectionDismissed
- MainViewModel exposes delegation functions that call detectionManager methods
- All test files construct their subjects with detectionManager parameter
- Build compiles successfully
- All existing unit tests pass
- The end-to-end data flow is: ExerciseDetectionManager -> detectionState StateFlow -> MainViewModel.detectionState -> ActiveWorkoutScreen collectAsState -> WorkoutUiState -> WorkoutTab -> WorkoutHud -> AutoDetectionSheet
</success_criteria>

<output>
After completion, create `.planning/phases/11-exercise-auto-detection/11-04-SUMMARY.md`
</output>

---
phase: 09-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/14.sqm
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  - shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
  - shared/build.gradle.kts
autonomous: true

must_haves:
  truths:
    - "ExerciseSignature table exists in database with columns for ROM, duration, symmetry, velocity profile, and cable usage"
    - "AssessmentResult table exists in database with columns for exercise reference, estimated 1RM, load-velocity data points, and timestamp"
    - "SQLDelight generates typed Kotlin code for both new tables including insert and select queries"
    - "iOS DriverFactory creates both tables manually with IF NOT EXISTS"
  artifacts:
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      provides: "ExerciseSignature and AssessmentResult table definitions and queries"
      contains: "CREATE TABLE ExerciseSignature"
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/14.sqm"
      provides: "Migration creating both new tables"
      contains: "CREATE TABLE ExerciseSignature"
    - path: "shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt"
      provides: "Manual table creation for iOS"
      contains: "ExerciseSignature"
    - path: "shared/build.gradle.kts"
      provides: "Updated schema version to 15"
      contains: "version = 15"
  key_links:
    - from: "VitruvianDatabase.sq"
      to: "14.sqm"
      via: "migration creates tables matching schema definition"
      pattern: "ExerciseSignature"
    - from: "VitruvianDatabase.sq"
      to: "DriverFactory.ios.kt"
      via: "iOS manual schema mirrors .sq table definitions"
      pattern: "CREATE TABLE IF NOT EXISTS ExerciseSignature"
---

<objective>
Add ExerciseSignature and AssessmentResult table schemas via SQLDelight migration.

Purpose: INFRA-03 (ExerciseSignature) provides the data foundation for exercise auto-detection in Phase 11. INFRA-04 (AssessmentResult) provides the data foundation for VBT strength assessment in Phase 10. Both are pure schema additions with no business logic.

Output: Two new database tables with full CRUD queries, migration 14.sqm, iOS manual schema updates, version bumps.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-infrastructure/09-01-SUMMARY.md

@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
@shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
@shared/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ExerciseSignature and AssessmentResult tables with queries to schema</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  </files>
  <action>
    Add two new table definitions and their queries to `VitruvianDatabase.sq`. Place them after the RepMetric section and before the Gamification tables.

    **ExerciseSignature table** (for Phase 11 exercise auto-detection):
    ```sql
    -- ==================== EXERCISE SIGNATURES ====================
    -- Movement signatures for exercise auto-detection

    CREATE TABLE ExerciseSignature (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        exerciseId TEXT NOT NULL,
        romMm REAL NOT NULL,
        durationMs INTEGER NOT NULL,
        symmetryRatio REAL NOT NULL,
        velocityProfile TEXT NOT NULL,
        cableConfig TEXT NOT NULL,
        sampleCount INTEGER NOT NULL DEFAULT 1,
        confidence REAL NOT NULL DEFAULT 0.0,
        createdAt INTEGER NOT NULL,
        updatedAt INTEGER NOT NULL,
        FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE
    );

    CREATE INDEX idx_exercise_signature_exercise ON ExerciseSignature(exerciseId);
    ```

    Column rationale:
    - `exerciseId`: Links to Exercise table for the identified exercise
    - `romMm`: Range of motion in millimeters (from position data)
    - `durationMs`: Typical rep duration in milliseconds
    - `symmetryRatio`: Cable A vs B load ratio (0.0-1.0, where 1.0 = perfectly symmetric)
    - `velocityProfile`: JSON-encoded velocity curve shape (e.g., `"[0.2, 0.8, 1.0, 0.6, 0.3]"` normalized velocity at 5 time points)
    - `cableConfig`: SINGLE or DOUBLE cable usage pattern
    - `sampleCount`: Number of confirmed reps contributing to this signature (grows with corrections)
    - `confidence`: Computed match confidence (0.0-1.0), increases as sampleCount grows
    - `createdAt`/`updatedAt`: Timestamps for tracking signature evolution

    **ExerciseSignature queries:**
    ```sql
    -- ==================== EXERCISE SIGNATURE QUERIES ====================

    insertExerciseSignature:
    INSERT INTO ExerciseSignature (exerciseId, romMm, durationMs, symmetryRatio, velocityProfile, cableConfig, sampleCount, confidence, createdAt, updatedAt)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);

    selectSignaturesByExercise:
    SELECT * FROM ExerciseSignature WHERE exerciseId = ? ORDER BY confidence DESC;

    selectAllSignatures:
    SELECT * FROM ExerciseSignature ORDER BY updatedAt DESC;

    updateExerciseSignature:
    UPDATE ExerciseSignature
    SET romMm = ?, durationMs = ?, symmetryRatio = ?, velocityProfile = ?, cableConfig = ?,
        sampleCount = ?, confidence = ?, updatedAt = ?
    WHERE id = ?;

    deleteExerciseSignature:
    DELETE FROM ExerciseSignature WHERE id = ?;

    deleteSignaturesByExercise:
    DELETE FROM ExerciseSignature WHERE exerciseId = ?;
    ```

    **AssessmentResult table** (for Phase 10 strength assessment):
    ```sql
    -- ==================== ASSESSMENT RESULTS ====================
    -- VBT strength assessment results

    CREATE TABLE AssessmentResult (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        exerciseId TEXT NOT NULL,
        estimatedOneRepMaxKg REAL NOT NULL,
        loadVelocityData TEXT NOT NULL,
        assessmentSessionId TEXT,
        userOverrideKg REAL,
        createdAt INTEGER NOT NULL,
        FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE,
        FOREIGN KEY (assessmentSessionId) REFERENCES WorkoutSession(id) ON DELETE SET NULL
    );

    CREATE INDEX idx_assessment_result_exercise ON AssessmentResult(exerciseId);
    ```

    Column rationale:
    - `exerciseId`: Links to Exercise for the assessed exercise
    - `estimatedOneRepMaxKg`: System-calculated 1RM from load-velocity regression
    - `loadVelocityData`: JSON-encoded array of `[{load: kg, velocity: m/s}]` data points from the assessment
    - `assessmentSessionId`: Links to the WorkoutSession with `__ASSESSMENT__` marker (nullable for manual entries)
    - `userOverrideKg`: If user rejected the estimate and entered their own value (nullable)
    - `createdAt`: When assessment was performed

    **AssessmentResult queries:**
    ```sql
    -- ==================== ASSESSMENT RESULT QUERIES ====================

    insertAssessmentResult:
    INSERT INTO AssessmentResult (exerciseId, estimatedOneRepMaxKg, loadVelocityData, assessmentSessionId, userOverrideKg, createdAt)
    VALUES (?, ?, ?, ?, ?, ?);

    selectAssessmentsByExercise:
    SELECT * FROM AssessmentResult WHERE exerciseId = ? ORDER BY createdAt DESC;

    selectLatestAssessment:
    SELECT * FROM AssessmentResult WHERE exerciseId = ? ORDER BY createdAt DESC LIMIT 1;

    selectAllAssessments:
    SELECT * FROM AssessmentResult ORDER BY createdAt DESC;

    deleteAssessmentResult:
    DELETE FROM AssessmentResult WHERE id = ?;

    deleteAssessmentsByExercise:
    DELETE FROM AssessmentResult WHERE exerciseId = ?;
    ```
  </action>
  <verify>
    - Grep for `CREATE TABLE ExerciseSignature` in VitruvianDatabase.sq
    - Grep for `CREATE TABLE AssessmentResult` in VitruvianDatabase.sq
    - Grep for `insertExerciseSignature` and `insertAssessmentResult` queries
  </verify>
  <done>ExerciseSignature and AssessmentResult tables defined in schema with full CRUD queries, indexes, and foreign keys.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration 14.sqm and update all version numbers and iOS schema</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/14.sqm
    shared/build.gradle.kts
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
    shared/src/androidMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.android.kt
  </files>
  <action>
    **Create migration 14.sqm** at `shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/14.sqm`:
    ```sql
    -- Migration 14: ExerciseSignature and AssessmentResult tables
    -- ExerciseSignature: Movement signatures for exercise auto-detection (Phase 11)
    -- AssessmentResult: VBT strength assessment results (Phase 10)

    CREATE TABLE IF NOT EXISTS ExerciseSignature (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        exerciseId TEXT NOT NULL,
        romMm REAL NOT NULL,
        durationMs INTEGER NOT NULL,
        symmetryRatio REAL NOT NULL,
        velocityProfile TEXT NOT NULL,
        cableConfig TEXT NOT NULL,
        sampleCount INTEGER NOT NULL DEFAULT 1,
        confidence REAL NOT NULL DEFAULT 0.0,
        createdAt INTEGER NOT NULL,
        updatedAt INTEGER NOT NULL,
        FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_exercise_signature_exercise ON ExerciseSignature(exerciseId);

    CREATE TABLE IF NOT EXISTS AssessmentResult (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        exerciseId TEXT NOT NULL,
        estimatedOneRepMaxKg REAL NOT NULL,
        loadVelocityData TEXT NOT NULL,
        assessmentSessionId TEXT,
        userOverrideKg REAL,
        createdAt INTEGER NOT NULL,
        FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE,
        FOREIGN KEY (assessmentSessionId) REFERENCES WorkoutSession(id) ON DELETE SET NULL
    );

    CREATE INDEX IF NOT EXISTS idx_assessment_result_exercise ON AssessmentResult(exerciseId);
    ```

    **Update build.gradle.kts**: Change `version = 14` to `version = 15`.
    Update comment to: `// Version 15 = initial schema (1) + 14 migrations (1.sqm through 14.sqm)`

    **Update iOS DriverFactory.ios.kt**:
    1. Change `CURRENT_SCHEMA_VERSION = 14L` to `CURRENT_SCHEMA_VERSION = 15L`
    2. Add ExerciseSignature and AssessmentResult table definitions to the `createAllTables` method (in the tables list, after RepMetric and before EarnedBadge). Use the same column definitions as in the .sq file but with `CREATE TABLE IF NOT EXISTS`.
    3. Add indexes to the `createAllIndexes` method:
       - `"CREATE INDEX IF NOT EXISTS idx_exercise_signature_exercise ON ExerciseSignature(exerciseId)"`
       - `"CREATE INDEX IF NOT EXISTS idx_assessment_result_exercise ON AssessmentResult(exerciseId)"`

    **Update Android DriverFactory.android.kt**: Add migration 14 to `getMigrationStatements`:
    ```kotlin
    14 -> listOf(
        """CREATE TABLE IF NOT EXISTS ExerciseSignature (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            exerciseId TEXT NOT NULL,
            romMm REAL NOT NULL,
            durationMs INTEGER NOT NULL,
            symmetryRatio REAL NOT NULL,
            velocityProfile TEXT NOT NULL,
            cableConfig TEXT NOT NULL,
            sampleCount INTEGER NOT NULL DEFAULT 1,
            confidence REAL NOT NULL DEFAULT 0.0,
            createdAt INTEGER NOT NULL,
            updatedAt INTEGER NOT NULL,
            FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE
        )""",
        "CREATE INDEX IF NOT EXISTS idx_exercise_signature_exercise ON ExerciseSignature(exerciseId)",
        """CREATE TABLE IF NOT EXISTS AssessmentResult (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            exerciseId TEXT NOT NULL,
            estimatedOneRepMaxKg REAL NOT NULL,
            loadVelocityData TEXT NOT NULL,
            assessmentSessionId TEXT,
            userOverrideKg REAL,
            createdAt INTEGER NOT NULL,
            FOREIGN KEY (exerciseId) REFERENCES Exercise(id) ON DELETE CASCADE,
            FOREIGN KEY (assessmentSessionId) REFERENCES WorkoutSession(id) ON DELETE SET NULL
        )""",
        "CREATE INDEX IF NOT EXISTS idx_assessment_result_exercise ON AssessmentResult(exerciseId)"
    )
    ```
  </action>
  <verify>
    - File `migrations/14.sqm` exists with both CREATE TABLE statements
    - `build.gradle.kts` contains `version = 15`
    - iOS DriverFactory contains `CURRENT_SCHEMA_VERSION = 15L` and both table definitions
    - Android DriverFactory getMigrationStatements handles version 14
    - Run `./gradlew :shared:generateCommonMainVitruvianDatabaseInterface` to verify SQLDelight compiles
    - Run `./gradlew :androidApp:assembleDebug` for full build verification
  </verify>
  <done>Migration 14.sqm creates both tables. All version numbers updated to 15. iOS manual schema includes both tables and indexes. Android resilient migration handles version 14. Full build succeeds.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:generateCommonMainVitruvianDatabaseInterface` succeeds
2. `./gradlew :androidApp:assembleDebug` succeeds
3. ExerciseSignature table has columns: romMm, durationMs, symmetryRatio, velocityProfile, cableConfig
4. AssessmentResult table has columns: exerciseId, estimatedOneRepMaxKg, loadVelocityData, assessmentSessionId, createdAt
5. Migration 14.sqm exists with both tables
6. Version = 15 in build.gradle.kts, iOS = 15L
</verification>

<success_criteria>
- ExerciseSignature table schema defined with all required columns for auto-detection
- AssessmentResult table schema defined with all required columns for strength assessment
- SQLDelight generates typed Kotlin interfaces for both tables
- iOS and Android migration paths both handle the new tables
- Project compiles and runs successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-infrastructure/09-02-SUMMARY.md`
</output>

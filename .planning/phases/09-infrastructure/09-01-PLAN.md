---
phase: 09-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/13.sqm
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  - shared/build.gradle.kts
autonomous: true

must_haves:
  truths:
    - "Power values stored in MetricSample reflect combined load (loadA + loadB) times velocity for dual-cable exercises"
    - "MetricSample queries filtered by sessionId use an index instead of full table scan"
    - "SQLDelight schema version is correct and migrations run on Android"
    - "iOS DriverFactory schema version matches and includes the new index"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt"
      provides: "Fixed power calculation using (loadA + loadB) * velocity"
      contains: "loadA + metric.loadB"
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      provides: "MetricSample sessionId index definition"
      contains: "idx_metric_sample_session"
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/13.sqm"
      provides: "Migration adding MetricSample sessionId index"
      contains: "CREATE INDEX"
    - path: "shared/build.gradle.kts"
      provides: "Updated SQLDelight schema version"
      contains: "version = 14"
  key_links:
    - from: "SqlDelightWorkoutRepository.kt"
      to: "MetricSample table"
      via: "insertMetric query with corrected power value"
      pattern: "loadA.*\\+.*loadB"
    - from: "13.sqm"
      to: "VitruvianDatabase.sq"
      via: "migration adds index that matches .sq definition"
      pattern: "idx_metric_sample_session"
---

<objective>
Fix the dual-cable power calculation bug and add a MetricSample index on sessionId for query performance.

Purpose: INFRA-01 (power calculation) ensures accurate power display during dual-cable exercises. INFRA-02 (MetricSample index) prevents slow session detail queries when sessions have 100+ metric samples. Also fixes stale SQLDelight schema version in build.gradle.kts (currently 11, should be 14 after this migration).

Output: Corrected power formula, new database index, migration 13.sqm, version bumps on Android and iOS.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
@shared/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix power calculation and add MetricSample index to schema</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightWorkoutRepository.kt
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  </files>
  <action>
    **Power calculation fix** in `SqlDelightWorkoutRepository.kt` around line 658:
    - Current: `val power = metric.loadA * metric.velocityA.toFloat()`
    - Change to: `val power = (metric.loadA + metric.loadB) * metric.velocityA.toFloat()`
    - This gives combined force (both cables) times velocity for true power output.
    - Update the comment from "P = F x v (force x velocity)" to "P = (loadA + loadB) x v (combined force x velocity for dual-cable)"

    **MetricSample index** in `VitruvianDatabase.sq`:
    - Add `CREATE INDEX idx_metric_sample_session ON MetricSample(sessionId);` after the MetricSample table definition (around line 110, after the CREATE TABLE and before the PersonalRecord table).
    - This index accelerates `selectMetricsBySession` which filters WHERE sessionId = ? and orders by timestamp.
  </action>
  <verify>
    - Grep for `loadA + metric.loadB` in SqlDelightWorkoutRepository.kt confirms the fix
    - Grep for `idx_metric_sample_session` in VitruvianDatabase.sq confirms the index exists
  </verify>
  <done>Power calculation uses combined load (loadA + loadB). MetricSample table has sessionId index in schema definition.</done>
</task>

<task type="auto">
  <name>Task 2: Create migration 13.sqm and update version numbers</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/13.sqm
    shared/build.gradle.kts
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  </files>
  <action>
    **Pre-existing issue**: `build.gradle.kts` has `version = 11` but there are already migrations up through 12.sqm, and the iOS DriverFactory uses `CURRENT_SCHEMA_VERSION = 13L`. This means Android users on version 11 would not get migration 12 (RepMetric table) applied via SQLDelight's automatic migration system. Fix this by setting the correct version after adding our new migration.

    **Create migration 13.sqm** at `shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/13.sqm`:
    ```sql
    -- Migration 13: MetricSample performance index
    -- Adds index on sessionId to accelerate session detail queries
    -- (selectMetricsBySession: WHERE sessionId = ? ORDER BY timestamp ASC)

    CREATE INDEX IF NOT EXISTS idx_metric_sample_session ON MetricSample(sessionId);
    ```

    **Update build.gradle.kts**: Change `version = 11` to `version = 14` in the sqldelight databases block.
    The formula is: initial schema version (1) + number of .sqm files (13) = 14.
    Also update the comment to: `// Version 14 = initial schema (1) + 13 migrations (1.sqm through 13.sqm)`

    **Update iOS DriverFactory.ios.kt**: Change `CURRENT_SCHEMA_VERSION = 13L` to `CURRENT_SCHEMA_VERSION = 14L`.
    Also add the new index to the `createAllIndexes` method if not already present (it already has `idx_metric_sample_session` -- verify it exists and matches).

    **Update Android DriverFactory.android.kt**: Add migration 13 to `getMigrationStatements`:
    ```kotlin
    13 -> listOf(
        "CREATE INDEX IF NOT EXISTS idx_metric_sample_session ON MetricSample(sessionId)"
    )
    ```
  </action>
  <verify>
    - File `migrations/13.sqm` exists with CREATE INDEX statement
    - `build.gradle.kts` contains `version = 14`
    - iOS DriverFactory contains `CURRENT_SCHEMA_VERSION = 14L`
    - Android DriverFactory getMigrationStatements handles version 13
    - Run `./gradlew :shared:generateCommonMainVitruvianDatabaseInterface` to verify SQLDelight compiles
  </verify>
  <done>Migration 13.sqm creates MetricSample sessionId index. build.gradle.kts version is 14. iOS CURRENT_SCHEMA_VERSION is 14. Android resilient migration handles version 13. SQLDelight generates successfully.</done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:generateCommonMainVitruvianDatabaseInterface` succeeds (schema is valid)
2. Grep confirms power calculation uses `(loadA + loadB) * velocity`
3. Migration 13.sqm exists and contains the index creation
4. Version numbers are consistent: build.gradle.kts=14, iOS=14L
5. `./gradlew :androidApp:assembleDebug` succeeds (full Android build)
</verification>

<success_criteria>
- Power formula uses combined load for accurate dual-cable power values
- MetricSample sessionId index exists in schema, migration, and iOS manual schema
- All version numbers are synchronized across Android and iOS
- Project compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-infrastructure/09-01-SUMMARY.md`
</output>

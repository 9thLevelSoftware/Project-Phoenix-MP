---
phase: 21-rpg-attributes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RpgModels.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngineTest.kt
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/17.sqm
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  - shared/build.gradle.kts
autonomous: true
requirements: [RPG-01, RPG-02, RPG-04]
must_haves:
  truths:
    - "RpgAttributeEngine.computeProfile() returns five integer attributes (0-100) from workout aggregate data"
    - "CharacterClass is auto-assigned from dominant attribute ratio with Phoenix as balanced fallback"
    - "Zero-workout users receive RpgProfile.EMPTY (all zeros, Phoenix class) instead of NaN/crash"
    - "RpgAttributes table exists in schema v17 and persists profile data across app restarts"
    - "iOS DriverFactory CURRENT_SCHEMA_VERSION matches migration count (18L)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RpgModels.kt"
      provides: "RpgAttribute enum, CharacterClass enum, RpgProfile data class, RpgInput data class"
      exports: ["RpgAttribute", "CharacterClass", "RpgProfile", "RpgInput"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt"
      provides: "Pure stateless computation engine for RPG attributes"
      exports: ["RpgAttributeEngine"]
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngineTest.kt"
      provides: "TDD test suite covering all attribute computations, character classification, and edge cases"
      min_lines: 80
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/17.sqm"
      provides: "CREATE TABLE RpgAttributes migration"
      contains: "CREATE TABLE RpgAttributes"
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      provides: "RpgAttributes table definition + selectRpgAttributes/upsertRpgAttributes queries + RPG aggregate queries"
      contains: "RpgAttributes"
  key_links:
    - from: "RpgAttributeEngine.kt"
      to: "RpgModels.kt"
      via: "import RpgInput, RpgProfile, CharacterClass"
      pattern: "fun computeProfile.*RpgInput.*RpgProfile"
    - from: "DriverFactory.ios.kt"
      to: "17.sqm"
      via: "CURRENT_SCHEMA_VERSION = 18L matching 17 migration files"
      pattern: "CURRENT_SCHEMA_VERSION = 18L"
---

<objective>
Create the RPG attribute computation engine with TDD, domain model types, schema migration v17
for the RpgAttributes table, and SQL queries for aggregate workout data.

Purpose: Establish the pure computation layer and persistence foundation that Plan 02 will
wire into the UI. Follows the exact ReadinessEngine pattern (Phase 20-01).

Output: RpgAttributeEngine object, RpgModels domain types, RpgAttributeEngineTest,
schema migration 17.sqm, new SQL queries, iOS DriverFactory version bump.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-rpg-attributes/21-RESEARCH.md
@.planning/phases/20-readiness-briefing/20-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/ReadinessEngine.kt (PATTERN TO FOLLOW):
```kotlin
// ReadinessEngine is a stateless object with pure functions.
// RpgAttributeEngine MUST follow this exact pattern.
object ReadinessEngine {
    fun computeReadiness(sessions: List<SessionSummary>, nowMs: Long): ReadinessResult
    internal fun mapAcwrToScore(acwr: Double): Int
}
```

From shared/src/commonMain/sqldelight/.../VitruvianDatabase.sq (EXISTING QUERIES TO REUSE):
```sql
-- Already exist -- use these for RPG input data:
countTotalWorkouts:       SELECT COUNT(*) FROM WorkoutSession;
countTotalReps:           SELECT SUM(totalReps) FROM WorkoutSession;
countTotalVolume:         SELECT SUM(totalReps * weightPerCableKg * 2) FROM WorkoutSession;
countUniqueExercises:     SELECT COUNT(DISTINCT exerciseId) FROM WorkoutSession WHERE exerciseId IS NOT NULL;
countPersonalRecords:     SELECT COUNT(*) FROM PersonalRecord;
countEarnedBadges:        SELECT COUNT(*) FROM EarnedBadge;
selectPeakPower:          SELECT MAX(power) AS peakPower FROM MetricSample;
selectWorkoutDates:       SELECT DISTINCT DATE(timestamp / 1000, 'unixepoch') AS workoutDate FROM WorkoutSession ORDER BY timestamp DESC;
```

From GamificationStats table (existing singleton with useful fields):
```sql
CREATE TABLE GamificationStats (
    id INTEGER PRIMARY KEY,
    totalWorkouts INTEGER NOT NULL DEFAULT 0,
    totalReps INTEGER NOT NULL DEFAULT 0,
    totalVolumeKg INTEGER NOT NULL DEFAULT 0,
    longestStreak INTEGER NOT NULL DEFAULT 0,
    currentStreak INTEGER NOT NULL DEFAULT 0,
    uniqueExercisesUsed INTEGER NOT NULL DEFAULT 0,
    prsAchieved INTEGER NOT NULL DEFAULT 0,
    lastWorkoutDate INTEGER,
    streakStartDate INTEGER,
    lastUpdated INTEGER NOT NULL
);
```

From DriverFactory.ios.kt:
```kotlin
private const val CURRENT_SCHEMA_VERSION = 17L  // Must become 18L after 17.sqm
```

From shared/build.gradle.kts:
```kotlin
version = 16  // Must become 17 after adding 17.sqm
```
</interfaces>
</context>

<feature>
  <name>RPG Attribute Computation Engine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RpgModels.kt,
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt,
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngineTest.kt
  </files>
  <behavior>
    RpgAttributeEngine.computeProfile(input: RpgInput) -> RpgProfile

    Cases:
    - Empty input (totalWorkouts=0) -> RpgProfile.EMPTY (all zeros, Phoenix class)
    - High strength input (maxWeight=200, avgWorking=120) -> strength ~80-100
    - High power input (peakPower=1800) -> power ~90
    - High stamina input (volume=400000, reps=40000) -> stamina ~80
    - High consistency input (streak=80, trainingDays=400) -> consistency ~80-90
    - High mastery input (exercises=45, prs=90, badges=35) -> mastery ~85-90
    - Balanced attributes (spread <= 15) -> CharacterClass.PHOENIX
    - Dominant strength (str=90, others=50) -> CharacterClass.POWERLIFTER
    - Dominant power -> CharacterClass.ATHLETE
    - Dominant stamina -> CharacterClass.IRONMAN
    - Dominant consistency -> CharacterClass.MONK
    - All attributes coerced to 0-100 range (no negatives, no overflow)
  </behavior>
  <implementation>
    1. Create RpgModels.kt with RpgAttribute enum, CharacterClass enum, RpgProfile data class (with EMPTY companion), RpgInput data class
    2. Create RpgAttributeEngine as stateless object with computeProfile(), individual compute* functions (internal), classifyCharacter(), normalize()
    3. Normalization uses configurable ceiling constants tuned for Vitruvian Trainer (max 220kg machine)
    4. All division guarded against zero denominators
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Domain models and failing tests for RpgAttributeEngine</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RpgModels.kt,
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngineTest.kt,
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt
  </files>
  <action>
    1. Create `RpgModels.kt` in `domain/model/` with:
       - `enum class RpgAttribute(val displayName: String, val description: String)` with entries: STRENGTH("Strength", "Peak load lifted"), POWER("Power", "Explosive force generation"), STAMINA("Stamina", "Training volume endurance"), CONSISTENCY("Consistency", "Training regularity"), MASTERY("Mastery", "Exercise variety and technique")
       - `enum class CharacterClass(val displayName: String, val description: String)` with entries: POWERLIFTER("Powerlifter", "Dominant in raw strength"), ATHLETE("Athlete", "Dominant in explosive power"), IRONMAN("Ironman", "Dominant in volume endurance"), MONK("Monk", "Dominant in training discipline"), PHOENIX("Phoenix", "Balanced across all attributes")
       - `data class RpgProfile(val strength: Int, val power: Int, val stamina: Int, val consistency: Int, val mastery: Int, val characterClass: CharacterClass, val lastComputed: Long = 0)` with `companion object { val EMPTY = RpgProfile(0, 0, 0, 0, 0, CharacterClass.PHOENIX) }`
       - `data class RpgInput(val maxWeightLiftedKg: Double, val totalVolumeKg: Double, val totalWorkouts: Int, val totalReps: Int, val uniqueExercises: Int, val personalRecords: Int, val peakPowerWatts: Double, val avgWorkingWeightKg: Double, val currentStreak: Int, val longestStreak: Int, val trainingDays: Int, val badgesEarned: Int)`

    2. Create a STUB `RpgAttributeEngine.kt` in `domain/premium/` that compiles but returns wrong values:
       ```kotlin
       object RpgAttributeEngine {
           fun computeProfile(input: RpgInput): RpgProfile = RpgProfile.EMPTY
       }
       ```

    3. Create `RpgAttributeEngineTest.kt` in `commonTest/domain/premium/` with tests:
       - `test empty input returns EMPTY profile` -- totalWorkouts=0, expect all zeros and PHOENIX
       - `test strength computation with high max weight` -- maxWeight=180.0, avgWorking=100.0, expect strength >= 60
       - `test power computation with high peak power` -- peakPower=1800.0, expect power >= 80
       - `test stamina computation with high volume` -- volume=400000.0, reps=40000, expect stamina >= 70
       - `test consistency with long streak` -- longestStreak=80, trainingDays=400, currentStreak=30, expect consistency >= 70
       - `test mastery with high variety` -- exercises=45, prs=90, badges=35, expect mastery >= 75
       - `test balanced attributes classify as Phoenix` -- all attrs within 15pt spread, expect PHOENIX
       - `test dominant strength classifies as Powerlifter` -- str >> others, expect POWERLIFTER
       - `test dominant power classifies as Athlete` -- pow >> others, expect ATHLETE
       - `test dominant stamina classifies as Ironman` -- sta >> others, expect IRONMAN
       - `test dominant consistency classifies as Monk` -- con >> others, expect MONK
       - `test all attributes coerced to 0-100` -- extreme inputs, verify all in 0..100 range
       - `test normalize handles zero ceiling` -- edge case for division by zero

       Use `kotlin.test.Test`, `kotlin.test.assertEquals`, `kotlin.test.assertTrue` imports.
       For tests that need specific attribute ranges, create RpgInput with controlled values and assert the specific attribute value falls within expected range.

    4. Run tests to confirm they FAIL (stub returns EMPTY for all):
       `./gradlew :shared:testDebugUnitTest --tests "*.RpgAttributeEngineTest" 2>&1 | tail -30`

    5. Commit: `test(21-01): add failing tests for RpgAttributeEngine`
  </action>
  <verify>
    <automated>./gradlew :shared:testDebugUnitTest --tests "*.RpgAttributeEngineTest" 2>&1 | tail -30</automated>
    Tests MUST FAIL (RED phase). Only the empty-input test should pass (stub returns EMPTY which is correct for that case).
  </verify>
  <done>RpgModels.kt defines all domain types. RpgAttributeEngineTest has 13 test cases. Tests fail because engine is stubbed.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement RpgAttributeEngine, schema migration v17, SQL queries</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt,
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq,
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/17.sqm,
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt,
    shared/build.gradle.kts
  </files>
  <action>
    1. Implement `RpgAttributeEngine` as a stateless `object` in `domain/premium/`:
       - `fun computeProfile(input: RpgInput): RpgProfile` -- guard with `if (input.totalWorkouts < 1) return RpgProfile.EMPTY`, compute all 5 attributes, classify character, return RpgProfile
       - `internal fun computeStrength(input: RpgInput): Int` -- 70% maxLiftScore + 30% avgWeightScore, normalize against MAX_WEIGHT_CEILING=200.0 (maxLift) and 120.0 (avgWeight), multiply by 100, coerceIn(0, 100)
       - `internal fun computePower(input: RpgInput): Int` -- normalize peakPowerWatts against POWER_CEILING=2000.0, multiply by 100, coerceIn(0, 100)
       - `internal fun computeStamina(input: RpgInput): Int` -- 60% volumeScore (ceiling 500000.0) + 40% repsScore (ceiling 50000.0), multiply by 100, coerceIn(0, 100)
       - `internal fun computeConsistency(input: RpgInput): Int` -- 40% streakScore (ceiling 90.0) + 40% frequencyScore (ceiling 500.0) + 20% currentStreakBonus (ceiling 30.0), multiply by 100, coerceIn(0, 100)
       - `internal fun computeMastery(input: RpgInput): Int` -- 40% varietyScore (ceiling 50.0) + 35% prScore (ceiling 100.0) + 25% badgeScore (ceiling 40.0), multiply by 100, coerceIn(0, 100)
       - `internal fun classifyCharacter(str: Int, pow: Int, sta: Int, con: Int, mas: Int): CharacterClass` -- if max-min <= 15 return PHOENIX, else when(max) str->POWERLIFTER, pow->ATHLETE, sta->IRONMAN, con->MONK, mas->PHOENIX
       - `private fun normalize(value: Double, ceiling: Double): Double` -- guard `if (ceiling <= 0.0) return 0.0`, return `(value / ceiling).coerceIn(0.0, 1.0)`

    2. Add to `VitruvianDatabase.sq`:
       a. After GamificationStats table, add RpgAttributes table definition:
       ```sql
       -- RPG Attributes (dedicated table per STATE.md decision, not GamificationStats singleton)
       CREATE TABLE RpgAttributes (
           id INTEGER PRIMARY KEY DEFAULT 1,
           strength INTEGER NOT NULL DEFAULT 0,
           power INTEGER NOT NULL DEFAULT 0,
           stamina INTEGER NOT NULL DEFAULT 0,
           consistency INTEGER NOT NULL DEFAULT 0,
           mastery INTEGER NOT NULL DEFAULT 0,
           characterClass TEXT NOT NULL DEFAULT 'Phoenix',
           lastComputed INTEGER NOT NULL DEFAULT 0
       );
       ```
       b. Add queries after existing gamification queries:
       ```sql
       -- RPG Attributes Queries
       selectRpgAttributes:
       SELECT * FROM RpgAttributes WHERE id = 1;

       upsertRpgAttributes:
       INSERT OR REPLACE INTO RpgAttributes
       (id, strength, power, stamina, consistency, mastery, characterClass, lastComputed)
       VALUES (1, ?, ?, ?, ?, ?, ?, ?);

       -- RPG computation helpers
       selectMaxWeightLifted:
       SELECT MAX(heaviestLiftKg) FROM WorkoutSession WHERE heaviestLiftKg IS NOT NULL;

       selectAvgWorkingWeight:
       SELECT AVG(workingAvgWeightKg) FROM WorkoutSession WHERE workingAvgWeightKg IS NOT NULL;

       selectPeakRepPower:
       SELECT MAX(peakPowerWatts) FROM RepMetric;

       countTrainingDays:
       SELECT COUNT(DISTINCT DATE(timestamp / 1000, 'unixepoch')) FROM WorkoutSession;
       ```

    3. Create `17.sqm` migration file:
       ```sql
       -- Migration 17: RPG Attributes table (Phase 21, RPG-01/RPG-04)
       CREATE TABLE RpgAttributes (
           id INTEGER PRIMARY KEY DEFAULT 1,
           strength INTEGER NOT NULL DEFAULT 0,
           power INTEGER NOT NULL DEFAULT 0,
           stamina INTEGER NOT NULL DEFAULT 0,
           consistency INTEGER NOT NULL DEFAULT 0,
           mastery INTEGER NOT NULL DEFAULT 0,
           characterClass TEXT NOT NULL DEFAULT 'Phoenix',
           lastComputed INTEGER NOT NULL DEFAULT 0
       );
       ```

    4. Update `shared/build.gradle.kts`:
       Change SQLDelight `version = 16` to `version = 17`

    5. Update `DriverFactory.ios.kt`:
       Change `CURRENT_SCHEMA_VERSION = 17L` to `CURRENT_SCHEMA_VERSION = 18L`
       (18L = initial schema 1 + 17 migrations)

    6. Run tests -- all 13 must now PASS:
       `./gradlew :shared:testDebugUnitTest --tests "*.RpgAttributeEngineTest"`

    7. Build the full project to verify schema migration compiles:
       `./gradlew :androidApp:assembleDebug`

    8. Commit: `feat(21-01): implement RpgAttributeEngine and schema migration v17`

    CRITICAL: The 17.sqm file and DriverFactory.ios.kt version bump MUST be in the same commit.
    This is a known pitfall (Daem0n warning #155, STATE.md blocker).
  </action>
  <verify>
    <automated>./gradlew :shared:testDebugUnitTest --tests "*.RpgAttributeEngineTest" 2>&1 | tail -20</automated>
    All 13 tests MUST PASS (GREEN phase).
    Also verify: `./gradlew :androidApp:assembleDebug` succeeds (schema compiles).
  </verify>
  <done>
    RpgAttributeEngine computes all 5 attributes correctly with all tests green.
    Schema migration 17.sqm creates RpgAttributes table.
    iOS DriverFactory bumped to CURRENT_SCHEMA_VERSION = 18L.
    SQLDelight version = 17 in build.gradle.kts.
    Project builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest --tests "*.RpgAttributeEngineTest"` -- all 13 tests pass
2. `./gradlew :androidApp:assembleDebug` -- full build succeeds with schema v17
3. `grep -r "CURRENT_SCHEMA_VERSION = 18L" shared/src/iosMain/` -- iOS version synced
4. `grep "version = 17" shared/build.gradle.kts` -- SQLDelight version bumped
5. `test -f shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/17.sqm` -- migration exists
</verification>

<success_criteria>
- RpgAttributeEngine.computeProfile() returns correct 0-100 attributes for all test cases
- Empty input (0 workouts) returns RpgProfile.EMPTY without NaN/crash
- Character classification correctly identifies dominant attribute or balanced (Phoenix)
- RpgAttributes table created via migration 17.sqm
- iOS CURRENT_SCHEMA_VERSION = 18L (synced with 17 migration files)
- All 13 TDD tests pass, project builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21-rpg-attributes/21-01-SUMMARY.md`
</output>

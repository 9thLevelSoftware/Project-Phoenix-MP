---
phase: 21-rpg-attributes
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RpgAttributeCard.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/GamificationViewModel.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightGamificationRepository.kt
autonomous: true
requirements: [RPG-01, RPG-03, RPG-04]
must_haves:
  truths:
    - "Phoenix+ tier user sees RPG attribute card with five attribute bars on BadgesScreen"
    - "FREE tier user does not see the RPG attribute card"
    - "Character class name displays prominently on the card header"
    - "Each attribute bar shows name, numeric value (0-100), and filled progress bar"
    - "Card displays 'View full skill tree on Phoenix Portal' deep link button"
    - "Attributes recompute fresh each time BadgesScreen opens (not stale cached values)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RpgAttributeCard.kt"
      provides: "RpgAttributeCard composable with attribute bars, character class header, portal link"
      min_lines: 60
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt"
      provides: "Phoenix+ tier gated RPG card above StreakWidget"
      contains: "hasProAccess"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/GamificationViewModel.kt"
      provides: "rpgProfile StateFlow computed on init"
      contains: "rpgProfile"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt"
      provides: "getRpgInput() and saveRpgProfile() methods"
      contains: "getRpgInput"
  key_links:
    - from: "BadgesScreen.kt"
      to: "RpgAttributeCard.kt"
      via: "composable call inside hasProAccess gate"
      pattern: "if.*hasProAccess.*RpgAttributeCard"
    - from: "GamificationViewModel.kt"
      to: "RpgAttributeEngine.kt"
      via: "computeProfile call in loadRpgProfile"
      pattern: "RpgAttributeEngine\\.computeProfile"
    - from: "GamificationViewModel.kt"
      to: "GamificationRepository.kt"
      via: "getRpgInput() for DB aggregate data"
      pattern: "getRpgInput"
---

<objective>
Create the RpgAttributeCard composable and wire it into BadgesScreen with Phoenix+ tier
gating, computing attributes from GamificationRepository aggregate data via RpgAttributeEngine.

Purpose: Give Phoenix+ tier users a visible RPG profile on the gamification screen with
character class, attribute bars, and portal deep link.

Output: RpgAttributeCard composable, BadgesScreen integration, GamificationViewModel
rpgProfile state, repository methods for RPG data.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-rpg-attributes/21-RESEARCH.md
@.planning/phases/21-rpg-attributes/21-01-SUMMARY.md
@.planning/phases/20-readiness-briefing/20-02-SUMMARY.md

<interfaces>
<!-- Types created in Plan 01 that this plan consumes -->

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RpgModels.kt:
```kotlin
enum class RpgAttribute(val displayName: String, val description: String) {
    STRENGTH("Strength", "Peak load lifted"),
    POWER("Power", "Explosive force generation"),
    STAMINA("Stamina", "Training volume endurance"),
    CONSISTENCY("Consistency", "Training regularity"),
    MASTERY("Mastery", "Exercise variety and technique")
}

enum class CharacterClass(val displayName: String, val description: String) {
    POWERLIFTER("Powerlifter", "Dominant in raw strength"),
    ATHLETE("Athlete", "Dominant in explosive power"),
    IRONMAN("Ironman", "Dominant in volume endurance"),
    MONK("Monk", "Dominant in training discipline"),
    PHOENIX("Phoenix", "Balanced across all attributes")
}

data class RpgProfile(
    val strength: Int, val power: Int, val stamina: Int,
    val consistency: Int, val mastery: Int,
    val characterClass: CharacterClass, val lastComputed: Long = 0
) {
    companion object { val EMPTY = RpgProfile(0, 0, 0, 0, 0, CharacterClass.PHOENIX) }
}

data class RpgInput(
    val maxWeightLiftedKg: Double, val totalVolumeKg: Double,
    val totalWorkouts: Int, val totalReps: Int,
    val uniqueExercises: Int, val personalRecords: Int,
    val peakPowerWatts: Double, val avgWorkingWeightKg: Double,
    val currentStreak: Int, val longestStreak: Int,
    val trainingDays: Int, val badgesEarned: Int
)
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/RpgAttributeEngine.kt:
```kotlin
object RpgAttributeEngine {
    fun computeProfile(input: RpgInput): RpgProfile
}
```

From shared/src/commonMain/sqldelight/.../VitruvianDatabase.sq (Plan 01 adds these queries):
```sql
selectRpgAttributes:     SELECT * FROM RpgAttributes WHERE id = 1;
upsertRpgAttributes:     INSERT OR REPLACE INTO RpgAttributes (...) VALUES (1, ?, ?, ?, ?, ?, ?, ?);
selectMaxWeightLifted:   SELECT MAX(heaviestLiftKg) FROM WorkoutSession WHERE heaviestLiftKg IS NOT NULL;
selectAvgWorkingWeight:  SELECT AVG(workingAvgWeightKg) FROM WorkoutSession WHERE workingAvgWeightKg IS NOT NULL;
selectPeakRepPower:      SELECT MAX(peakPowerWatts) FROM RepMetric;
countTrainingDays:       SELECT COUNT(DISTINCT DATE(timestamp / 1000, 'unixepoch')) FROM WorkoutSession;
-- Plus existing: countTotalWorkouts, countTotalReps, countTotalVolume,
--   countUniqueExercises, countPersonalRecords, countEarnedBadges, selectPeakPower
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt:
```kotlin
@Composable
fun BadgesScreen(
    onBack: () -> Unit,
    mainViewModel: MainViewModel,
    viewModel: GamificationViewModel = koinInject()
)
// Currently: Column { StreakWidget(...), StatsRow(...), CategoryFilterRow(...), BadgesGrid }
// RPG card goes ABOVE StreakWidget, inside Phoenix+ tier gate
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/GamificationViewModel.kt:
```kotlin
class GamificationViewModel(
    private val repository: GamificationRepository
) : ViewModel()
// Need to add: rpgProfile StateFlow, loadRpgProfile() method
```

From shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt:
```kotlin
interface GamificationRepository {
    fun getEarnedBadges(): Flow<List<EarnedBadge>>
    fun getStreakInfo(): Flow<StreakInfo>
    fun getGamificationStats(): Flow<GamificationStats>
    suspend fun updateStats()
    // Need to add: suspend fun getRpgInput(): RpgInput, suspend fun saveRpgProfile(profile: RpgProfile)
}
```

From ActiveWorkoutScreen.kt (TIER GATING PATTERN TO FOLLOW):
```kotlin
val subscriptionManager: SubscriptionManager = koinInject()
val hasProAccess by subscriptionManager.hasProAccess.collectAsState()
// For Phoenix+ features: if (hasProAccess) { ... koinInject inside guard ... }
```

From ReadinessBriefingCard.kt (CARD COMPOSABLE PATTERN TO FOLLOW):
```kotlin
@Composable
fun ReadinessBriefingCard(
    result: ReadinessResult,
    onDismiss: () -> Unit,
    onPortalLink: () -> Unit,
    modifier: Modifier = Modifier
)
// Uses Card { Column { header, content, TextButton("...Portal") } }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Repository methods, ViewModel state, and RpgAttributeCard composable</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt,
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/SqlDelightGamificationRepository.kt,
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/GamificationViewModel.kt,
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RpgAttributeCard.kt
  </files>
  <action>
    1. Add to `GamificationRepository` interface:
       ```kotlin
       suspend fun getRpgInput(): RpgInput
       suspend fun saveRpgProfile(profile: RpgProfile)
       ```

    2. Implement in `SqlDelightGamificationRepository`:
       - `getRpgInput()`: Query aggregate data using existing + new SQLDelight queries:
         - `queries.countTotalWorkouts().executeAsOne()` -> totalWorkouts (Long, convert to Int)
         - `queries.countTotalReps().executeAsOneOrNull()` -> totalReps (Long?, default 0, convert to Int)
         - `queries.countTotalVolume().executeAsOneOrNull()` -> totalVolumeKg (Double?, default 0.0)
         - `queries.countUniqueExercises().executeAsOne()` -> uniqueExercises (Long, convert to Int)
         - `queries.countPersonalRecords().executeAsOne()` -> personalRecords (Long, convert to Int)
         - `queries.countEarnedBadges().executeAsOne()` -> badgesEarned (Long, convert to Int)
         - `queries.selectMaxWeightLifted().executeAsOneOrNull()` -> maxWeightLiftedKg (Double?, default 0.0)
         - `queries.selectAvgWorkingWeight().executeAsOneOrNull()` -> avgWorkingWeightKg (Double?, default 0.0)
         - `queries.selectPeakRepPower().executeAsOneOrNull()` -> peakPowerWatts (Double?, default 0.0). If null (no RepMetric data), fall back to `queries.selectPeakPower().executeAsOneOrNull()` converted from Long to Double.
         - `queries.countTrainingDays().executeAsOne()` -> trainingDays (Long, convert to Int)
         - For currentStreak/longestStreak: query `queries.selectGamificationStats().executeAsOneOrNull()` and extract `.currentStreak.toInt()` and `.longestStreak.toInt()` (default 0 if null)
         - Return constructed `RpgInput(...)` with all fields
       - `saveRpgProfile(profile: RpgProfile)`: Call `queries.upsertRpgAttributes(profile.strength.toLong(), profile.power.toLong(), profile.stamina.toLong(), profile.consistency.toLong(), profile.mastery.toLong(), profile.characterClass.name, profile.lastComputed)`
       - All DB calls wrapped in `withContext(Dispatchers.IO)`

    3. Update `GamificationViewModel`:
       - Add `private val _rpgProfile = MutableStateFlow<RpgProfile?>(null)`
       - Add `val rpgProfile: StateFlow<RpgProfile?> = _rpgProfile.asStateFlow()`
       - Add `fun loadRpgProfile()`:
         ```kotlin
         fun loadRpgProfile() {
             viewModelScope.launch {
                 try {
                     val input = repository.getRpgInput()
                     val profile = RpgAttributeEngine.computeProfile(input)
                     _rpgProfile.value = profile
                     repository.saveRpgProfile(profile.copy(lastComputed = currentTimeMillis()))
                 } catch (e: Exception) {
                     // Log error, leave profile null (card won't show)
                 }
             }
         }
         ```
       - Import `RpgAttributeEngine`, `RpgProfile`, `RpgInput` from domain
       - Import `currentTimeMillis` from platform utils
       - Do NOT call loadRpgProfile() in init -- it will be called from BadgesScreen LaunchedEffect (avoids computing for users who never visit the screen)

    4. Create `RpgAttributeCard.kt` in `presentation/components/`:
       ```kotlin
       @Composable
       fun RpgAttributeCard(
           profile: RpgProfile,
           onPortalLink: () -> Unit,
           modifier: Modifier = Modifier
       )
       ```
       Card layout:
       - Card with MaterialTheme.colorScheme.surface background, MaterialTheme.shapes.medium
       - Column with Spacing.medium padding:
         a. **Header row**: Character class icon (use getCharacterClassIcon helper) + class displayName (titleMedium, Bold) + class description (bodySmall, onSurfaceVariant)
         b. **Spacer** (Spacing.small)
         c. **Five attribute bars**: For each `RpgAttribute.entries`, extract the value from profile (when expression), render `AttributeBar(name, value)` composable
         d. **Spacer** (Spacing.small)
         e. **Portal link**: TextButton with text "View full skill tree on Phoenix Portal", bodySmall, primary color, onClick = onPortalLink. Zero contentPadding.

       Create private `AttributeBar` composable:
       ```kotlin
       @Composable
       private fun AttributeBar(name: String, value: Int, modifier: Modifier = Modifier)
       ```
       - Row: Text(name, bodySmall, width 90.dp) | LinearProgressIndicator(progress = value/100f, weight 1f, height 8.dp, clip RoundedCornerShape(4.dp)) | Text("$value", bodySmall, Bold, width 30.dp, textAlign End)
       - Use MaterialTheme.colorScheme.primary for progress color, surfaceVariant for track
       - Add vertical spacing (4.dp) between bars

       Create private `getCharacterClassIcon` helper:
       ```kotlin
       private fun getCharacterClassIcon(characterClass: CharacterClass): ImageVector {
           return when (characterClass) {
               CharacterClass.POWERLIFTER -> Icons.Default.FitnessCenter
               CharacterClass.ATHLETE -> Icons.Default.Bolt
               CharacterClass.IRONMAN -> Icons.Default.Repeat
               CharacterClass.MONK -> Icons.Default.SelfImprovement
               CharacterClass.PHOENIX -> Icons.Default.LocalFireDepartment
           }
       }
       ```

    5. Build to verify compilation: `./gradlew :androidApp:assembleDebug`

    6. Commit: `feat(21-02): add RpgAttributeCard composable and repository RPG methods`
  </action>
  <verify>
    <automated>./gradlew :androidApp:assembleDebug 2>&1 | tail -5</automated>
    Build succeeds. RpgAttributeCard.kt exists. GamificationRepository has getRpgInput/saveRpgProfile.
  </verify>
  <done>
    RpgAttributeCard composable renders character class header, five attribute bars with progress indicators, and portal deep link.
    GamificationRepository.getRpgInput() aggregates all workout data into RpgInput.
    GamificationViewModel.rpgProfile StateFlow holds computed profile.
    saveRpgProfile() persists to RpgAttributes table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire RpgAttributeCard into BadgesScreen with Phoenix+ tier gate</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt,
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeGamificationRepository.kt
  </files>
  <action>
    1. Update `BadgesScreen.kt`:
       a. Add import for SubscriptionManager: `import com.devil.phoenixproject.domain.subscription.SubscriptionManager`
       b. Add import for RpgAttributeCard: `import com.devil.phoenixproject.presentation.components.RpgAttributeCard`
       c. Add import for koinInject: already imported
       d. Add import for collectAsState, LaunchedEffect: already imported via `androidx.compose.runtime.*`

       e. Inside BadgesScreen composable, BEFORE the Scaffold, add tier gating:
       ```kotlin
       // RPG attributes - gated to Phoenix+ tier (RPG-03)
       val subscriptionManager: SubscriptionManager = koinInject()
       val hasProAccess by subscriptionManager.hasProAccess.collectAsState()
       ```

       f. Inside the Column (after paddingValues padding, before StreakWidget), add conditional RPG card:
       ```kotlin
       // RPG Attribute Card -- Phoenix+ only (RPG-03)
       if (hasProAccess) {
           // Compute attributes fresh each time screen opens (Pitfall 5 avoidance)
           LaunchedEffect(Unit) {
               viewModel.loadRpgProfile()
           }
           val rpgProfile by viewModel.rpgProfile.collectAsState()
           rpgProfile?.let { profile ->
               RpgAttributeCard(
                   profile = profile,
                   onPortalLink = { /* Portal deep link - deferred to v0.6.0+ (PORTAL-02) */ },
                   modifier = Modifier.padding(horizontal = Spacing.medium)
               )
               Spacer(modifier = Modifier.height(Spacing.small))
           }
       }
       ```
       This follows the exact pattern from ActiveWorkoutScreen readiness briefing (Phase 20-02):
       koinInject inside tier guard, LaunchedEffect for data fetch, conditional rendering.

    2. Update `FakeGamificationRepository` (if it exists in test utils) to implement the new
       interface methods. Add stub implementations:
       ```kotlin
       override suspend fun getRpgInput(): RpgInput = RpgInput(
           maxWeightLiftedKg = 0.0, totalVolumeKg = 0.0, totalWorkouts = 0,
           totalReps = 0, uniqueExercises = 0, personalRecords = 0,
           peakPowerWatts = 0.0, avgWorkingWeightKg = 0.0,
           currentStreak = 0, longestStreak = 0, trainingDays = 0, badgesEarned = 0
       )
       override suspend fun saveRpgProfile(profile: RpgProfile) { /* no-op */ }
       ```
       If FakeGamificationRepository doesn't exist, check if compilation fails due to
       unimplemented interface methods in any test fakes and fix them.

    3. Build and run all tests:
       `./gradlew :androidApp:assembleDebug`
       `./gradlew :shared:testDebugUnitTest`

    4. Commit: `feat(21-02): wire RpgAttributeCard into BadgesScreen with Phoenix+ tier gate`
  </action>
  <verify>
    <automated>./gradlew :shared:testDebugUnitTest 2>&1 | tail -10</automated>
    All tests pass. Build succeeds.
    Also verify: `./gradlew :androidApp:assembleDebug` compiles.
  </verify>
  <done>
    BadgesScreen shows RPG attribute card above StreakWidget for Phoenix+ users.
    FREE users see no RPG card (hasProAccess gate).
    Attributes recompute on each screen visit via LaunchedEffect.
    Portal deep link button present with placeholder callback.
    All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest` -- all tests pass (including RpgAttributeEngineTest from Plan 01)
2. `./gradlew :androidApp:assembleDebug` -- full build succeeds
3. `grep -n "hasProAccess" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt` -- tier gating present
4. `grep -n "RpgAttributeCard" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/screen/BadgesScreen.kt` -- card wired in
5. `grep -n "Portal" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/components/RpgAttributeCard.kt` -- deep link present
6. `grep -n "getRpgInput" shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/GamificationRepository.kt` -- repository method exists
</verification>

<success_criteria>
- RpgAttributeCard displays character class, five attribute bars (0-100), and portal link
- BadgesScreen conditionally renders card only for Phoenix+ tier users
- Attributes recompute fresh on each BadgesScreen visit (not stale)
- FREE users never see the RPG card
- "View full skill tree on Phoenix Portal" deep link is visible on the card
- All tests pass, project builds cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/21-rpg-attributes/21-02-SUMMARY.md`
</output>

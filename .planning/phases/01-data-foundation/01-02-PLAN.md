---
phase: 01-data-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepositoryTest.kt
autonomous: true

must_haves:
  truths:
    - "RepMetricRepository can save and retrieve per-rep metric data for a session"
    - "FeatureGate correctly gates every Feature for FREE, PHOENIX, and ELITE tiers"
    - "resolveEffectiveTier returns FREE when subscription is expired past grace period"
    - "Data capture happens for all tiers (GATE-04) - repository has no tier checks"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt"
      provides: "Repository for RepMetric CRUD with JSON serialization"
      exports: ["RepMetricRepository", "SqlDelightRepMetricRepository"]
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt"
      provides: "Tests for FeatureGate tier-based access"
      contains: "class FeatureGateTest"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepositoryTest.kt"
      provides: "Tests for RepMetric save/load round-trip"
      contains: "class RepMetricRepositoryTest"
  key_links:
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt"
      to: "VitruvianDatabase.sq"
      via: "SQLDelight queries (insertRepMetric, selectRepMetricsBySession)"
      pattern: "database\\.vitruvianDatabaseQueries"
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt"
      to: "RepMetricRepository"
      via: "Koin DI registration"
      pattern: "single.*RepMetricRepository"
---

<objective>
Wire RepMetricRepository to the database with JSON serialization for curve arrays, register in Koin DI, and add tests for FeatureGate and RepMetricRepository.

Purpose: Plan 01 created the schema and domain models. This plan wires them together with a working repository and proves correctness through tests. Without tests, the gating logic and data round-trip cannot be trusted.

Output: Working RepMetricRepository with JSON serialization, FeatureGate tests, repository tests, Koin DI registration.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SubscriptionTier.kt
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/TestFixtures.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RepMetricRepository with JSON serialization and DI registration</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/di/DataModule.kt
  </files>
  <action>
    1. Create `RepMetricRepository.kt` at `shared/.../data/repository/`:

       Interface:
       ```kotlin
       interface RepMetricRepository {
           suspend fun saveRepMetrics(sessionId: String, metrics: List<RepMetricData>)
           suspend fun getRepMetrics(sessionId: String): List<RepMetricData>
           suspend fun deleteRepMetrics(sessionId: String)
           suspend fun getRepMetricCount(sessionId: String): Long
       }
       ```

       Implementation `SqlDelightRepMetricRepository`:
       - Constructor takes `VitruvianDatabase`
       - JSON serialization: Convert FloatArray/LongArray to JSON strings for TEXT columns using a simple manual approach (no kotlinx.serialization dependency needed for arrays):
         - `FloatArray.toJsonString()`: Join with "," and wrap in "[]"
         - `String.toFloatArray()`: Strip brackets, split on ",", map to Float
         - Same pattern for LongArray
       - `saveRepMetrics()`: Iterate and call `insertRepMetric` for each RepMetricData, converting arrays to JSON strings
       - `getRepMetrics()`: Call `selectRepMetricsBySession`, map each row back to RepMetricData by parsing JSON strings back to arrays
       - `deleteRepMetrics()`: Call `deleteRepMetricsBySession`
       - `getRepMetricCount()`: Call `countRepMetricsBySession`
       - IMPORTANT: No subscription tier checks in the repository. Data is captured for ALL users (GATE-04).

    2. Register in `DataModule.kt`:
       - Add `single<RepMetricRepository> { SqlDelightRepMetricRepository(get()) }` to the existing dataModule Koin module

    3. Follow existing patterns:
       - Look at how `SqlDelightWorkoutRepository` handles the database instance
       - Use `withContext(Dispatchers.IO)` for DB operations (follow existing repo patterns)
       - Use the SQLDelight generated query names from Task 1 of Plan 01
  </action>
  <verify>
    Run `./gradlew :shared:compileKotlinMetadata` to verify compilation.
    Verify RepMetricRepository is registered in DataModule.kt Koin module.
    Run `./gradlew :androidApp:testDebugUnitTest --tests "*.KoinModuleVerifyTest"` to verify DI wiring.
  </verify>
  <done>
    RepMetricRepository interface and SqlDelightRepMetricRepository implementation exist. JSON serialization converts FloatArray/LongArray to/from TEXT columns. Repository registered in Koin DataModule. KoinModuleVerifyTest passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FeatureGate and RepMetricRepository tests</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/domain/premium/FeatureGateTest.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/data/repository/RepMetricRepositoryTest.kt
  </files>
  <action>
    1. Create `FeatureGateTest.kt`:
       - Test `isEnabled()` for each tier:
         - FREE tier: all features return false
         - PHOENIX tier: phoenix features return true, elite-only features return false
         - ELITE tier: all features return true
       - Test `resolveEffectiveTier()`:
         - Valid subscription (not expired) returns the tier
         - Expired within 30 days returns the tier (grace period)
         - Expired beyond 30 days returns FREE
         - FREE tier always returns FREE regardless of expiry
         - Null expiresAt returns FREE for non-FREE tiers
       - Use simple `assertEquals` / `assertTrue` assertions
       - No mocking needed - FeatureGate is a pure function object

    2. Create `RepMetricRepositoryTest.kt`:
       - Test JSON serialization round-trip:
         - Create a RepMetricData with known FloatArray values
         - Convert to JSON and back, verify values match
       - Test the helper extension functions:
         - `FloatArray.toJsonString()` produces valid JSON array string
         - `String.toFloatArray()` parses back correctly
         - Empty arrays handled correctly
         - Single-element arrays handled correctly
       - NOTE: Full integration test with SQLite requires a test database driver. If the project's test infrastructure supports it (check TestFixtures.kt), write an integration test. Otherwise, focus on the serialization unit tests which are the most critical correctness concern.

    3. Follow existing test patterns:
       - Check `shared/src/commonTest/` for test structure conventions
       - Use `kotlin.test` annotations (`@Test`, `assertEquals`, etc.)
  </action>
  <verify>
    Run `./gradlew :androidApp:testDebugUnitTest` to verify all tests pass.
    Verify FeatureGateTest has at least 5 test methods covering tier boundaries.
    Verify RepMetricRepositoryTest has at least 3 test methods covering serialization.
  </verify>
  <done>
    FeatureGateTest covers all tier combinations and grace period logic. RepMetricRepositoryTest covers JSON serialization round-trip. All tests pass. Requirements DATA-02 (tier queryable), DATA-03 (FeatureGate works), GATE-04 (no tier checks in repo) are verified by tests.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :androidApp:testDebugUnitTest` passes (all tests including new ones)
2. KoinModuleVerifyTest still passes with RepMetricRepository registered
3. FeatureGateTest covers FREE/PHOENIX/ELITE boundaries for all Feature values
4. RepMetricRepository JSON serialization round-trips correctly
5. No tier checks in RepMetricRepository (GATE-04 verified by code inspection)
</verification>

<success_criteria>
- All existing tests continue to pass
- FeatureGateTest has 5+ test cases covering tier boundaries and grace period
- RepMetricRepositoryTest verifies JSON array serialization round-trip
- KoinModuleVerifyTest passes with new DI registration
- Requirements DATA-02, DATA-03, GATE-04 are test-verified
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-02-SUMMARY.md`
</output>

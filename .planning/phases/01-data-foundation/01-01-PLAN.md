---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
  - shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/12.sqm
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SubscriptionTier.kt
  - shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
autonomous: true

must_haves:
  truths:
    - "RepMetric table exists in database schema with all per-rep curve and summary columns"
    - "SubscriptionTier enum defines FREE, PHOENIX, and ELITE tiers"
    - "FeatureGate.isEnabled() correctly returns access for each feature at each tier level"
    - "Migration 12.sqm creates RepMetric table with indexes and sync fields"
    - "iOS DriverFactory reports version 13 and includes RepMetric in manual schema"
    - "RepMetricData data class captures concentric/eccentric phase curves and summaries"
  artifacts:
    - path: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/12.sqm"
      provides: "Migration creating RepMetric table"
      contains: "CREATE TABLE RepMetric"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SubscriptionTier.kt"
      provides: "Three-tier subscription enum"
      contains: "enum class SubscriptionTier"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt"
      provides: "Tier-based feature gating utility"
      contains: "fun isEnabled"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt"
      provides: "RepMetricData data class for per-rep metrics"
      contains: "data class RepMetricData"
  key_links:
    - from: "shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq"
      to: "migrations/12.sqm"
      via: "SQLDelight migration chain"
      pattern: "CREATE TABLE RepMetric"
    - from: "shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt"
      to: "VitruvianDatabase.sq"
      via: "Manual schema sync (CURRENT_SCHEMA_VERSION = 13)"
      pattern: "CURRENT_SCHEMA_VERSION = 13"
    - from: "shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt"
      to: "SubscriptionTier.kt"
      via: "FeatureGate uses SubscriptionTier parameter"
      pattern: "tier: SubscriptionTier"
---

<objective>
Create the database schema, migration, domain models, and feature gating infrastructure for Phase 1 Data Foundation.

Purpose: Every premium feature (LED biofeedback, rep quality, smart suggestions) depends on per-rep metric storage and tier-based gating. This plan builds the complete foundation in one pass.

Output: RepMetric table in schema, migration 12.sqm, SubscriptionTier enum, FeatureGate utility, RepMetricData domain model, iOS DriverFactory synced to v13.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/specs/00-data-foundation.md
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
@shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/11.sqm
@shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/subscription/SubscriptionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/UserProfileRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RepMetric table schema and migration</name>
  <files>
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/migrations/12.sqm
    shared/src/commonMain/sqldelight/com/devil/phoenixproject/database/VitruvianDatabase.sq
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/model/RepMetrics.kt
  </files>
  <action>
    1. Create `12.sqm` migration file with RepMetric table creation. Use the exact schema from Spec 00 Section 5.1:
       - All columns: id (autoincrement PK), sessionId, repNumber, isWarmup, startTimestamp, endTimestamp, durationMs
       - Concentric phase: concentricDurationMs, concentricPositions (TEXT/JSON), concentricLoadsA, concentricLoadsB, concentricVelocities, concentricTimestamps
       - Eccentric phase: same pattern as concentric
       - Computed summaries: peakForceA, peakForceB, avgForceConcentricA/B, avgForceEccentricA/B, peakVelocity, avgVelocityConcentric, avgVelocityEccentric, rangeOfMotionMm, peakPowerWatts, avgPowerWatts
       - Sync fields: updatedAt, serverId
       - FK to WorkoutSession(id) ON DELETE CASCADE
       - Two indexes: idx_rep_metric_session and idx_rep_metric_session_rep

    2. Add the same CREATE TABLE and indexes to `VitruvianDatabase.sq` after the PhaseStatistics section (before Gamification tables). Follow the existing section pattern with comment headers.

    3. Add SQLDelight queries to VitruvianDatabase.sq for RepMetric:
       - `insertRepMetric`: INSERT with all columns
       - `selectRepMetricsBySession`: SELECT * WHERE sessionId = ? ORDER BY repNumber ASC
       - `deleteRepMetricsBySession`: DELETE WHERE sessionId = ?
       - `selectAllRepMetricsSync`: SELECT * (for backup)
       - `countRepMetricsBySession`: SELECT COUNT(*) WHERE sessionId = ?

    4. Create `RepMetrics.kt` domain model at `shared/.../domain/model/RepMetrics.kt`:
       - `data class RepMetricData` matching Spec 00 Section 1.3 exactly
       - Use FloatArray for curve data, LongArray for timestamps
       - Include all concentric/eccentric arrays and computed summary fields
       - NOTE: This is an in-memory model; JSON serialization for DB storage will be in the repository (Plan 02)
  </action>
  <verify>
    Run `./gradlew :shared:compileKotlinMetadata` to verify SQLDelight generates code successfully.
    Check that 12.sqm file exists and contains CREATE TABLE RepMetric.
    Check that VitruvianDatabase.sq compiles with the new table and queries.
  </verify>
  <done>
    Migration 12.sqm creates RepMetric table. VitruvianDatabase.sq has RepMetric table definition and 5 queries. RepMetricData data class exists in domain/model/. SQLDelight code generation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SubscriptionTier enum and FeatureGate utility</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/SubscriptionTier.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/domain/premium/FeatureGate.kt
  </files>
  <action>
    1. Create `SubscriptionTier.kt` at `shared/.../domain/premium/`:
       ```kotlin
       enum class SubscriptionTier {
           FREE, PHOENIX, ELITE;
           companion object {
               fun fromDbString(value: String?): SubscriptionTier =
                   when (value?.lowercase()) {
                       "phoenix" -> PHOENIX
                       "elite" -> ELITE
                       else -> FREE
                   }
           }
           fun toDbString(): String = name.lowercase()
       }
       ```
       This coexists with the existing `SubscriptionStatus` enum in UserProfileRepository.kt for now. The existing `subscription_status` DB field will store tier values ("free", "phoenix", "elite") instead of status values ("free", "active"). The existing `SubscriptionStatus` is a payment state; `SubscriptionTier` is a feature access level. Both are valid concepts.

    2. Create `FeatureGate.kt` at `shared/.../domain/premium/`:
       - Define `Feature` enum with all premium features from Spec 00 Section 2.3:
         Phoenix: FORCE_CURVES, PER_REP_METRICS, VBT_METRICS, PORTAL_SYNC, LED_BIOFEEDBACK, REP_QUALITY_SCORE
         Elite: ASYMMETRY_ANALYSIS, AUTO_REGULATION, SMART_SUGGESTIONS, WORKOUT_REPLAY, STRENGTH_ASSESSMENT, PORTAL_ADVANCED_ANALYTICS
       - Use `object FeatureGate` with `fun isEnabled(feature: Feature, tier: SubscriptionTier): Boolean`
       - Phoenix features available to Phoenix AND Elite tiers
       - Elite features available to Elite tier only
       - FREE tier gets no premium features
       - Add `fun resolveEffectiveTier(subscriptionTier: SubscriptionTier, expiresAt: Long?, nowMs: Long): SubscriptionTier` that handles offline grace period (30-day grace from Spec 00 Section 2.4)
       - Import `currentTimeMillis` from PlatformUtils for the default `nowMs` parameter

    IMPORTANT: Do NOT modify the existing `SubscriptionManager` or `PremiumFeatureGate.kt` in this plan. Those will be updated in a future plan when the UI wiring is done. The new FeatureGate is a domain utility, not a presentation layer replacement.
  </action>
  <verify>
    Run `./gradlew :shared:compileKotlinMetadata` to verify compilation.
    Verify that FeatureGate.isEnabled(Feature.LED_BIOFEEDBACK, SubscriptionTier.PHOENIX) would return true.
    Verify that FeatureGate.isEnabled(Feature.SMART_SUGGESTIONS, SubscriptionTier.PHOENIX) would return false.
  </verify>
  <done>
    SubscriptionTier enum has FREE/PHOENIX/ELITE with DB string conversion. FeatureGate object provides isEnabled() and resolveEffectiveTier() functions. Code compiles in commonMain.
  </done>
</task>

<task type="auto">
  <name>Task 3: Sync iOS DriverFactory to schema version 13</name>
  <files>
    shared/src/iosMain/kotlin/com/devil/phoenixproject/data/local/DriverFactory.ios.kt
  </files>
  <action>
    Per Daem0n warning #155: Any CREATE TABLE change needs iOS DriverFactory version bump.

    1. Update `CURRENT_SCHEMA_VERSION` from 12L to 13L.

    2. Add RepMetric table to `createAllTables()` list, after the PhaseStatistics table. Use the exact same column definitions as in VitruvianDatabase.sq (Task 1), wrapped in `CREATE TABLE IF NOT EXISTS RepMetric (...)`.

    3. Add RepMetric indexes to `createAllIndexes()` list:
       - `CREATE INDEX IF NOT EXISTS idx_rep_metric_session ON RepMetric(sessionId)`
       - `CREATE INDEX IF NOT EXISTS idx_rep_metric_session_rep ON RepMetric(sessionId, repNumber)`

    4. No new columns need to be added to `ensureAllColumnsExist()` since RepMetric is a brand new table (IF NOT EXISTS handles fresh installs, and OUTDATED health check handles version bumps by purging).

    CRITICAL: The table definition in DriverFactory.ios.kt MUST exactly match VitruvianDatabase.sq. Any column mismatch causes SQLDelight query failures on iOS. Double-check every column name, type, and default value.
  </action>
  <verify>
    Verify CURRENT_SCHEMA_VERSION is 13L in DriverFactory.ios.kt.
    Verify RepMetric table appears in createAllTables() with all columns matching VitruvianDatabase.sq.
    Verify both RepMetric indexes appear in createAllIndexes().
    Run `./gradlew :shared:compileKotlinIosArm64` (or metadata) to verify iOS compilation.
  </verify>
  <done>
    iOS DriverFactory reports version 13. RepMetric table and indexes are in manual schema. Column definitions match VitruvianDatabase.sq exactly. iOS code compiles.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:compileKotlinMetadata` succeeds (SQLDelight generation + all new Kotlin files)
2. Migration 12.sqm exists and creates RepMetric table with correct schema
3. VitruvianDatabase.sq has RepMetric table + 5 queries
4. SubscriptionTier enum has FREE/PHOENIX/ELITE
5. FeatureGate.isEnabled() correctly gates features by tier
6. iOS DriverFactory has version 13 with RepMetric table matching .sq schema
7. RepMetricData data class has all fields from Spec 00
</verification>

<success_criteria>
- SQLDelight code generation succeeds with new RepMetric table and queries
- All new Kotlin files compile without errors on all targets (common, Android, iOS)
- Schema version is 13 in both SQLDelight (1 base + 12 migrations) and iOS DriverFactory
- Requirements DATA-01 (schema), DATA-04 (migration), DATA-05 (iOS sync) are satisfied at the schema level
- Requirements DATA-02 (SubscriptionTier enum), DATA-03 (FeatureGate utility) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
